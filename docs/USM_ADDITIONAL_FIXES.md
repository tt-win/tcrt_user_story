# User Story Map 額外修正報告

## 修正項目

### 1. ✅ 根節點不能新增同級節點
**修改**: `addSiblingNode()` 函數加入檢查

```javascript
// Root node cannot have siblings
if (!siblingNode.data.parentId) {
    alert('根節點不能新增同級節點');
    return;
}
```

**效果**: 點擊根節點的「同級」按鈕會顯示提示訊息，不會開啟新增對話框

---

### 2. ✅ 更名：兄節點 → 同級節點
**修改位置**:
- 按鈕文字：`' 兄'` → `' 同級'`
- 按鈕 title：`'新增兄弟節點'` → `'新增同級節點'`

**效果**: UI 上所有「兄」都改為「同級」，語意更清楚

---

### 3. ✅ 智能定位：由左到右樹狀排版
**修改**: `addNode()` 函數改用樹狀定位演算法

**定位邏輯**:
```
有父節點:
  X 座標 = 父節點 X + 300 (往右 300px)
  Y 座標 = 父節點 Y + (兄弟數量 × 120)

無父節點 (根層級):
  X 座標 = 100
  Y 座標 = 100 + (根節點數量 × 200)
```

**效果**: 
- 子節點自動出現在父節點右方
- 同層節點垂直排列，間隔 120px
- 符合由左到右的樹狀結構

**範例**:
```
Root (100, 100)
  │
  ├─→ Child 1 (400, 100)    ← 第一個子節點
  │
  └─→ Child 2 (400, 220)    ← 第二個子節點，往下 120px
```

---

### 4. ✅ 取消四個角落的連接點
**修改**: 移除 top-left, top-right, bottom-left, bottom-right handles

**保留的連接點**:
- ⬆️ top (上)
- ⬇️ bottom (下)
- ⬅️ left (左)
- ➡️ right (右)

**效果**: 
- 連接點從 8 個減為 4 個
- 更簡潔的視覺呈現
- 仍可從四個方向建立連線

---

## 節點定位示意圖

### 新增子節點
```
     Root
    (100,100)
        │
        │ 300px
        ↓
   ┌────────┐
   │ Child 1│ (400,100)
   └────────┘
        │
        │ 300px
        ↓
   ┌────────┐
   │Grandchild│ (700,100)
   └────────┘
```

### 新增多個同級節點
```
     Root
    (100,100)
        │
        ├───→ Child 1 (400,100)   ← Y = 100 + (0 × 120)
        │
        ├───→ Child 2 (400,220)   ← Y = 100 + (1 × 120)
        │
        └───→ Child 3 (400,340)   ← Y = 100 + (2 × 120)
```

### 自動排版效果
```
Root ──→ Feature A ──→ Story A1
         (100,100)   (400,100)    (700,100)
              │
              └──→ Feature B ──→ Story B1
                   (400,220)     (700,220)
```

---

## 連接點配置

### 修改前 (8 個連接點)
```
     ●   ●   ●
      \  |  /
    ●──┌───┐──●
       │   │
    ●──└───┘──●
      /  |  \
     ●   ●   ●
```

### 修改後 (4 個連接點)
```
         ●
         |
    ●──┌───┐──●
       │   │
       └───┘
         |
         ●
```

---

## 測試檢查清單

### 1. 根節點限制
- [ ] 點擊根節點的「同級」按鈕
- [ ] 確認顯示「根節點不能新增同級節點」提示
- [ ] 確認未開啟新增對話框

### 2. 按鈕文字
- [ ] 確認所有節點顯示「子」和「同級」按鈕
- [ ] 確認無「兄」字樣

### 3. 智能定位
- [ ] 新增子節點，確認出現在父節點右方
- [ ] 連續新增多個子節點，確認垂直排列
- [ ] 檢查節點間距約 120px
- [ ] 新增孫節點，確認再往右 300px

### 4. 連接點數量
- [ ] 檢查節點只有 4 個連接點
- [ ] 確認上下左右四個方向都可連線
- [ ] 確認無角落連接點

---

## 程式碼變更摘要

### app/static/js/user_story_map.js

**1. addNode() 函數**
- 新增樹狀定位演算法
- 根據父節點和兄弟節點計算位置
- X 軸：每層往右 300px
- Y 軸：同層間隔 120px

**2. addSiblingNode() 函數**
- 新增根節點檢查
- 禁止根節點新增同級節點

**3. CustomNode 元件**
- 移除 4 個角落 Handle
- 按鈕文字改為「同級」
- 更新 title 屬性

---

## 效能考量

### 定位計算
- 時間複雜度: O(n) - 需要遍歷節點陣列找兄弟節點
- 空間複雜度: O(1) - 只需固定變數

### 建議
- 節點數量 < 100: 無影響
- 節點數量 > 100: 考慮快取兄弟節點數量
- 未來可考慮維護每個節點的子節點計數

---

## 未來改進建議

1. **動態間距**: 根據節點內容長度調整間距
2. **避免重疊**: 檢測節點重疊並自動調整
3. **智能對齊**: 同層節點可選擇垂直對齊或水平對齊
4. **拖曳後重排**: 手動拖曳後仍可恢復智能排版

---

## 總結

所有 4 項修正都已完成：
- ✅ 根節點不能新增同級節點
- ✅ 更名為「同級節點」
- ✅ 智能樹狀定位
- ✅ 只保留 4 個連接點

節點現在會按照樹狀結構自動排列，大幅改善使用體驗！

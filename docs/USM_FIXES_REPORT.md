# User Story Map 問題修復報告

## 修復的問題

### 1. ✅ Database migration 自動偵測啟動
**問題**: 需要手動執行遷移腳本

**解決方案**:
- 修改 `database_init.py` 加入 User Story Map 資料庫初始化
- 新增 `initialize_usm_engine()` 函數
- 新增 `print_usm_stats()` 顯示 USM 資料庫統計
- 應用啟動時會自動執行 `init_usm_db()` (已在 `app/main.py` 中)

**修改檔案**:
- `database_init.py`

### 2. ✅ 新增地圖時的 500 錯誤
**問題**: 呼叫 `datetime.utcnow().timestamp()` 產生浮點數 ID 導致錯誤

**解決方案**:
- 改用 `time.time() * 1000` 並轉為整數生成唯一 ID
- 確保 position_x 和 position_y 為浮點數類型
- 修正 root 節點的資料類型

**修改檔案**:
- `app/api/user_story_maps.py` - `create_map()` 函數

### 3. ✅ 沒有刪除地圖的功能
**問題**: 無法刪除已建立的地圖

**解決方案**:
- 在地圖列表中每個地圖項目加上刪除按鈕
- 實作刪除確認對話框
- 刪除後自動重新整理列表
- 如果刪除的是當前顯示的地圖，自動清空畫布

**修改檔案**:
- `app/static/js/user_story_map.js` - 地圖列表顯示和刪除處理

**新增功能**:
- 刪除按鈕（垃圾桶圖示）
- 刪除確認提示
- 自動清空被刪除的地圖

### 4. ✅ 節點無法新增子節點或兄弟節點
**問題**: 只能從頂部按鈕新增獨立節點，無法建立父子關係

**解決方案**:
- 在每個節點卡片上新增「+子」和「+兄」按鈕
- 點擊按鈕時記錄父節點資訊
- 新增節點時自動建立父子連線
- 自動更新父節點的 children_ids
- 新增 `addChildNode()` 函數
- 新增 `addSiblingNode()` 函數
- 子節點的 level 自動設為父節點 level + 1

**修改檔案**:
- `app/static/js/user_story_map.js`
  - CustomNode 元件加入按鈕
  - addNode 函數支援 parentId 和 level
  - 新增 addChildNode 和 addSiblingNode 函數
  - confirmAddNodeBtn 事件處理加入父子關係邏輯

### 5. ✅ 節點需要連接點
**問題**: 節點沒有明顯的連接點，難以建立連線

**解決方案**:
- 在節點的 8 個位置加上連接點 (Handle):
  - 上、下、左、右（中間）
  - 上左、上右、下左、下右（四角）
- 使用 React Flow 的 Handle 元件
- 設定適當的視覺樣式（藍色圓點，白色邊框）
- 每個 handle 都有唯一 ID

**修改檔案**:
- `app/templates/user_story_map.html` - CSS 樣式
- `app/static/js/user_story_map.js` - CustomNode 元件

**新增的連接點**:
- `top` - 上方中間
- `bottom` - 下方中間
- `left` - 左方中間
- `right` - 右方中間
- `top-left` - 左上角
- `top-right` - 右上角
- `bottom-left` - 左下角
- `bottom-right` - 右下角

## 技術細節

### 資料庫初始化流程
```
啟動應用
  ↓
app/main.py startup_event()
  ↓
init_usm_db()
  ↓
建立 user_story_maps 和 user_story_map_nodes 表
```

### 節點新增流程（含父子關係）
```
使用者點擊節點上的「+子」按鈕
  ↓
記錄父節點 ID 和 level
  ↓
顯示新增節點 Modal
  ↓
填寫節點資訊並確認
  ↓
建立新節點（level = 父 level + 1）
  ↓
自動建立從父到子的連線 (smoothstep)
  ↓
更新父節點的 children_ids
```

### 地圖刪除流程
```
點擊地圖列表中的刪除按鈕
  ↓
顯示確認對話框
  ↓
呼叫 DELETE /api/user-story-maps/{id}
  ↓
後端刪除地圖和相關節點
  ↓
前端重新整理列表
  ↓
如果刪除當前地圖，清空畫布
```

## 測試建議

### 1. 資料庫初始化測試
```bash
# 重啟服務測試自動初始化
./stop.sh
./start.sh

# 檢查日誌
tail -f logs/app.log | grep "User Story Map"
```

### 2. 新增地圖測試
- 點擊「新增地圖」按鈕
- 輸入名稱和描述
- 確認自動產生根節點
- 檢查沒有 500 錯誤

### 3. 刪除地圖測試
- 建立多個測試地圖
- 在地圖列表中點擊刪除按鈕
- 確認刪除對話框顯示
- 確認刪除後列表更新
- 確認刪除當前地圖時畫布清空

### 4. 節點父子關係測試
- 選擇根節點
- 點擊「+子」按鈕新增子節點
- 確認自動建立連線
- 再對子節點點擊「+子」建立孫節點
- 確認 level 遞增正確

### 5. 兄弟節點測試
- 選擇任一子節點
- 點擊「+兄」按鈕
- 確認新節點與原節點同層級
- 確認兩者有相同的父節點

### 6. 連接點測試
- 將滑鼠移到節點上
- 確認 8 個連接點都可見
- 嘗試從不同位置拖曳建立連線
- 確認連線正確建立

## 已知限制

1. **兄弟節點位置**: 目前新增的兄弟節點位置是隨機的，建議新增後使用「自動排版」
2. **連接點視覺**: 需要滑鼠 hover 才清楚看到連接點，這是 React Flow 的預設行為
3. **刪除地圖**: 無法復原，建議未來加入確認二次確認或軟刪除機制

## 未來改進建議

1. **智能定位**: 新增子節點時自動計算合適的位置（在父節點下方或右方）
2. **批次操作**: 支援選取多個節點進行批次刪除或移動
3. **拖曳新增**: 從工具列拖曳節點類型到畫布上新增
4. **樣板節點**: 預設常用節點類型的樣板
5. **快捷鍵**: 支援鍵盤快捷鍵（如 Ctrl+C 複製節點）
6. **撤銷/重做**: 支援操作歷史的撤銷和重做

## 變更檔案清單

1. `database_init.py` - 加入 USM 資料庫初始化
2. `app/api/user_story_maps.py` - 修正建立地圖的錯誤
3. `app/templates/user_story_map.html` - 加入連接點 CSS
4. `app/static/js/user_story_map.js` - 主要功能增強：
   - 刪除地圖功能
   - 新增子節點功能
   - 新增兄弟節點功能
   - 8 個連接點
   - 父子關係自動建立

## 總結

所有報告的問題都已修復：
- ✅ 資料庫自動初始化
- ✅ 修正 500 錯誤
- ✅ 加入刪除地圖功能
- ✅ 支援新增子節點和兄弟節點
- ✅ 節點有 8 個連接點

系統現在可以正常運作，並且具備完整的節點管理功能。

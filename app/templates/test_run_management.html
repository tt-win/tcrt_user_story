{% extends "base.html" %}

{% block title %}{{ i18n.t('testRun.management') if i18n else '測試執行管理' }} - Test Case Repository Web Tool{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/test-run-management.css">
{% endblock %}

{% block page_title_text %}
<span data-i18n="testRun.management">測試執行管理</span>
{% endblock %}

{% block page_subtitle_text %}
<span data-i18n="testRun.subtitle">管理測試執行記錄，追蹤測試進度和結果</span>
{% endblock %}

{% block page_specific_actions %}
<div class="d-flex flex-column flex-md-row gap-3">
    <!-- 狀態過濾按鈕群組 -->
    <div class="btn-group" role="group" aria-label="Status filter buttons">
        <input type="radio" class="btn-check" name="statusFilter" id="filterAll" value="all" checked>
        <label class="btn btn-secondary" for="filterAll">
            <i class="fas fa-list me-1"></i><span data-i18n="testRun.filter.all">全部</span>
        </label>

        <input type="radio" class="btn-check" name="statusFilter" id="filterDraft" value="draft">
        <label class="btn btn-warning" for="filterDraft">
            <i class="fas fa-edit me-1"></i><span data-i18n="testRun.filter.draft">草稿</span>
        </label>

        <input type="radio" class="btn-check" name="statusFilter" id="filterActive" value="active">
        <label class="btn btn-primary" for="filterActive">
            <i class="fas fa-play me-1"></i><span data-i18n="testRun.filter.active">進行中</span>
        </label>

        <input type="radio" class="btn-check" name="statusFilter" id="filterCompleted" value="completed">
        <label class="btn btn-success" for="filterCompleted">
            <i class="fas fa-check me-1"></i><span data-i18n="testRun.filter.completed">已完成</span>
        </label>

        <input type="radio" class="btn-check" name="statusFilter" id="filterArchived" value="archived">
        <label class="btn btn-secondary" for="filterArchived">
            <i class="fas fa-archive me-1"></i><span data-i18n="testRun.filter.archived">已歸檔</span>
        </label>
    </div>

    <!-- 其他操作按鈕 -->
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-secondary" id="refreshBtn">
            <i class="fas fa-sync-alt me-2"></i><span data-i18n="common.refresh">重新整理</span>
        </button>
        <a href="/" class="btn btn-secondary">
            <i class="fas fa-home me-2"></i><span data-i18n="navigation.backToHome">回到首頁</span>
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- Loading state -->
    <div id="loading-state" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden" data-i18n="common.loading">載入中...</span>
        </div>
        <div class="mt-3 text-muted" data-i18n="testRun.loadingConfigs">載入測試執行配置中...</div>
    </div>

    <!-- 無配置時的提示區域 -->
    <div id="no-configs-section" style="display: none;">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-4">
                <div class="card text-center add-test-run-card" onclick="openConfigFormModal()">
                    <div class="card-body py-5">
                        <div class="text-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 64px; height: 64px; font-size: 24px; border: 2px dashed var(--tr-primary);">
                            <i class="fas fa-plus"></i>
                        </div>
                        <h5 class="text-primary mb-2" data-i18n="testRun.createFirstConfig">建立第一個測試執行</h5>
                        <p class="text-muted small mb-0" data-i18n="testRun.createFirstConfigHint">
                            設定 Lark 資料表開始測試執行
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Run Set 與未歸組區域 -->
    <div id="test-run-configs-section">
        <div id="test-run-sets-section" class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <div>
                    <h4 class="mb-0" data-i18n="testRun.sets.heading">Test Run Set</h4>
                    <small class="text-muted" data-i18n="testRun.sets.subtitle">集中管理多個 Test Run 組合</small>
                </div>
            </div>
            <div class="row" id="test-run-sets-container"></div>
        </div>

        <div class="test-run-section-divider"></div>

        <div id="adhoc-runs-section" class="mb-5" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <div>
                    <h4 class="mb-0" data-i18n="adhoc.title">Ad-hoc Runs</h4>
                    <small class="text-muted">{{ i18n.t("adhoc.desc") if i18n else "Quick test runs without predefined test cases" }}</small>
                </div>
            </div>
            <div class="row" id="adhoc-runs-container"></div>
            <div class="test-run-section-divider"></div>
        </div>

        <div id="unassigned-test-runs-section">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <div>
                    <h4 class="mb-0" data-i18n="testRun.unassigned.heading">未歸組 Test Run</h4>
                    <small class="text-muted" data-i18n="testRun.unassigned.subtitle">尚未加入任何 Test Run Set 的測試執行</small>
                </div>
            </div>
            <div class="row" id="unassigned-test-runs-container"></div>
            <div id="no-unassigned-test-runs" class="text-center text-muted py-4" style="display: none;">
                <i class="fas fa-clipboard-check fa-2x mb-3"></i>
                <div data-i18n="testRun.unassigned.empty">所有 Test Run 皆已加入 Test Run Set</div>
            </div>
        </div>
    </div>
</div>

<!-- Ad-hoc Run 建立 Modal -->
<div class="modal fade" id="adHocRunFormModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="adHocRunFormTitle">Create Ad-hoc Run</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="adHocRunForm">
                    <div class="mb-3">
                        <label for="adHocName" class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="adHocName" required>
                    </div>
                    <div class="mb-3">
                        <label for="adHocDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="adHocDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label for="adHocTestEnvironment" class="form-label">Test Environment <span class="badge bg-secondary ms-2">Optional</span></label>
                          <input type="text" class="form-control" id="adHocTestEnvironment" placeholder="e.g. Staging / UAT">
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label for="adHocBuildNumber" class="form-label">Build Number <span class="badge bg-secondary ms-2">Optional</span></label>
                          <input type="text" class="form-control" id="adHocBuildNumber" placeholder="e.g. v1.2.3">
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label for="adHocRelatedTpTickets" class="form-label">Related JIRA Tickets <span class="badge bg-secondary ms-2">Optional</span></label>
                          <input type="text" class="form-control" id="adHocRelatedTpTicketsInput" 
                                 placeholder="Enter JIRA ticket (e.g. TP-12345)"
                                 autocomplete="off">
                          <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            <span>Press Enter to add ticket</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- TP Tickets Display Area -->
                    <div class="mb-3" id="adHocTpTicketsDisplay" style="display: none;">
                        <label class="form-label">Selected Tickets:</label>
                        <div id="adHocTpTicketTags" class="d-flex flex-wrap gap-2"></div>
                    </div>
                    
                    <!-- Legacy JIRA Ticket (Hidden or Removed? Keeping hidden for backward compat if needed, but logic should use tags) -->
                    <input type="hidden" id="adHocJira"> 
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAdHocRunBtn">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Test Run Configuration Modal -->
<div class="modal fade" id="configFormModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="configFormModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="testRunConfigForm">
                    <input type="hidden" id="configId" name="id">
                    <input type="hidden" id="configSetId" name="set_id">
                    <input type="hidden" id="configTestCaseSetId" name="test_case_set_id">
                    <div class="mb-3" id="testCaseSetSelectorGroup">
                        <label for="testCaseSetSelector" class="form-label">
                            <span data-i18n="testRun.sets.selectSets">選擇 Test Case Sets</span>
                            <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="testCaseSetSelector" multiple size="6" required>
                            <!-- options 由 JS 動態載入 -->
                        </select>
                        <div class="form-text text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            <span data-i18n="testRun.sets.selectSetHintMulti">可選多個 Test Case Set，僅限同一團隊</span>
                        </div>
                    </div>
                    <div class="mb-3 d-none" id="testCaseSetReadOnlyGroup">
                        <label class="form-label">
                            <span data-i18n="testRun.sets.selectedSet">Test Case Set</span>
                        </label>
                        <div class="form-control-plaintext fw-semibold" id="testCaseSetReadOnlyText"></div>
                    </div>

                    <div class="mb-3">
                        <label for="configName" class="form-label">
                            <span data-i18n="testRun.configName">Test Run 名稱</span> 
                            <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="configName" name="name" required 
                               data-i18n-placeholder="testRun.configNamePlaceholder"
                               placeholder="輸入 Test Run 名稱">
                    </div>
                    
                    
                    <div class="mb-3">
                        <label for="configDescription" class="form-label" data-i18n="common.description">描述</label>
                        <textarea class="form-control" id="configDescription" name="description" rows="3" 
                                data-i18n-placeholder="testRun.descriptionPlaceholder"></textarea>

                    </div>

                    <div class="row">
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label for="testEnvironment" class="form-label"><span data-i18n="testRun.testEnvironment">測試環境</span> <span class="badge bg-secondary ms-2" data-i18n="common.optional">選填</span></label>
                          <input type="text" class="form-control" id="testEnvironment" name="test_environment" data-i18n-placeholder="testRun.testEnvironmentPlaceholder" placeholder="例如：Staging / UAT / Prod Sandbox">
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label for="buildNumber" class="form-label"><span data-i18n="testRun.buildNumber">建置版本</span> <span class="badge bg-secondary ms-2" data-i18n="common.optional">選填</span></label>
                          <input type="text" class="form-control" id="buildNumber" name="build_number" data-i18n-placeholder="testRun.buildNumberPlaceholder" placeholder="例如：v1.2.3 / build #4567">
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label for="relatedTpTickets" class="form-label">
                            <span data-i18n="testRun.relatedTpTickets">相關 JIRA Tickets</span> 
                            <span class="badge bg-secondary ms-2" data-i18n="common.optional">選填</span>
                          </label>
                          <input type="text" class="form-control" id="relatedTpTicketsInput" 
                                 data-i18n-placeholder="testRun.relatedTpTicketsPlaceholder" 
                                 placeholder="輸入 TP 票號，例如：TP-12345"
                                 autocomplete="off">
                          <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            <span data-i18n="testRun.tpTicketInputHint">按 Enter 鍵新增票號</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- TP 標籤顯示區域 -->
                    <div class="mb-3" id="tpTicketsDisplay" style="display: none;">
                        <label class="form-label">
                            <span data-i18n="testRun.addedTpTickets">已新增的 TP 開發單</span>
                        </label>
                        <div id="tpTicketTags" class="d-flex flex-wrap gap-2">
                            <!-- TP 票號標籤將在這裡動態生成 -->
                        </div>
                    </div>

                    <!-- 通知設定區域 -->
                    <div class="mb-3">
                        <h6 class="mb-3">
                            <i class="fas fa-bell me-2"></i>
                            <span data-i18n="testRun.notifications.title">通知設定</span>
                            <span class="badge bg-secondary ms-2" data-i18n="common.optional">選填</span>
                        </h6>
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="notificationsEnabled" name="notifications_enabled">
                            <label class="form-check-label" for="notificationsEnabled">
                                <span data-i18n="testRun.notifications.enable">啟用 Lark 群組通知</span>
                            </label>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                <span data-i18n="testRun.notifications.enableHint">在測試執行狀態變更時發送通知到選定的 Lark 群組</span>
                            </div>
                        </div>
                        
                        <!-- 群組選擇區域，預設隱藏 -->
                        <div id="notificationGroupsSection" style="display: none;">
                            <label for="notifyGroupsSelect" class="form-label">
                                <span data-i18n="testRun.notifications.selectGroups">選擇通知群組</span>
                            </label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="notifyGroupsInput" 
                                       data-i18n-placeholder="testRun.notifications.searchPlaceholder" 
                                       placeholder="搜尋群組名稱..." 
                                       autocomplete="off">
                                <button class="btn btn-secondary" type="button" id="searchGroupsBtn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div id="groupSearchResults" class="border rounded p-2" style="max-height: 200px; overflow-y: auto; display: none;">
                                <!-- 群組搜尋結果將在這裡顯示 -->
                            </div>
                            <div class="form-text mb-3">
                                <i class="fas fa-info-circle me-1"></i>
                                <span data-i18n="testRun.notifications.selectHint">輸入群組名稱關鍵字搜尋並選擇通知群組，最多可選 100 個</span>
                            </div>
                            
                            <!-- 已選群組顯示區域 -->
                            <div id="selectedGroupsDisplay" class="mb-3" style="display: none;">
                                <label class="form-label">
                                    <span data-i18n="testRun.notifications.selectedGroups">已選群組</span>
                                    <span class="badge bg-primary ms-2" id="selectedGroupsCount">0</span>
                                </label>
                                <div id="selectedGroupsTags" class="d-flex flex-wrap gap-2">
                                    <!-- 已選群組標籤將在這裡動態生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="saveConfigBtn">
                    <i class="fas fa-save me-2"></i><span id="saveConfigBtnText"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Case 選擇 Modal -->
<div class="modal fade" id="caseSelectModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-tasks me-2"></i><span data-i18n="testRun.caseSelect.title">選擇要加入的 Test Case</span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body case-select-modal-body">
        <div class="case-select-controls">
        <div class="mb-3" id="caseSelectSetSelectorGroup">
          <label for="caseSelectTestCaseSet" class="form-label">
            <span data-i18n="testRun.sets.filterSet">篩選 Test Case Set</span>
          </label>
          <select class="form-select" id="caseSelectTestCaseSet"></select>
          <div class="form-text text-muted">
            <i class="fas fa-info-circle me-1"></i>
            <span data-i18n="testRun.sets.filterSetHint">可切換顯示單一 Set，已勾選項目會保留</span>
          </div>
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="selectAllCurrentSetCheckbox">
            <label class="form-check-label" for="selectAllCurrentSetCheckbox">
              <span data-i18n="testRun.caseSelect.selectAllCurrentSet">全選目前 Test Case Set</span>
            </label>
            <div class="form-text text-muted" id="selectAllCurrentSetHint"></div>
          </div>
        </div>
        <div class="mb-3 d-none" id="caseSelectSetReadOnlyGroup">
          <label class="form-label">
            <span data-i18n="testRun.sets.selectedSet">Test Case Set</span>
          </label>
          <div class="form-control-plaintext fw-semibold" id="caseSelectSetReadOnlyText"></div>
        </div>

        <div class="mb-3">
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input id="caseSearchInput" class="form-control" data-i18n-placeholder="testRun.caseSelect.searchPlaceholder" placeholder="搜尋測試案例...">
          </div>
        </div>
        </div>

        <div id="caseListContainer" class="case-select-list-container">
          <div class="text-center text-muted py-4">
            <div class="spinner-border spinner-border-sm" role="status">
              <span class="visually-hidden" data-i18n="common.loading">載入中...</span>
            </div>
          </div>
        </div>

        <div class="mt-2 pt-2 border-top case-select-summary">
          <small class="text-muted d-block" id="caseSelectInfo"></small>
          <small class="text-muted" id="caseSelectionSummary">已選 0 個測試案例</small>
        </div>
      </div>
      <div class="modal-footer">
        <div class="me-auto text-muted small"><span id="selectedCount">0</span></div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
        <button type="button" class="btn btn-primary" id="confirmCreateItemsBtn"><i class="fas fa-check me-1"></i><span data-i18n="common.create">建立</span></button>
      </div>
    </div>
  </div>
</div>

<!-- Test Run 配置詳情 Modal -->
<div class="modal fade" id="configDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog me-2"></i>
                    <span id="configDetailTitle" data-i18n="testRun.configDetails">Test Run 配置詳情</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="configDetailContent">
                <!-- Configuration details will be dynamically loaded by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.close">關閉</button>
                <button type="button" class="btn btn-warning" id="editConfigBtn">
                    <i class="fas fa-edit me-2"></i><span data-i18n="common.edit">編輯</span>
                </button>
                <button type="button" class="btn btn-danger" id="deleteConfigBtn">
                    <i class="fas fa-trash me-2"></i><span data-i18n="common.delete">刪除</span>
                </button>
            </div>
</div>
</div>
</div>

<!-- Test Run Set 建立/編輯 Modal -->
<div class="modal fade" id="testRunSetFormModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testRunSetFormTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="testRunSetForm">
                    <input type="hidden" id="testRunSetId" name="id">
                    <div class="mb-3">
                        <label for="testRunSetName" class="form-label">
                            <span data-i18n="testRun.sets.form.name">Test Run Set 名稱</span>
                            <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="testRunSetName" name="name" maxlength="120" required>
                        <div class="form-text text-muted" data-i18n="testRun.sets.form.nameHint">請輸入易辨識的組合名稱，建議 120 字以內</div>
                    </div>
                    <div class="mb-3">
                        <label for="testRunSetDescription" class="form-label" data-i18n="testRun.sets.form.description">描述</label>
                        <textarea class="form-control" id="testRunSetDescription" name="description" rows="3"></textarea>
                        <div class="form-text text-muted" data-i18n="testRun.sets.form.descriptionHint">可補充使用情境、測試目標或通知需求</div>
                    </div>

                    <div class="mb-3">
                        <label for="setTpTicketsInput" class="form-label">
                            <span data-i18n="testRun.sets.form.relatedTpTickets">相關 JIRA Tickets</span>
                            <span class="badge bg-secondary ms-2" data-i18n="common.optional">選填</span>
                        </label>
                        <input type="text" class="form-control" id="setTpTicketsInput" placeholder="TP-12345" autocomplete="off">
                        <div class="form-text text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            <span data-i18n="testRun.sets.form.relatedTpTicketsHint">按 Enter 鍵新增票號，格式 TP-123456</span>
                        </div>
                    </div>

                    <div class="mb-3" id="setTpTicketsDisplay" style="display: none;">
                        <label class="form-label">
                            <span data-i18n="testRun.sets.form.relatedTpTicketsSelected">已選 TP 票號</span>
                            <span class="badge bg-primary ms-2" id="setTpTicketsCount">0</span>
                        </label>
                        <div id="setTpTicketTags" class="d-flex flex-wrap gap-2"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="saveTestRunSetBtn">
                    <i class="fas fa-save me-2"></i><span data-i18n="common.save">儲存</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Run Set 詳情 Modal -->
<div class="modal fade" id="testRunSetDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title d-flex align-items-center gap-2">
                    <i class="fas fa-layer-group text-primary"></i>
                    <span id="testRunSetDetailTitle"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 上方：Test Run Set 資訊 -->
                <div class="mb-4" id="testRunSetDetailInfoSection">
                    <div class="mb-3" id="testRunSetDetailDescription"></div>

                    <div class="row gx-3 gy-2 align-items-start">
                        <div class="col-auto">
                            <span id="testRunSetDetailStatus"></span>
                        </div>
                        <div class="col-auto">
                            <small class="text-muted" id="testRunSetDetailMeta"></small>
                        </div>
                    </div>

                    <div class="mt-3" id="setDetailTpSection" style="display: none;">
                        <div class="text-muted small mb-2" data-i18n="testRun.sets.detail.relatedTpTickets">相關 JIRA Tickets</div>
                        <div id="setDetailTpTags" class="d-flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <!-- 按鈕區域 -->
                <div class="mb-4" id="testRunSetDetailActionsSection">
                    <div id="testRunSetDetailActions" class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-primary btn-sm" id="setDetailCreateConfigBtn">
                            <i class="fas fa-plus me-1"></i><span data-i18n="testRun.sets.detail.createTestRun">新增 Test Run</span>
                        </button>
                        <button type="button" class="btn btn-primary btn-sm" id="setDetailAddExistingBtn">
                            <i class="fas fa-link me-1"></i><span data-i18n="testRun.sets.detail.addExisting">加入既有 Test Run</span>
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" id="setDetailEditBtn">
                            <i class="fas fa-edit me-1"></i><span data-i18n="common.edit">編輯</span>
                        </button>
                        <button type="button" class="btn btn-warning btn-sm" id="setDetailArchiveBtn">
                            <i class="fas fa-archive me-1"></i><span data-i18n="testRun.sets.detail.archive">Archive</span>
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="setDetailReportBtn">
                            <i class="fas fa-chart-pie me-1"></i><span data-i18n="testRun.sets.detail.report">Report</span>
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" id="setDetailDeleteBtn">
                            <i class="fas fa-trash me-1"></i><span data-i18n="common.delete">刪除</span>
                        </button>
                    </div>
                </div>

                <!-- 下方：Test Run 列表 -->
                <div class="mt-4" id="testRunSetRunsContainer"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.close">關閉</button>
            </div>
        </div>
    </div>
</div>

<!-- Test Run Set Report Modal -->
<div class="modal fade" id="testRunSetReportModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" style="max-width: 1400px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title d-flex align-items-center gap-2">
                    <i class="fas fa-chart-pie text-primary"></i>
                    <span id="setReportTitle"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3 d-flex flex-wrap gap-3 align-items-center">
                    <span id="setReportStatusBadge"></span>
                    <span class="text-muted small" id="setReportMeta"></span>
                </div>
                <div class="mb-3" id="setReportDescription"></div>

                <div class="card mb-3">
                    <div class="card-body p-3">
                        <div class="row g-3" id="setReportStatGrid"></div>
                    </div>
                </div>

                <div class="mb-2 d-flex flex-wrap align-items-center gap-2" id="setReportHtmlRow">
                    <span class="fw-semibold" data-i18n="testRun.sets.detail.reportLink">HTML Report</span>
                    <span class="text-muted small" id="setReportHtmlStatus"></span>
                    <a class="btn btn-outline-secondary btn-sm d-none" target="_blank" rel="noopener noreferrer" id="setReportOpenHtmlBtn">
                        <i class="fas fa-external-link-alt me-1"></i><span data-i18n="testRun.sets.detail.openReport">開啟報告</span>
                    </a>
                </div>

                <div class="table-responsive border rounded">
                    <table class="table table-sm align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Test Run</th>
                                <th>狀態</th>
                                <th class="text-center">執行率</th>
                                <th class="text-center">Pass Rate</th>
                                <th class="text-center">總案例</th>
                                <th class="text-center">已執行</th>
                                <th class="text-center">通過</th>
                                <th>環境</th>
                                <th>版本</th>
                            </tr>
                        </thead>
                        <tbody id="setReportRunsBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" id="setReportGenerateHtmlBtn">
                    <i class="fas fa-file-alt me-1" id="setReportGenerateIcon"></i>
                    <span id="setReportGenerateText" data-i18n="testRun.generateHtmlButton">生成並複製連結</span>
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.close">關閉</button>
            </div>
        </div>
    </div>
</div>

<!-- 加入既有 Test Run 到 Set Modal -->
<div class="modal fade" id="addExistingToSetModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title d-flex align-items-center gap-2">
                    <i class="fas fa-link text-primary"></i>
                    <span data-i18n="testRun.sets.addExisting.title">加入既有 Test Run</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label" data-i18n="testRun.sets.addExisting.hint">選擇要加入 Test Run Set 的測試執行</label>
                    <div id="addExistingToSetList" class="list-group"></div>
                    <div id="addExistingToSetEmpty" class="text-muted py-3" style="display: none;" data-i18n="testRun.sets.addExisting.empty">目前沒有可加入的 Test Run</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="confirmAddExistingToSetBtn">
                    <i class="fas fa-check me-2"></i><span data-i18n="common.confirm">確認</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Run Delete Confirmation Dialog - Temporarily commented to fix loading issues -->
<!--
<div class="modal fade" id="deleteTestRunModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-triangle text-warning me-2"></i>
          <span data-i18n="common.confirm">確認刪除</span>
        </h5>
      </div>
      <div class="modal-body">
        <p id="deleteConfirmMessage" class="mb-3"></p>
        <div class="alert alert-warning mb-0">
          <i class="fas fa-info-circle me-2"></i>
          <span data-i18n="form.deleteWarning">此操作無法復原，請仔細確認</span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <span data-i18n="common.cancel">取消</span>
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteTestRun">
          <i class="fas fa-trash me-2"></i>
          <span data-i18n="common.delete">刪除</span>
        </button>
      </div>
    </div>
  </div>
</div>
-->
<!-- Test Run Delete Confirmation Dialog -->
<div class="modal fade" id="deleteConfigModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title d-flex align-items-center">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <span data-i18n="common.confirm">確認刪除</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="deleteConfirmMessage" class="mb-3"></p>
        <div class="alert alert-danger mb-0">
          <i class="fas fa-exclamation-circle me-2"></i>
          <span data-i18n="form.deleteWarning">此操作無法復原，請仔細確認</span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <span data-i18n="common.cancel">取消</span>
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteConfigBtn">
          <i class="fas fa-trash me-2"></i>
          <span data-i18n="common.delete">刪除</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Test Run Set Delete Confirmation Dialog -->
<div class="modal fade" id="deleteTestRunSetModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title d-flex align-items-center">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <span data-i18n="common.confirm">確認刪除</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger mb-0">
          <i class="fas fa-exclamation-circle me-2"></i>
          <span data-i18n="testRun.sets.deleteWarningPart1">確定要刪除此 Test Run Set 嗎？</span><br>
          <span data-i18n="testRun.sets.deleteWarningPart2">此操作將刪除其下所有 Test Run，且無法復原。</span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <span data-i18n="common.cancel">取消</span>
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteTestRunSetBtn">
          <i class="fas fa-trash me-2"></i>
          <span data-i18n="common.delete">刪除</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 自訂狀態下拉選單 - Fixed positioning -->
<div class="custom-status-dropdown-overlay" id="statusDropdownOverlay" onclick="hideCustomStatusDropdown()"></div>
<div class="custom-status-dropdown" id="customStatusDropdown">
    <!-- 選項將由 JavaScript 動態生成 -->
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/adhoc_run_manager.js"></script>
<script src="/static/js/test-run-management/core.js"></script>
<script src="/static/js/test-run-management/data.js"></script>
<script src="/static/js/test-run-management/render.js"></script>
<script src="/static/js/test-run-management/status.js"></script>
<script src="/static/js/test-run-management/config-modal.js"></script>
<script src="/static/js/test-run-management/set-modal.js"></script>
<script src="/static/js/test-run-management/details.js"></script>
<script src="/static/js/test-run-management/case-select.js"></script>
<script src="/static/js/test-run-management/tickets.js"></script>
<script src="/static/js/test-run-management/tooltips.js"></script>
<script src="/static/js/test-run-management/validation.js"></script>
<script src="/static/js/test-run-management/quick-search.js"></script>
<script src="/static/js/test-run-management/notifications.js"></script>
<script src="/static/js/test-run-management/init.js"></script>
{% endblock %}

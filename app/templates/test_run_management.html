{% extends "base.html" %}

{% block title %}{{ i18n.t('testRun.management') if i18n else '測試執行管理' }} - Test Case Repository Web Tool{% endblock %}

{% block head %}
<!-- Test Run 入口頁面樣式 -->
<style>
/* Test Run 卡片樣式 - 增強狀態視覺標示 */
.test-run-card {
    transition: all 0.3s ease;
    border: 1px solid var(--tr-border-light);
    cursor: pointer;
    position: relative;
    border-left-width: 4px;
}

/* 狀態顏色左邊框標示 */
.test-run-card.status-draft {
    border-left-color: #F57C00;
    background: linear-gradient(135deg, #FFFEF7 0%, #FFF9E1 100%);
}

.test-run-card.status-active {
    border-left-color: #1976D2;
    background: linear-gradient(135deg, #F8FBFF 0%, #E3F2FD 100%);
    animation: card-glow-active 3s infinite;
}

.test-run-card.status-completed {
    border-left-color: #388E3C;
    background: linear-gradient(135deg, #F9FDF9 0%, #E8F5E8 100%);
}

.test-run-card.status-archived {
    border-left-color: #757575;
    background: linear-gradient(135deg, #FAFAFA 0%, #F5F5F5 100%);
    opacity: 0.85;
}

/* 狀態光暈動畫 - Active 狀態 */
@keyframes card-glow-active {
    0%, 100% { box-shadow: 0 2px 8px rgba(25,118,210,0.1); }
    50% { box-shadow: 0 4px 16px rgba(25,118,210,0.2); }
}

.test-run-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.test-run-card.status-active:hover {
    box-shadow: 0 8px 25px rgba(25,118,210,0.3);
}

.test-run-card.status-completed:hover {
    box-shadow: 0 8px 25px rgba(56,142,60,0.2);
}

.test-run-card.status-draft:hover {
    box-shadow: 0 8px 25px rgba(245,124,0,0.2);
}

.test-run-card:hover .card-title {
    color: var(--tr-primary-dark) !important;
}

.test-run-card .card-body {
    padding: 1.25rem;
}

/* Prevent card title overflow */
.test-run-card .card-title {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    word-break: break-word;
}

/* Ensure flex items with long content don't overflow */
.min-width-0 {
    min-width: 0;
}

/* 狀態指示角標 */
.test-run-card::before {
    content: '';
    position: absolute;
    top: -1px;
    right: -1px;
    width: 0;
    height: 0;
    border-style: solid;
    border-width: 0 12px 12px 0;
    opacity: 0.7;
}

.test-run-card.status-draft::before { border-color: transparent #F57C00 transparent transparent; }
.test-run-card.status-active::before { border-color: transparent #1976D2 transparent transparent; }
.test-run-card.status-completed::before { border-color: transparent #388E3C transparent transparent; }
.test-run-card.status-archived::before { border-color: transparent #757575 transparent transparent; }

/* 新增 Test Run 卡片樣式 */
.add-test-run-card {
    transition: all 0.2s ease;
    border: 2px dashed var(--tr-border-light);
    cursor: pointer;
    background-color: var(--tr-bg-light);
}

.add-test-run-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--tr-shadow-md);
    border-color: var(--tr-primary);
    background-color: var(--tr-primary-light);
}

.add-test-run-card:hover h5,
.add-test-run-card:hover h6 {
    color: var(--tr-primary-dark) !important;
}

.add-test-run-card:hover .fas {
    color: var(--tr-primary-dark) !important;
}

/* 進度條樣式 */
.progress {
    height: 8px;
    border-radius: 4px;
}

.progress-bar {
    border-radius: 4px;
}

/* 狀態標籤樣式 - 增強視覺識別 */
.status-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.6rem;
    border-radius: 0.5rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
}

.status-badge:hover {
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    transform: translateY(-1px);
}

/* 狀態顏色系統 - 更直覺的色彩語意 */
.status-badge.status-draft { 
    background: linear-gradient(135deg, #FFF3CD 0%, #FFE69C 100%);
    color: #856404; 
    border: 1px solid #F0C419;
}

.status-badge.status-active { 
    background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
    color: #0D47A1; 
    border: 1px solid #2196F3;
    animation: pulse-active 2s infinite;
}

.status-badge.status-completed { 
    background: linear-gradient(135deg, #E8F5E8 0%, #C8E6C9 100%);
    color: #2E7D32; 
    border: 1px solid #4CAF50;
}

.status-badge.status-archived { 
    background: linear-gradient(135deg, #F5F5F5 0%, #E0E0E0 100%);
    color: #616161; 
    border: 1px solid #9E9E9E;
    opacity: 0.8;
}

/* 狀態脈動動畫 - 強調進行中狀態 */
@keyframes pulse-active {
    0%, 100% { box-shadow: 0 1px 3px rgba(33,150,243,0.2); }
    50% { box-shadow: 0 1px 8px rgba(33,150,243,0.4); }
}

/* 狀態圖示 */
.status-badge::before {
    content: '';
    width: 6px;
    height: 6px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 0.25rem;
}

.status-badge.status-draft::before { background-color: #F57C00; }
.status-badge.status-active::before { background-color: #1976D2; animation: blink-dot 1.5s infinite; }
.status-badge.status-completed::before { background-color: #388E3C; }
.status-badge.status-archived::before { background-color: #757575; }

/* 閃爍點 - 進行中狀態指示器 */
@keyframes blink-dot {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0.3; }
}

#configDetailModal .modal-dialog,
#testRunSetDetailModal .modal-dialog,
#caseSelectModal .modal-dialog {
    max-width: 1200px;
    width: 90%;
}
/* 自訂狀態下拉選單 - 使用 fixed positioning 解決層級問題 */
.custom-status-dropdown {
    position: fixed !important;
    z-index: 999999 !important;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15);
    min-width: 120px;
    padding: 0.5rem 0;
    display: none;
}

.custom-status-dropdown.show {
    display: block !important;
}

.custom-status-dropdown-item {
    display: flex;
    align-items: center;
    width: 100%;
    padding: 0.5rem 1rem;
    clear: both;
    font-weight: 400;
    color: #212529;
    text-align: inherit;
    text-decoration: none;
    white-space: nowrap;
    background-color: transparent;
    border: 0;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
    line-height: 1.5;
}

.custom-status-dropdown-item i {
    width: 16px;
    text-align: center;
    flex-shrink: 0;
}

.custom-status-dropdown-item:hover {
    background-color: #f8f9fa;
    color: #1e2125;
}

.custom-status-dropdown-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 999998;
    display: none;
}

.custom-status-dropdown-overlay.show {
    display: block;
}

/* 統計資訊樣式 */
.stats-item {
    display: flex;
    align-items: center;
    margin-bottom: 0.5rem;
}


.stats-item:last-child {
    margin-bottom: 0;
}

/* TP 標籤間距調整 */
.stats-item .tp-tag {
    margin-left: 0.25rem;
}

/* T028: 快速搜尋結果樣式 - 現代化設計 */
.quick-search-tp-item {
    background-color: var(--tr-bg-card) !important;
    border-radius: 6px !important;
    margin: 4px 0 !important;
    transition: all 0.2s ease-in-out !important;
    box-shadow: var(--tr-shadow-sm) !important;
    font-size: 0.875rem !important;
    border: 1px solid var(--tr-border-light) !important;
    line-height: 1.5 !important;
    overflow: visible !important; /* 允許 focus 外框不被截斷 */
    box-sizing: border-box !important;
}

/* T028: 圖示對齊樣式 */
.quick-search-tp-item .fas {
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    line-height: 1 !important;
    vertical-align: middle !important;
}

/* 統一圖示樣式 */
.quick-search-tp-item i.fas {
    width: 14px !important;
    text-align: center !important;
    font-size: 13px !important;
}

/* 允許結果名稱換行避免被截斷 */
.quick-search-tp-item .result-title {
    white-space: normal !important;
    overflow: visible !important;
    text-overflow: initial !important;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    line-height: 1.35;
    word-break: break-word;
}

.quick-search-tp-item:hover {
    background: linear-gradient(135deg, var(--tr-primary-light) 0%, #f8fbff 100%) !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 3px 12px rgba(74, 144, 226, 0.15) !important;
    border-color: var(--tr-primary) !important;
}

.quick-search-tp-item.quick-search-active {
    background: linear-gradient(135deg, var(--tr-primary-light) 0%, #e8f4fd 100%) !important;
    border: 1px solid var(--tr-primary) !important;
    border-left: 3px solid var(--tr-primary) !important;
    box-shadow: 0 2px 8px rgba(74, 144, 226, 0.2) !important;
    transform: translateX(2px) !important;
}

/* 移除預設按鈕 focus 線條，避免中間出現水平線 */
.quick-search-tp-item:focus,
.quick-search-tp-item:focus-visible {
    outline: none !important;
    box-shadow: var(--tr-shadow-sm) !important;
}

.stats-icon {
    width: 1.25rem;
    text-align: center;
    margin-right: 0.5rem;
    opacity: 0.7;
}

/* JIRA Tickets 標籤容器樣式 */
.stats-item .tcg-tag {
    vertical-align: middle;
}

/* Loading animation */
.loading-skeleton {
    background: linear-gradient(90deg, var(--tr-bg-sidebar) 25%, var(--tr-border-light) 50%, var(--tr-bg-sidebar) 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* TP 票號標籤樣式 */
.tp-ticket-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.375rem 0.75rem;
    background-color: var(--tr-primary-light);
    color: var(--tr-primary-dark);
    border: 1px solid var(--tr-primary);
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s ease;
    cursor: pointer;
}

.tp-ticket-tag:hover {
    background-color: var(--tr-primary);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.tp-ticket-tag .remove-btn {
    margin-left: 0.25rem;
    padding: 0;
    border: none;
    background: none;
    color: inherit;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
}

.tp-ticket-tag .remove-btn:hover {
    opacity: 1;
}

.tp-ticket-tag .remove-btn:focus {
    outline: none;
    opacity: 1;
}

/* 響應式設計 - 小螢幕適配 */
@media (max-width: 768px) {
    .tp-ticket-tag {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    
    #tpTicketTags {
        gap: 0.375rem !important;
    }
}

/* 輸入欄位提示樣式 */
.form-text .fas {
    opacity: 0.6;
}


/* 通知設定區域樣式 */
#notificationGroupsSection {
    transition: all 0.3s ease;
}

#groupSearchResults {
    background-color: #ffffff;
    border-color: #dee2e6;
    transition: all 0.2s ease;
}

#groupSearchResults:empty {
    display: none !important;
}

.group-search-item {
    padding: 0.5rem 0.75rem;
    cursor: pointer;
    border-bottom: 1px solid #f1f3f4;
    transition: background-color 0.2s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.group-search-item:last-child {
    border-bottom: none;
}

.group-search-item:hover {
    background-color: #f8f9fa;
}

.group-search-item .group-icon {
    color: #6c757d;
    width: 16px;
    text-align: center;
}

.group-search-item .group-name {
    font-weight: 500;
    color: #212529;
    flex-grow: 1;
}

.group-search-item .group-id {
    font-size: 0.75rem;
    color: #6c757d;
    font-family: 'Courier New', monospace;
}

/* 已選群組標籤樣式 */
.selected-group-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.375rem 0.75rem;
    background-color: var(--tr-primary-light);
    color: var(--tr-primary-dark);
    border: 1px solid var(--tr-primary);
    border-radius: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s ease;
    cursor: default;
}

.selected-group-tag:hover {
    background-color: var(--tr-primary);
    color: white;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.selected-group-tag .group-remove-btn {
    margin-left: 0.25rem;
    padding: 0;
    border: none;
    background: none;
    color: inherit;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
}

.selected-group-tag .group-remove-btn:hover {
    opacity: 1;
}

.selected-group-tag .group-remove-btn:focus {
    outline: none;
    opacity: 1;
}

/* 群組設定动画 */
.notification-groups-entering {
    opacity: 0;
    transform: translateY(-10px);
}

.notification-groups-entered {
    opacity: 1;
    transform: translateY(0);
}

.notification-groups-exiting {
    opacity: 1;
    transform: translateY(0);
}

.notification-groups-exited {
    opacity: 0;
    transform: translateY(-10px);
}

/* 群組標認欄位呼呼效果 */
.notifications-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.125rem 0.5rem;
    background-color: #e3f2fd;
    color: #1976d2;
    border: 1px solid #bbdefb;
    border-radius: 0.375rem;
    font-size: 0.75rem;
    font-weight: 500;
}

.notifications-indicator .fas {
    animation: bell-ring 2s infinite;
}

@keyframes bell-ring {
    0%, 50%, 100% {
        transform: rotate(0deg);
    }
    10% {
        transform: rotate(10deg);
    }
    20% {
        transform: rotate(-10deg);
    }
    30% {
        transform: rotate(8deg);
    }
    40% {
        transform: rotate(-8deg);
    }
}

.test-run-section-divider {
    border-top: 2px solid var(--tr-border-light);
    margin: 3rem 0;
}

/* Test Run Set Detail Modal 排版改善 */

/* 標題 - 限制最多顯示兩行 */
#testRunSetDetailTitle {
    max-height: 2.8em;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    word-break: break-word;
    line-height: 1.4;
}

/* 確保 modal-header 中的 title 不會被拉長 */
#testRunSetDetailModal .modal-header h5.modal-title {
    flex: 1;
    max-width: calc(100% - 2rem);
    word-break: break-word;
}

/* Test Run Set 信息區域 */
#testRunSetDetailInfoSection {
    padding-bottom: 1rem;
}

#testRunSetDetailInfoSection .row {
    margin-top: 0.75rem;
}

#testRunSetDetailActions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
}

#testRunSetDetailActions .btn {
    white-space: nowrap;
}


.testRunDetailRunActions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.testRunDetailRunActions .btn {
    white-space: nowrap;
    font-size: 0.8rem;
}

.testRunDetailRunActions .dropdown {
    display: flex;
}

/* Test Case 選擇介面 (對齊 setCaseSelectModal 風格) */
.set-case-list {
    font-size: 0.9rem;
}

.section-group {
    margin-bottom: 0.5rem;
}

.section-header {
    cursor: pointer;
    transition: background-color 0.2s;
}

.section-header:hover {
    background-color: #e9ecef !important;
}

.section-content {
    background-color: #f9f9f9;
    transition: all 0.3s ease;
}

.section-content.d-none {
    display: none !important;
}

.case-item {
    transition: background-color 0.2s;
}

.case-item:hover {
    background-color: #f0f8ff;
}

input[type="checkbox"]:indeterminate {
    background-color: #0dcaf0;
    border-color: #0dcaf0;
}

</style>
{% endblock %}

{% block page_title_text %}
<span data-i18n="testRun.management">測試執行管理</span>
{% endblock %}

{% block page_subtitle_text %}
<span data-i18n="testRun.subtitle">管理測試執行記錄，追蹤測試進度和結果</span>
{% endblock %}

{% block page_specific_actions %}
<div class="d-flex flex-column flex-md-row gap-3">
    <!-- 狀態過濾按鈕群組 -->
    <div class="btn-group" role="group" aria-label="Status filter buttons">
        <input type="radio" class="btn-check" name="statusFilter" id="filterAll" value="all" checked>
        <label class="btn btn-secondary" for="filterAll">
            <i class="fas fa-list me-1"></i><span data-i18n="testRun.filter.all">全部</span>
        </label>

        <input type="radio" class="btn-check" name="statusFilter" id="filterDraft" value="draft">
        <label class="btn btn-warning" for="filterDraft">
            <i class="fas fa-edit me-1"></i><span data-i18n="testRun.filter.draft">草稿</span>
        </label>

        <input type="radio" class="btn-check" name="statusFilter" id="filterActive" value="active">
        <label class="btn btn-primary" for="filterActive">
            <i class="fas fa-play me-1"></i><span data-i18n="testRun.filter.active">進行中</span>
        </label>

        <input type="radio" class="btn-check" name="statusFilter" id="filterCompleted" value="completed">
        <label class="btn btn-success" for="filterCompleted">
            <i class="fas fa-check me-1"></i><span data-i18n="testRun.filter.completed">已完成</span>
        </label>

        <input type="radio" class="btn-check" name="statusFilter" id="filterArchived" value="archived">
        <label class="btn btn-secondary" for="filterArchived">
            <i class="fas fa-archive me-1"></i><span data-i18n="testRun.filter.archived">已歸檔</span>
        </label>
    </div>

    <!-- 其他操作按鈕 -->
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-secondary" id="refreshBtn">
            <i class="fas fa-sync-alt me-2"></i><span data-i18n="common.refresh">重新整理</span>
        </button>
        <a href="/" class="btn btn-secondary">
            <i class="fas fa-home me-2"></i><span data-i18n="navigation.backToHome">回到首頁</span>
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">

    <!-- Loading state -->
    <div id="loading-state" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden" data-i18n="common.loading">載入中...</span>
        </div>
        <div class="mt-3 text-muted" data-i18n="testRun.loadingConfigs">載入測試執行配置中...</div>
    </div>

    <!-- 無配置時的提示區域 -->
    <div id="no-configs-section" style="display: none;">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-4">
                <div class="card text-center add-test-run-card" onclick="openConfigFormModal()">
                    <div class="card-body py-5">
                        <div class="text-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                             style="width: 64px; height: 64px; font-size: 24px; border: 2px dashed var(--tr-primary);">
                            <i class="fas fa-plus"></i>
                        </div>
                        <h5 class="text-primary mb-2" data-i18n="testRun.createFirstConfig">建立第一個測試執行</h5>
                        <p class="text-muted small mb-0" data-i18n="testRun.createFirstConfigHint">
                            設定 Lark 資料表開始測試執行
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Run Set 與未歸組區域 -->
    <div id="test-run-configs-section">
        <div id="test-run-sets-section" class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <div>
                    <h4 class="mb-0" data-i18n="testRun.sets.heading">Test Run Set</h4>
                    <small class="text-muted" data-i18n="testRun.sets.subtitle">集中管理多個 Test Run 組合</small>
                </div>
            </div>
            <div class="row" id="test-run-sets-container"></div>
        </div>

        <div class="test-run-section-divider"></div>

        <div id="adhoc-runs-section" class="mb-5" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <div>
                    <h4 class="mb-0" data-i18n="adhoc.title">Ad-hoc Runs</h4>
                    <small class="text-muted">{{ i18n.t("adhoc.desc") if i18n else "Quick test runs without predefined test cases" }}</small>
                </div>
            </div>
            <div class="row" id="adhoc-runs-container"></div>
            <div class="test-run-section-divider"></div>
        </div>

        <div id="unassigned-test-runs-section">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <div>
                    <h4 class="mb-0" data-i18n="testRun.unassigned.heading">未歸組 Test Run</h4>
                    <small class="text-muted" data-i18n="testRun.unassigned.subtitle">尚未加入任何 Test Run Set 的測試執行</small>
                </div>
            </div>
            <div class="row" id="unassigned-test-runs-container"></div>
            <div id="no-unassigned-test-runs" class="text-center text-muted py-4" style="display: none;">
                <i class="fas fa-clipboard-check fa-2x mb-3"></i>
                <div data-i18n="testRun.unassigned.empty">所有 Test Run 皆已加入 Test Run Set</div>
            </div>
        </div>
    </div>
</div>

<!-- Ad-hoc Run 建立 Modal -->
<div class="modal fade" id="adHocRunFormModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="adHocRunFormTitle">Create Ad-hoc Run</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="adHocRunForm">
                    <div class="mb-3">
                        <label for="adHocName" class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="adHocName" required>
                    </div>
                    <div class="mb-3">
                        <label for="adHocDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="adHocDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label for="adHocTestEnvironment" class="form-label">Test Environment <span class="badge bg-secondary ms-2">Optional</span></label>
                          <input type="text" class="form-control" id="adHocTestEnvironment" placeholder="e.g. Staging / UAT">
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label for="adHocBuildNumber" class="form-label">Build Number <span class="badge bg-secondary ms-2">Optional</span></label>
                          <input type="text" class="form-control" id="adHocBuildNumber" placeholder="e.g. v1.2.3">
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label for="adHocRelatedTpTickets" class="form-label">Related JIRA Tickets <span class="badge bg-secondary ms-2">Optional</span></label>
                          <input type="text" class="form-control" id="adHocRelatedTpTicketsInput" 
                                 placeholder="Enter JIRA ticket (e.g. TP-12345)"
                                 autocomplete="off">
                          <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            <span>Press Enter to add ticket</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- TP Tickets Display Area -->
                    <div class="mb-3" id="adHocTpTicketsDisplay" style="display: none;">
                        <label class="form-label">Selected Tickets:</label>
                        <div id="adHocTpTicketTags" class="d-flex flex-wrap gap-2"></div>
                    </div>
                    
                    <!-- Legacy JIRA Ticket (Hidden or Removed? Keeping hidden for backward compat if needed, but logic should use tags) -->
                    <input type="hidden" id="adHocJira"> 
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAdHocRunBtn">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Test Run Configuration Modal -->
<div class="modal fade" id="configFormModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="configFormModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="testRunConfigForm">
                    <input type="hidden" id="configId" name="id">
                    <input type="hidden" id="configSetId" name="set_id">
                    <input type="hidden" id="configTestCaseSetId" name="test_case_set_id">
                    <div class="mb-3">
                        <label for="testCaseSetSelector" class="form-label">
                            <span data-i18n="testRun.sets.selectSet">選擇 Test Case Set</span>
                            <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="testCaseSetSelector" required>
                            <!-- options 由 JS 動態載入 -->
                        </select>
                        <div class="form-text text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            <span data-i18n="testRun.sets.selectSetHint">請先選擇 Test Case Set，僅允許同一 Set 的案例</span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="configName" class="form-label">
                            <span data-i18n="testRun.configName">Test Run 名稱</span> 
                            <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="configName" name="name" required 
                               data-i18n-placeholder="testRun.configNamePlaceholder"
                               placeholder="輸入 Test Run 名稱">
                    </div>
                    
                    
                    <div class="mb-3">
                        <label for="configDescription" class="form-label" data-i18n="common.description">描述</label>
                        <textarea class="form-control" id="configDescription" name="description" rows="3" 
                                data-i18n-placeholder="testRun.descriptionPlaceholder"></textarea>

                    </div>

                    <div class="row">
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label for="testEnvironment" class="form-label"><span data-i18n="testRun.testEnvironment">測試環境</span> <span class="badge bg-secondary ms-2" data-i18n="common.optional">選填</span></label>
                          <input type="text" class="form-control" id="testEnvironment" name="test_environment" data-i18n-placeholder="testRun.testEnvironmentPlaceholder" placeholder="例如：Staging / UAT / Prod Sandbox">
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label for="buildNumber" class="form-label"><span data-i18n="testRun.buildNumber">建置版本</span> <span class="badge bg-secondary ms-2" data-i18n="common.optional">選填</span></label>
                          <input type="text" class="form-control" id="buildNumber" name="build_number" data-i18n-placeholder="testRun.buildNumberPlaceholder" placeholder="例如：v1.2.3 / build #4567">
                        </div>
                      </div>
                      <div class="col-md-4">
                        <div class="mb-3">
                          <label for="relatedTpTickets" class="form-label">
                            <span data-i18n="testRun.relatedTpTickets">相關 JIRA Tickets</span> 
                            <span class="badge bg-secondary ms-2" data-i18n="common.optional">選填</span>
                          </label>
                          <input type="text" class="form-control" id="relatedTpTicketsInput" 
                                 data-i18n-placeholder="testRun.relatedTpTicketsPlaceholder" 
                                 placeholder="輸入 TP 票號，例如：TP-12345"
                                 autocomplete="off">
                          <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>
                            <span data-i18n="testRun.tpTicketInputHint">按 Enter 鍵新增票號</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- TP 標籤顯示區域 -->
                    <div class="mb-3" id="tpTicketsDisplay" style="display: none;">
                        <label class="form-label">
                            <span data-i18n="testRun.addedTpTickets">已新增的 TP 開發單</span>
                        </label>
                        <div id="tpTicketTags" class="d-flex flex-wrap gap-2">
                            <!-- TP 票號標籤將在這裡動態生成 -->
                        </div>
                    </div>

                    <!-- 通知設定區域 -->
                    <div class="mb-3">
                        <h6 class="mb-3">
                            <i class="fas fa-bell me-2"></i>
                            <span data-i18n="testRun.notifications.title">通知設定</span>
                            <span class="badge bg-secondary ms-2" data-i18n="common.optional">選填</span>
                        </h6>
                        <div class="form-check mb-3">
                            <input type="checkbox" class="form-check-input" id="notificationsEnabled" name="notifications_enabled">
                            <label class="form-check-label" for="notificationsEnabled">
                                <span data-i18n="testRun.notifications.enable">啟用 Lark 群組通知</span>
                            </label>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                <span data-i18n="testRun.notifications.enableHint">在測試執行狀態變更時發送通知到選定的 Lark 群組</span>
                            </div>
                        </div>
                        
                        <!-- 群組選擇區域，預設隱藏 -->
                        <div id="notificationGroupsSection" style="display: none;">
                            <label for="notifyGroupsSelect" class="form-label">
                                <span data-i18n="testRun.notifications.selectGroups">選擇通知群組</span>
                            </label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="notifyGroupsInput" 
                                       data-i18n-placeholder="testRun.notifications.searchPlaceholder" 
                                       placeholder="搜尋群組名稱..." 
                                       autocomplete="off">
                                <button class="btn btn-secondary" type="button" id="searchGroupsBtn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div id="groupSearchResults" class="border rounded p-2" style="max-height: 200px; overflow-y: auto; display: none;">
                                <!-- 群組搜尋結果將在這裡顯示 -->
                            </div>
                            <div class="form-text mb-3">
                                <i class="fas fa-info-circle me-1"></i>
                                <span data-i18n="testRun.notifications.selectHint">輸入群組名稱關鍵字搜尋並選擇通知群組，最多可選 100 個</span>
                            </div>
                            
                            <!-- 已選群組顯示區域 -->
                            <div id="selectedGroupsDisplay" class="mb-3" style="display: none;">
                                <label class="form-label">
                                    <span data-i18n="testRun.notifications.selectedGroups">已選群組</span>
                                    <span class="badge bg-primary ms-2" id="selectedGroupsCount">0</span>
                                </label>
                                <div id="selectedGroupsTags" class="d-flex flex-wrap gap-2">
                                    <!-- 已選群組標籤將在這裡動態生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="saveConfigBtn">
                    <i class="fas fa-save me-2"></i><span id="saveConfigBtnText"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Case 選擇 Modal -->
<div class="modal fade" id="caseSelectModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-tasks me-2"></i><span data-i18n="testRun.caseSelect.title">選擇要加入的 Test Case</span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="caseSelectTestCaseSet" class="form-label">
            <span data-i18n="testRun.sets.selectSet">選擇 Test Case Set</span>
            <span class="text-danger">*</span>
          </label>
          <select class="form-select" id="caseSelectTestCaseSet"></select>
          <div class="form-text text-muted">
            <i class="fas fa-info-circle me-1"></i>
            <span data-i18n="testRun.sets.selectSetHint">僅可從同一個 Test Case Set 選取案例</span>
          </div>
        </div>

        <div class="mb-3">
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input id="caseSearchInput" class="form-control" data-i18n-placeholder="testRun.caseSelect.searchPlaceholder" placeholder="搜尋測試案例...">
          </div>
        </div>

        <div id="caseListContainer" style="max-height: 60vh; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 0.5rem;">
          <div class="text-center text-muted py-4">
            <div class="spinner-border spinner-border-sm" role="status">
              <span class="visually-hidden" data-i18n="common.loading">載入中...</span>
            </div>
          </div>
        </div>

        <div class="mt-2 pt-2 border-top">
          <small class="text-muted d-block" id="caseSelectInfo"></small>
          <small class="text-muted" id="caseSelectionSummary">已選 0 個測試案例</small>
        </div>
      </div>
      <div class="modal-footer">
        <div class="me-auto text-muted small"><span id="selectedCount">0</span></div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
        <button type="button" class="btn btn-primary" id="confirmCreateItemsBtn"><i class="fas fa-check me-1"></i><span data-i18n="common.create">建立</span></button>
      </div>
    </div>
  </div>
</div>

<!-- Test Run 配置詳情 Modal -->
<div class="modal fade" id="configDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog me-2"></i>
                    <span id="configDetailTitle" data-i18n="testRun.configDetails">Test Run 配置詳情</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="configDetailContent">
                <!-- Configuration details will be dynamically loaded by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.close">關閉</button>
                <button type="button" class="btn btn-warning" id="editConfigBtn">
                    <i class="fas fa-edit me-2"></i><span data-i18n="common.edit">編輯</span>
                </button>
                <button type="button" class="btn btn-danger" id="deleteConfigBtn">
                    <i class="fas fa-trash me-2"></i><span data-i18n="common.delete">刪除</span>
                </button>
            </div>
</div>
</div>
</div>

<!-- Test Run Set 建立/編輯 Modal -->
<div class="modal fade" id="testRunSetFormModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testRunSetFormTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="testRunSetForm">
                    <input type="hidden" id="testRunSetId" name="id">
                    <div class="mb-3">
                        <label for="testRunSetName" class="form-label">
                            <span data-i18n="testRun.sets.form.name">Test Run Set 名稱</span>
                            <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="testRunSetName" name="name" maxlength="120" required>
                        <div class="form-text text-muted" data-i18n="testRun.sets.form.nameHint">請輸入易辨識的組合名稱，建議 120 字以內</div>
                    </div>
                    <div class="mb-3">
                        <label for="testRunSetDescription" class="form-label" data-i18n="testRun.sets.form.description">描述</label>
                        <textarea class="form-control" id="testRunSetDescription" name="description" rows="3"></textarea>
                        <div class="form-text text-muted" data-i18n="testRun.sets.form.descriptionHint">可補充使用情境、測試目標或通知需求</div>
                    </div>

                    <div class="mb-3">
                        <label for="setTpTicketsInput" class="form-label">
                            <span data-i18n="testRun.sets.form.relatedTpTickets">相關 JIRA Tickets</span>
                            <span class="badge bg-secondary ms-2" data-i18n="common.optional">選填</span>
                        </label>
                        <input type="text" class="form-control" id="setTpTicketsInput" placeholder="TP-12345" autocomplete="off">
                        <div class="form-text text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            <span data-i18n="testRun.sets.form.relatedTpTicketsHint">按 Enter 鍵新增票號，格式 TP-123456</span>
                        </div>
                    </div>

                    <div class="mb-3" id="setTpTicketsDisplay" style="display: none;">
                        <label class="form-label">
                            <span data-i18n="testRun.sets.form.relatedTpTicketsSelected">已選 TP 票號</span>
                            <span class="badge bg-primary ms-2" id="setTpTicketsCount">0</span>
                        </label>
                        <div id="setTpTicketTags" class="d-flex flex-wrap gap-2"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="saveTestRunSetBtn">
                    <i class="fas fa-save me-2"></i><span data-i18n="common.save">儲存</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Run Set 詳情 Modal -->
<div class="modal fade" id="testRunSetDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title d-flex align-items-center gap-2">
                    <i class="fas fa-layer-group text-primary"></i>
                    <span id="testRunSetDetailTitle"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 上方：Test Run Set 資訊 -->
                <div class="mb-4" id="testRunSetDetailInfoSection">
                    <div class="mb-3" id="testRunSetDetailDescription"></div>

                    <div class="row gx-3 gy-2 align-items-start">
                        <div class="col-auto">
                            <span id="testRunSetDetailStatus"></span>
                        </div>
                        <div class="col-auto">
                            <small class="text-muted" id="testRunSetDetailMeta"></small>
                        </div>
                    </div>

                    <div class="mt-3" id="setDetailTpSection" style="display: none;">
                        <div class="text-muted small mb-2" data-i18n="testRun.sets.detail.relatedTpTickets">相關 JIRA Tickets</div>
                        <div id="setDetailTpTags" class="d-flex flex-wrap gap-2"></div>
                    </div>
                </div>

                <!-- 按鈕區域 -->
                <div class="mb-4" id="testRunSetDetailActionsSection">
                    <div id="testRunSetDetailActions" class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-primary btn-sm" id="setDetailCreateConfigBtn">
                            <i class="fas fa-plus me-1"></i><span data-i18n="testRun.sets.detail.createTestRun">新增 Test Run</span>
                        </button>
                        <button type="button" class="btn btn-primary btn-sm" id="setDetailAddExistingBtn">
                            <i class="fas fa-link me-1"></i><span data-i18n="testRun.sets.detail.addExisting">加入既有 Test Run</span>
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" id="setDetailEditBtn">
                            <i class="fas fa-edit me-1"></i><span data-i18n="common.edit">編輯</span>
                        </button>
                        <button type="button" class="btn btn-warning btn-sm" id="setDetailArchiveBtn">
                            <i class="fas fa-archive me-1"></i><span data-i18n="testRun.sets.detail.archive">Archive</span>
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="setDetailReportBtn">
                            <i class="fas fa-chart-pie me-1"></i><span data-i18n="testRun.sets.detail.report">Report</span>
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" id="setDetailDeleteBtn">
                            <i class="fas fa-trash me-1"></i><span data-i18n="common.delete">刪除</span>
                        </button>
                    </div>
                </div>

                <!-- 下方：Test Run 列表 -->
                <div class="mt-4" id="testRunSetRunsContainer"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.close">關閉</button>
            </div>
        </div>
    </div>
</div>

<!-- Test Run Set Report Modal -->
<div class="modal fade" id="testRunSetReportModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" style="max-width: 1400px;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title d-flex align-items-center gap-2">
                    <i class="fas fa-chart-pie text-primary"></i>
                    <span id="setReportTitle"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3 d-flex flex-wrap gap-3 align-items-center">
                    <span id="setReportStatusBadge"></span>
                    <span class="text-muted small" id="setReportMeta"></span>
                </div>
                <div class="mb-3" id="setReportDescription"></div>

                <div class="card mb-3">
                    <div class="card-body p-3">
                        <div class="row g-3" id="setReportStatGrid"></div>
                    </div>
                </div>

                <div class="mb-2 d-flex flex-wrap align-items-center gap-2" id="setReportHtmlRow">
                    <span class="fw-semibold" data-i18n="testRun.sets.detail.reportLink">HTML Report</span>
                    <span class="text-muted small" id="setReportHtmlStatus"></span>
                    <a class="btn btn-outline-secondary btn-sm d-none" target="_blank" rel="noopener noreferrer" id="setReportOpenHtmlBtn">
                        <i class="fas fa-external-link-alt me-1"></i><span data-i18n="testRun.sets.detail.openReport">開啟報告</span>
                    </a>
                </div>

                <div class="table-responsive border rounded">
                    <table class="table table-sm align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Test Run</th>
                                <th>狀態</th>
                                <th class="text-center">執行率</th>
                                <th class="text-center">Pass Rate</th>
                                <th class="text-center">總案例</th>
                                <th class="text-center">已執行</th>
                                <th class="text-center">通過</th>
                                <th>環境</th>
                                <th>版本</th>
                            </tr>
                        </thead>
                        <tbody id="setReportRunsBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" id="setReportGenerateHtmlBtn">
                    <i class="fas fa-file-alt me-1" id="setReportGenerateIcon"></i>
                    <span id="setReportGenerateText" data-i18n="testRun.generateHtmlButton">生成並複製連結</span>
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.close">關閉</button>
            </div>
        </div>
    </div>
</div>

<!-- 加入既有 Test Run 到 Set Modal -->
<div class="modal fade" id="addExistingToSetModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title d-flex align-items-center gap-2">
                    <i class="fas fa-link text-primary"></i>
                    <span data-i18n="testRun.sets.addExisting.title">加入既有 Test Run</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label" data-i18n="testRun.sets.addExisting.hint">選擇要加入 Test Run Set 的測試執行</label>
                    <div id="addExistingToSetList" class="list-group"></div>
                    <div id="addExistingToSetEmpty" class="text-muted py-3" style="display: none;" data-i18n="testRun.sets.addExisting.empty">目前沒有可加入的 Test Run</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="confirmAddExistingToSetBtn">
                    <i class="fas fa-check me-2"></i><span data-i18n="common.confirm">確認</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Run Delete Confirmation Dialog - Temporarily commented to fix loading issues -->
<!--
<div class="modal fade" id="deleteTestRunModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-triangle text-warning me-2"></i>
          <span data-i18n="common.confirm">確認刪除</span>
        </h5>
      </div>
      <div class="modal-body">
        <p id="deleteConfirmMessage" class="mb-3"></p>
        <div class="alert alert-warning mb-0">
          <i class="fas fa-info-circle me-2"></i>
          <span data-i18n="form.deleteWarning">此操作無法復原，請仔細確認</span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <span data-i18n="common.cancel">取消</span>
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteTestRun">
          <i class="fas fa-trash me-2"></i>
          <span data-i18n="common.delete">刪除</span>
        </button>
      </div>
    </div>
  </div>
</div>
-->
<!-- Test Run Delete Confirmation Dialog -->
<div class="modal fade" id="deleteConfigModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title d-flex align-items-center">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <span data-i18n="common.confirm">確認刪除</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="deleteConfirmMessage" class="mb-3"></p>
        <div class="alert alert-danger mb-0">
          <i class="fas fa-exclamation-circle me-2"></i>
          <span data-i18n="form.deleteWarning">此操作無法復原，請仔細確認</span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <span data-i18n="common.cancel">取消</span>
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteConfigBtn">
          <i class="fas fa-trash me-2"></i>
          <span data-i18n="common.delete">刪除</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Test Run Set Delete Confirmation Dialog -->
<div class="modal fade" id="deleteTestRunSetModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title d-flex align-items-center">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <span data-i18n="common.confirm">確認刪除</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger mb-0">
          <i class="fas fa-exclamation-circle me-2"></i>
          <span data-i18n="testRun.sets.deleteWarningPart1">確定要刪除此 Test Run Set 嗎？</span><br>
          <span data-i18n="testRun.sets.deleteWarningPart2">此操作將刪除其下所有 Test Run，且無法復原。</span>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <span data-i18n="common.cancel">取消</span>
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteTestRunSetBtn">
          <i class="fas fa-trash me-2"></i>
          <span data-i18n="common.delete">刪除</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 自訂狀態下拉選單 - Fixed positioning -->
<div class="custom-status-dropdown-overlay" id="statusDropdownOverlay" onclick="hideCustomStatusDropdown()"></div>
<div class="custom-status-dropdown" id="customStatusDropdown">
    <!-- 選項將由 JavaScript 動態生成 -->
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/adhoc_run_manager.js"></script>
<script>
// Test Run 配置管理
let testRunConfigs = [];
let testCaseSets = [];
let testRunSets = [];
let unassignedTestRuns = [];
let currentTeamId = null;
let configDetailModalInstance = null;
let configFormModalInstance = null;
let testRunSetFormModalInstance = null;
let testRunSetDetailModalInstance = null;
let addExistingToSetModalInstance = null;
let currentSetContext = null;
let pendingSetIdForNewConfig = null;
// delete config modal is handled via bootstrap instance on demand

let testRunPermissions = {
    role: 'viewer',
    isViewer: true,
    canCreate: false,
    canUpdate: false,
    canDelete: false,
    canChangeStatus: false,
};

let currentStatusFilter = 'all';
let currentSetTpTickets = [];
let setTpInputInitialized = false;
let reopenSetDetailAfterForm = false;
let suppressSetDetailReopen = false;
let reopenSetDetailAfterCaseModal = false;
let preserveSetContextOnHide = false;

async function applyTestRunManagementPermissions() {
    const defaults = {
        role: 'viewer',
        isViewer: true,
        canCreate: false,
        canUpdate: false,
        canDelete: false,
        canChangeStatus: false,
    };

    if (!window.AuthClient) {
        testRunPermissions = defaults;
        window._testRunPermissions = defaults;
        return defaults;
    }

    let components = {};
    try {
        const resp = await window.AuthClient.fetch('/api/permissions/ui-config?page=test_run_management');
        if (resp && resp.ok) {
            const payload = await resp.json();
            if (payload && payload.components) {
                components = payload.components;
            }
        }
    } catch (error) {
        console.warn('Failed to fetch Test Run UI permissions:', error);
    }

    let role = 'viewer';
    try {
        const info = await window.AuthClient.getUserInfo();
        if (info && info.role) {
            role = String(info.role).toLowerCase();
        }
    } catch (error) {
        console.warn('Failed to resolve user role, fallback to viewer:', error);
    }

    const resolved = {
        role,
        isViewer: role === 'viewer',
        canCreate: !!(components.addConfigCard || components.saveConfigBtn),
        canUpdate: !!(components.editConfigBtn || components.saveConfigBtn),
        canDelete: !!components.deleteConfigBtn,
        canChangeStatus: !!(components.changeStatusBtn || components.editConfigBtn),
    };

    if (!resolved.isViewer) {
        resolved.canCreate = true;
        resolved.canUpdate = true;
        resolved.canDelete = true;
        resolved.canChangeStatus = true;
    }

    testRunPermissions = resolved;
    window._testRunPermissions = resolved;

    setElementVisibility('saveConfigBtn', resolved.canCreate || resolved.canUpdate);
    setElementVisibility('confirmCreateItemsBtn', resolved.canCreate || resolved.canUpdate);
    setElementVisibility('editConfigBtn', resolved.canUpdate);
    setElementVisibility('deleteConfigBtn', resolved.canDelete);

    return resolved;
}

function setElementVisibility(elementId, isVisible) {
    const element = document.getElementById(elementId);
    if (!element) return;

    if (!element.dataset.defaultDisplay || element.dataset.defaultDisplay === 'none') {
        let defaultDisplay = '';
        if (element.classList.contains('d-flex')) {
            defaultDisplay = 'flex';
        } else if (element.classList.contains('btn-group')) {
            defaultDisplay = 'inline-flex';
        } else if (element.tagName === 'BUTTON' || element.classList.contains('btn')) {
            defaultDisplay = 'inline-block';
        } else if (element.tagName === 'INPUT' || element.tagName === 'SELECT' || element.tagName === 'TEXTAREA') {
            defaultDisplay = 'block';
        } else {
            const computed = window.getComputedStyle(element).display;
            if (computed && computed !== 'none') {
                defaultDisplay = computed;
            }
        }
        element.dataset.defaultDisplay = defaultDisplay || '';
    }

    if (isVisible) {
        element.classList.remove('d-none');
        const displayValue = element.dataset.defaultDisplay;
        if (displayValue) {
            element.style.setProperty('display', displayValue, 'important');
        } else {
            element.style.removeProperty('display');
        }
    } else {
        element.classList.add('d-none');
        element.style.setProperty('display', 'none', 'important');
    }
}

function showPermissionDenied() {
    const message = window.i18n && window.i18n.isReady()
        ? window.i18n.t('messages.permissionDenied')
        : 'No permission to perform this action';
    if (window.AppUtils && typeof window.AppUtils.showWarning === 'function') {
        window.AppUtils.showWarning(message);
    } else {
        alert(message);
    }
}

// 頁面狀態旗標，避免競態與重複綁定
let teamIdReady = false;      // 取得有效 teamId 後才為 true
let dataLoadedOnce = false;   // 成功載入過資料後為 true
let eventsBound = false;      // 避免重複綁定 i18n/page 事件

document.addEventListener('DOMContentLoaded', async function() {
    await applyTestRunManagementPermissions();
    if (window.AuthClient && typeof window.AuthClient.on === 'function') {
        window.AuthClient.on('authReady', async () => {
            await applyTestRunManagementPermissions();
            try {
                const activeFilter = document.querySelector('input[name="statusFilter"]:checked');
                const filterValue = activeFilter ? activeFilter.value : 'all';
                currentStatusFilter = filterValue;
                renderTestRunOverview(filterValue);
            } catch (_) {}
        });
    }
    // 監聽全域 team 變更事件，隨時更新 URL 的 team_id
    try {
        window.addEventListener('teamChanged', function(e) {
            const newTeam = e && e.detail && e.detail.team;
            if (newTeam && newTeam.id) {
                ensureTeamIdInUrl_TRM(newTeam.id);
            }
        });
    } catch (_) {}

    initializePage();
    bindEventListeners();

    // 綁定 i18n 事件（僅重翻譯，不觸發資料重載）
    if (!eventsBound) {
        document.addEventListener('i18nReady', onI18nEventOnce);
        document.addEventListener('languageChanged', onI18nEvent);
        // 處理 bfcache 返回
        window.addEventListener('pageshow', onPageShow);
        eventsBound = true;
    }

    // DOM 就緒且 i18n 已就緒時，僅重翻譯
    if (window.i18n && window.i18n.isReady && window.i18n.isReady()) {
        refreshStatusTexts();
    }
});

function onI18nEventOnce() {
    // i18n 初始化完成後，不重打 API，僅更新文案
    refreshStatusTexts();
}

function onI18nEvent() {
    // 語言切換後，不重打 API，僅更新文案
    refreshStatusTexts();
}

function onPageShow(event) {
    // bfcache 或一般顯示時，確認 teamId 狀態
    const latestTeamId = AppUtils.getCurrentTeamId ? AppUtils.getCurrentTeamId() : (AppUtils.getCurrentTeam()?.id ?? null);
    if (latestTeamId && latestTeamId !== currentTeamId) {
        currentTeamId = latestTeamId;
        teamIdReady = true;
        // 只有在尚未載入過資料時才載入，避免返回頁面時不必要的 API 呼叫
        if (!dataLoadedOnce) {
            loadTestRunConfigs();
        } else {
            refreshStatusTexts();
        }
    } else if (!latestTeamId) {
        teamIdReady = false;
        console.warn('pageshow: Skip loading due to missing teamId');
        // 可選：顯示需選擇團隊的提示
    } else {
        // teamId 未變更
        refreshStatusTexts();
    }
}

function initializePage() {
    // 以 AppUtils.getCurrentTeamId 為單一資料源
    currentTeamId = (typeof AppUtils.getCurrentTeamId === 'function')
        ? AppUtils.getCurrentTeamId()
        : (AppUtils.getCurrentTeam()?.id ?? null);

    // 確保網址列包含 team_id（不重新載入頁面）
    try { if (currentTeamId) ensureTeamIdInUrl_TRM(currentTeamId); } catch (_) {}

    if (currentTeamId) {
        teamIdReady = true;
        loadTestRunConfigs();
    } else {
        teamIdReady = false;
        console.warn('initializePage: teamId not ready, skip loading');
        // 不打 API；可選：顯示需先選擇團隊的 UI 狀態
        showNoConfigs();
    }
}

function bindEventListeners() {
    const refreshBtn = document.getElementById('refreshBtn');
    if (refreshBtn) refreshBtn.addEventListener('click', () => {
        if (!teamIdReady) {
            // 嘗試延遲取得 teamId
            const latestTeamId = (typeof AppUtils.getCurrentTeamId === 'function')
                ? AppUtils.getCurrentTeamId()
                : (AppUtils.getCurrentTeam()?.id ?? null);
            if (latestTeamId) {
                currentTeamId = latestTeamId;
                teamIdReady = true;
            }
        }
        if (teamIdReady) {
            loadTestRunConfigs();
        } else {
            console.warn('Refresh skipped: teamId not ready');
            AppUtils.showWarning && AppUtils.showWarning((window.i18n && window.i18n.isReady()) ? window.i18n.t('errors.teamNotSelected') : '請先選擇團隊');
        }
    });
    
    document.addEventListener('click', function(e) {
        const addCard = e.target.closest('.add-test-run-card');
        if (addCard) {
            const perms = window._testRunPermissions || testRunPermissions || {};
            if (!perms.canCreate) {
                showPermissionDenied();
                return;
            }
            const cardType = addCard.dataset.cardType || 'run';
            if (cardType === 'set') {
                openTestRunSetFormModal();
            } else if (cardType === 'adhoc') {
                openAdHocRunModal();
            } else {
                openConfigFormModal();
            }
        }
    });
    
    const saveBtn = document.getElementById('saveConfigBtn');
    if (saveBtn) saveBtn.addEventListener('click', handleSaveConfig);

    const saveSetBtn = document.getElementById('saveTestRunSetBtn');
    if (saveSetBtn) saveSetBtn.addEventListener('click', handleSaveTestRunSet);

    const confirmAddExistingBtn = document.getElementById('confirmAddExistingToSetBtn');
    if (confirmAddExistingBtn) confirmAddExistingBtn.addEventListener('click', confirmAddExistingToSet);

    const setReportGenerateBtn = document.getElementById('setReportGenerateHtmlBtn');
    if (setReportGenerateBtn) setReportGenerateBtn.addEventListener('click', generateTestRunSetHtmlReport);
    
    // 狀態過濾事件監聽器
    document.querySelectorAll('input[name="statusFilter"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                const filterValue = this.value;
                currentStatusFilter = filterValue;
                renderTestRunOverview(filterValue);
            }
        });
    });
}

async function loadTestRunConfigs() {
    try {
        // 防護：若 teamId 尚未就緒，嘗試回填，否則中止
        if (!currentTeamId) {
            const latestTeamId = (typeof AppUtils.getCurrentTeamId === 'function')
                ? AppUtils.getCurrentTeamId()
                : (AppUtils.getCurrentTeam()?.id ?? null);
            if (latestTeamId) {
                currentTeamId = latestTeamId;
                teamIdReady = true;
            }
        }
        if (!currentTeamId) {
            console.warn('loadTestRunConfigs: Skip loading due to missing teamId');
            showNoConfigs();
            return;
        }

        // 預先載入 Test Case Set 列表
        await loadTestCaseSets();

        showLoading();
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-sets/overview?include_archived=true`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const payload = await response.json();
        testRunSets = Array.isArray(payload.sets) ? payload.sets : [];
        unassignedTestRuns = Array.isArray(payload.unassigned) ? payload.unassigned : [];
        
        // Load Ad-hoc Runs
        try {
            const adhocResponse = await window.AuthClient.fetch(`/api/adhoc-runs/team/${currentTeamId}`);
            if (adhocResponse.ok) {
                const adhocRuns = await adhocResponse.json();
                renderAdHocRuns(adhocRuns);
            } else {
                renderAdHocRuns([]);
            }
        } catch (e) {
            console.error('Failed to load adhoc runs', e);
            renderAdHocRuns([]);
        }

        rebuildTestRunConfigIndex();
        dataLoadedOnce = true;
        renderTestRunOverview(currentStatusFilter);
        await refreshCurrentSetDetail();
    } catch (error) {
        console.error('Failed to load Test Run configurations:', error);
        const errorMsg = window.i18n ? window.i18n.t('messages.loadConfigsFailed') : '載入失敗';
        AppUtils.showError(errorMsg + '：' + error.message);
        showNoConfigs();
    } finally {
        hideLoading();
        
        // 檢查是否有從 Test Case Set 預選的 Test Cases
        const preselectedCaseIds = sessionStorage.getItem('testRunSelectedCaseIds');
        const setId = sessionStorage.getItem('testRunSetId');
        if (preselectedCaseIds && setId) {
          // 保存預選信息到 window，稍後在建立配置後使用
          window._preselectedCaseIdsFromSet = preselectedCaseIds;
          window._testCaseSetIdSource = parseInt(setId);
          currentSetIdForCaseSelection = parseInt(setId);
          // 打開 Test Run Set 建立表單（正規流程的第一步）
          openConfigFormModal();
          // 清除 sessionStorage，避免重複使用
          sessionStorage.removeItem('testRunSelectedCaseIds');
          sessionStorage.removeItem('testRunSetId');
        }
    }
}

function rebuildTestRunConfigIndex() {
    const flattened = [];
    (testRunSets || []).forEach(set => {
        (set.test_runs || []).forEach(run => {
            flattened.push({
                ...run,
                set_id: run.set_id ?? set.id,
                set_name: run.set_name ?? set.name,
            });
        });
    });
    (unassignedTestRuns || []).forEach(run => {
        flattened.push({
            ...run,
            set_id: run.set_id ?? null,
            set_name: run.set_name ?? null,
        });
    });
    testRunConfigs = flattened;
}

function filterTestRunsByStatus(runs, filterStatus) {
    if (!runs) return [];
    if (!filterStatus || filterStatus === 'all') return [...runs];
    return runs.filter(item => (item.status || '').toLowerCase() === filterStatus.toLowerCase());
}

function renderTestRunOverview(filterStatus = 'all') {
    const hasSets = Array.isArray(testRunSets) && testRunSets.length > 0;
    const hasUnassigned = Array.isArray(unassignedTestRuns) && unassignedTestRuns.length > 0;

    // 若尚未載入 Test Case Set 選項，嘗試載入
    if (!testCaseSets.length && currentTeamId) {
        loadTestCaseSets().catch(() => {});
    }

    // 即使沒有任何 Test Run，也要顯示新增 Test Run / Test Run Set 卡片
    showConfigsSection();
    renderTestRunSetCards(filterStatus);
    renderUnassignedTestRunCards(filterStatus);
}

function renderTestRunSetCards(filterStatus) {
    const container = document.getElementById('test-run-sets-container');
    const emptyHint = document.getElementById('no-test-run-sets');
    if (!container) return;

    const perms = window._testRunPermissions || testRunPermissions || {};
    const hasSets = Array.isArray(testRunSets) && testRunSets.length > 0;

    // 根據狀態篩選 Test Run Set
    let filteredSets = testRunSets;
    if (hasSets && filterStatus !== 'all') {
        filteredSets = testRunSets.filter(set => {
            const setStatus = set.status || 'active';
            // archived 篩選：只顯示 archived 的 set
            if (filterStatus === 'archived') {
                return setStatus === 'archived';
            }
            // 其他篩選 (draft, active, completed)：只顯示非 archived 的 set
            return setStatus !== 'archived';
        });
    }

    const cards = filteredSets.length > 0 ? filteredSets.map(set => createTestRunSetCard(set, filterStatus)) : [];

    if (perms.canCreate) {
        cards.push(getAddTestRunSetCardHtml());
    }

    container.innerHTML = cards.join('');

    if (emptyHint) emptyHint.style.display = hasSets ? 'none' : 'block';

    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(container);
    }
}

function summarizeSetMetrics(testRuns) {
    let totalCases = 0;
    let executedCases = 0;
    let passedCases = 0;

    (testRuns || []).forEach(run => {
        totalCases += run.total_test_cases || 0;
        executedCases += run.executed_cases || 0;
        passedCases += run.passed_cases || 0;
    });

    const executionRate = totalCases > 0 ? (executedCases / totalCases) * 100 : 0;
    const passRate = executedCases > 0 ? (passedCases / executedCases) * 100 : 0;

    return { totalCases, executedCases, passedCases, executionRate, passRate };
}

// ------- Test Run Set Report -------
let testRunSetReportModalInstance = null;

function openTestRunSetReport(setData) {
    if (!setData) return;
    renderTestRunSetReport(setData);
    refreshSetHtmlReportStatus(setData.id);
    if (!testRunSetReportModalInstance) {
        testRunSetReportModalInstance = new bootstrap.Modal(document.getElementById('testRunSetReportModal'));
    }
    testRunSetReportModalInstance.show();
}

function renderTestRunSetReport(setData) {
    const titleEl = document.getElementById('setReportTitle');
    const statusEl = document.getElementById('setReportStatusBadge');
    const metaEl = document.getElementById('setReportMeta');
    const descEl = document.getElementById('setReportDescription');
    const statGrid = document.getElementById('setReportStatGrid');
    const runsBody = document.getElementById('setReportRunsBody');

    const runs = Array.isArray(setData.test_runs) ? setData.test_runs : [];
    const metrics = summarizeSetMetrics(runs);
    const statusCounts = runs.reduce((acc, run) => {
        const key = String(run.status || 'unknown').toLowerCase();
        acc[key] = (acc[key] || 0) + 1;
        return acc;
    }, {});

    if (titleEl) titleEl.textContent = setData.name || '';
    if (statusEl) statusEl.innerHTML = getSetStatusBadge(setData.status);
    if (metaEl) metaEl.textContent = `Test Run: ${runs.length} · 總案例: ${metrics.totalCases} · 執行率 ${Math.round(metrics.executionRate)}% · Pass Rate ${Math.round(metrics.passRate)}%`;
    if (descEl) {
        descEl.innerHTML = setData.description ? escapeHtml(setData.description).replace(/\n/g, '<br>') : '<span class="text-muted" data-i18n="testRun.sets.detail.noDescription">尚未填寫描述</span>';
    }

    if (statGrid) {
        statGrid.innerHTML = `
            <div class="col-6 col-md-3">
                <div class="small text-muted">Active</div>
                <div class="fw-semibold">${statusCounts['active'] || 0}</div>
            </div>
            <div class="col-6 col-md-3">
                <div class="small text-muted">Completed</div>
                <div class="fw-semibold">${statusCounts['completed'] || 0}</div>
            </div>
            <div class="col-6 col-md-3">
                <div class="small text-muted">Archived</div>
                <div class="fw-semibold">${statusCounts['archived'] || 0}</div>
            </div>
            <div class="col-6 col-md-3">
                <div class="small text-muted">草稿/其他</div>
                <div class="fw-semibold">${statusCounts['draft'] || 0}</div>
            </div>
            <div class="col-6 col-md-3">
                <div class="small text-muted">總案例</div>
                <div class="fw-semibold">${metrics.totalCases}</div>
            </div>
            <div class="col-6 col-md-3">
                <div class="small text-muted">已執行</div>
                <div class="fw-semibold">${metrics.executedCases}</div>
            </div>
            <div class="col-6 col-md-3">
                <div class="small text-muted">執行率</div>
                <div class="fw-semibold">${Math.round(metrics.executionRate)}%</div>
            </div>
            <div class="col-6 col-md-3">
                <div class="small text-muted">Pass Rate</div>
                <div class="fw-semibold">${Math.round(metrics.passRate)}%</div>
            </div>
        `;
    }

    if (runsBody) {
        if (!runs.length) {
            runsBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-3">尚未加入任何 Test Run</td></tr>';
        } else {
            runsBody.innerHTML = runs.map(run => {
                const execRate = run.total_test_cases > 0 ? Math.round((run.executed_cases || 0) / run.total_test_cases * 100) : 0;
                const passRate = (run.executed_cases || 0) > 0 ? Math.round((run.passed_cases || 0) / run.executed_cases * 100) : 0;
                return `
                    <tr>
                        <td>${escapeHtml(run.name || '')}</td>
                        <td><span class="status-badge ${getStatusClass(run.status)}">${getStatusText(run.status)}</span></td>
                        <td class="text-center">${execRate}%</td>
                        <td class="text-center">${passRate}%</td>
                        <td class="text-center">${run.total_test_cases || 0}</td>
                        <td class="text-center">${run.executed_cases || 0}</td>
                        <td class="text-center">${run.passed_cases || 0}</td>
                        <td>${escapeHtml(run.test_environment || '-')}</td>
                        <td>${escapeHtml(run.test_version || '-')}</td>
                    </tr>
                `;
            }).join('');
        }
    }
}

async function refreshSetHtmlReportStatus(setId) {
    const statusEl = document.getElementById('setReportHtmlStatus');
    const openBtn = document.getElementById('setReportOpenHtmlBtn');
    if (openBtn) openBtn.classList.add('d-none');
    if (statusEl) statusEl.textContent = '';
    if (!currentTeamId) return;

    try {
        const resp = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-sets/${setId}/report`);
        const data = await resp.json();
        if (resp.ok && data.exists) {
            if (statusEl) statusEl.textContent = '已有報告，可直接開啟';
            if (openBtn && data.report_url) {
                openBtn.href = data.report_url;
                openBtn.classList.remove('d-none');
            }
        } else if (statusEl) {
            statusEl.textContent = '尚未生成報告';
        }
    } catch (e) {
        if (statusEl) statusEl.textContent = '查詢報告狀態失敗';
    }
}

async function generateTestRunSetHtmlReport() {
    const btn = document.getElementById('setReportGenerateHtmlBtn');
    const icon = document.getElementById('setReportGenerateIcon');
    const text = document.getElementById('setReportGenerateText');
    if (!currentSetContext || !currentTeamId || !btn) return;

    const defaultLabel = (window.i18n?.t('testRun.generateHtmlButton') || '生成並複製連結');
    const loadingLabel = (window.i18n?.t('testRun.generatingHtml') || '生成中...');

    try {
        btn.disabled = true;
        if (icon) {
            icon.classList.remove('fa-file-alt');
            icon.classList.add('fa-spinner', 'fa-spin');
        }
        if (text) text.textContent = loadingLabel;

        const resp = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-sets/${currentSetContext.id}/generate-html`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await resp.json();
        if (!resp.ok || !data.success) {
            throw new Error(data?.detail || '生成失敗');
        }

        if (data.report_url) {
            if (window.AppUtils?.showCopyModal) {
                window.AppUtils.showCopyModal(data.report_url);
            } else {
                window.prompt('請手動複製此連結：', data.report_url);
            }
        }
        refreshSetHtmlReportStatus(currentSetContext.id);
    } catch (error) {
        const msg = error?.message || '生成失敗';
        AppUtils.showError(`生成 HTML 報告時發生錯誤：${msg}`);
    } finally {
        btn.disabled = false;
        if (icon) {
            icon.classList.remove('fa-spinner', 'fa-spin');
            icon.classList.add('fa-file-alt');
        }
        if (text) text.textContent = defaultLabel;
    }
}

function createTestRunSetCard(set, filterStatus) {
    const allRuns = Array.isArray(set.test_runs) ? set.test_runs : [];
    const filteredRuns = filterTestRunsByStatus(allRuns, filterStatus);
    const metrics = summarizeSetMetrics(allRuns);
    const filteredMetrics = summarizeSetMetrics(filteredRuns);
    const totalRuns = allRuns.length;
    const filteredCount = filteredRuns.length;

    const recentRunsHtml = filteredRuns.slice(0, 3).map(run => {
        const statusClass = getStatusClass(run.status);
        const statusText = getStatusText(run.status);
        return `
            <div class="d-flex align-items-center justify-content-between py-1 border-bottom gap-2">
                <div class="flex-grow-1 min-width-0 text-truncate"><i class="fas fa-flag text-muted me-2"></i>${escapeHtml(run.name)}</div>
                <span class="status-badge ${statusClass} flex-shrink-0">${statusText}</span>
            </div>
        `;
    }).join('');

    const emptyKey = filterStatus === 'all' ? 'testRun.sets.card.empty' : 'testRun.sets.card.noMatches';
    const emptyFallback = filterStatus === 'all' ? '尚未包含任何 Test Run' : '沒有符合篩選條件的 Test Run';
    const noRunsHtml = `
        <div class="text-muted small py-2" data-i18n="${emptyKey}">
            ${emptyFallback}
        </div>
    `;

    const statusClass = getStatusClass(set.status || 'active');
    const statusBadge = getSetStatusBadge(set.status);

    let tpContent = '';
    if (set.related_tp_tickets && Array.isArray(set.related_tp_tickets) && set.related_tp_tickets.length > 0) {
        const maxDisplay = 5;
        const visibleTickets = set.related_tp_tickets.slice(0, maxDisplay);
        const remainingCount = set.related_tp_tickets.length - maxDisplay;
        const tpTags = visibleTickets.map(ticket => {
            const safe = escapeHtml(ticket);
            return `<span class="tcg-tag me-1" data-tp-ticket="${safe}"` +
                ` onmouseenter="showJiraPreview(event, '${safe}')"` +
                ` onmouseleave="hideJiraPreview()"` +
                ` onclick="event.stopPropagation(); openJiraTicket('${safe}')" style="cursor:pointer; font-size: 0.75rem;">${safe}</span>`;
        }).join('');
        const remainingTag = remainingCount > 0
            ? `<span class="badge bg-light text-dark" style="font-size: 0.75rem;">+${remainingCount}</span>`
            : '';
        tpContent = `${tpTags}${remainingTag}`;
    } else {
        tpContent = `<span class="tp-tag badge bg-secondary me-1">N/A</span>`;
    }
    const tpLine = `<div class="stats-item mb-1">
        <i class="fas fa-tags stats-icon"></i>
        <small class="text-muted flex-grow-1" data-i18n="testRun.relatedTpTickets">相關 JIRA Tickets</small>
        <div class="d-flex flex-wrap gap-1 justify-content-end ms-auto">${tpContent}</div>
    </div>`;

    return `
        <div class="col-xl-4 col-lg-6 mb-4">
            <div class="card h-100 test-run-card ${statusClass}" onclick="openTestRunSetDetail(${set.id})">
                <div class="card-body d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-start mb-3 gap-2">
                        <div class="flex-grow-1 min-width-0">
                            <h5 class="card-title text-primary mb-1 text-truncate">${escapeHtml(set.name)}</h5>
                            <div class="text-muted small">
                                <i class="fas fa-calendar-plus me-1"></i>${AppUtils.formatDate(set.created_at, 'datetime')}
                            </div>
                        </div>
                        <div class="flex-shrink-0">
                            ${statusBadge}
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="small text-muted">
                            <div class="d-flex justify-content-between"><span data-i18n="testRun.sets.card.totalRuns">包含 Test Run</span><span>${filteredCount}/${totalRuns}</span></div>
                            <div class="d-flex justify-content-between"><span data-i18n="testRun.progressLabel">執行進度</span><span>${filteredMetrics.executionRate.toFixed(1)}%</span></div>
                            <div class="d-flex justify-content-between"><span data-i18n="testRun.passRateLabel">Pass Rate</span><span>${filteredMetrics.passRate.toFixed(1)}%</span></div>
                        </div>
                        ${tpLine}
                    </div>
                    <div class="border rounded p-2 bg-light flex-grow-1">
                        ${filteredCount > 0 ? recentRunsHtml : noRunsHtml}
                    </div>
                    <div class="mt-3 d-flex gap-2 flex-wrap">
                        <button type="button" class="btn btn-primary btn-sm flex-grow-1" onclick="event.stopPropagation(); openTestRunSetDetail(${set.id})">
                            <i class="fas fa-layer-group me-1"></i><span data-i18n="testRun.sets.card.openDetail">管理 Test Run</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function renderUnassignedTestRunCards(filterStatus) {
    const container = document.getElementById('unassigned-test-runs-container');
    const emptyHint = document.getElementById('no-unassigned-test-runs');
    if (!container) return;

    if (!Array.isArray(unassignedTestRuns) || unassignedTestRuns.length === 0) {
        const perms = window._testRunPermissions || testRunPermissions || {};
        container.innerHTML = perms.canCreate ? getAddTestRunCardHtml() : '';
        if (emptyHint) emptyHint.style.display = 'block';
        if (window.i18n && window.i18n.isReady()) {
            window.i18n.retranslate(container);
        }
        return;
    }

    const runs = filterTestRunsByStatus(unassignedTestRuns, filterStatus);
    const perms = window._testRunPermissions || testRunPermissions || {};

    if (runs.length === 0) {
        let messageHtml = '';
        if (filterStatus === 'all') {
            if (emptyHint) emptyHint.style.display = 'block';
        } else {
            messageHtml = `
                <div class="col-12">
                    <div class="text-center text-muted py-4" data-i18n="testRun.unassigned.noFilterMatches">目前沒有符合篩選條件的 Test Run</div>
                </div>
            `;
            if (emptyHint) emptyHint.style.display = 'none';
        }
        container.innerHTML = messageHtml + (perms.canCreate ? getAddTestRunCardHtml() : '');
        if (window.i18n && window.i18n.isReady()) {
            window.i18n.retranslate(container);
        }
        return;
    }

    let cardsHtml = runs.map(config => createConfigCard(config)).join('');
    if (perms.canCreate) {
        cardsHtml += getAddTestRunCardHtml();
    }
    container.innerHTML = cardsHtml;
    if (emptyHint) emptyHint.style.display = 'none';

    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(container);
    }
}


function showLoading() {
    document.getElementById('loading-state').style.display = 'block';
    document.getElementById('test-run-configs-section').style.display = 'none';
    document.getElementById('no-configs-section').style.display = 'none';
}

function hideLoading() {
    document.getElementById('loading-state').style.display = 'none';
}

function showNoConfigs() {
    document.getElementById('no-configs-section').style.display = 'block';
    document.getElementById('test-run-configs-section').style.display = 'none';
}

function showConfigsSection() {
    document.getElementById('no-configs-section').style.display = 'none';
    document.getElementById('test-run-configs-section').style.display = 'block';
}

function createConfigCard(config) {
    const permissions = window._testRunPermissions || testRunPermissions || {};
    const statusClass = getStatusClass(config.status);
    const statusText = getStatusText(config.status);
    const progressPercentage = config.execution_rate || 0;
    const passPercentage = config.pass_rate || 0;
    const createdDate = AppUtils.formatDate(config.created_at, 'datetime-tz');
    const envLine = config.test_environment ? `<div class=\"stats-item\"><i class=\"fas fa-server stats-icon\"></i><small class=\"text-muted\"><span data-i18n=\"testRun.testEnvironment\">測試環境</span>: ${escapeHtml(config.test_environment)}</small></div>` : '';
    
    // TP 標籤顯示邏輯
    let tpContent = '';
    if (config.related_tp_tickets && Array.isArray(config.related_tp_tickets) && config.related_tp_tickets.length > 0) {
        const maxDisplay = 5; // 最多顯示5個標籤
        const visibleTickets = config.related_tp_tickets.slice(0, maxDisplay);
        const remainingCount = config.related_tp_tickets.length - maxDisplay;

        const tpTags = visibleTickets.map(ticket =>
            `<span class="tcg-tag me-1" data-tp-ticket="${escapeHtml(ticket)}"
                   onmouseenter="showJiraPreview(event, '${escapeHtml(ticket)}')"
                   onmouseleave="hideJiraPreview()"
                   onclick="event.stopPropagation(); openJiraTicket('${escapeHtml(ticket)}')"
                   style="cursor: pointer; font-size: 0.75rem;">${escapeHtml(ticket)}</span>`
        ).join('');

        const remainingTag = remainingCount > 0 ?
            `<span class="badge bg-light text-dark" style="font-size: 0.75rem;">+${remainingCount}</span>` : '';

        tpContent = `${tpTags}${remainingTag}`;
    } else {
        tpContent = `<span class="tp-tag badge bg-secondary me-1">N/A</span>`;
    }
    const tpLine = `<div class="stats-item mb-1">
        <i class="fas fa-tags stats-icon"></i>
        <small class="text-muted flex-grow-1"><span data-i18n="testRun.relatedTpTickets">相關 JIRA Tickets</span></small>
        <div class="d-flex flex-wrap gap-1 justify-content-end ms-auto">${tpContent}</div>
    </div>`;
    
    const buildLine = config.build_number ? `<div class=\"stats-item\"><i class=\"fas fa-code-branch stats-icon\"></i><small class=\"text-muted\"><span data-i18n=\"testRun.buildNumber\">建置版本</span>: ${escapeHtml(config.build_number)}</small></div>` : '';
    
    const primaryActions = [];
    const secondaryActions = [];

    primaryActions.push(`
                        <button class="btn btn-primary btn-sm flex-grow-1" onclick="event.stopPropagation(); enterTestRun(${config.id})">
                            <i class="fas fa-arrow-right me-1"></i><span data-i18n="testRun.enterButton">進入</span>
                        </button>
    `);

    const lockedForConfigEdit = config.status === 'completed' || config.status === 'archived';
    const lockedForCasesEdit = config.status === 'completed';
    const lockedConfigTitle = lockedForConfigEdit
        ? ` title="${(window.i18n && window.i18n.isReady()) ? window.i18n.t('testRun.cannotEditCompleted') : '已完成或已歸檔的 Test Run 不可編輯'}"`
        : '';
    const lockedCasesTitle = lockedForCasesEdit
        ? ` title="${(window.i18n && window.i18n.isReady()) ? window.i18n.t('testRun.cannotEditCompleted') : '已完成的 Test Run 不可編輯 Test Case'}"`
        : '';

    if (permissions.canUpdate) {
        primaryActions.push(`
                        <button class="btn btn-secondary btn-sm${lockedForConfigEdit ? ' disabled' : ''}" 
                                ${lockedForConfigEdit ? 'disabled' : ''}${lockedConfigTitle}
                                onclick="event.stopPropagation(); editBasicSettings(${config.id})">
                            <i class="fas fa-edit me-1"></i><span data-i18n="testRun.editBasicSettings">編輯基本設定</span>
                        </button>
        `);
        primaryActions.push(`
                        <button class="btn btn-info btn-sm${(lockedForConfigEdit || lockedForCasesEdit) ? ' disabled' : ''}" 
                                ${(lockedForConfigEdit || lockedForCasesEdit) ? 'disabled' : ''}${lockedCasesTitle}
                                onclick="event.stopPropagation(); editTestCases(${config.id})">
                            <i class="fas fa-list me-1"></i><span data-i18n="testRun.editTestCases">編輯 Test Case</span>
                        </button>
        `);
    }

    if (permissions.canChangeStatus) {
        secondaryActions.push(`
                        <div class="position-relative" onclick="event.stopPropagation()">
                            <button type="button" class="btn btn-warning btn-sm custom-status-btn" 
                                    data-config-id="${config.id}" 
                                    onclick="event.stopPropagation(); toggleCustomStatusDropdown(this, ${config.id})">
                                <i class="fas fa-exchange-alt me-1"></i><span data-i18n="testRun.changeStatus">狀態</span>
                                <i class="fas fa-chevron-down ms-1"></i>
                            </button>
                        </div>
        `);
    }

    if (permissions.canDelete) {
        secondaryActions.push(`
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteTestRun(${config.id}, '${escapeHtml(config.name)}')">
                            <i class="fas fa-trash me-1"></i><span data-i18n="common.delete">刪除</span>
                        </button>
        `);
    }

    const actionsHtml = (() => {
        const merged = [...primaryActions, ...secondaryActions];
        if (!merged.length) return '';
        return `<div class="d-flex gap-2 flex-wrap w-100 justify-content-lg-end">${merged.join('')}</div>`;
    })();

    return `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 test-run-card ${getStatusClass(config.status)}" onclick="enterTestRun(${config.id})">
                <div class="card-body d-flex flex-column h-100">
                    <div class="d-flex justify-content-between align-items-start mb-3 gap-2">
                        <div class="d-flex align-items-center overflow-hidden flex-grow-1">
                            <div class="flex-shrink-0 me-3">
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width: 48px; height: 48px; font-size: 16px; font-weight: bold;">
                                    <i class="fas fa-play"></i>
                                </div>
                            </div>
                            <div class="min-width-0">
                                <h5 class="card-title text-primary mb-1 text-truncate">${escapeHtml(config.name)}</h5>
                            </div>
                        </div>
                        <div class="flex-shrink-0">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted" data-i18n="testRun.progressLabel">執行進度</small>
                            <small class="text-muted">${progressPercentage.toFixed(1)}%</small>
                        </div>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-primary" style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted" data-i18n="testRun.passRateLabel">Pass Rate</small>
                            <small class="text-muted">${passPercentage.toFixed(1)}%</small>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success" style="width: ${passPercentage}%"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        ${envLine}
                        ${tpLine}
                        ${buildLine}
                        <div class="stats-item">
                            <i class="fas fa-list-ul stats-icon"></i>
                            <small class="text-muted">${(window.i18n && window.i18n.isReady()) ? window.i18n.t('testRun.totalExecuted', {total: config.total_test_cases, executed: config.executed_cases}) : `總數: ${config.total_test_cases} | 已執行: ${config.executed_cases}`}</small>
                        </div>
                        <div class="stats-item">
                            <i class="fas fa-calendar stats-icon"></i>
                            <small class="text-muted">${(window.i18n && window.i18n.isReady()) ? window.i18n.t('testRun.createdLabel', {date: createdDate}) : `建立: ${createdDate}`}</small>
                        </div>
                    </div>
                    ${actionsHtml ? `<div class="mt-auto pt-2">${actionsHtml}</div>` : ''}
                </div>
            </div>
        </div>
    `;
}

function getAddTestRunCardHtml() {
    return `
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 add-test-run-card text-center" data-card-type="run">
                <div class="card-body d-flex flex-column justify-content-center">
                    <div class="text-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3" 
                         style="width: 48px; height: 48px; font-size: 18px; border: 2px dashed var(--tr-primary);">
                        <i class="fas fa-plus"></i>
                    </div>
                    <h6 class="text-primary mb-1" data-i18n="testRun.addConfigs">新增 Test Run</h6>
                    <small class="text-muted" data-i18n="testRun.addConfigsHint">建立新的測試執行配置</small>
                </div>
            </div>
        </div>
    `;
}

function getAddTestRunSetCardHtml() {
    return `
        <div class="col-xl-4 col-lg-6 mb-4">
            <div class="card h-100 add-test-run-card text-center" data-card-type="set">
                <div class="card-body d-flex flex-column justify-content-center">
                    <div class="text-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3"
                         style="width: 48px; height: 48px; font-size: 18px; border: 2px dashed var(--tr-primary);">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <h6 class="text-primary mb-1" data-i18n="testRun.sets.form.addCardTitle">新增 Test Run Set</h6>
                    <small class="text-muted" data-i18n="testRun.sets.form.addCardHint">將相關的 Test Run 分組管理</small>
                </div>
            </div>
        </div>
    `;
}

function getStatusClass(status) {
    switch (status) {
        case 'active': return 'status-active';
        case 'completed': return 'status-completed';
        case 'draft': return 'status-draft';
        case 'archived': return 'status-archived';
        default: return 'status-draft';
    }
}

function getStatusText(status) {
    if (window.i18n && window.i18n.isReady && window.i18n.isReady()) {
        const statusKey = `testRun.status.${status}`;
        const translated = window.i18n.t(statusKey);
        // 如果翻譯失敗（返回原始鍵），使用預設文字
        if (translated === statusKey || !translated) {
            return getDefaultStatusText(status);
        }
        return translated;
    }
    return getDefaultStatusText(status);
}

function getDefaultStatusText(status) {
    const defaultTexts = {
        'active': '進行中',
        'completed': '已完成', 
        'draft': '草稿',
        'archived': '已歸檔',
        'unknown': '未知'
    };
    return defaultTexts[status] || '未知';
}

function getSetStatusText(status) {
    const key = String(status || '').toLowerCase();
    if (key === 'active') {
        return window.i18n?.t('testRun.sets.status.active') || 'Active';
    }
    if (key === 'completed') {
        return window.i18n?.t('testRun.sets.status.completed') || 'Completed';
    }
    if (key === 'archived') {
        return window.i18n?.t('testRun.sets.status.archived') || 'Archived';
    }
    return key || 'Unknown';
}

function getSetStatusBadge(status) {
    const text = getSetStatusText(status);
    const key = String(status || '').toLowerCase();
    let className = 'status-badge status-active';
    if (key === 'archived') {
        className = 'status-badge status-archived';
    } else if (key === 'completed') {
        className = 'status-badge status-completed';
    }
    return `<span class="${className}">${text}</span>`;
}

// 自訂下拉選單邏輯
let currentDropdownConfig = null;

function toggleCustomStatusDropdown(button, configId) {
    const permissions = window._testRunPermissions || testRunPermissions || {};
    if (!permissions.canChangeStatus) {
        showPermissionDenied();
        return;
    }

    const dropdown = document.getElementById('customStatusDropdown');
    const overlay = document.getElementById('statusDropdownOverlay');
    
    // 如果已經打開，則關閉
    if (dropdown.classList.contains('show')) {
        hideCustomStatusDropdown();
        return;
    }
    
    // 找到對應的配置
    const config = testRunConfigs.find(c => c.id === configId);
    if (!config) return;
    
    currentDropdownConfig = config;
    
    // 生成下拉選單內容
    generateCustomStatusDropdownItems(config, dropdown);
    
    // 計算位置
    const rect = button.getBoundingClientRect();
    dropdown.style.left = rect.left + 'px';
    dropdown.style.top = (rect.bottom + 5) + 'px';
    
    // 顯示下拉選單和覆蓋層
    overlay.classList.add('show');
    dropdown.classList.add('show');
}

function hideCustomStatusDropdown() {
    const dropdown = document.getElementById('customStatusDropdown');
    const overlay = document.getElementById('statusDropdownOverlay');
    
    dropdown.classList.remove('show');
    overlay.classList.remove('show');
    currentDropdownConfig = null;
}

function generateCustomStatusDropdownItems(config, dropdown) {
    const currentStatus = config.status;
    
    // 定義狀態轉換規則
    const statusTransitions = {
        'draft': ['active', 'archived'],
        'active': ['completed', 'archived'],  // 進行中不可回到草稿
        'completed': ['archived'],  // 已完成只能歸檔
        'archived': ['active', 'draft']
    };
    
    const availableStatuses = statusTransitions[currentStatus] || [];
    
    let html = '';
    
    availableStatuses.forEach(status => {
        const statusText = getStatusText(status);
        const icon = getStatusIcon(status);
        
        html += `
            <div class="custom-status-dropdown-item" onclick="handleCustomStatusChange('${status}')">
                <i class="${icon} me-2"></i>${statusText}
            </div>
        `;
    });
    
    dropdown.innerHTML = html;
}

function handleCustomStatusChange(newStatus) {
    if (currentDropdownConfig) {
        changeTestRunStatus(currentDropdownConfig.id, newStatus, currentDropdownConfig.name);
        hideCustomStatusDropdown();
    }
}

function generateStatusDropdownItems(config) {
    const currentStatus = config.status;
    
    // 定義狀態轉換規則
    const statusTransitions = {
        'draft': ['active', 'archived'],
        'active': ['completed', 'archived'],  // 進行中不可回到草稿
        'completed': ['archived'],  // 已完成只能歸檔
        'archived': ['active', 'draft']
    };
    
    const availableStatuses = statusTransitions[currentStatus] || [];
    
    let items = [];
    
    availableStatuses.forEach(status => {
        const statusText = getStatusText(status);
        const icon = getStatusIcon(status);
        
        items.push(`
            <li><a class="dropdown-item" href="#" onclick="event.stopPropagation(); changeTestRunStatus(${config.id}, '${status}', '${escapeHtml(config.name)}')">
                <i class="${icon} me-2"></i>${statusText}
            </a></li>
        `);
    });
    
    return items.join('');
}

function getStatusIcon(status) {
    const icons = {
        'active': 'fas fa-play text-primary',
        'completed': 'fas fa-check text-success',
        'draft': 'fas fa-edit text-warning',
        'archived': 'fas fa-archive text-secondary'
    };
    return icons[status] || 'fas fa-question text-muted';
}

async function changeTestRunStatus(configId, newStatus, configName) {
    // 直接執行狀態變更，不需要輸入原因
    const permissions = window._testRunPermissions || testRunPermissions || {};
    if (!permissions.canChangeStatus) {
        showPermissionDenied();
        return;
    }
    
    try {
        const teamId = currentTeamId; // 使用全域變數
        const response = await window.AuthClient.fetch(`/api/teams/${teamId}/test-run-configs/${configId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: newStatus
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || '狀態變更失敗');
        }
        
        const updatedConfig = await response.json();
        
        // 顯示成功訊息 - 使用 fallback 參數確保有預設文字
        const successMsg = (window.i18n && window.i18n.isReady()) ? 
            window.i18n.t('testRun.statusChangedSuccess', {name: configName, status: getStatusText(newStatus)}, 
                         `Test Run "${configName}" 狀態已變更為 ${getStatusText(newStatus)}`) : 
            `Test Run "${configName}" 狀態已變更為 ${getStatusText(newStatus)}`;
        
        AppUtils.showSuccess(successMsg);
        
        // 重新載入 Test Run 列表
        await loadTestRunConfigs();
        
    } catch (error) {
        console.error('Change status error:', error);
        const errorMsg = (window.i18n && window.i18n.isReady()) ? 
            window.i18n.t('testRun.statusChangeFailed', {}, '狀態變更失敗：' + error.message) : 
            '狀態變更失敗：' + error.message;
        
        AppUtils.showError(errorMsg);
    }
}

function refreshStatusTexts() {
    // 僅做文案重翻譯，不重打 API，避免 teams/null 之類錯誤
    try {
        if (window.i18n && window.i18n.isReady && window.i18n.isReady()) {
            window.i18n.retranslate(document);
        }
    } catch (e) {
        console.warn('refreshStatusTexts: retranslate failed', e);
    }
    
    // 同步更新已開啟的詳情視窗中的狀態徽章文案
    const detailModal = document.getElementById('configDetailModal');
    if (detailModal && detailModal.classList.contains('show')) {
        const statusBadges = detailModal.querySelectorAll('.status-badge');
        statusBadges.forEach(badge => {
            const statusClass = badge.className.match(/status-(\w+)/);
            if (statusClass && statusClass[1]) {
                const status = statusClass[1];
                badge.textContent = getStatusText(status);
            }
        });
    }
}

function openConfigFormModal(configId = null, options = {}) {
    const permissions = window._testRunPermissions || testRunPermissions || {};
    if (configId && !permissions.canUpdate) {
        showPermissionDenied();
        return;
    }
    if (!configId && !permissions.canCreate) {
        showPermissionDenied();
        return;
    }

    // 如果 Test Run Set Detail Modal 正在顯示，先隱藏它
    const setDetailModalElement = document.getElementById('testRunSetDetailModal');
    const wasSetDetailModalOpen = setDetailModalElement && setDetailModalElement.classList.contains('show');
    if (wasSetDetailModalOpen && testRunSetDetailModalInstance) {
        preserveSetContextOnHide = true;
        testRunSetDetailModalInstance.hide();
    }
    suppressSetDetailReopen = false;

    const modalElement = document.getElementById('configFormModal');
    if (!configFormModalInstance) {
        configFormModalInstance = new bootstrap.Modal(modalElement);
    }

    const form = document.getElementById('testRunConfigForm');
    form.reset();
    document.getElementById('configId').value = '';
    // 優先使用顯式傳入的 setId；若有從 Test Case Set 預選流程也帶入
    if (!options.setId && window._testCaseSetIdSource) {
        options.setId = window._testCaseSetIdSource;
    }
    pendingSetIdForNewConfig = options.setId ?? null;
    document.getElementById('configSetId').value = pendingSetIdForNewConfig ? String(pendingSetIdForNewConfig) : '';
    renderTestCaseSetOptions(pendingSetIdForNewConfig);
    currentSetIdForCaseSelection = pendingSetIdForNewConfig ?? null;

    const titleEl = document.getElementById('configFormModalTitle');
    const saveBtnTextEl = document.getElementById('saveConfigBtnText');

    if (configId) {
        // Edit mode
        const config = testRunConfigs.find(c => c.id === configId);
        if (config) {
            titleEl.setAttribute('data-i18n', 'testRun.editConfig');
            saveBtnTextEl.setAttribute('data-i18n', 'common.update');
            document.getElementById('configId').value = config.id;
            document.getElementById('configName').value = config.name;
            document.getElementById('configDescription').value = config.description || '';
            document.getElementById('configSetId').value = config.set_id ? String(config.set_id) : '';
            currentSetIdForCaseSelection = pendingSetIdForNewConfig || null;
            renderTestCaseSetOptions(currentSetIdForCaseSelection);
            // 嘗試載入詳細配置以填入可選欄位和 TP 票號
            window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${configId}`)
              .then(r => r.ok ? r.json() : null)
              .then(full => {
                if (full) {
                  document.getElementById('testEnvironment').value = full.test_environment || '';
                  document.getElementById('buildNumber').value = full.build_number || '';
                  // 載入 TP 票號
                  const tpTickets = full.related_tp_tickets || [];
                  setTpTickets(tpTickets);
                  // 載入通知設定
                  loadNotificationSettings(full.notifications_enabled || false, full.notify_chat_ids || [], full.notify_chat_names_snapshot || []);
                }
              }).catch(() => {});
        }
    } else {
        // Create mode
        titleEl.setAttribute('data-i18n', 'testRun.createConfig');
        saveBtnTextEl.setAttribute('data-i18n', 'common.create');
        // 清空 TP 票號
        clearAllTpTickets();
        renderTestCaseSetOptions(pendingSetIdForNewConfig);
    }
    
    // 初始化 TP 標籤輸入功能
    initTpTicketInput();
    
    // 初始化通知設定功能
    initNotificationSettings();
    
    // 監聽 Modal 關閉事件，清理 TP 標籤狀態和通知設定
    modalElement.addEventListener('hidden.bs.modal', function() {
        clearAllTpTickets();
        clearNotificationSettings();
        pendingSetIdForNewConfig = null;
        document.getElementById('configSetId').value = '';

        // 如果之前 Test Run Set Detail Modal 是打開的，重新顯示它
        if (!suppressSetDetailReopen && wasSetDetailModalOpen && testRunSetDetailModalInstance) {
            testRunSetDetailModalInstance.show();
        }
        suppressSetDetailReopen = false;
    }, { once: true }); // 只監聽一次，避免重複綁定

    if (window.i18n) window.i18n.retranslate(modalElement);
    configFormModalInstance.show();
}

async function handleSaveConfig() {
    const form = document.getElementById('testRunConfigForm');
    
    // 執行綜合表單驗證
    const validationResult = validateTestRunConfigForm();
    if (!validationResult.isValid) {
        // 顯示第一個錯誤並聚焦到對應欄位
        showFormValidationError(validationResult);
        return;
    }
    
    // HTML5 基礎驗證
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const configId = document.getElementById('configId').value;
    const isEdit = !!configId;

    const permissions = window._testRunPermissions || testRunPermissions || {};
    if (isEdit && !permissions.canUpdate) {
        showPermissionDenied();
        return;
    }
    if (!isEdit && !permissions.canCreate) {
        showPermissionDenied();
        return;
    }

    const configData = { name: document.getElementById('configName').value };
    const descVal = (document.getElementById('configDescription').value || '').trim();
    const envVal = (document.getElementById('testEnvironment').value || '').trim();
    const buildVal = (document.getElementById('buildNumber').value || '').trim();
    const tpTickets = getCurrentTpTickets(); // 獲取當前 TP 票號列表
    const notificationSettings = getCurrentNotificationSettings(); // 獲取當前通知設定
    
    if (descVal) configData.description = descVal;
    if (envVal) configData.test_environment = envVal;
    if (buildVal) configData.build_number = buildVal;
    configData.related_tp_tickets = tpTickets;  // 總是傳送，即使是空陣列
    // 加入通知設定
    configData.notifications_enabled = notificationSettings.enabled;
    if (notificationSettings.enabled && notificationSettings.chatIds.length > 0) {
        configData.notify_chat_ids = notificationSettings.chatIds;
        configData.notify_chat_names_snapshot = notificationSettings.chatNames;
    }

  if (!isEdit) {
    const testCaseSetId = document.getElementById('configTestCaseSetId').value;
    if (!testCaseSetId) {
      const msg = window.i18n ? (window.i18n.t('testRun.sets.selectSetFirst') || '請先選擇一個 Test Case Set 再建立 Test Run') : '請先選擇一個 Test Case Set 再建立 Test Run';
      AppUtils.showWarning(msg);
      return;
    }
    currentSetIdForCaseSelection = parseInt(testCaseSetId, 10);
    window._lastTestCaseSetIdForRun = currentSetIdForCaseSelection;
    renderTestCaseSetOptions(currentSetIdForCaseSelection);
    // 保留原有 Test Run Set 功能（若有選擇）
    const setIdValue = document.getElementById('configSetId').value;
    if (setIdValue) {
      configData.set_id = parseInt(setIdValue, 10);
    }
    }

    const url = isEdit
      ? `/api/teams/${currentTeamId}/test-run-configs/${configId}`
      : `/api/teams/${currentTeamId}/test-run-configs`;
    const method = isEdit ? 'PUT' : 'POST';

    const saveBtn = document.getElementById('saveConfigBtn');
    try {
        saveBtn.disabled = true;
        const response = await window.AuthClient.fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(configData)
        });

        if (!response.ok) {
            const errorData = await response.json();
            const fallbackMsg = window.i18n ? window.i18n.t('messages.saveFailed') : '儲存失敗';
            throw new Error(errorData.detail || fallbackMsg);
        }

        const data = await response.json();
        if (!isEdit) {
            suppressSetDetailReopen = true;
        }
        configFormModalInstance.hide();
        if (isEdit) {
            const msg = window.i18n ? window.i18n.t('testRun.updateSuccess') : '更新成功';
            AppUtils.showSuccess(msg);
            await loadTestRunConfigs();
        } else {
            const msg = window.i18n ? window.i18n.t('testRun.createConfigSuccessSelectCases') : '建立成功，請選擇要加入的 Test Case';
            AppUtils.showSuccess(msg);
            currentSetIdForCaseSelection = window._lastTestCaseSetIdForRun || parseInt(document.getElementById('configTestCaseSetId').value || '0', 10) || null;
            renderTestCaseSetOptions(currentSetIdForCaseSelection);
            // 進入 Test Case 選擇流程（直接開啟，取消時自動回滾）
            pendingCreate = true;
            createdItemsInSession = false;
            // 確保為全新建立流程，清空任何編輯殘留選取狀態
            modalMode = 'create';
            selectedCaseMap.clear();
            existingItemIdByCaseNumber.clear();
            
            // 檢查是否有從 Test Case Set 預選的 Test Cases
            if (window._preselectedCaseIdsFromSet) {
              window._preselectedCaseIds = new Set(window._preselectedCaseIdsFromSet.split(',').map(id => id.trim()));
              isPreselectedFromTestCaseSet = true;
              // 清除臨時變數
              window._preselectedCaseIdsFromSet = null;
              window._testCaseSetIdSource = null;
            } else {
              isPreselectedFromTestCaseSet = false;
            }
            
            openCaseSelectModal(data.id);
        }

    } catch (error) {
        AppUtils.showError(error.message);
    } finally {
        saveBtn.disabled = false;
        pendingSetIdForNewConfig = null;
        document.getElementById('configSetId').value = '';
    }
}

function openTestRunSetFormModal(setId = null) {
    const permissions = window._testRunPermissions || testRunPermissions || {};
    if (setId) {
        if (!permissions.canUpdate) {
            showPermissionDenied();
            return;
        }
    } else if (!permissions.canCreate) {
        showPermissionDenied();
        return;
    }

    const modalElement = document.getElementById('testRunSetFormModal');
    if (!testRunSetFormModalInstance) {
        testRunSetFormModalInstance = new bootstrap.Modal(modalElement);
        modalElement.addEventListener('hidden.bs.modal', async () => {
            const form = document.getElementById('testRunSetForm');
            if (form) form.reset();
            const idInput = document.getElementById('testRunSetId');
            if (idInput) idInput.value = '';
            clearAllSetTpTickets();
            clearSetTpInputError();

            // 檢查是否為儲存成功後關閉
            if (window._setFormSavedSuccessfully) {
                const savedSetId = window._savedSetId;
                const shouldReopen = window._shouldReopenDetailAfterSave;
                const newSetId = window._newSetId;

                // 清除標記
                window._setFormSavedSuccessfully = false;
                window._savedSetId = null;
                window._shouldReopenDetailAfterSave = false;
                window._newSetId = null;
                reopenSetDetailAfterForm = false;

                // 根據情況重新打開 Detail Modal
                if (newSetId) {
                    // 新建：打開新建的 Set Detail
                    await openTestRunSetDetail(newSetId);
                } else if (savedSetId && shouldReopen) {
                    // 編輯：重新打開原本的 Set Detail
                    await openTestRunSetDetail(savedSetId);
                }
            } else {
                // 取消或其他情況：檢查是否需要重新打開
                if (reopenSetDetailAfterForm && currentSetContext?.id) {
                    reopenSetDetailAfterForm = false;
                    openTestRunSetDetail(currentSetContext.id);
                } else {
                    reopenSetDetailAfterForm = false;
                }
            }
        });
    }

    const form = document.getElementById('testRunSetForm');
    form.reset();
    const idInput = document.getElementById('testRunSetId');
    idInput.value = setId ? String(setId) : '';

    const titleEl = document.getElementById('testRunSetFormTitle');
    const nameInput = document.getElementById('testRunSetName');
    const descInput = document.getElementById('testRunSetDescription');

    clearAllSetTpTickets();
    initSetTpTicketInput();

    const detailModalEl = document.getElementById('testRunSetDetailModal');
    const detailInstanceVisible = detailModalEl && detailModalEl.classList.contains('show');
    if (detailInstanceVisible && testRunSetDetailModalInstance) {
        reopenSetDetailAfterForm = true;
        testRunSetDetailModalInstance.hide();
    } else {
        reopenSetDetailAfterForm = false;
    }

    if (setId) {
        const setData = (testRunSets || []).find(s => s.id === setId) || currentSetContext || null;
        titleEl.setAttribute('data-i18n', 'testRun.sets.form.editTitle');
        titleEl.textContent = window.i18n?.t('testRun.sets.form.editTitle') || '編輯 Test Run Set';
        nameInput.value = setData ? (setData.name || '') : '';
        descInput.value = setData ? (setData.description || '') : '';
        if (setData && Array.isArray(setData.related_tp_tickets)) {
            setSetTpTickets(setData.related_tp_tickets);
        }
    } else {
        titleEl.setAttribute('data-i18n', 'testRun.sets.form.createTitle');
        titleEl.textContent = window.i18n?.t('testRun.sets.form.createTitle') || '新增 Test Run Set';
    }

    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(modalElement);
    }

    testRunSetFormModalInstance.show();
}

async function handleSaveTestRunSet() {
    const form = document.getElementById('testRunSetForm');
    if (!form) return;

    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const setId = form.querySelector('#testRunSetId').value || null;
    const name = form.querySelector('#testRunSetName').value.trim();
    const description = form.querySelector('#testRunSetDescription').value.trim();

    const permissions = window._testRunPermissions || testRunPermissions || {};
    if (setId && !permissions.canUpdate) {
        showPermissionDenied();
        return;
    }
    if (!setId && !permissions.canCreate) {
        showPermissionDenied();
        return;
    }

    const payload = { name };
    if (description) {
        payload.description = description;
    }
    payload.related_tp_tickets = [...currentSetTpTickets];

    const endpoint = setId
        ? `/api/teams/${currentTeamId}/test-run-sets/${setId}`
        : `/api/teams/${currentTeamId}/test-run-sets`;
    const method = setId ? 'PUT' : 'POST';

    const saveBtn = document.getElementById('saveTestRunSetBtn');
    try {
        saveBtn.disabled = true;
        const response = await window.AuthClient.fetch(endpoint, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorPayload = await response.json().catch(() => ({ detail: null }));
            throw new Error(errorPayload?.detail || (window.i18n?.t('messages.saveFailed') || '儲存失敗'));
        }

        const data = await response.json();
        const successMsg = setId
            ? (window.i18n?.t('testRun.sets.form.updateSuccess') || 'Test Run Set 已更新')
            : (window.i18n?.t('testRun.sets.form.createSuccess') || 'Test Run Set 建立成功');
        AppUtils.showSuccess(successMsg);

        // 標記為成功儲存，之後 hidden 事件中會手動處理重新打開
        const shouldReopenDetail = reopenSetDetailAfterForm && setId;
        window._setFormSavedSuccessfully = true;
        window._savedSetId = setId;
        window._shouldReopenDetailAfterSave = shouldReopenDetail;
        window._newSetId = !setId ? data?.id : null;

        testRunSetFormModalInstance?.hide();
        await loadTestRunConfigs();
    } catch (error) {
        console.error('Save Test Run Set failed:', error);
        AppUtils.showError(error.message);
    } finally {
        saveBtn.disabled = false;
    }
}

async function openTestRunSetDetail(setId) {
    try {
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-sets/${setId}`);
        if (!response.ok) {
            const payload = await response.json().catch(() => ({ detail: null }));
            throw new Error(payload?.detail || '無法載入 Test Run Set 詳細資訊');
        }
        currentSetContext = await response.json();

        const modalElement = document.getElementById('testRunSetDetailModal');
        if (!testRunSetDetailModalInstance) {
            testRunSetDetailModalInstance = new bootstrap.Modal(modalElement);
            modalElement.addEventListener('hidden.bs.modal', () => {
                if (!preserveSetContextOnHide) {
                    currentSetContext = null;
                }
                preserveSetContextOnHide = false;
            });
        }

        renderTestRunSetDetail(currentSetContext, currentStatusFilter);

        if (window.i18n && window.i18n.isReady()) {
            window.i18n.retranslate(modalElement);
        }

        testRunSetDetailModalInstance.show();
    } catch (error) {
        console.error('Open Test Run Set detail failed:', error);
        AppUtils.showError(error.message);
    }
}

function renderTestRunSetDetail(setData, filterStatus = 'all') {
    if (!setData) return;

    const titleEl = document.getElementById('testRunSetDetailTitle');
    const descEl = document.getElementById('testRunSetDetailDescription');
    const statusEl = document.getElementById('testRunSetDetailStatus');
    const metaEl = document.getElementById('testRunSetDetailMeta');
    const actionsContainer = document.getElementById('testRunSetDetailActions');
    const runsContainer = document.getElementById('testRunSetRunsContainer');

    titleEl.textContent = setData.name || '';

    if (setData.description) {
        descEl.innerHTML = escapeHtml(setData.description).replace(/\n/g, '<br>');
    } else {
        descEl.innerHTML = '<span class="text-muted" data-i18n="testRun.sets.detail.noDescription">尚未填寫描述</span>';
    }

    statusEl.innerHTML = getSetStatusBadge(setData.status);

    const metrics = summarizeSetMetrics(setData.test_runs || []);
    const metaText = `${window.i18n?.t('testRun.sets.detail.totalRuns') || 'Test Run 數'}: ${setData.test_runs?.length || 0} · ${window.i18n?.t('testRun.sets.detail.totalCases') || '總案例'}: ${metrics.totalCases}`;
    metaEl.textContent = metaText;
    renderSetDetailTpTags(setData.related_tp_tickets || []);

    const perms = window._testRunPermissions || testRunPermissions || {};

    const createBtn = document.getElementById('setDetailCreateConfigBtn');
    const addExistingBtn = document.getElementById('setDetailAddExistingBtn');
    const editBtn = document.getElementById('setDetailEditBtn');
    const archiveBtn = document.getElementById('setDetailArchiveBtn');
    const reportBtn = document.getElementById('setDetailReportBtn');
    const deleteBtn = document.getElementById('setDetailDeleteBtn');

    setElementVisibility('setDetailCreateConfigBtn', perms.canCreate);
    setElementVisibility('setDetailAddExistingBtn', perms.canCreate);
    setElementVisibility('setDetailEditBtn', perms.canUpdate);
    setElementVisibility('setDetailArchiveBtn', perms.canUpdate);
    setElementVisibility('setDetailReportBtn', true);
    setElementVisibility('setDetailDeleteBtn', perms.canDelete);

    if (createBtn) {
        createBtn.disabled = setData.status === 'archived' || !perms.canCreate;
        createBtn.onclick = () => openConfigFormModal(null, { setId: setData.id });
    }

    if (addExistingBtn) {
        addExistingBtn.disabled = setData.status === 'archived' || !perms.canCreate;
        addExistingBtn.onclick = () => openAddExistingToSetModal(setData);
    }

    if (editBtn) {
        editBtn.disabled = !perms.canUpdate;
        editBtn.onclick = () => openTestRunSetFormModal(setData.id);
    }

    if (archiveBtn) {
        archiveBtn.disabled = !perms.canUpdate;
        if (setData.status === 'archived') {
            archiveBtn.innerHTML = '<i class="fas fa-undo me-1"></i><span data-i18n="testRun.sets.detail.unarchive">取消 Archive</span>';
            archiveBtn.onclick = () => toggleArchiveTestRunSet(setData, 'active');
        } else {
            archiveBtn.innerHTML = '<i class="fas fa-archive me-1"></i><span data-i18n="testRun.sets.detail.archive">Archive</span>';
            archiveBtn.onclick = () => toggleArchiveTestRunSet(setData, 'archived');
        }
    }

    if (reportBtn) {
        reportBtn.disabled = false;
        reportBtn.onclick = () => openTestRunSetReport(setData);
    }

    if (deleteBtn) {
        deleteBtn.disabled = !perms.canDelete;
        const newDeleteBtn = deleteBtn.cloneNode(true);
        deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);

        newDeleteBtn.addEventListener('click', () => {
            const deleteModalEl = document.getElementById('deleteTestRunSetModal');
            if (deleteModalEl) {
                const deleteModal = new bootstrap.Modal(deleteModalEl);
                const confirmBtn = document.getElementById('confirmDeleteTestRunSetBtn');
                
                const handleConfirm = () => {
                    deleteTestRunSet(setData.id);
                    deleteModal.hide();
                };
                
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                newConfirmBtn.addEventListener('click', handleConfirm);
                
                deleteModal.show();
            } else if (confirm(window.i18n ? window.i18n.t('testRun.sets.deleteConfirm') : '確定要刪除此 Test Run Set 嗎？此操作將刪除其下所有 Test Run，且無法復原。')) {
                deleteTestRunSet(setData.id);
            }
        });
    }

    const runs = filterTestRunsByStatus(setData.test_runs || [], filterStatus);
    if (!runs.length) {
        const emptyKey = filterStatus === 'all' ? 'testRun.sets.detail.noRuns' : 'testRun.sets.detail.noFilterMatches';
        const fallbackText = filterStatus === 'all' ? '尚未加入任何 Test Run' : '目前沒有符合篩選條件的 Test Run';
        runsContainer.innerHTML = `
            <div class="text-center text-muted py-4" data-i18n="${emptyKey}">
                ${fallbackText}
            </div>
        `;
    } else {
        runsContainer.innerHTML = runs.map(run => buildSetRunDetailRow(run, setData)).join('');
    }

    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(actionsContainer);
        window.i18n.retranslate(runsContainer);
    }
}

function buildSetRunDetailRow(run, setData) {
    const statusClass = getStatusClass(run.status);
    const statusText = getStatusText(run.status);
    const metricsText = `${run.executed_cases || 0}/${run.total_test_cases || 0}`;
    const createdText = run.created_at ? AppUtils.formatDate(run.created_at, 'datetime') : '';
    const otherSets = (testRunSets || []).filter(s => s.id !== setData.id);
    const perms = window._testRunPermissions || testRunPermissions || {};
    const moveLabel = window.i18n?.t('testRun.sets.detail.moveToOther') || '搬移至其他 Set';
    const moveDropdown = (perms.canUpdate && otherSets.length > 0) ? `
        <div class="dropdown" onclick="event.stopPropagation()">
            <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-random me-1"></i><span data-i18n="testRun.sets.detail.moveToOther">${escapeHtml(moveLabel)}</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                ${otherSets.map(s => `
                    <li>
                        <button class="dropdown-item" type="button" onclick="event.stopPropagation(); moveTestRunToSet(${run.id}, ${s.id});">
                            ${escapeHtml(s.name)}
                        </button>
                    </li>
                `).join('')}
            </ul>
        </div>
    ` : '';

    const lockedForConfigEdit = run.status === 'completed' || run.status === 'archived';
    const lockedForCasesEdit = run.status === 'completed';
    const lockedConfigMessage = (window.i18n && window.i18n.isReady())
        ? window.i18n.t('testRun.cannotEditCompleted')
        : '已完成或已歸檔的 Test Run 不可編輯';
    const lockedCasesMessage = (window.i18n && window.i18n.isReady())
        ? window.i18n.t('testRun.cannotEditCompleted')
        : '已完成的 Test Run 不可編輯 Test Case';
    const lockedConfigTitle = lockedForConfigEdit ? ` title="${escapeHtml(lockedConfigMessage)}"` : '';
    const lockedCasesTitle = (lockedForConfigEdit || lockedForCasesEdit) ? ` title="${escapeHtml(lockedCasesMessage)}"` : '';

    const primaryActionButtons = [];
    const secondaryActionButtons = [];

    primaryActionButtons.push(`
        <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); enterTestRun(${run.id})">
            <i class="fas fa-arrow-right me-1"></i><span data-i18n="testRun.enterButton">進入</span>
        </button>
    `);

    if (perms.canUpdate) {
        primaryActionButtons.push(`
            <button class="btn btn-sm btn-secondary${lockedForConfigEdit ? ' disabled' : ''}" ${lockedForConfigEdit ? 'disabled' : ''}${lockedConfigTitle}
                    onclick="event.stopPropagation(); editBasicSettings(${run.id})">
                <i class="fas fa-edit me-1"></i><span data-i18n="testRun.editBasicSettings">編輯基本設定</span>
            </button>
        `);

        primaryActionButtons.push(`
            <button class="btn btn-sm btn-info${(lockedForConfigEdit || lockedForCasesEdit) ? ' disabled' : ''}" ${(lockedForConfigEdit || lockedForCasesEdit) ? 'disabled' : ''}${lockedCasesTitle}
                    onclick="event.stopPropagation(); editTestCases(${run.id})">
                <i class="fas fa-list me-1"></i><span data-i18n="testRun.editTestCases">編輯 Test Case</span>
            </button>
        `);
    }

    if (perms.canChangeStatus) {
        secondaryActionButtons.push(`
            <div class="position-relative" onclick="event.stopPropagation()">
                <button type="button" class="btn btn-sm btn-warning custom-status-btn"
                        data-config-id="${run.id}"
                        onclick="event.stopPropagation(); toggleCustomStatusDropdown(this, ${run.id})">
                    <i class="fas fa-exchange-alt me-1"></i><span data-i18n="testRun.changeStatus">狀態</span>
                    <i class="fas fa-chevron-down ms-1"></i>
                </button>
            </div>
        `);
    }

    if (perms.canUpdate) {
        secondaryActionButtons.push(`
            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); removeTestRunFromSet(${run.id}, '${escapeHtml(run.name)}')">
                <i class="fas fa-unlink me-1"></i><span data-i18n="testRun.sets.detail.remove">移出 Test Run Set</span>
            </button>
        `);
    }

    if (perms.canDelete) {
        secondaryActionButtons.push(`
            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteTestRun(${run.id}, '${escapeHtml(run.name)}')">
                <i class="fas fa-trash me-1"></i><span data-i18n="common.delete">刪除</span>
            </button>
        `);
    }

    if (moveDropdown) {
        secondaryActionButtons.unshift(moveDropdown);
    }

    const actionsHtml = (() => {
        const merged = [...primaryActionButtons, ...secondaryActionButtons];
        if (!merged.length) return '';
        return `<div class="testRunDetailRunActions">${merged.join('')}</div>`;
    })();

    return `
        <div class="card mb-3">
            <div class="card-body">
                <!-- Test Run 名稱 -->
                <h6 class="mb-2 text-primary">${escapeHtml(run.name)}</h6>
                <!-- Test Run 狀態資訊 -->
                <div class="mb-3 small">
                    <div class="d-flex gap-2 align-items-center flex-wrap">
                        <span class="status-badge ${statusClass}">${statusText}</span>
                        <span class="text-muted"><i class="fas fa-list-ul me-1"></i>${metricsText}</span>
                        ${createdText ? `<span class="text-muted"><i class="fas fa-clock me-1\"></i>${createdText}</span>` : ''}
                    </div>
                </div>
                <!-- 按鈕區域 -->
                ${actionsHtml || ''}
            </div>
        </div>
    `;
}

function openAddExistingToSetModal(setData) {
    if (!addExistingToSetModalInstance) {
        const modalEl = document.getElementById('addExistingToSetModal');
        addExistingToSetModalInstance = new bootstrap.Modal(modalEl);
    }

    const listContainer = document.getElementById('addExistingToSetList');
    const emptyHint = document.getElementById('addExistingToSetEmpty');
    const confirmBtn = document.getElementById('confirmAddExistingToSetBtn');
    listContainer.innerHTML = '';

    const availableRuns = Array.isArray(unassignedTestRuns) ? unassignedTestRuns : [];
    if (!availableRuns.length) {
        emptyHint.style.display = 'block';
        confirmBtn.disabled = true;
    } else {
        emptyHint.style.display = 'none';
        confirmBtn.disabled = false;
        listContainer.innerHTML = availableRuns.map(run => `
            <label class="list-group-item d-flex align-items-center justify-content-between">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="${run.id}" id="add-existing-${run.id}">
                    <label class="form-check-label" for="add-existing-${run.id}">
                        <strong>${escapeHtml(run.name)}</strong>
                        <div class="small text-muted">${getStatusText(run.status)} · ${run.executed_cases || 0}/${run.total_test_cases || 0}</div>
                    </label>
                </div>
            </label>
        `).join('');
    }

    const modalEl = document.getElementById('addExistingToSetModal');
    modalEl.dataset.targetSetId = String(setData.id);

    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(modalEl);
    }

    addExistingToSetModalInstance.show();
}

async function confirmAddExistingToSet() {
    const modalEl = document.getElementById('addExistingToSetModal');
    const targetSetId = parseInt(modalEl.dataset.targetSetId || '0', 10);
    if (!targetSetId) {
        addExistingToSetModalInstance.hide();
        return;
    }

    const selected = Array.from(document.querySelectorAll('#addExistingToSetList input[type="checkbox"]:checked'))
        .map(input => parseInt(input.value, 10));

    if (!selected.length) {
        AppUtils.showWarning(window.i18n?.t('testRun.sets.addExisting.selectWarning') || '請至少選擇一個 Test Run');
        return;
    }

    try {
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-sets/${targetSetId}/members`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ config_ids: selected })
        });

        if (!response.ok) {
            const payload = await response.json().catch(() => ({ detail: null }));
            throw new Error(payload?.detail || '加入既有 Test Run 失敗');
        }

        addExistingToSetModalInstance.hide();
        AppUtils.showSuccess(window.i18n?.t('testRun.sets.addExisting.success') || '已將選定的 Test Run 加入 Set');
        await loadTestRunConfigs();
        await refreshCurrentSetDetail();
    } catch (error) {
        console.error('Add existing Test Run failed:', error);
        AppUtils.showError(error.message);
    }
}

async function moveTestRunToSet(configId, targetSetId) {
    try {
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-sets/members/${configId}/move`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ target_set_id: targetSetId })
        });

        if (!response.ok) {
            const payload = await response.json().catch(() => ({ detail: null }));
            throw new Error(payload?.detail || '搬移 Test Run 失敗');
        }

        const targetName = targetSetId
            ? (testRunSets.find(s => s.id === targetSetId)?.name || '其他 Set')
            : (window.i18n?.t('testRun.sets.moveToUnassigned') || '未歸組 Test Run');
        AppUtils.showSuccess(`${window.i18n?.t('testRun.sets.moveSuccess') || '搬移成功'}：${targetName}`);

        await loadTestRunConfigs();
        await refreshCurrentSetDetail();
    } catch (error) {
        console.error('Move Test Run between sets failed:', error);
        AppUtils.showError(error.message);
    }
}

async function removeTestRunFromSet(configId, configName) {
    const confirmed = await AppUtils.showConfirm(window.i18n?.t('testRun.sets.removeConfirm', { name: configName }) || `確定要將 ${configName} 移出目前的 Test Run Set？`);
    if (!confirmed) return;
    await moveTestRunToSet(configId, null);
}

async function toggleArchiveTestRunSet(setData, targetStatus) {
    try {
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-sets/${setData.id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: targetStatus })
        });

        if (!response.ok) {
            const payload = await response.json().catch(() => ({ detail: null }));
            throw new Error(payload?.detail || '更新狀態失敗');
        }

        const successMsg = targetStatus === 'archived'
            ? (window.i18n?.t('testRun.sets.archiveSuccess') || 'Test Run Set 已 Archive')
            : (window.i18n?.t('testRun.sets.unarchiveSuccess') || 'Test Run Set 已啟用');
        AppUtils.showSuccess(successMsg);

        await loadTestRunConfigs();
        await refreshCurrentSetDetail();
    } catch (error) {
        console.error('Toggle archive Test Run Set failed:', error);
        AppUtils.showError(error.message);
    }
}

async function deleteTestRunSet(setId) {
    const currentTeamId = AppUtils.getCurrentTeamId();
    if (!currentTeamId) {
        console.error('No team selected');
        return;
    }

    try {
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-sets/${setId}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            const payload = await response.json().catch(() => ({ detail: null }));
            throw new Error(payload?.detail || '刪除失敗');
        }

        AppUtils.showSuccess(window.i18n?.t('testRun.sets.deleteSuccess') || 'Test Run Set 已刪除');
        
        // Close modals if open
        const deleteModalEl = document.getElementById('deleteTestRunSetModal');
        if (deleteModalEl) {
            const modal = bootstrap.Modal.getInstance(deleteModalEl);
            if (modal) modal.hide();
        }
        
        // Close detail modal if open
        if (testRunSetDetailModalInstance) {
            testRunSetDetailModalInstance.hide();
        }

        await loadTestRunConfigs();
    } catch (error) {
        console.error('Delete Test Run Set failed:', error);
        AppUtils.showError(error.message);
    }
}

async function confirmDeleteTestRunSet(setData) {
    const confirmed = await AppUtils.showConfirm(window.i18n?.t('testRun.sets.deleteConfirm', { name: setData.name }) || `確定要刪除「${setData.name}」以及底下的所有 Test Run？`);
    if (!confirmed) return;

    try {
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-sets/${setData.id}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            const payload = await response.json().catch(() => ({ detail: null }));
            throw new Error(payload?.detail || '刪除失敗');
        }

        AppUtils.showSuccess(window.i18n?.t('testRun.sets.deleteSuccess') || 'Test Run Set 已刪除');
        testRunSetDetailModalInstance?.hide();
        await loadTestRunConfigs();
    } catch (error) {
        console.error('Delete Test Run Set failed:', error);
        AppUtils.showError(error.message);
    }
}

async function refreshCurrentSetDetail() {
    const modalEl = document.getElementById('testRunSetDetailModal');
    if (!modalEl || !modalEl.classList.contains('show') || !currentSetContext) {
        return;
    }

    try {
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-sets/${currentSetContext.id}`);
        if (!response.ok) {
            throw new Error('Refresh failed');
        }
        currentSetContext = await response.json();
        renderTestRunSetDetail(currentSetContext, currentStatusFilter);
        if (window.i18n && window.i18n.isReady()) {
            window.i18n.retranslate(modalEl);
        }
    } catch (error) {
        console.warn('Refresh Test Run Set detail failed:', error);
    }
}

function showConfigDetails(configId) {
    const config = testRunConfigs.find(c => c.id === configId);
    if (!config) return;

    const modalElement = document.getElementById('configDetailModal');
    if (!configDetailModalInstance) {
        configDetailModalInstance = new bootstrap.Modal(modalElement);
    }
    
    document.getElementById('configDetailTitle').textContent = config.name;
    document.getElementById('configDetailContent').innerHTML = createConfigDetailContent(config);
    
    // 手動觸發翻譯處理動態插入的內容
    if (window.i18n && window.i18n.isReady()) {
        const detailContent = document.getElementById('configDetailContent');
        window.i18n.retranslate(detailContent);
    }
    
    const deleteBtn = document.getElementById('deleteConfigBtn');
    deleteBtn.setAttribute('data-config-id', configId);
    deleteBtn.onclick = handleDeleteConfig;

    const editBtn = document.getElementById('editConfigBtn');
    editBtn.setAttribute('data-config-id', configId);
    editBtn.onclick = handleEditConfig;

    const permissions = window._testRunPermissions || testRunPermissions || {};
    setElementVisibility('editConfigBtn', permissions.canUpdate);
    setElementVisibility('deleteConfigBtn', permissions.canDelete);
    
    configDetailModalInstance.show();
}

function handleEditConfig(event) {
    const permissions = window._testRunPermissions || testRunPermissions || {};
    if (!permissions.canUpdate) {
        showPermissionDenied();
        return;
    }
    const configId = parseInt(event.currentTarget.getAttribute('data-config-id'));
    if (configDetailModalInstance) {
        configDetailModalInstance.hide();
    }
    setTimeout(() => {
        openConfigFormModal(configId);
    }, 150);
}

async function handleDeleteConfig(event) {
    const permissions = window._testRunPermissions || testRunPermissions || {};
    if (!permissions.canDelete) {
        showPermissionDenied();
        return;
    }

    const configId = event.currentTarget.getAttribute('data-config-id');
    const config = testRunConfigs.find(c => c.id === parseInt(configId));
    if (!config) return;
    // Show custom modal
    const modal = document.getElementById('deleteConfigModal');
    const msgEl = document.getElementById('deleteConfirmMessage');
    msgEl.textContent = window.i18n ? window.i18n.t('testRun.confirmDelete', { name: escapeHtml(config.name) }) : `您確定要刪除 Test Run 配置 "${escapeHtml(config.name)}" 嗎？此操作無法復原。`;
    const inst = bootstrap.Modal.getOrCreateInstance(modal);
    // Rebind confirm handler
    const btnOld = document.getElementById('confirmDeleteConfigBtn');
    const btnNew = btnOld.cloneNode(true);
    btnOld.parentNode.replaceChild(btnNew, btnOld);
    document.getElementById('confirmDeleteConfigBtn').addEventListener('click', async () => {
        try {
            const resp = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${configId}`, { method: 'DELETE' });
            if (resp.ok || resp.status === 204) {
                if (configDetailModalInstance) configDetailModalInstance.hide();
                inst.hide();
                const successMsg = window.i18n ? window.i18n.t('testRun.deleteSuccess', { name: config.name }) : `成功刪除 "${config.name}"`;
                AppUtils.showSuccess(successMsg);
                await loadTestRunConfigs();
            } else {
                let detail = '';
                try {
                    const text = await resp.text();
                    try { detail = JSON.parse(text).detail || text; } catch { detail = text; }
                } catch { detail = ''; }
                const fallbackMsg = window.i18n ? window.i18n.t('messages.deleteFailed') : '刪除失敗';
                throw new Error(detail || fallbackMsg);
            }
        } catch (error) {
            console.error('Error deleting Test Run configuration:', error);
            const errorMsg = window.i18n ? window.i18n.t('messages.deleteFailed') : '刪除失敗';
            AppUtils.showError(`${errorMsg}: ${error.message}`);
        }
    });
    if (window.i18n && window.i18n.isReady()) window.i18n.retranslate(modal);
    inst.show();
}

function createConfigDetailContent(config) {
    return `
        <div class="row">
            <div class="col-md-6">
                <h6 data-i18n="testRun.configBasicInfo">基本資訊</h6>
                <table class="table table-sm">
                    <tr><td data-i18n="testRun.configNameLabel">名稱</td><td>${escapeHtml(config.name)}</td></tr>
                    <tr><td data-i18n="testRun.testEnvironment">測試環境</td><td>${escapeHtml(config.test_environment || '')}</td></tr>
                    <tr><td data-i18n="testRun.buildNumber">建置版本</td><td>${escapeHtml(config.build_number || '')}</td></tr>
                    <tr><td data-i18n="testRun.configStatusLabel">狀態</td><td><span class="status-badge ${getStatusClass(config.status)}">${getStatusText(config.status)}</span></td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 data-i18n="testRun.configStatsInfo">統計資訊</h6>
                <table class="table table-sm">
                    <tr><td data-i18n="testRun.configTotalCasesLabel">總測試案例</td><td>${config.total_test_cases}</td></tr>
                    <tr><td data-i18n="testRun.configExecutedLabel">已執行</td><td>${config.executed_cases}</td></tr>
                    <tr><td data-i18n="testRun.configExecutionRateLabel">執行率</td><td>${config.execution_rate.toFixed(1)}%</td></tr>
                    <tr><td data-i18n="testRun.configPassRateLabel">Pass Rate</td><td>${config.pass_rate.toFixed(1)}%</td></tr>
                    <tr><td data-i18n="testRun.configCreatedLabel">建立時間</td><td>${AppUtils.formatDate(config.created_at, 'datetime-tz')}</td></tr>
                </table>
            </div>
        </div>
        ${config.description ? `
            <div class="mt-3">
                <h6 data-i18n="common.description">描述</h6>
                <p class="text-muted">${escapeHtml(config.description)}</p>
            </div>
        ` : ''}
    `;
}

function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

function updatePageTitle() {
    const pageTitle = window.i18n ? window.i18n.t('testRun.management') : '測試執行管理';
    const siteTitle = window.i18n ? window.i18n.t('navigation.title') : 'Test Case Repository';
    document.title = `${pageTitle} - ${siteTitle} Web Tool`;
}

// Test Run entry function
function enterTestRun(configId) {
    const config = testRunConfigs.find(c => c.id === configId);
    if (!config) {
        console.error('Test Run configuration not found:', configId);
        AppUtils.showError(window.i18n ? window.i18n.t('testRun.notFound') : '找不到測試執行配置');
        return;
    }
    
    // 導向 Test Run 執行頁面
    window.location.href = `/test-run-execution?config_id=${configId}`;
}

document.addEventListener('i18nReady', updatePageTitle);
document.addEventListener('languageChanged', updatePageTitle);

// ---- Test Case 選擇流程 ----
let caseSelectModalInstance = null;
let currentSelectingConfigId = null;
let availableCases = [];
let selectedCaseMap = new Map(); // key: test_case_number, value: case object
let pendingCreate = false; // true only for newly created config awaiting items
let createdItemsInSession = false; // set true when items are created
let modalMode = 'create'; // 'create' | 'edit'
let existingItemIdByCaseNumber = new Map(); // for edit mode: case_number -> item_id
let currentCaseFilter = 'all'; // 'all' | 'selected' | 'unselected'
let isPreselectedFromTestCaseSet = false; // 標記是否從 Test Case Set 預選的流程
let currentSetIdForCaseSelection = null; // 限定同一 Test Case Set，避免跨 Set
let currentSectionFilterId = null; // 依 Section 過濾
let currentSectionTree = [];
let sectionTreeContainer = null;
let caseSelectData = { sections: [], testCases: [], filteredCases: [], selectedCaseIds: new Set() };

function renderSectionTree() {
  renderCaseSelectList();
}

function renderTestCaseSetOptions(defaultId = null) {
  const configSelect = document.getElementById('testCaseSetSelector');
  const modalSelect = document.getElementById('caseSelectTestCaseSet');
  const sets = Array.isArray(testCaseSets) ? testCaseSets : [];
  const placeholder = (window.i18n && window.i18n.isReady())
    ? (window.i18n.t('testRun.sets.selectSetPlaceholder') || '請選擇 Test Case Set')
    : '請選擇 Test Case Set';

  const buildOptions = (target, hiddenInput, selectedId) => {
    if (!target) return;
    let options = `<option value="" disabled ${selectedId ? '' : 'selected'}>${escapeHtml(placeholder)}</option>`;
    sets.forEach(set => {
      const selected = selectedId && String(selectedId) === String(set.id) ? 'selected' : '';
      options += `<option value="${escapeHtml(String(set.id))}" ${selected}>${escapeHtml(set.name || `Set #${set.id}`)}</option>`;
    });
    target.innerHTML = options;
    if (selectedId) target.value = String(selectedId);
    if (hiddenInput) hiddenInput.value = target.value || '';
  };

  buildOptions(configSelect, document.getElementById('configTestCaseSetId'), defaultId);
  buildOptions(modalSelect, null, currentSetIdForCaseSelection || defaultId);

  if (configSelect) {
    configSelect.onchange = () => {
      const val = configSelect.value || '';
      document.getElementById('configTestCaseSetId').value = val;
      currentSetIdForCaseSelection = val ? parseInt(val, 10) : null;
      if (modalSelect && val) modalSelect.value = val;
    };
  }
  if (modalSelect) {
    modalSelect.onchange = () => {
      currentSetIdForCaseSelection = modalSelect.value ? parseInt(modalSelect.value, 10) : null;
      if (configSelect && modalSelect.value) {
        configSelect.value = modalSelect.value;
        document.getElementById('configTestCaseSetId').value = modalSelect.value;
      }
      if (caseSelectModalInstance && modalSelect.value) {
        loadTeamTestCases(document.getElementById('caseSearchInput').value || '');
      }
    };
  }
}

async function loadTestCaseSets() {
  if (!currentTeamId) return;
  try {
    const resp = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-case-sets`);
    if (resp.ok) {
      testCaseSets = await resp.json();
    } else {
      testCaseSets = [];
    }
  } catch (e) {
    console.warn('loadTestCaseSets failed', e);
    testCaseSets = [];
  }
}

async function loadSectionTreeForCurrentSet() {
  if (!currentSetIdForCaseSelection) {
    currentSectionTree = [];
    renderSectionTree();
    return;
  }
  try {
    const resp = await window.AuthClient.fetch(`/api/test-case-sets/${currentSetIdForCaseSelection}/sections`);
    if (resp.ok) {
      currentSectionTree = await resp.json();
    } else {
      currentSectionTree = [];
    }
  } catch (e) {
    console.warn('loadSectionTreeForCurrentSet failed', e);
    currentSectionTree = [];
  }
  renderSectionTree();
}

async function loadCaseSelectData() {
  if (!currentSetIdForCaseSelection) return;
  try {
    const sectionsResp = await window.AuthClient.fetch(`/api/test-case-sets/${currentSetIdForCaseSelection}/sections`);
    if (sectionsResp.ok) {
      caseSelectData.sections = await sectionsResp.json();
      currentSectionTree = caseSelectData.sections;
    } else {
      caseSelectData.sections = [];
      currentSectionTree = [];
    }
    const casesResp = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/testcases?set_id=${currentSetIdForCaseSelection}&limit=10000`);
    if (casesResp.ok) {
      caseSelectData.testCases = await casesResp.json();
    } else {
      caseSelectData.testCases = [];
    }
    caseSelectData.filteredCases = caseSelectData.testCases;
    availableCases = caseSelectData.testCases; // 兼容既有流程

    // 套用預選（從 Test Case Set 卡片）
    if (window._preselectedCaseIds && window._preselectedCaseIds.size > 0) {
      isPreselectedFromTestCaseSet = true;
      for (const c of caseSelectData.testCases) {
        const caseId = c.record_id || c.id;
        if (window._preselectedCaseIds.has(caseId)) {
          selectedCaseMap.set(c.test_case_number, c);
        }
      }
      window._preselectedCaseIds = null;
    }
  } catch (e) {
    console.warn('loadCaseSelectData failed', e);
    caseSelectData.sections = [];
    caseSelectData.testCases = [];
    caseSelectData.filteredCases = [];
    availableCases = [];
  }
}

// Removed confirmation step; open modal directly and rely on hidden handler for rollback
function openCaseSelectModalWithConfirm(configId) {
  pendingCreate = true;
  createdItemsInSession = false;
  modalMode = 'create';
  openCaseSelectModal(configId);
}

async function openCaseSelectModal(configId) {
  const permissions = window._testRunPermissions || testRunPermissions || {};
  if (modalMode === 'edit' && !permissions.canUpdate) {
    showPermissionDenied();
    return;
  }
  if (modalMode !== 'edit' && !permissions.canCreate) {
    showPermissionDenied();
    return;
  }

  if (!currentSetIdForCaseSelection) {
    const formSetVal = document.getElementById('configTestCaseSetId')?.value;
    if (formSetVal) currentSetIdForCaseSelection = parseInt(formSetVal, 10);
  }
  if (!currentSetIdForCaseSelection) {
    const cfg = testRunConfigs.find(c => c.id === configId);
    if (cfg && cfg.set_id) {
      currentSetIdForCaseSelection = cfg.set_id;
    }
  }
  if (!currentSetIdForCaseSelection) {
    const warn = window.i18n ? (window.i18n.t('testRun.sets.selectSetFirst') || '請先選擇一個 Test Case Set') : '請先選擇一個 Test Case Set';
    AppUtils.showWarning(warn);
    return;
  }

  currentSelectingConfigId = configId;
  const modalEl = document.getElementById('caseSelectModal');
  if (!caseSelectModalInstance) caseSelectModalInstance = new bootstrap.Modal(modalEl);
  if (!testCaseSets.length && currentTeamId) {
    await loadTestCaseSets();
    renderTestCaseSetOptions(currentSetIdForCaseSelection);
  }
  await loadCaseSelectData();
  // reset
    if (modalMode === 'create') {
      existingItemIdByCaseNumber.clear();
      // 若沒有預選，保持空集合；有預選則保留 loadCaseSelectData 套用的選取
      if (!isPreselectedFromTestCaseSet) {
        selectedCaseMap.clear();
      }
    } else {
      // 編輯模式
      isPreselectedFromTestCaseSet = false;
    }
  document.getElementById('selectedCount').textContent = String(selectedCaseMap.size || 0);
  document.getElementById('caseListContainer').innerHTML = `
    <div class="text-center text-muted py-4">
      <div class="spinner-border spinner-border-sm" role="status">
        <span class="visually-hidden" data-i18n="common.loading">載入中...</span>
      </div>
    </div>`;
  const searchInput = document.getElementById('caseSearchInput');
  if (searchInput) searchInput.value = '';
  const infoEl = document.getElementById('caseSelectInfo');
  if (infoEl) infoEl.textContent = '';
  currentCaseFilter = 'all';
  // set modal title and confirm button text/handler per mode
  const titleSpan = modalEl.querySelector('.modal-title [data-i18n]');
  if (titleSpan) {
    if (modalMode === 'edit') {
      titleSpan.setAttribute('data-i18n', 'testRun.caseSelect.editTitle');
      titleSpan.textContent = (window.i18n && window.i18n.isReady()) ? window.i18n.t('testRun.caseSelect.editTitle') : '新增／修改 Test Case';
    } else {
      titleSpan.setAttribute('data-i18n', 'testRun.caseSelect.title');
      titleSpan.textContent = (window.i18n && window.i18n.isReady()) ? window.i18n.t('testRun.caseSelect.title') : '選擇要加入的 Test Case';
    }
  }
  const confirmBtn = document.getElementById('confirmCreateItemsBtn');
  const confirmTextSpan = confirmBtn.querySelector('span');
  if (modalMode === 'edit') {
    confirmTextSpan.setAttribute('data-i18n', 'common.update');
    confirmTextSpan.textContent = (window.i18n && window.i18n.isReady()) ? window.i18n.t('common.update') : '更新';
  } else {
    confirmTextSpan.setAttribute('data-i18n', 'common.create');
    confirmTextSpan.textContent = (window.i18n && window.i18n.isReady()) ? window.i18n.t('common.create') : '建立';
  }
  const newBtn = confirmBtn.cloneNode(true);
  confirmBtn.parentNode.replaceChild(newBtn, confirmBtn);
  document.getElementById('confirmCreateItemsBtn').addEventListener('click', async () => {
    if (modalMode === 'edit') {
      await saveEditedItems();
    } else {
      await createItemsFromSelection();
    }
  });
  const detailModalEl = document.getElementById('testRunSetDetailModal');
  const detailWasOpen = detailModalEl && detailModalEl.classList.contains('show');
  if (detailWasOpen && testRunSetDetailModalInstance) {
    preserveSetContextOnHide = true;
    testRunSetDetailModalInstance.hide();
    reopenSetDetailAfterCaseModal = true;
  } else {
    reopenSetDetailAfterCaseModal = false;
  }
  caseSelectModalInstance.show();
  // ensure we bind a one-time hide handler for rollback if pending
  const modalDom = document.getElementById('caseSelectModal');
  // Remove previous listener if any by cloning (simple way to avoid multiple bindings)
  modalDom.addEventListener('hidden.bs.modal', async function onHidden() {
    // This will be called whenever modal hides. If pending and no items created, rollback
    if (pendingCreate && !createdItemsInSession && currentSelectingConfigId) {
      try {
        await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentSelectingConfigId}`, { method: 'DELETE' });
        const warnMsg = window.i18n ? window.i18n.t('testRun.configDeletedDueToCancel') : '已取消選擇，設定已刪除';
        AppUtils.showInfo(warnMsg);
        await loadTestRunConfigs();
      } catch (e) {
        AppUtils.showError((window.i18n ? window.i18n.t('messages.deleteFailed') : '刪除失敗') + `: ${e.message}`);
      } finally {
        pendingCreate = false;
        createdItemsInSession = false;
        currentSelectingConfigId = null;
      }
    } else {
      // Clear flags when modal hides in any case
      pendingCreate = false;
      createdItemsInSession = false;
      currentSelectingConfigId = null;
    }
    if (reopenSetDetailAfterCaseModal && testRunSetDetailModalInstance) {
      testRunSetDetailModalInstance.show();
    }
    reopenSetDetailAfterCaseModal = false;
    isPreselectedFromTestCaseSet = false;
    // remove this handler after execution
    modalDom.removeEventListener('hidden.bs.modal', onHidden);
  }, { once: true });
  // load first page (資料已載入，僅渲染)
  renderCaseSelectList();
  if (window.i18n && window.i18n.isReady()) window.i18n.retranslate(document.getElementById('caseSelectModal'));
  // bind search/clear once per open
  bindCaseSearchBarEvents();
}

// 在卡片上提供「編輯基本設定」
function editBasicSettings(configId) {
  const permissions = window._testRunPermissions || testRunPermissions || {};
  if (!permissions.canUpdate) {
    showPermissionDenied();
    return;
  }
  // 檢查 Test Run 狀態，已完成或已歸檔的不允許編輯
  const config = testRunConfigs.find(c => c.id === configId);
  if (config && (config.status === 'completed' || config.status === 'archived')) {
    const completedEditMsg = window.i18n && window.i18n.isReady() 
      ? window.i18n.t('testRun.cannotEditCompleted')
      : '已完成或已歸檔的 Test Run 不可編輯';
    AppUtils.showWarning(completedEditMsg);
    return;
  }
  openConfigFormModal(configId);
}

// 在卡片上提供「編輯 Test Case」
async function editTestCases(configId) {
  const permissions = window._testRunPermissions || testRunPermissions || {};
  if (!permissions.canUpdate) {
    showPermissionDenied();
    return;
  }
  // 檢查 Test Run 狀態，已完成的不允許編輯
  const config = testRunConfigs.find(c => c.id === configId);
  if (config && config.status === 'completed') {
    const completedEditMsg = window.i18n && window.i18n.isReady() 
      ? window.i18n.t('testRun.cannotEditCompleted')
      : '已完成的 Test Run 不可編輯 Test Case';
    AppUtils.showWarning(completedEditMsg);
    return;
  }
  try {
    modalMode = 'edit';
    pendingCreate = false;
    createdItemsInSession = false;
    currentSelectingConfigId = configId;
    // 讀取現有 items，預設勾選
    const resp = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${configId}/items?limit=10000`);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const items = await resp.json();

    // 嘗試從現有項目中推斷 Test Case Set ID
    let deducedSetId = null;
    if (items && items.length > 0) {
        deducedSetId = items[0].test_case_set_id;
    }

    // 設定 currentSetIdForCaseSelection
    // 優先順序: 從項目推斷 > Config 的 set_id
    currentSetIdForCaseSelection = deducedSetId || (config?.set_id ?? null);

    if (!currentSetIdForCaseSelection) {
        const warn = window.i18n ? (window.i18n.t('testRun.sets.selectSetFirst') || '請先選擇一個 Test Case Set') : '請先選擇一個 Test Case Set';
        AppUtils.showWarning(warn);
        return;
    }

    selectedCaseMap.clear();
    existingItemIdByCaseNumber.clear();
    for (const it of items) {
      existingItemIdByCaseNumber.set(it.test_case_number, it.id);
      selectedCaseMap.set(it.test_case_number, { test_case_number: it.test_case_number, title: it.title, priority: it.priority });
    }
    openCaseSelectModal(configId);
  } catch (e) {
    AppUtils.showError((window.i18n ? window.i18n.t('messages.loadFailed') : '載入失敗') + `: ${e.message}`);
  }
}

async function loadTeamTestCases(search) {
  try {
    if (!currentSetIdForCaseSelection) {
      const warn = window.i18n ? (window.i18n.t('testRun.sets.selectSetFirst') || '請先選擇一個 Test Case Set') : '請先選擇一個 Test Case Set';
      AppUtils.showWarning(warn);
      return;
    }
    await loadSectionTreeForCurrentSet();
    const url = new URL(`/api/teams/${currentTeamId}/testcases/`, window.location.origin);
    url.searchParams.set('set_id', String(currentSetIdForCaseSelection));
    if (search) url.searchParams.set('search', search);
    url.searchParams.set('limit', '10000');
    const resp = await window.AuthClient.fetch(url);
    if (!resp.ok) {
      const errorText = await resp.text();
      throw new Error(`HTTP ${resp.status}: ${errorText}`);
    }
    
    availableCases = await resp.json();
    caseSelectData.testCases = availableCases;
    caseSelectData.filteredCases = availableCases;
    caseSelectData.sections = currentSectionTree || [];
    
    // 若為編輯模式：用完整資料覆蓋已選取的項目（確保存檔可帶出完整欄位）
    if (modalMode === 'edit') {
      for (const c of availableCases) {
        if (selectedCaseMap.has(c.test_case_number)) {
          selectedCaseMap.set(c.test_case_number, c);
        }
      }
    } else if (window._preselectedCaseIds && window._preselectedCaseIds.size > 0) {
      // 如果有從 Test Case Set 卡片預選的 Test Cases，自動選中它們
      for (const c of availableCases) {
        const caseId = c.record_id || c.id;
        if (window._preselectedCaseIds.has(caseId)) {
          selectedCaseMap.set(c.test_case_number, c);
        }
      }
      // 清除 sessionStorage 中的預選 ID
      sessionStorage.removeItem('testRunSelectedCaseIds');
      sessionStorage.removeItem('testRunSetId');
      window._preselectedCaseIds = null;
      isPreselectedFromTestCaseSet = false;
    }
    renderCaseSelectList();
  } catch (e) {
    console.error('Load test cases error:', e);
    AppUtils.showError((window.i18n ? window.i18n.t('messages.loadFailed') : '載入失敗') + `: ${e.message}`);
  }
}

function isUnassignedCaseSection(section) {
  if (!section || !section.name) return false;
  return section.name.trim().toLowerCase() === 'unassigned';
}

function sortCaseSectionsForDisplay(sections) {
  if (!sections || sections.length === 0) return [];
  const unassigned = [];
  const normal = [];
  sections.forEach(sec => {
    if (isUnassignedCaseSection(sec)) unassigned.push(sec);
    else normal.push(sec);
  });
  return [...normal, ...unassigned];
}

function getCaseSectionId(testCase) {
  return testCase.test_case_section_id ?? testCase.test_case_section?.id ?? null;
}

function getCaseKey(testCase) {
  return testCase.test_case_number || String(testCase.record_id || testCase.id || '');
}

function renderCaseSelectList() {
  const container = document.getElementById('caseListContainer');
  if (!container) return;
  const searchVal = (document.getElementById('caseSearchInput')?.value || '').toLowerCase();

  caseSelectData.filteredCases = caseSelectData.testCases.filter(tc => {
    const num = (tc.test_case_number || '').toLowerCase();
    const title = (tc.title || '').toLowerCase();
    return num.includes(searchVal) || title.includes(searchVal);
  });

  const casesBySectionId = {};
  caseSelectData.filteredCases.forEach(tc => {
    const sid = getCaseSectionId(tc) ?? 'unassigned';
    if (!casesBySectionId[sid]) casesBySectionId[sid] = [];
    casesBySectionId[sid].push(tc);
  });

  const hasUnassigned = (casesBySectionId['unassigned'] || []).length > 0;
  let sectionsToRender = sortCaseSectionsForDisplay(caseSelectData.sections || []);
  if (hasUnassigned) {
    sectionsToRender = [...sectionsToRender, { id: 'unassigned', name: 'Unassigned', children: [] }];
  }

  function collectSubtreeCases(sec) {
    const sid = sec.id;
    const subtree = [...(casesBySectionId[sid] || [])];
    (sec.children || []).forEach(child => {
      subtree.push(...collectSubtreeCases(child));
    });
    return subtree;
  }

  function sectionContentId(id) {
    return `case-section-content-${id}`;
  }

  function renderSectionTree(sections, level = 0) {
    if (!sections || sections.length === 0) return '';
    return sections.map(section => {
      const sid = section.id;
      const isUnassigned = sid === 'unassigned';
      const sectionKey = `case-section-${sid}`;
      const isExpanded = sessionStorage.getItem(sectionKey) !== 'collapsed';
      const sectionCases = casesBySectionId[sid] || [];
      const childSections = section.children || [];
      const subtreeCases = isUnassigned ? sectionCases : collectSubtreeCases(section);
      const allSelected = subtreeCases.length > 0 && subtreeCases.every(tc => selectedCaseMap.has(getCaseKey(tc)));
      const someSelected = subtreeCases.length > 0 && subtreeCases.some(tc => selectedCaseMap.has(getCaseKey(tc)));
      const indent = level * 20;

      return `
        <div class="section-group" style="margin-left: ${indent}px;">
          <div class="section-header d-flex align-items-center py-2 px-2 border-bottom" style="background-color: #e8eef5;">
            <input type="checkbox"
                   class="section-checkbox me-2"
                   data-section-id="${sid}"
                   ${allSelected ? 'checked' : ''}
                   ${someSelected && !allSelected ? 'data-indeterminate="true"' : ''}>
            <button class="btn btn-link btn-sm p-0 me-2 toggle-section-btn"
                    data-section-id="${sid}"
                    style="width: 24px; height: 24px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; text-decoration: none;"
                    onmouseover="this.style.textDecoration='none'"
                    onmouseout="this.style.textDecoration='none'">
              <i class="fas fa-chevron-${isExpanded ? 'down' : 'right'}"></i>
            </button>
            <span class="fw-500 flex-grow-1">${escapeHtml(section.name || (isUnassigned ? 'Unassigned' : `Section #${sid}`))}</span>
            <small class="text-muted">(${subtreeCases.length})</small>
          </div>
          <div class="section-content ${isExpanded ? '' : 'd-none'}" id="${sectionContentId(sid)}">
            ${sectionCases.map(testCase => {
              const key = getCaseKey(testCase);
              const checked = selectedCaseMap.has(key) ? 'checked' : '';
              return `
                <div class="case-item d-flex align-items-center py-2 px-3" style="background-color: #f8f9fa; border-bottom: 1px solid #e9ecef;">
                  <input type="checkbox"
                         class="case-checkbox me-3"
                         data-case-num="${escapeHtml(key)}"
                         ${checked}>
                  <code class="me-2" style="min-width: 100px; flex-shrink: 0; color: rgb(194, 54, 120); font-size: inherit; font-weight: 500;">${escapeHtml(testCase.test_case_number || '')}</code>
                  <div class="flex-grow-1 text-truncate">${escapeHtml(testCase.title || '')}</div>
                  ${testCase.priority ? `<span class="badge bg-secondary ms-2">${escapeHtml(testCase.priority)}</span>` : ''}
                </div>
              `;
            }).join('')}
            ${renderSectionTree(childSections, level + 1)}
          </div>
        </div>
      `;
    }).join('');
  }

  let html = '<div class="set-case-list">';
  if (!sectionsToRender.length) {
    const noMsg = window.i18n && window.i18n.isReady()
      ? window.i18n.t('testCase.noTestCases', {}, '沒有符合的測試案例')
      : '沒有符合的測試案例';
    html += `<div class="alert alert-info">${noMsg}</div>`;
  } else {
    html += renderSectionTree(sectionsToRender);
  }
  html += '</div>';

  container.innerHTML = html;

  container.querySelectorAll('[data-indeterminate="true"]').forEach(cb => { cb.indeterminate = true; });

  container.querySelectorAll('.case-checkbox').forEach(cb => {
    cb.addEventListener('change', (e) => {
      const num = e.target.getAttribute('data-case-num');
      handleCaseCheckboxChange(num, e.target.checked);
    });
  });

  container.querySelectorAll('.section-checkbox').forEach(cb => {
    cb.addEventListener('change', (e) => {
      const sid = e.target.getAttribute('data-section-id');
      handleSectionCheckboxChange(sid, e.target.checked);
    });
  });

  container.querySelectorAll('.toggle-section-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const sid = btn.getAttribute('data-section-id');
      toggleSectionExpand(sid);
    });
  });

  updateCaseSelectionSummary();
  if (window.i18n && window.i18n.isReady()) window.i18n.retranslate(container);
}

function handleSectionCheckboxChange(sectionId, isChecked) {
  if (sectionId === null || typeof sectionId === 'undefined') return;
  const searchVal = (document.getElementById('caseSearchInput')?.value || '').toLowerCase();
  const matchesSearch = (tc) => {
    const num = (tc.test_case_number || '').toLowerCase();
    const title = (tc.title || '').toLowerCase();
    return num.includes(searchVal) || title.includes(searchVal);
  };

  const collectIds = (sec, acc = new Set()) => {
    acc.add(sec.id);
    (sec.children || []).forEach(child => collectIds(child, acc));
    return acc;
  };

  let sectionIds = new Set();
  if (sectionId === 'unassigned') {
    sectionIds.add('unassigned');
  } else {
    const target = (function find(sections, targetId) {
      for (const sec of sections) {
        if (String(sec.id) === String(targetId)) return sec;
        const child = find(sec.children || [], targetId);
        if (child) return child;
      }
      return null;
    })(caseSelectData.sections || [], sectionId);
    if (!target) return;
    sectionIds = collectIds(target);
  }

  const affectedCases = caseSelectData.testCases.filter(tc => {
    const sid = getCaseSectionId(tc) ?? 'unassigned';
    return sectionIds.has(sid) && matchesSearch(tc);
  });

  affectedCases.forEach(tc => {
    const key = getCaseKey(tc);
    if (isChecked) {
      selectedCaseMap.set(key, tc);
    } else {
      selectedCaseMap.delete(key);
    }
  });

  updateSelectedCount();
  renderCaseSelectList();
}

function handleCaseCheckboxChange(caseNum, isChecked) {
  const targetCase = caseSelectData.testCases.find(c => getCaseKey(c) === caseNum);
  if (isChecked) {
    if (targetCase) selectedCaseMap.set(getCaseKey(targetCase), targetCase);
  } else {
    selectedCaseMap.delete(caseNum);
  }
  updateSelectedCount();
  updateCaseSelectionSummary();
}

function toggleSectionExpand(sectionId) {
  const key = `case-section-${sectionId}`;
  const isCollapsed = sessionStorage.getItem(key) === 'collapsed';
  if (isCollapsed) {
    sessionStorage.removeItem(key);
  } else {
    sessionStorage.setItem(key, 'collapsed');
  }
  renderCaseSelectList();
}

function wireCaseCheckHandlers() {
  // handled in renderCaseSelectList via explicit listeners
}

function bindCaseSearchBarEvents() {
  const input = document.getElementById('caseSearchInput');
  if (!input) return;
  input.addEventListener('input', () => {
    renderCaseSelectList();
  });
}

function updateSelectedCount() {
  const count = selectedCaseMap.size;
  const selectedEl = document.getElementById('selectedCount');
  if (selectedEl) selectedEl.textContent = String(count);
}

function updateCaseSelectionSummary() {
  const count = selectedCaseMap.size;
  const summaryEl = document.getElementById('caseSelectionSummary');
  const infoEl = document.getElementById('caseSelectInfo');
  const total = caseSelectData.testCases.length;
  const filtered = caseSelectData.filteredCases.length;
  const searchVal = (document.getElementById('caseSearchInput')?.value || '').trim();
  const summaryText = (window.i18n && window.i18n.isReady())
    ? window.i18n.t('testCaseSet.selectedCount', { count }, `已選 ${count} 個測試案例`)
    : `已選 ${count} 個測試案例`;
  if (summaryEl) summaryEl.textContent = summaryText;
  if (infoEl) {
    if (searchVal) {
      infoEl.textContent = `搜尋 "${searchVal}" ，共 ${filtered} 筆`;
    } else {
      infoEl.textContent = `共 ${total} 筆`;
    }
  }
}

// 預設綁定為建立；開啟 modal 時會依模式改寫處理器
document.getElementById('confirmCreateItemsBtn').addEventListener('click', createItemsFromSelection);

async function createItemsFromSelection() {
  const permissions = window._testRunPermissions || testRunPermissions || {};
  if (modalMode === 'edit' && !permissions.canUpdate) {
    showPermissionDenied();
    return;
  }
  if (modalMode !== 'edit' && !permissions.canCreate) {
    showPermissionDenied();
    return;
  }
  
  if (selectedCaseMap.size === 0) {
    const warn = window.i18n ? window.i18n.t('errors.pleaseSelectTestCases') : '請先選擇至少一筆 Test Case';
    AppUtils.showWarning ? AppUtils.showWarning(warn) : alert(warn);
    return;
  }
  
  if (!currentSelectingConfigId) return;
  
  const items = Array.from(selectedCaseMap.values()).map(c => ({
    test_case_number: c.test_case_number,
    title: c.title,
    priority: c.priority || 'Medium',
    precondition: c.precondition || null,
    steps: c.steps || null,
    expected_result: c.expected_result || null,
    assignee: c.assignee ? { id: c.assignee.id, name: c.assignee.name, en_name: c.assignee.en_name, email: c.assignee.email } : null,
    attachments: (c.attachments || []).map(a => ({ file_token: a.file_token, name: a.name, size: a.size, type: a.type })),
    user_story_map: c.user_story_map || [],
    tcg: c.tcg || [],
    parent_record: c.parent_record || [],
    raw_fields: c.raw_fields || null,
  }));

  try {
    const url = `/api/teams/${currentTeamId}/test-run-configs/${currentSelectingConfigId}/items`;
    const resp = await window.AuthClient.fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items }) });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
    const res = await resp.json();
    createdItemsInSession = true;
    pendingCreate = false;
    caseSelectModalInstance.hide();
    const msg = window.i18n ? window.i18n.t('testRun.itemsCreated', { count: res.created_count || items.length }) : `建立成功 (${res.created_count || items.length} 筆)`;
    AppUtils.showSuccess(msg);
    // 同步統計後刷新管理頁
    try { await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentSelectingConfigId}/sync`); } catch(e) {}
    await loadTestRunConfigs();
  } catch (e) {
    AppUtils.showError((window.i18n ? window.i18n.t('messages.saveFailed') : '建立失敗') + `: ${e.message}`);
  }
}

// 儲存「編輯 Test Case」的差異：新增選入、刪除取消勾選
async function saveEditedItems() {
  const permissions = window._testRunPermissions || testRunPermissions || {};
  if (!permissions.canUpdate) {
    showPermissionDenied();
    return;
  }
  if (!currentSelectingConfigId) return;
  // 計算差異
  const selectedNumbers = new Set(Array.from(selectedCaseMap.keys()));
  const existingNumbers = new Set(Array.from(existingItemIdByCaseNumber.keys()));
  const toAdd = Array.from(selectedNumbers).filter(n => !existingNumbers.has(n));
  const toRemove = Array.from(existingNumbers).filter(n => !selectedNumbers.has(n));

  try {
    // 先新增
    if (toAdd.length > 0) {
      const items = toAdd.map(n => selectedCaseMap.get(n)).map(c => ({
        test_case_number: c.test_case_number,
        title: c.title,
        priority: c.priority || 'Medium',
        precondition: c.precondition || null,
        steps: c.steps || null,
        expected_result: c.expected_result || null,
        assignee: c.assignee ? { id: c.assignee.id, name: c.assignee.name, en_name: c.assignee.en_name, email: c.assignee.email } : null,
        attachments: (c.attachments || []).map(a => ({ file_token: a.file_token, name: a.name, size: a.size, type: a.type })),
        user_story_map: c.user_story_map || [],
        tcg: c.tcg || [],
        parent_record: c.parent_record || [],
        raw_fields: c.raw_fields || null,
      }));
      const url = `/api/teams/${currentTeamId}/test-run-configs/${currentSelectingConfigId}/items`;
      const resp = await window.AuthClient.fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ items }) });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      await resp.json();
    }
    // 再刪除（包含執行歷程刪除由後端處理）
    for (const n of toRemove) {
      const itemId = existingItemIdByCaseNumber.get(n);
      if (!itemId) continue;
      const url = `/api/teams/${currentTeamId}/test-run-configs/${currentSelectingConfigId}/items/${itemId}`;
      const resp = await window.AuthClient.fetch(url, { method: 'DELETE' });
      if (!resp.ok && resp.status !== 204) {
        // 若已不存在則忽略
        console.warn('Failed to delete item', itemId, 'status', resp.status);
      }
    }
    // 完成
    caseSelectModalInstance.hide();
    const msg = window.i18n ? window.i18n.t('testRun.itemsUpdated') : '已更新 Test Run 的 Test Case';
    AppUtils.showSuccess(msg);
    try { await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentSelectingConfigId}/sync`); } catch(e) {}
    await loadTestRunConfigs();
  } catch (e) {
    AppUtils.showError((window.i18n ? window.i18n.t('messages.saveFailed') : '儲存失敗') + `: ${e.message}`);
  }
}

// 卡片上的刪除按鈕（不進入詳情也可刪除）
function deleteTestRun(configId, name) {
  const permissions = window._testRunPermissions || testRunPermissions || {};
  if (!permissions.canDelete) {
    showPermissionDenied();
    return;
  }
  const modal = document.getElementById('deleteConfigModal');
  const msgEl = document.getElementById('deleteConfirmMessage');
  const safeName = escapeHtml(name || '');
  msgEl.textContent = window.i18n ? window.i18n.t('testRun.confirmDelete', { name: safeName }) : `您確定要刪除 Test Run 配置 "${safeName}" 嗎？此操作無法復原。`;
  const inst = bootstrap.Modal.getOrCreateInstance(modal);
  // Rebind confirm handler
  const btnOld = document.getElementById('confirmDeleteConfigBtn');
  const btnNew = btnOld.cloneNode(true);
  btnOld.parentNode.replaceChild(btnNew, btnOld);
  document.getElementById('confirmDeleteConfigBtn').addEventListener('click', async () => {
    try {
      const resp = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${configId}`, { method: 'DELETE' });
      if (resp.ok || resp.status === 204) {
        inst.hide();
        const successMsg = window.i18n ? window.i18n.t('testRun.deleteSuccess', { name: safeName }) : `成功刪除 "${safeName}"`;
        AppUtils.showSuccess(successMsg);
        await loadTestRunConfigs();
        await refreshCurrentSetDetail();
      } else {
        let detail = '';
        try {
          const text = await resp.text();
          try { detail = JSON.parse(text).detail || text; } catch { detail = text; }
        } catch { detail = ''; }
        const fallbackMsg = window.i18n ? window.i18n.t('messages.deleteFailed') : '刪除失敗';
        throw new Error(detail || fallbackMsg);
      }
    } catch (error) {
      const errorMsg = window.i18n ? window.i18n.t('messages.deleteFailed') : '刪除失敗';
      AppUtils.showError(`${errorMsg}: ${error.message}`);
    }
  });
  if (window.i18n && window.i18n.isReady()) window.i18n.retranslate(modal);
  inst.show();
}

// ===== TP 標籤管理功能 =====

// 存儲當前的 TP 票號列表
let currentTpTickets = [];

// TP 票號格式驗證函數
function validateTpTicketFormat(ticketNumber) {
    // TP 票號格式：TP-XXXXX（TP- 後接 1-10 位數字或字母）
    const tpTicketPattern = /^TP-[A-Z0-9]{1,10}$/i;
    return tpTicketPattern.test(ticketNumber.trim());
}

// 檢查重複票號
function isDuplicateTicket(ticketNumber) {
    return currentTpTickets.includes(ticketNumber.trim().toUpperCase());
}

// 新增 TP 票號標籤
function addTpTicket(ticketNumber) {
    const trimmedTicket = ticketNumber.trim().toUpperCase();
    
    // 驗證格式
    if (!validateTpTicketFormat(trimmedTicket)) {
        showTpInputError('TP 票號格式無效，請使用格式：TP-XXXXX');
        return false;
    }
    
    // 檢查重複
    if (isDuplicateTicket(trimmedTicket)) {
        showTpInputError('此 TP 票號已存在');
        return false;
    }
    
    // 添加到列表
    currentTpTickets.push(trimmedTicket);
    
    // 更新顯示
    renderTpTags();
    
    // 清空輸入欄位
    const inputElement = document.getElementById('relatedTpTicketsInput');
    if (inputElement) {
        inputElement.value = '';
        clearTpInputError();
    }
    
    return true;
}

// 移除 TP 票號標籤
function removeTpTicket(ticketNumber) {
    const index = currentTpTickets.indexOf(ticketNumber);
    if (index > -1) {
        currentTpTickets.splice(index, 1);
        renderTpTags();
    }
}

// 渲染 TP 標籤列表
function renderTpTags() {
    const tagsContainer = document.getElementById('tpTicketTags');
    const displayContainer = document.getElementById('tpTicketsDisplay');
    
    if (!tagsContainer || !displayContainer) return;
    
    // 如果沒有標籤，隱藏顯示區域
    if (currentTpTickets.length === 0) {
        displayContainer.style.display = 'none';
        tagsContainer.innerHTML = '';
        return;
    }
    
    // 顯示標籤區域
    displayContainer.style.display = 'block';
    
    // 生成標籤 HTML
    const tagsHtml = currentTpTickets.map(ticket => `
        <div class="tp-ticket-tag" data-ticket="${ticket}">
            <i class="fas fa-ticket-alt me-1"></i>
            <span>${ticket}</span>
            <button type="button" class="remove-btn" 
                    onclick="removeTpTicket('${ticket}')"
                    title="移除此票號"
                    aria-label="移除 ${ticket}">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
    
    tagsContainer.innerHTML = tagsHtml;
    
    // 為所有 TP 標籤添加 hover 事件監聽器
    const ticketTags = tagsContainer.querySelectorAll('.tp-ticket-tag');
    ticketTags.forEach(tag => {
        const ticketNumber = tag.getAttribute('data-ticket');
        // 添加 hover 事件
        tag.addEventListener('mouseenter', (e) => showJiraPreview(e, ticketNumber));
        tag.addEventListener('mouseleave', hideJiraPreview);
        // 添加點擊跳轉事件
        tag.addEventListener('click', (e) => {
            // 如果點擊的是刪除按鈕，不執行跳轉
            if (e.target.closest('.remove-btn')) return;
            openJiraTicket(ticketNumber);
        });
    });
}

// 顯示輸入錯誤提示
function showTpInputError(message) {
    const inputElement = document.getElementById('relatedTpTicketsInput');
    if (!inputElement) return;
    
    // 移除現有的錯誤樣式
    clearTpInputError();
    
    // 添加錯誤樣式
    inputElement.classList.add('is-invalid');
    
    // 創建或更新錯誤訊息元素
    let errorElement = document.getElementById('tpTicketInputError');
    if (!errorElement) {
        errorElement = document.createElement('div');
        errorElement.id = 'tpTicketInputError';
        errorElement.className = 'invalid-feedback d-block';
        inputElement.parentNode.appendChild(errorElement);
    }
    
    errorElement.textContent = message;
    
    // 3秒後自動清除錯誤
    setTimeout(clearTpInputError, 3000);
}

// 清除輸入錯誤提示
function clearTpInputError() {
    const inputElement = document.getElementById('relatedTpTicketsInput');
    const errorElement = document.getElementById('tpTicketInputError');
    
    if (inputElement) {
        inputElement.classList.remove('is-invalid');
    }
    
    if (errorElement) {
        errorElement.remove();
    }
}

// 初始化 TP 標籤輸入功能
function initTpTicketInput() {
    const inputElement = document.getElementById('relatedTpTicketsInput');
    if (!inputElement) return;
    
    // Enter 鍵監聽
    inputElement.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const value = this.value.trim();
            if (value) {
                addTpTicket(value);
            }
        }
    });
    
    // 失去焦點時也可以添加標籤（可選）
    inputElement.addEventListener('blur', function() {
        const value = this.value.trim();
        if (value && validateTpTicketFormat(value) && !isDuplicateTicket(value)) {
            addTpTicket(value);
        }
    });
    
    // 清除錯誤樣式當用戶開始輸入
    inputElement.addEventListener('input', function() {
        if (this.classList.contains('is-invalid')) {
            clearTpInputError();
        }
    });
}

// 獲取當前 TP 票號列表（用於表單提交）
function getCurrentTpTickets() {
    return [...currentTpTickets]; // 返回副本避免意外修改
}

// 設置 TP 票號列表（用於編輯模式）
function setTpTickets(tickets) {
    currentTpTickets = Array.isArray(tickets) ? [...tickets] : [];
    renderTpTags();
}

// 清空所有 TP 票號
function clearAllTpTickets() {
    currentTpTickets = [];
    renderTpTags();
    clearTpInputError();
}

// ===== Test Run Set TP 票號輸入功能 =====

function initSetTpTicketInput() {
    if (setTpInputInitialized) return;
    const inputElement = document.getElementById('setTpTicketsInput');
    if (!inputElement) return;

    setTpInputInitialized = true;

    inputElement.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const value = this.value.trim();
            if (value) {
                addSetTpTicket(value);
            }
        }
    });

    inputElement.addEventListener('blur', function() {
        const value = this.value.trim();
        if (value) {
            addSetTpTicket(value);
        }
    });
}

function addSetTpTicket(ticketNumber) {
    const trimmed = ticketNumber.trim().toUpperCase();
    if (!trimmed) {
        return false;
    }

    if (!validateTpTicketFormat(trimmed)) {
        const message = window.i18n?.t('messages.invalidTpTicketFormat') || 'TP 票號格式不正確（需要 TP-12345）';
        showSetTpInputError(message);
        return false;
    }

    if (currentSetTpTickets.includes(trimmed)) {
        const message = window.i18n?.t('messages.duplicateTpTicket') || 'TP 票號已重複';
        showSetTpInputError(message);
        return false;
    }

    currentSetTpTickets.push(trimmed);
    renderSetTpTags();

    const inputElement = document.getElementById('setTpTicketsInput');
    if (inputElement) {
        inputElement.value = '';
    }
    clearSetTpInputError();
    return true;
}

function removeSetTpTicket(ticketNumber) {
    const index = currentSetTpTickets.indexOf(ticketNumber);
    if (index > -1) {
        currentSetTpTickets.splice(index, 1);
        renderSetTpTags();
    }
}

function renderSetTpTags() {
    const tagsContainer = document.getElementById('setTpTicketTags');
    const displayContainer = document.getElementById('setTpTicketsDisplay');
    const countBadge = document.getElementById('setTpTicketsCount');

    if (!tagsContainer || !displayContainer) return;

    if (currentSetTpTickets.length === 0) {
        displayContainer.style.display = 'none';
        tagsContainer.innerHTML = '';
        if (countBadge) countBadge.textContent = '0';
        return;
    }

    displayContainer.style.display = 'block';
    if (countBadge) countBadge.textContent = String(currentSetTpTickets.length);

    tagsContainer.innerHTML = currentSetTpTickets.map(ticket => {
        const safe = escapeHtml(ticket);
        return `
            <div class="tp-ticket-tag" data-ticket="${safe}">
                <i class="fas fa-ticket-alt me-1"></i>
                <span>${safe}</span>
                <button type="button" class="remove-btn" onclick="removeSetTpTicket('${safe}')" aria-label="移除 ${safe}">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    }).join('');

    const ticketTags = tagsContainer.querySelectorAll('.tp-ticket-tag');
    ticketTags.forEach(tag => {
        const ticketNumber = tag.getAttribute('data-ticket');
        tag.addEventListener('mouseenter', (e) => showJiraPreview(e, ticketNumber));
        tag.addEventListener('mouseleave', hideJiraPreview);
        tag.addEventListener('click', (e) => {
            if (e.target.closest('.remove-btn')) return;
            openJiraTicket(ticketNumber);
        });
    });
}

function setSetTpTickets(tickets) {
    currentSetTpTickets = Array.isArray(tickets) ? [...tickets] : [];
    renderSetTpTags();
    clearSetTpInputError();
}

function clearAllSetTpTickets() {
    currentSetTpTickets = [];
    renderSetTpTags();
    clearSetTpInputError();
}

function showSetTpInputError(message) {
    const inputElement = document.getElementById('setTpTicketsInput');
    if (!inputElement) return;

    clearSetTpInputError();
    inputElement.classList.add('is-invalid');

    let errorElement = document.getElementById('setTpTicketInputError');
    if (!errorElement) {
        errorElement = document.createElement('div');
        errorElement.id = 'setTpTicketInputError';
        errorElement.className = 'invalid-feedback d-block';
        inputElement.parentNode.appendChild(errorElement);
    }

    errorElement.textContent = message;
    setTimeout(clearSetTpInputError, 3000);
}

function clearSetTpInputError() {
    const inputElement = document.getElementById('setTpTicketsInput');
    const errorElement = document.getElementById('setTpTicketInputError');
    if (inputElement) {
        inputElement.classList.remove('is-invalid');
    }
    if (errorElement) {
        errorElement.remove();
    }
}

function renderSetDetailTpTags(tickets) {
    const section = document.getElementById('setDetailTpSection');
    const container = document.getElementById('setDetailTpTags');
    if (!section || !container) return;

    if (!tickets || tickets.length === 0) {
        section.style.display = 'none';
        container.innerHTML = '';
        return;
    }

    section.style.display = 'block';
    container.innerHTML = tickets.map(ticket => {
        const safe = escapeHtml(ticket);
        return `
            <span class="tp-tag badge bg-secondary me-1" data-ticket="${safe}" style="cursor: pointer;">
                <i class="fas fa-ticket-alt me-1"></i>${safe}
            </span>
        `;
    }).join('');

    container.querySelectorAll('.tp-tag').forEach(tag => {
        const ticketNumber = tag.getAttribute('data-ticket');
        tag.addEventListener('mouseenter', (e) => showJiraPreview(e, ticketNumber));
        tag.addEventListener('mouseleave', hideJiraPreview);
        tag.addEventListener('click', () => openJiraTicket(ticketNumber));
    });
}

// === TP 票號 JIRA 預覽功能 ===

// JIRA 票號資料快取
const jiraDataCache = new Map();

// 創建或獲取 tooltip 元素
function getOrCreateJiraTooltip() {
    let tooltip = document.getElementById('tcg-tooltip-content');
    if (!tooltip) {
        tooltip = document.createElement('div');
        tooltip.id = 'tcg-tooltip-content';
        tooltip.className = 'tcg-tooltip-content';

        // 添加鼠標事件，讓用戶可以移動到 tooltip 上而不會消失
        tooltip.addEventListener('mouseenter', cancelHideTooltip);
        tooltip.addEventListener('mouseleave', hideJiraPreview);

        document.body.appendChild(tooltip);
    }
    return tooltip;
}

// 顯示 JIRA 預覽
async function showJiraPreview(event, ticketNumber) {
    const tooltip = getOrCreateJiraTooltip();
    const targetElement = event.currentTarget;
    
    // 設定 tooltip 位置，確保畫面內可見
    positionTooltip(tooltip, targetElement);
    
    // 顯示載入中狀態
    tooltip.innerHTML = `
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin me-2"></i>
            載入中...
        </div>
    `;
    tooltip.classList.add('show');
    
    try {
        // 檢查快取
        if (jiraDataCache.has(ticketNumber)) {
            const cachedData = jiraDataCache.get(ticketNumber);
            displayJiraData(tooltip, ticketNumber, cachedData);
            return;
        }
        
        // 呼叫 JIRA API
        const response = await window.AuthClient.fetch(`/api/jira/tp/${ticketNumber}/details`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        // 快取資料（5分鐘）
        jiraDataCache.set(ticketNumber, data);
        setTimeout(() => jiraDataCache.delete(ticketNumber), 5 * 60 * 1000);
        
        // 顯示資料
        displayJiraData(tooltip, ticketNumber, data);
        
    } catch (error) {
        console.error('載入 JIRA 資料失敗:', error);
        tooltip.innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-triangle me-2"></i>
                載入失敗，請稍後再試
            </div>
        `;
    }
}

// 隱藏 JIRA 預覽（延遲機制避免誤觸發）
let hideTooltipTimer = null;

function hideJiraPreview() {
    // 設定延遲隱藏，讓用戶有時間移動到 tooltip 上
    hideTooltipTimer = setTimeout(() => {
        const tooltip = document.getElementById('tcg-tooltip-content');
        if (tooltip) {
            tooltip.classList.remove('show');
        }
    }, 150); // 150ms 延遲
}

// 取消隱藏 tooltip（用戶移動到 tooltip 上時）
function cancelHideTooltip() {
    if (hideTooltipTimer) {
        clearTimeout(hideTooltipTimer);
        hideTooltipTimer = null;
    }
}

// 顯示 JIRA 資料
function displayJiraData(tooltip, ticketNumber, data) {
    // 安全地獲取狀態文字 - status 可能是物件或字串
    let statusText = 'unknown';
    if (data.status) {
        if (typeof data.status === 'object' && data.status.name) {
            statusText = data.status.name;
        } else if (typeof data.status === 'string') {
            statusText = data.status;
        }
    }
    
    const statusClass = getStatusClass(statusText);
    
    // 安全地獲取負責人資訊 - assignee 也可能是物件
    let assigneeDisplay = '未指派';
    if (data.assignee) {
        if (typeof data.assignee === 'object') {
            assigneeDisplay = data.assignee.display_name || data.assignee.displayName || '未指派';
        } else if (typeof data.assignee === 'string') {
            assigneeDisplay = data.assignee;
        }
    }
    
    tooltip.innerHTML = `
        <div class="tcg-tooltip-header">
            <div class="tcg-ticket-info">
                <span class="tcg-ticket-number">${ticketNumber}</span>
                <span class="tcg-ticket-status ${statusClass}">${statusText || 'Unknown'}</span>
            </div>
        </div>
        
        <div class="tcg-ticket-content">
            <div class="tcg-ticket-title">${data.summary || '無標題'}</div>
            
            <div class="tcg-ticket-meta">
                <div class="tcg-assignee">
                    <span class="tcg-label">負責人:</span>
                    <span class="tcg-value">${assigneeDisplay}</span>
                </div>
                ${data.priority ? `
                <div class="tcg-priority">
                    <span class="tcg-label">優先級:</span>
                    <span class="tcg-value">${typeof data.priority === 'object' ? (data.priority.name || '未設定') : data.priority}</span>
                </div>
                ` : ''}
            </div>
        </div>
        
        <div class="tcg-tooltip-footer">
            <a href="${data.url || '#'}" target="_blank" class="tcg-jira-link">
                <i class="fas fa-external-link-alt me-1"></i>
                在 JIRA 中檢視
            </a>
        </div>
    `;
}


// 定位 tooltip
function positionTooltip(tooltip, targetElement) {
    const targetRect = targetElement.getBoundingClientRect();
    
    // 臨時顯示 tooltip 以獲得正確尺寸
    const wasVisible = tooltip.classList.contains('show');
    if (!wasVisible) {
        tooltip.style.visibility = 'hidden';
        tooltip.style.opacity = '1';
        tooltip.classList.add('show');
    }
    
    const tooltipRect = tooltip.getBoundingClientRect();
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;
    
    // 如果之前是隱藏的，恢復隱藏狀態
    if (!wasVisible) {
        tooltip.classList.remove('show');
        tooltip.style.visibility = '';
        tooltip.style.opacity = '';
    }
    
    // 預設放在目標元素下方
    let left = targetRect.left + (targetRect.width / 2) - (tooltipRect.width / 2);
    let top = targetRect.bottom + 8;
    
    // 調整水平位置避免超出視窗
    if (left < 8) {
        left = 8;
    } else if (left + tooltipRect.width > windowWidth - 8) {
        left = windowWidth - tooltipRect.width - 8;
    }
    
    // 調整垂直位置避免超出視窗
    if (top + tooltipRect.height > windowHeight - 8) {
        top = targetRect.top - tooltipRect.height - 8;
    }
    
    tooltip.style.left = `${left}px`;
    tooltip.style.top = `${top}px`;
}

// 開啟 JIRA 票號
function openJiraTicket(ticketNumber) {
    // 嘗試從快取獲取 URL，否則使用預設格式
    const cachedData = jiraDataCache.get(ticketNumber);
    if (cachedData && cachedData.url) {
        window.open(cachedData.url, '_blank');
        return;
    }
    
    // 使用 API 獲取正確的 JIRA URL
    window.AuthClient.fetch(`/api/jira/tp/${ticketNumber}/details`)
        .then(response => response.json())
        .then(data => {
            if (data.url) {
                window.open(data.url, '_blank');
            } else {
                console.error('無法獲取 JIRA URL');
            }
        })
        .catch(error => {
            console.error('開啟 JIRA 票號失敗:', error);
        });
}

// === T022 JIRA 整合工具函數 ===

// 獲取 TP 票號詳情
async function fetchTPDetails(ticketNumber) {
    try {
        // 檢查快取
        if (jiraDataCache.has(ticketNumber)) {
            return jiraDataCache.get(ticketNumber);
        }
        
        // 呼叫 JIRA API
        const response = await window.AuthClient.fetch(`/api/jira/tp/${ticketNumber}/details`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        // 快取資料（5分鐘）
        jiraDataCache.set(ticketNumber, data);
        setTimeout(() => jiraDataCache.delete(ticketNumber), 5 * 60 * 1000);
        
        return data;
        
    } catch (error) {
        console.error('獲取 JIRA 資料失敗:', error);
        throw error;
    }
}

// 顯示 TP 票號預覽（T022 兼容介面）
async function showTPPreview(element, ticketNumber) {
    // 創建兼容的 event 物件
    const fakeEvent = {
        currentTarget: element
    };
    
    // 使用現有的 showJiraPreview 函數
    return showJiraPreview(fakeEvent, ticketNumber);
}

// 開啟 JIRA 連結（T022 別名函數）
function openJiraLink(ticketNumber) {
    return openJiraTicket(ticketNumber);
}

// === Modal 表單驗證系統 ===

// 綜合表單驗證函數
function validateTestRunConfigForm() {
    const errors = [];
    
    // 1. 必填欄位驗證
    const configName = document.getElementById('configName').value.trim();
    if (!configName) {
        errors.push({
            field: 'configName',
            message: '測試執行配置名稱為必填欄位',
            type: 'required'
        });
    } else if (configName.length < 2) {
        errors.push({
            field: 'configName',
            message: '配置名稱至少需要2個字元',
            type: 'minLength'
        });
    } else if (configName.length > 100) {
        errors.push({
            field: 'configName',
            message: '配置名稱不能超過100個字元',
            type: 'maxLength'
        });
    }
    
    // 2. TP 票號綜合驗證
    const tpTickets = getCurrentTpTickets();
    const tpValidationResult = validateAllTpTickets(tpTickets);
    if (!tpValidationResult.isValid) {
        errors.push(...tpValidationResult.errors);
    }
    
    // 3. 可選欄位格式驗證
    const description = document.getElementById('configDescription').value.trim();
    if (description && description.length > 1000) {
        errors.push({
            field: 'configDescription',
            message: '描述不能超過1000個字元',
            type: 'maxLength'
        });
    }
    
    const testEnvironment = document.getElementById('testEnvironment').value.trim();
    if (testEnvironment && testEnvironment.length > 100) {
        errors.push({
            field: 'testEnvironment',
            message: '測試環境名稱不能超過100個字元',
            type: 'maxLength'
        });
    }
    
    const buildNumber = document.getElementById('buildNumber').value.trim();
    if (buildNumber && buildNumber.length > 100) {
        errors.push({
            field: 'buildNumber',
            message: '建置版本號不能超過100個字元',
            type: 'maxLength'
        });
    }
    
    return {
        isValid: errors.length === 0,
        errors: errors
    };
}

// 驗證所有 TP 票號
function validateAllTpTickets(tpTickets) {
    const errors = [];
    
    if (tpTickets.length > 100) {
        errors.push({
            field: 'tpTickets',
            message: 'TP 票號數量不能超過100個',
            type: 'maxCount'
        });
    }
    
    // 驗證每個票號格式
    const invalidTickets = [];
    const duplicateTickets = [];
    const ticketCounts = {};
    
    tpTickets.forEach(ticket => {
        // 格式驗證
        if (!validateTpTicketFormat(ticket)) {
            invalidTickets.push(ticket);
        }
        
        // 重複檢查
        if (ticketCounts[ticket]) {
            duplicateTickets.push(ticket);
        } else {
            ticketCounts[ticket] = 1;
        }
    });
    
    if (invalidTickets.length > 0) {
        errors.push({
            field: 'tpTickets',
            message: `以下 TP 票號格式無效：${invalidTickets.join(', ')}`,
            type: 'invalidFormat',
            details: invalidTickets
        });
    }
    
    if (duplicateTickets.length > 0) {
        errors.push({
            field: 'tpTickets',
            message: `發現重複的 TP 票號：${duplicateTickets.join(', ')}`,
            type: 'duplicate',
            details: duplicateTickets
        });
    }
    
    return {
        isValid: errors.length === 0,
        errors: errors
    };
}

// 顯示表單驗證錯誤
function showFormValidationError(validationResult) {
    if (validationResult.errors.length === 0) return;
    
    const firstError = validationResult.errors[0];
    
    // 清除所有現有的錯誤樣式
    clearAllFormErrors();
    
    // 根據錯誤類型處理
    if (firstError.field === 'tpTickets') {
        // TP 票號相關錯誤
        showTpInputError(firstError.message);
        const tpInput = document.getElementById('relatedTpTicketsInput');
        if (tpInput) tpInput.focus();
    } else {
        // 其他欄位錯誤
        const fieldElement = document.getElementById(firstError.field);
        if (fieldElement) {
            fieldElement.classList.add('is-invalid');
            fieldElement.focus();
            
            // 創建或更新錯誤訊息
            let errorElement = document.getElementById(`${firstError.field}Error`);
            if (!errorElement) {
                errorElement = document.createElement('div');
                errorElement.id = `${firstError.field}Error`;
                errorElement.className = 'invalid-feedback d-block';
                fieldElement.parentNode.appendChild(errorElement);
            }
            errorElement.textContent = firstError.message;
            
            // 自動清除錯誤（當用戶開始輸入時）
            const clearErrorHandler = () => {
                fieldElement.classList.remove('is-invalid');
                if (errorElement) errorElement.remove();
                fieldElement.removeEventListener('input', clearErrorHandler);
            };
            fieldElement.addEventListener('input', clearErrorHandler);
        }
    }
    
    // 顯示綜合錯誤訊息（如果有多個錯誤）
    if (validationResult.errors.length > 1) {
        const remainingErrors = validationResult.errors.length - 1;
        setTimeout(() => {
            const message = `發現 ${validationResult.errors.length} 個驗證錯誤，請檢查表單內容`;
            showNotification(message, 'warning');
        }, 100);
    }
}

// 清除所有表單錯誤樣式
function clearAllFormErrors() {
    // 清除一般欄位錯誤
    const errorFields = ['configName', 'configDescription', 'testEnvironment', 'buildNumber'];
    errorFields.forEach(fieldId => {
        const fieldElement = document.getElementById(fieldId);
        const errorElement = document.getElementById(`${fieldId}Error`);
        
        if (fieldElement) {
            fieldElement.classList.remove('is-invalid');
        }
        if (errorElement) {
            errorElement.remove();
        }
    });
    
    // 清除 TP 票號錯誤
    clearTpInputError();
}

// 顯示通知訊息
function showNotification(message, type = 'info') {
    if (window.AppUtils) {
        if (type === 'success' && typeof window.AppUtils.showSuccess === 'function') {
            window.AppUtils.showSuccess(message);
            return;
        }
        if (type === 'warning' && typeof window.AppUtils.showWarning === 'function') {
            window.AppUtils.showWarning(message);
            return;
        }
        if (type === 'error' && typeof window.AppUtils.showError === 'function') {
            window.AppUtils.showError(message);
            return;
        }
        if (typeof window.AppUtils.showInfo === 'function') {
            window.AppUtils.showInfo(message);
            return;
        }
    }
    if (type === 'error') {
        alert(message);
    }
}

// ===== 快速搜尋 TP 票號功能 (T024 + T027 快取優化) =====

// T027: 搜尋結果快取機制
class TPSearchCache {
    constructor(ttl = 5 * 60 * 1000) { // 5分鐘 TTL
        this.cache = new Map();
        this.ttl = ttl;
    }
    
    // 生成快取鍵
    generateKey(query, teamId, limit) {
        return `${query.toLowerCase()}_${teamId}_${limit}`;
    }
    
    // 獲取快取結果
    get(query, teamId, limit) {
        const key = this.generateKey(query, teamId, limit);
        const item = this.cache.get(key);
        
        if (!item) return null;
        
        // 檢查是否過期
        if (Date.now() - item.timestamp > this.ttl) {
            this.cache.delete(key);
            return null;
        }
        
        return item.data;
    }
    
    // 設定快取
    set(query, teamId, limit, data) {
        const key = this.generateKey(query, teamId, limit);
        this.cache.set(key, {
            data: data,
            timestamp: Date.now()
        });
        
        // 限制快取大小 (最多100個項目)
        if (this.cache.size > 100) {
            const firstKey = this.cache.keys().next().value;
            this.cache.delete(firstKey);
        }
    }
    
    // 清除過期快取
    cleanup() {
        const now = Date.now();
        for (const [key, item] of this.cache.entries()) {
            if (now - item.timestamp > this.ttl) {
                this.cache.delete(key);
            }
        }
    }
    
    // 清除所有快取
    clear() {
        this.cache.clear();
    }
}

// 全域搜尋快取實例
const tpSearchCache = new TPSearchCache();

// 定期清理過期快取
setInterval(() => tpSearchCache.cleanup(), 60000); // 每分鐘清理一次

// T028: 執行狀態處理函數 (與現有 UI 風格一致)
function getSearchResultStatusInfo(status, executionRate, passRate) {
    // 使用與主卡片相同的狀態樣式
    const statusClass = getStatusClass(status);
    const statusText = getStatusText(status);
    
    return {
        statusClass: statusClass,
        statusText: statusText,
        showProgress: status === 'active'
    };
}

function setupQuickSearch_TPTicket() {
    if (!document.getElementById('quickSearchTPOverlay')) {
        const overlay = document.createElement('div');
        overlay.id = 'quickSearchTPOverlay';
        overlay.style.cssText = 'position:fixed;inset:0;z-index:1060;display:none;background:rgba(0,0,0,0.35)';
        overlay.innerHTML = `
          <div class="position-fixed" style="top:34vh; left:50%; transform: translateX(-50%); width:min(800px, 95vw);">
            <div class="card shadow">
              <div class="card-body p-3">
                <input id="quickSearchTPInput" type="text" class="form-control form-control-lg" placeholder="${window.i18n ? window.i18n.t('tp.searchPlaceholder') : '搜尋 TP 票號...'}" autocomplete="off" />
                <div id="quickSearchTPResults" class="list-group list-group-flush" style="max-height:30vh; overflow-y:auto; overflow-x:hidden; padding: 0 4px;"></div>
              </div>
            </div>
          </div>`;
        document.body.appendChild(overlay);
        
        try {
            const applyPlaceholder = () => {
                const input = overlay.querySelector('#quickSearchTPInput');
                if (!input) return;
                if (window.i18n && window.i18n.isReady && window.i18n.isReady()) {
                    let text = window.i18n.t('tp.searchPlaceholder');
                    if (!text || text === 'tp.searchPlaceholder') {
                        text = '搜尋 TP 票號...';
                    }
                    input.placeholder = text;
                } else {
                    input.placeholder = '搜尋 TP 票號...';
                }
            };
            
            // 立即嘗試設置
            applyPlaceholder();
            
            // 語言切換時更新
            document.addEventListener('languageChanged', applyPlaceholder);
            
            // 如果翻譯系統還未準備好，監聽 i18nReady 事件
            if (!window.i18n || !window.i18n.isReady || !window.i18n.isReady()) {
                document.addEventListener('i18nReady', applyPlaceholder);
            }
        } catch (_) {}
        
        overlay.addEventListener('click', (e) => { 
            if(e.target === overlay) closeQuickSearchTP(); 
        });
    }

    // 鍵盤事件監聽器 - "/" 鍵觸發搜尋
    document.addEventListener('keydown', function(e) {
        const tag = (e.target && e.target.tagName || '').toLowerCase();
        const isTyping = ['input','textarea','select'].includes(tag) || (e.target && e.target.isContentEditable);
        if (!isTyping && e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey) {
            e.preventDefault();
            openQuickSearchTP();
        }
    });
}

// 底部左側 TP 搜尋提示
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('quickSearchTPHint')) return;
    const hint = document.createElement('div');
    hint.id = 'quickSearchTPHint';
    hint.className = 'position-fixed';
    hint.style.cssText = 'left:12px; bottom:12px; z-index:1040; opacity:0.85; pointer-events:none;';
    const label = window.i18n && window.i18n.isReady() ? window.i18n.t('hotkeys.quickSearchTP') : '按 / 快速搜尋 TP 票號';
    hint.innerHTML = `<span class="badge bg-secondary-subtle text-secondary border" style="--bs-bg-opacity:.65;">${label}</span>`;
    document.body.appendChild(hint);
    
    // i18n 準備完成時也同步更新
    document.addEventListener('i18nReady', () => {
        const text = window.i18n ? window.i18n.t('hotkeys.quickSearchTP') : '按 / 快速搜尋 TP 票號';
        const badge = document.querySelector('#quickSearchTPHint .badge');
        if (badge) badge.textContent = text;
    });
    document.addEventListener('languageChanged', () => {
        const text = window.i18n ? window.i18n.t('hotkeys.quickSearchTP') : '按 / 快速搜尋 TP 票號';
        const badge = document.querySelector('#quickSearchTPHint .badge');
        if (badge) badge.textContent = text;
    });
});

// T030: Debounce 函數 - 延遲執行搜尋，減少 API 呼叫
function debounce(func, delay) {
    let timeoutId;
    return function (...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => func.apply(this, args), delay);
    };
}

// T031: 關鍵字高亮顯示函數 - 在搜尋結果中高亮顯示匹配的關鍵字
function highlightSearchTerm(text, searchTerm) {
    if (!text || !searchTerm || searchTerm.trim().length === 0) {
        return escapeHtml(text || '');
    }
    
    const escapedText = escapeHtml(text);
    const escapedTerm = escapeHtml(searchTerm.trim());
    
    // 使用不區分大小寫的全局替換
    const regex = new RegExp(`(${escapedTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return escapedText.replace(regex, '<mark class="bg-warning bg-opacity-50 rounded px-1">$1</mark>');
}

// T032: 搜尋歷史記錄管理 - 使用 localStorage 儲存最近搜尋記錄
const tpSearchHistory = {
    key: 'tp_search_history',
    maxItems: 10,
    
    // 獲取搜尋歷史
    get() {
        try {
            const history = localStorage.getItem(this.key);
            return history ? JSON.parse(history) : [];
        } catch (e) {
            console.warn('無法讀取搜尋歷史:', e);
            return [];
        }
    },
    
    // 添加搜尋記錄
    add(searchTerm) {
        if (!searchTerm || searchTerm.trim().length === 0) return;
        
        const term = searchTerm.trim();
        let history = this.get();
        
        // 移除重複項目
        history = history.filter(item => item !== term);
        
        // 添加到開頭
        history.unshift(term);
        
        // 限制數量
        if (history.length > this.maxItems) {
            history = history.slice(0, this.maxItems);
        }
        
        try {
            localStorage.setItem(this.key, JSON.stringify(history));
        } catch (e) {
            console.warn('無法儲存搜尋歷史:', e);
        }
    },
    
    // 清空歷史
    clear() {
        try {
            localStorage.removeItem(this.key);
        } catch (e) {
            console.warn('無法清空搜尋歷史:', e);
        }
    }
};

// T032: 渲染搜尋歷史記錄
function renderSearchHistory(container) {
    const history = tpSearchHistory.get();
    if (history.length === 0) {
        container.innerHTML = `<div class="list-group-item text-center text-muted py-3 border-0">
            <small><i class="fas fa-history me-2"></i>${window.i18n ? window.i18n.t('search.noHistory') : '尚無搜尋歷史'}</small>
        </div>`;
        return;
    }

    container.innerHTML = history.map((term, idx) => `
        <button type="button" class="list-group-item list-group-item-action d-flex align-items-center py-2 ${idx===0?'active':''}" 
                data-search-term="${escapeHtml(term)}">
            <i class="fas fa-history text-muted me-3" style="width: 16px;"></i>
            <span class="flex-grow-1">${escapeHtml(term)}</span>
            <small class="text-muted">${window.i18n ? window.i18n.t('search.recent') : '最近'}</small>
        </button>
    `).join('');

    const buttons = container.querySelectorAll('.list-group-item-action');
    buttons.forEach((btn, idx) => {
        if (idx === 0) {
            btn.classList.add('quick-search-active');
            btn.classList.add('active');
        } else {
            btn.classList.remove('quick-search-active');
        }
    });

    // 綁定點擊事件 - 點擊歷史記錄項目直接搜尋
    container.querySelectorAll('[data-search-term]').forEach(btn => {
        btn.addEventListener('click', () => {
            const term = btn.getAttribute('data-search-term');
            const input = document.getElementById('quickSearchTPInput');
            if (input && term) {
                input.value = term;
                input.dispatchEvent(new Event('input'));
            }
        });
    });
}

function openQuickSearchTP() {
    const overlay = document.getElementById('quickSearchTPOverlay');
    const input = document.getElementById('quickSearchTPInput');
    const results = document.getElementById('quickSearchTPResults');
    if (!overlay || !input || !results) return;
    
    overlay.style.display = 'block';
    input.value = '';
    results.innerHTML = '';
    input.focus();
    
    // T032: 初始顯示搜尋歷史記錄
    renderSearchHistory(results);

    const handleKey = (e) => {
        if (e.key === 'Escape') { 
            closeQuickSearchTP(); 
            return; 
        }
        if (e.key === 'Enter') {
            const active = results.querySelector('.active');
            if (active) { 
                active.click(); 
            }
        } else if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
            e.preventDefault();
            // T032: 同時處理搜尋結果和歷史記錄項目
            const items = Array.from(results.querySelectorAll('.quick-search-tp-item, .list-group-item-action'));
            if (items.length === 0) return;
            let idx = items.findIndex(li => li.classList.contains('active'));
            if (idx < 0) idx = 0;
            idx = (e.key === 'ArrowDown') ? Math.min(idx+1, items.length-1) : Math.max(idx-1, 0);
            items.forEach(li => {
                li.classList.remove('active');
                li.classList.remove('quick-search-active');
            });
            items[idx].classList.add('active');
            items[idx].classList.add('quick-search-active');
            items[idx].scrollIntoView({ block:'nearest' });
        }
    };
    
    input.onkeydown = handleKey;
    
    // T030: 使用 debounce 優化搜尋，300ms 延遲減少 API 呼叫
    const debouncedSearch = debounce((query) => {
        quickSearchRenderTP(query, results);
    }, 300);
    
    input.oninput = () => {
        const query = input.value.trim();
        
        // T032: 如果查詢為空，顯示搜尋歷史記錄
        if (query.length === 0) {
            renderSearchHistory(results);
            return;
        }
        
        // 顯示搜尋中狀態（立即響應）
        if (query.length >= 1) {
            results.innerHTML = `<div class="list-group-item text-muted d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                ${window.i18n ? window.i18n.t('common.searching') : '搜尋中...'}
            </div>`;
        }
        
        // 延遲執行實際搜尋
        debouncedSearch(query);
    };
}

function closeQuickSearchTP() {
    const overlay = document.getElementById('quickSearchTPOverlay');
    if (overlay) overlay.style.display = 'none';
}

// T027: TP 票號搜尋結果渲染 (含快取優化)
function quickSearchRenderTP(query, container) {
    const q = (query || '').trim().toUpperCase();
    if (q.length === 0) {
        container.innerHTML = '';
        return;
    }
    
    const currentTeamId = AppUtils.getCurrentTeamId();
    if (!currentTeamId) {
        container.innerHTML = `<div class="list-group-item text-muted">${window.i18n ? window.i18n.t('errors.noTeamSelected') : '請先選擇團隊'}</div>`;
        return;
    }
    
    const limit = 20;

    // T027: 檢查快取
    const cachedResult = tpSearchCache.get(q, currentTeamId, limit);
    if (cachedResult) {
        renderSearchResults(cachedResult, container, q);
        return;
    }
    
    // 顯示載入中
    container.innerHTML = `<div class="list-group-item text-muted d-flex align-items-center">
        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
        ${window.i18n ? window.i18n.t('common.searching') : '搜尋中...'}
    </div>`;
    
    const configsUrl = `/api/test-run-configs/search/tp?q=${encodeURIComponent(q)}&team_id=${currentTeamId}&limit=${limit}`;
    const setsUrl = `/api/teams/${currentTeamId}/test-run-sets/search/tp?q=${encodeURIComponent(q)}&limit=${limit}`;

    const configRequest = window.AuthClient.fetch(configsUrl)
        .then(response => {
            if (!response.ok) throw new Error(`Config search failed: ${response.status}`);
            return response.json();
        });

    const setRequest = window.AuthClient.fetch(setsUrl)
        .then(response => {
            if (!response.ok) throw new Error(`Set search failed: ${response.status}`);
            return response.json();
        })
        .catch(error => {
            console.warn('Test Run Set search failed:', error);
            return [];
        });

    Promise.all([configRequest, setRequest])
        .then(([configData, setData]) => {
            const payload = { configs: configData, sets: setData };
            tpSearchCache.set(q, currentTeamId, limit, payload);
            renderSearchResults(payload, container, q);
        })
        .catch(error => {
            console.error('TP 搜尋 API 錯誤:', error);
            container.innerHTML = `<div class="quick-search-tp-no-results text-danger">${window.i18n ? window.i18n.t('errors.searchFailed') : '搜尋失敗，請稍後再試'}</div>`;
        });
}

// T027 + T028: 快速搜尋結果渲染 (簡潔下拉選單風格)
function renderSearchResults(data, container, searchTerm = '') {
    let configs = [];
    let sets = [];

    if (Array.isArray(data)) {
        configs = data;
    } else if (data && typeof data === 'object') {
        configs = Array.isArray(data.configs) ? data.configs : [];
        sets = Array.isArray(data.sets) ? data.sets : [];
    }

    if (configs.length === 0 && sets.length === 0) {
        container.innerHTML = `<div class="list-group-item text-center text-muted py-3 border-0">
            <small><i class="fas fa-search me-2"></i>${window.i18n ? window.i18n.t('errors.noMatchingTPConfigs') : '沒有找到符合條件的 TP 票號配置'}</small>
        </div>`;
        return;
    }

    const sections = [];
    const setHeading = window.i18n ? (window.i18n.t('testRun.quickSearch.testRunSetsHeading') || window.i18n.t('testRun.sets.heading')) : 'Test Run Sets';
    const runHeading = window.i18n ? (window.i18n.t('testRun.quickSearch.testRunsHeading') || 'Test Runs') : 'Test Runs';

    if (sets.length > 0) {
        sections.push(`<div class="list-group-item text-muted small fw-semibold bg-light border-0">${escapeHtml(setHeading || 'Test Run Sets')}</div>`);
        sections.push(sets.map(set => buildSetSearchItem(set, searchTerm)).join(''));
    }

    if (configs.length > 0) {
        sections.push(`<div class="list-group-item text-muted small fw-semibold bg-light border-0">${escapeHtml(runHeading || 'Test Runs')}</div>`);
        sections.push(configs.map(config => buildConfigSearchItem(config, searchTerm)).join(''));
    }

    container.innerHTML = sections.join('');

    const items = Array.from(container.querySelectorAll('.quick-search-tp-item'));
    if (items.length) {
        items[0].classList.add('quick-search-active', 'active');
    }

    items.forEach(btn => {
        btn.addEventListener('click', () => {
            const configId = btn.getAttribute('data-config-id');
            const setId = btn.getAttribute('data-set-id');
            const searchTermValue = btn.getAttribute('data-search-term');

            if (searchTermValue && searchTermValue.trim().length >= 2) {
                tpSearchHistory.add(searchTermValue.trim());
            }

            closeQuickSearchTP();

            if (configId) {
                const teamId = (typeof AppUtils.getCurrentTeamId === 'function') ? AppUtils.getCurrentTeamId() : (AppUtils.getCurrentTeam()?.id ?? '');
                const params = new URLSearchParams({ config_id: String(configId) });
                if (teamId) params.set('team_id', String(teamId));
                window.location.href = `/test-run-execution?${params.toString()}`;
            } else if (setId) {
                openTestRunSetDetail(Number(setId));
            }
        });
    });
}

function buildConfigSearchItem(config, searchTerm) {
    const statusInfo = getSearchResultStatusInfo(config.status, config.execution_rate, config.pass_rate);

    let tpDisplay = '';
    if (config.related_tp_tickets && Array.isArray(config.related_tp_tickets) && config.related_tp_tickets.length > 0) {
        const maxDisplay = 3;
        const visibleTickets = config.related_tp_tickets.slice(0, maxDisplay);
        const remainingCount = config.related_tp_tickets.length - maxDisplay;

        const tpTags = visibleTickets.map(ticket =>
            `<span class="tp-tag badge bg-secondary me-1">${highlightSearchTerm(ticket, searchTerm)}</span>`
        ).join('');

        const remainingTag = remainingCount > 0
            ? `<span class="badge bg-light text-dark" style="font-size: 0.75rem;">+${remainingCount}</span>`
            : '';

        tpDisplay = `<span class="d-inline-flex flex-wrap align-items-center gap-1">${tpTags}${remainingTag}</span>`;
    }

    const envInfo = config.test_environment || '';
    const buildInfo = config.build_number || '';
    const envBuildDisplay = [envInfo, buildInfo].filter(Boolean).join(' • ');

    return `
        <button type="button" class="list-group-item list-group-item-action quick-search-tp-item py-3 px-4 w-100 text-start"
                data-result-type="config" data-config-id="${config.id}" data-search-term="${escapeHtml(searchTerm)}">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1 min-width-0 pe-3">
                    <div class="d-flex align-items-center mb-1">
                        <i class="fas fa-play stats-icon me-2"></i>
                        <span class="fw-medium text-dark result-title" style="font-size: 1rem;">${highlightSearchTerm(config.name || '', searchTerm)}</span>
                        <span class="status-badge ${statusInfo.statusClass} ms-2 flex-shrink-0" style="font-size: 0.7rem; padding: 0.15rem 0.4rem;">
                            ${statusInfo.statusText}
                        </span>
                    </div>
                    <div class="small text-muted">
                        ${tpDisplay ? `<span class="me-3"><i class="fas fa-ticket-alt stats-icon"></i>${tpDisplay}</span>` : ''}
                        ${envBuildDisplay ? `<span class="me-3"><i class="fas fa-server stats-icon"></i>${escapeHtml(envBuildDisplay)}</span>` : ''}
                        <span><i class="fas fa-list-ul stats-icon"></i>${config.total_test_cases || 0} 案例</span>
                        ${statusInfo.showProgress ? ` • <i class="fas fa-clock stats-icon"></i> ${Math.round(config.execution_rate || 0)}% 執行` : ''}
                    </div>
                </div>
            </div>
        </button>
    `;
}

function buildSetSearchItem(set, searchTerm) {
    const statusInfo = getSearchResultStatusInfo(set.status || 'active', 0, 0);
    const matchingTickets = Array.isArray(set.related_tp_tickets) ? set.related_tp_tickets : [];
    const maxDisplay = 3;
    const visibleTickets = matchingTickets.slice(0, maxDisplay);
    const remainingCount = matchingTickets.length - maxDisplay;
    let tpTags = '';
    let tpMeta = '';
    if (visibleTickets.length > 0) {
        const badges = visibleTickets.map(ticket =>
            `<span class="tp-tag badge bg-secondary me-1">${highlightSearchTerm(ticket, searchTerm)}</span>`
        ).join('');
        const remaining = remainingCount > 0
            ? `<span class="badge bg-light text-dark ms-1" style="font-size: 0.75rem;">+${remainingCount}</span>`
            : '';
        tpMeta = `<span class="d-inline-flex align-items-center gap-1">${badges}${remaining}</span>`;
    }

    const totalRunsLabel = window.i18n ? (window.i18n.t('testRun.sets.card.totalRuns') || '包含 Test Run') : 'Test Runs';

    return `
        <button type="button" class="list-group-item list-group-item-action quick-search-tp-item py-3 px-4 w-100 text-start"
                data-result-type="set" data-set-id="${set.id}" data-search-term="${escapeHtml(searchTerm)}">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1 min-width-0 pe-3">
                    <div class="d-flex align-items-center mb-1">
                        <i class="fas fa-layer-group stats-icon me-2"></i>
                        <span class="fw-medium text-dark result-title" style="font-size: 1rem;">${highlightSearchTerm(set.name || '', searchTerm)}</span>
                        <span class="status-badge ${statusInfo.statusClass} ms-2 flex-shrink-0" style="font-size: 0.7rem; padding: 0.15rem 0.4rem;">
                            ${statusInfo.statusText}
                        </span>
                    </div>
                    <div class="small text-muted">
                        <span class="me-3"><i class="fas fa-layer-group stats-icon"></i>${escapeHtml(totalRunsLabel || 'Test Runs')}: ${set.test_run_count || 0}</span>
                        ${tpMeta ? `<span class="me-3"><i class="fas fa-ticket-alt stats-icon"></i>${tpMeta}</span>` : ''}
                    </div>
                </div>
            </div>
        </button>
    `;
}

// 初始化快速搜尋功能
document.addEventListener('DOMContentLoaded', function() {
    setupQuickSearch_TPTicket();
});

// ===== 通知設定相關功能 =====
function initNotificationSettings() {
    const enabledEl = document.getElementById('notificationsEnabled');
    const sectionEl = document.getElementById('notificationGroupsSection');
    const searchBtn = document.getElementById('searchGroupsBtn');
    const searchInput = document.getElementById('notifyGroupsInput');

    if (!enabledEl || !sectionEl) return;

    const toggleSection = () => {
        if (enabledEl.checked) {
            sectionEl.style.display = '';
            sectionEl.classList.add('notification-groups-entering');
            requestAnimationFrame(() => {
                sectionEl.classList.remove('notification-groups-entering');
                sectionEl.classList.add('notification-groups-entered');
            });
        } else {
            sectionEl.classList.remove('notification-groups-entered');
            sectionEl.classList.add('notification-groups-exiting');
            setTimeout(() => {
                sectionEl.classList.remove('notification-groups-exiting');
                sectionEl.style.display = 'none';
            }, 150);
        }
    };

    enabledEl.onchange = toggleSection;
    toggleSection();

    if (searchBtn && searchInput) {
        searchBtn.onclick = () => performGroupSearch(searchInput.value.trim());
        searchInput.onkeydown = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                performGroupSearch(searchInput.value.trim());
            }
        };
    }
}

// ===== URL 工具：確保 team_id 反映在網址列（不重新載入頁面） =====
function ensureTeamIdInUrl_TRM(teamId) {
    try {
        const url = new URL(window.location.href);
        const before = url.searchParams.get('team_id');
        if (String(before || '') !== String(teamId)) {
            url.searchParams.set('team_id', teamId);
            history.replaceState(null, '', `${url.pathname}?${url.searchParams.toString()}`);
        }
    } catch (_) {}
}

function clearNotificationSettings() {
    const enabledEl = document.getElementById('notificationsEnabled');
    const sectionEl = document.getElementById('notificationGroupsSection');
    const resultsEl = document.getElementById('groupSearchResults');
    const tagsEl = document.getElementById('selectedGroupsTags');
    const countEl = document.getElementById('selectedGroupsCount');
    const displayEl = document.getElementById('selectedGroupsDisplay');
    const searchInput = document.getElementById('notifyGroupsInput');

    if (enabledEl) enabledEl.checked = false;
    if (sectionEl) sectionEl.style.display = 'none';
    if (resultsEl) resultsEl.style.display = 'none', resultsEl.innerHTML = '';
    if (tagsEl) tagsEl.innerHTML = '';
    if (countEl) countEl.textContent = '0';
    if (displayEl) displayEl.style.display = 'none';
    if (searchInput) searchInput.value = '';

    selectedNotifyGroups = [];
}

let selectedNotifyGroups = [];

function loadNotificationSettings(enabled, chatIds, chatNames) {
    const enabledEl = document.getElementById('notificationsEnabled');
    const sectionEl = document.getElementById('notificationGroupsSection');
    enabledEl.checked = !!enabled;
    if (enabled) {
        sectionEl.style.display = '';
    }
    selectedNotifyGroups = [];
    if (Array.isArray(chatIds)) {
        for (let i = 0; i < chatIds.length; i++) {
            const id = chatIds[i];
            const name = (Array.isArray(chatNames) && chatNames[i]) ? chatNames[i] : id;
            selectedNotifyGroups.push({ chat_id: id, name });
        }
    }
    renderSelectedGroups();
}

async function performGroupSearch(keyword) {
    const resultsEl = document.getElementById('groupSearchResults');
    resultsEl.style.display = '';
    resultsEl.innerHTML = `<div class="text-muted small"><i class="fas fa-spinner fa-spin me-2"></i>${window.i18n ? window.i18n.t('testRun.notifications.searchingGroups') : '搜尋群組中...'}</div>`;
    try {
        const url = new URL('/api/integrations/lark/groups', window.location.origin);
        if (keyword) url.searchParams.set('q', keyword);
        const resp = await window.AuthClient.fetch(url);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        if (!Array.isArray(data) || data.length === 0) {
            resultsEl.innerHTML = `<div class="text-muted small"><i class="fas fa-info-circle me-2"></i>${window.i18n ? window.i18n.t('testRun.notifications.noGroupsFound') : '找不到符合條件的群組'}</div>`;
            return;
        }
        resultsEl.innerHTML = data.map(g => renderGroupSearchItem(g)).join('');
        // 綁定點擊事件
        resultsEl.querySelectorAll('.group-search-item').forEach(el => {
            el.addEventListener('click', () => {
                const id = el.getAttribute('data-chat-id');
                const name = el.getAttribute('data-name');
                addSelectedGroup({ chat_id: id, name });
            });
        });
    } catch (e) {
        resultsEl.innerHTML = `<div class="text-danger small"><i class="fas fa-exclamation-triangle me-2"></i>${window.i18n ? window.i18n.t('testRun.notifications.searchError') : '搜尋群組失敗'}</div>`;
    }
}

function renderGroupSearchItem(group) {
    const id = escapeHtml(group.chat_id || '');
    const name = escapeHtml(group.name || id);
    return `
        <div class="group-search-item" data-chat-id="${id}" data-name="${name}">
            <i class="fas fa-users group-icon"></i>
            <span class="group-name">${name}</span>
            <code class="group-id">${id}</code>
        </div>
    `;
}

function addSelectedGroup(group) {
    if (!group || !group.chat_id) return;
    // 去重
    const exists = selectedNotifyGroups.some(g => g.chat_id === group.chat_id);
    if (exists) return;
    if (selectedNotifyGroups.length >= 100) {
        AppUtils.showWarning && AppUtils.showWarning(window.i18n ? window.i18n.t('testRun.notifications.maxGroupsReached') : '最多選擇 100 個群組');
        return;
    }
    selectedNotifyGroups.push({ chat_id: group.chat_id, name: group.name || group.chat_id });
    renderSelectedGroups();
}

function removeSelectedGroup(chatId) {
    selectedNotifyGroups = selectedNotifyGroups.filter(g => g.chat_id !== chatId);
    renderSelectedGroups();
}

function renderSelectedGroups() {
    const displayEl = document.getElementById('selectedGroupsDisplay');
    const tagsEl = document.getElementById('selectedGroupsTags');
    const countEl = document.getElementById('selectedGroupsCount');
    if (!tagsEl || !countEl || !displayEl) return;

    if (selectedNotifyGroups.length === 0) {
        displayEl.style.display = 'none';
        tagsEl.innerHTML = '';
        countEl.textContent = '0';
        return;
    }
    displayEl.style.display = '';
    countEl.textContent = String(selectedNotifyGroups.length);
    tagsEl.innerHTML = selectedNotifyGroups.map(g => renderSelectedGroupTag(g)).join('');
    // 綁定移除按鈕
    tagsEl.querySelectorAll('.group-remove-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-chat-id');
            removeSelectedGroup(id);
        });
    });
}

function renderSelectedGroupTag(group) {
    const id = escapeHtml(group.chat_id || '');
    const name = escapeHtml(group.name || id);
    return `
        <span class="selected-group-tag">
            <i class="fas fa-users"></i>${name}
            <button type="button" class="group-remove-btn" data-chat-id="${id}" title="${window.i18n ? window.i18n.t('testRun.notifications.removeGroup') : '移除群組'}"><i class="fas fa-times"></i></button>
        </span>
    `;
}

function getCurrentNotificationSettings() {
    const enabled = !!document.getElementById('notificationsEnabled')?.checked;
    const chatIds = selectedNotifyGroups.map(g => g.chat_id);
    const chatNames = selectedNotifyGroups.map(g => g.name || g.chat_id);
    return { enabled, chatIds, chatNames };
}

function renderSetDetailTpTags(tickets) {
    const container = document.getElementById('setDetailTpTags');
    const section = document.getElementById('setDetailTpSection');
    
    if (!tickets || tickets.length === 0) {
        if (section) section.style.display = 'none';
        if (container) container.innerHTML = '';
        return;
    }
    
    if (section) section.style.display = 'block';
    if (container) {
        container.innerHTML = tickets.map(ticket => 
            `<span class="tcg-tag me-1" 
                   onmouseenter="showJiraPreview(event, '${escapeHtml(ticket)}')"
                   onmouseleave="hideJiraPreview()"
                   onclick="event.stopPropagation(); openJiraTicket('${escapeHtml(ticket)}')"
                   style="cursor: pointer;">${escapeHtml(ticket)}</span>`
        ).join('');
    }
}

</script>
{% endblock %}

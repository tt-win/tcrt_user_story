{% extends "base.html" %}

{% block title %}測試案例管理 - Test Case Repository Web Tool{% endblock %}

{% block head %}
<!-- Markdown 編輯器相關資源 -->
<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
<link rel="stylesheet" href="/static/css/test-case-management.css">
{% endblock %}

{% block page_title_text %}
<span data-i18n="testCase.management">測試案例管理</span>
{% endblock %}

{% block page_subtitle_text %}
<span data-i18n="testCase.subtitle">管理測試案例，支援搜尋、過濾、編輯和批次操作</span>
{% endblock %}

{% block page_specific_actions %}
<div class="d-flex gap-2">
    <button type="button" class="btn btn-primary" id="addTestCaseBtn" style="display: none;">
        <i class="fas fa-plus me-2"></i><span data-i18n="testCase.createTestCase">新增測試案例</span>
    </button>
    <div class="btn-group" role="group" id="bulkModeDropdownGroup" style="display: none;">
        <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-layer-group me-2"></i><span data-i18n="testCase.bulk.bulkMode">大量模式</span>
        </button>
        <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" id="openBulkCreateBtn">
                <i class="fas fa-plus me-2"></i><span data-i18n="testCase.bulk.bulkCreateMode">大量新增模式</span>
            </a></li>
            <li><a class="dropdown-item" href="#" id="openBulkEditBtn">
                <i class="fas fa-edit me-2"></i><span data-i18n="testCase.bulk.bulkEditMode">大量編輯模式</span>
            </a></li>
        </ul>
    </div>
    <button type="button" class="btn btn-secondary" id="refreshBtn">
        <i class="fas fa-sync-alt me-2"></i><span data-i18n="common.refresh">重新整理</span>
    </button>
    <div class="btn-group" role="group" id="jumpToSetGroup" style="display: none;">
        <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-arrow-right me-2"></i><span data-i18n="common.jumpTo">跳至</span>
        </button>
        <ul class="dropdown-menu" id="jumpToSetDropdown">
            <!-- 其他 Test Case Sets 會在此動態列出 -->
        </ul>
    </div>
    <a href="/test-case-sets" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-2"></i><span data-i18n="navigation.backToSets">回到 Test Case Sets</span>
    </a>
    <a href="/" class="btn btn-secondary">
        <i class="fas fa-home me-2"></i><span data-i18n="navigation.backToHome">回到首頁</span>
    </a>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid" id="testCasesPage">

    <!-- 載入進度條 -->
    <div id="loadingProgress" class="card mb-2" style="display: none;">
        <div class="card-body">
            <h5 class="card-title mb-3">
                <i class="fas fa-spinner fa-spin me-2"></i><span data-i18n="common.loading">載入中...</span>
            </h5>

            <!-- Test Case 載入進度 -->
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="text-muted" data-i18n="testCase.loadingTestCases">載入測試案例</small>
                    <small class="text-muted" id="testCaseProgress">0%</small>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-primary" id="testCaseProgressBar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>

            <!-- TCG 快取載入進度 -->
            <div class="mb-2">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <small class="text-muted" data-i18n="testCase.loadingTCG">載入 JIRA Tickets 快取</small>
                    <small class="text-muted" id="tcgCacheProgress">0%</small>
                </div>
                <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-success" id="tcgCacheProgressBar" role="progressbar" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 搜尋與篩選區 -->
    <div class="card mb-3" id="searchFilterCard" style="display: none;">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3 col-lg-2">
                    <label for="testCaseNumberSearch" class="form-label" data-i18n="testCase.testCaseNumber">Test Case Number</label>
                    <input type="text" class="form-control" id="testCaseNumberSearch" data-i18n-placeholder="testCase.testCaseNumberPlaceholder">
                </div>
                <div class="col-md-3 col-lg-2">
                    <label for="searchInput" class="form-label" data-i18n="common.search">關鍵字搜尋</label>
                    <input type="text" class="form-control" id="searchInput" data-i18n-placeholder="testCase.searchPlaceholder">
                </div>
                <div class="col-md-2 col-lg-1">
                    <label for="tcgFilter" class="form-label">JIRA Tickets</label>
                    <input type="text" class="form-control" id="tcgFilter" data-i18n-placeholder="testCase.tcgFilterPlaceholder" data-i18n-placeholder-fallback="輸入 JIRA Ticket">
                </div>
                <div class="col-md-1 col-lg-1">
                    <label for="priorityFilter" class="form-label" data-i18n="testCase.priority">優先級</label>
                    <select class="form-select" id="priorityFilter">
                        <option value="" data-i18n="common.all">全部</option>
                        <option value="High" data-i18n="priority.high">High</option>
                        <option value="Medium" data-i18n="priority.medium">Medium</option>
                        <option value="Low" data-i18n="priority.low">Low</option>
                    </select>
                </div>
                <div class="col-md-3 col-lg-6 d-flex align-items-end justify-content-between flex-wrap">
                    <div class="d-flex align-items-center mb-2 mb-lg-0">
                        <button type="button" class="btn btn-success me-2" id="applyFiltersBtn">
                            <i class="fas fa-filter me-2"></i><span data-i18n="common.apply">套用篩選</span>
                        </button>
                        <button type="button" class="btn btn-secondary" id="clearFiltersBtn">
                            <i class="fas fa-times me-2"></i><span data-i18n="common.clear">清除</span>
                        </button>
                    </div>
                    <!-- 批次操作工具列（與套用篩選同一排、靠右顯示） -->
                    <div id="batchInlineToolbar" class="d-none d-flex align-items-center gap-2 ms-lg-auto mb-2 mb-lg-0" style="display: none !important;">
                        <button type="button" class="btn btn-secondary btn-sm" id="clearSelectionBtnTC"
                                data-i18n-title="common.clearSelection" title="清除選取">
                            <i class="fas fa-xmark"></i>
                        </button>
                        <span class="text-muted" id="selectedCountWrapper" data-i18n="testCase.selectedItems" data-i18n-params='{"count":0}'>
                            已選取 0 個項目
                        </span>
                        <button type="button" class="btn btn-warning btn-sm" id="batchModifyBtn" style="display: none;">
                            <i class="fas fa-edit me-2"></i><span data-i18n="testCase.batchModify">批次修改</span>
                        </button>
                        <button type="button" class="btn btn-warning btn-sm" id="batchCopyBtn" style="display: none;">
                            <i class="fas fa-copy me-2"></i><span data-i18n="testCase.batchCopy.title">批次複製</span>
                        </button>
                        <button type="button" class="btn btn-danger btn-sm" id="batchDeleteBtn" style="display: none;">
                            <i class="fas fa-trash me-2"></i><span data-i18n="testCase.batchDelete">批次刪除</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 測試案例卡片 -->
    <div class="card" id="testCasesCard">
        <div class="card-body">
            <div id="testCasesScroll">
                <div id="testCasesStack" class="section-stack">
                    <!-- cards injected here -->
                </div>
            </div>
        </div>
    </div>

</div>

<!-- 測試案例詳情/編輯 Modal -->
<div class="modal fade" id="testCaseModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog" style="max-width: 85vw; width: 1400px; height: 90vh; max-height: 90vh;">
        <div class="modal-content" style="height: 100%; display: flex; flex-direction: column;">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-clipboard-check me-2"></i>
                    <span id="testCaseModalTitle" data-i18n="testCase.createTestCase">新增測試案例</span>
                </h5>
                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-primary btn-sm" id="copyTcmCaseLinkBtn">
                        <i class="fas fa-link me-1"></i><span data-i18n="common.copyLink">複製連結</span>
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" id="prevTestCaseBtn" data-i18n-title="testCase.previousTestCase">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" id="nextTestCaseBtn" data-i18n-title="testCase.nextTestCase">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body" style="flex: 1; overflow: hidden; padding: 0; display: flex; flex-direction: column;">
                <form id="testCaseForm" style="height: 100%; display: flex; flex-direction: column;">
                    <input type="hidden" id="testCaseId" name="id">
                    <input type="hidden" id="tcg" name="tcg">

                    <!-- 固定區域：基本資訊 -->
                    <div class="fixed-section" style="flex-shrink: 0; padding: 1rem; border-bottom: 1px solid #dee2e6; background: #f8f9fa;">
                        <!-- 第一列：Test Case Number 和 Title -->
                        <div class="row mb-2">
                            <div class="col-md-3">
                                <label for="testCaseNumber" class="form-label"><span data-i18n="testCase.testCaseNumber">Test Case Number</span> <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="testCaseNumber" name="test_case_number" required>
                            </div>
                            <div class="col-md-9">
                                <label for="title" class="form-label"><span data-i18n="form.testCaseTitle">測試案例標題</span> <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="title" name="title" required>
                            </div>
                        </div>
                        <!-- 第二列：Priority、TCG 和 Section -->
                        <div class="row">
                            <div class="col-md-2">
                                <label for="priority" class="form-label"><span data-i18n="testCase.priority">Priority</span></label>
                                <select class="form-select" id="priority" name="priority">
                                    <option value="Medium" data-i18n="testCase.priorityMedium">Medium</option>
                                    <option value="High" data-i18n="testCase.priorityHigh">High</option>
                                    <option value="Low" data-i18n="testCase.priorityLow">Low</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="tcg" class="form-label d-flex align-items-center">
                                    JIRA Tickets
                                    <button type="button" class="btn-icon-only"
                                            title="檢視 JIRA Ticket 資訊"
                                            data-i18n-title="tooltips.viewJiraInfo"
                                            onclick="showTCGPreviewForModal()">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </label>
                                <div class="tcg-tags-container" id="modalTcgContainer"
                                     style="min-height: 32px; padding: 4px 8px; border: 1px solid #dee2e6; border-radius: 4px; background-color: #fff; cursor: text; display: flex; align-items: center; flex-wrap: wrap; gap: 4px; position: relative; max-height: 120px; overflow-y: auto;"
                                     data-permission-required="update">
                                    <!-- TCG 標籤會顯示在這裡 -->
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="testCaseSectionSelect" class="form-label"><span data-i18n="testCase.section">Section</span></label>
                                <select class="form-select" id="testCaseSectionSelect" name="test_case_section_id">
                                    <option value="" data-i18n="testCase.selectSection">請選擇區段</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 可滾動內容區域 -->
                    <div class="scrollable-content" style="flex: 1; overflow-y: auto; padding: 1rem;">

                        <!-- 測試內容三個區域 -->

                        <!-- 測試內容三個區域 - 統一網格佈局 -->
                        <div class="row">
                            <!-- Precondition 區域 -->
                            <div class="col-12 mb-4">
                                <div class="mb-3">
                                    <label for="precondition" class="form-label mb-0">
                                        <i class="fas fa-list-ul me-2"></i><span data-i18n="testCase.preconditions">Preconditions</span>
                                    </label>
                                </div>
                                <div class="markdown-field-container" id="precondition_container">
                                    <div class="row">
                                        <div class="col-12 d-none edit-column">
                                            <!-- 編輯框容器 -->
                                            <div class="form-control markdown-edit-container" style="padding: 0; height: 200px;">
                                                <!-- Markdown 工具列 -->
                                                <div class="markdown-toolbar px-2 py-1 border-bottom" data-target="precondition" style="background-color: #f8f9fa; height: 32px; display: flex; align-items: center;">
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="**" data-i18n-title="markdown.bold">
                                                            <i class="fas fa-bold"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="*" data-i18n-title="markdown.italic">
                                                            <i class="fas fa-italic"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="`" data-i18n-title="markdown.code">
                                                            <i class="fas fa-code"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="# " data-i18n-title="markdown.heading1">H1</button>
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="## " data-i18n-title="markdown.heading2">H2</button>
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="### " data-i18n-title="markdown.heading3">H3</button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="- " data-i18n-title="markdown.unorderedList">
                                                            <i class="fas fa-list-ul"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="1. " data-i18n-title="markdown.orderedList">
                                                            <i class="fas fa-list-ol"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="[text](url)" data-i18n-title="markdown.link">
                                                            <i class="fas fa-link"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="![alt](url)" data-i18n-title="markdown.image">
                                                            <i class="fas fa-image"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <textarea id="precondition" name="precondition" class="markdown-textarea" rows="4"
                                                        data-i18n-placeholder="testCase.preconditionsPlaceholder"
                                                        style="border: none; border-radius: 0; height: calc(100% - 32px); resize: none; outline: none; padding: 0.375rem 0.75rem; width: 100%; box-sizing: border-box; overflow-y: auto;"></textarea>
                                            </div>
                                        </div>
                                        <div class="col-12 preview-column">
                                            <div class="card" style="height: 200px;">
                                                <div class="card-body" style="height: calc(100% - 2rem); padding: 0.75rem;">
                                                    <div class="markdown-preview" data-target="precondition" style="height: 100%; overflow-y: auto; padding: 0.375rem;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 測試步驟區域 -->
                            <div class="col-12 mb-4">
                                <label for="test_steps" class="form-label">
                                    <i class="fas fa-list-ol me-2"></i><span data-i18n="form.testSteps">測試步驟</span>
                                </label>
                                <div class="markdown-field-container" id="test_steps_container">
                                    <div class="row">
                                        <div class="col-12 d-none edit-column">
                                            <!-- 編輯框容器 -->
                                            <div class="form-control markdown-edit-container" style="padding: 0; height: 250px;">
                                                <!-- Markdown 工具列 -->
                                                <div class="markdown-toolbar px-2 py-1 border-bottom" data-target="test_steps" style="background-color: #f8f9fa; height: 32px; display: flex; align-items: center;">
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="**" data-i18n-title="markdown.bold">
                                                            <i class="fas fa-bold"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="*" data-i18n-title="markdown.italic">
                                                            <i class="fas fa-italic"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="`" data-i18n-title="markdown.code">
                                                            <i class="fas fa-code"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="# " data-i18n-title="markdown.heading1">H1</button>
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="## " data-i18n-title="markdown.heading2">H2</button>
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="### " data-i18n-title="markdown.heading3">H3</button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="- " data-i18n-title="markdown.unorderedList">
                                                            <i class="fas fa-list-ul"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="1. " data-i18n-title="markdown.orderedList">
                                                            <i class="fas fa-list-ol"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="[text](url)" data-i18n-title="markdown.link">
                                                            <i class="fas fa-link"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="![alt](url)" data-i18n-title="markdown.image">
                                                            <i class="fas fa-image"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <textarea id="test_steps" name="test_steps" class="markdown-textarea" rows="6"
                                                        data-i18n-placeholder="testCase.stepsPlaceholder"
                                                        style="border: none; border-radius: 0; height: calc(100% - 32px); resize: none; outline: none; padding: 0.375rem 0.75rem; width: 100%; box-sizing: border-box; overflow-y: auto;"></textarea>
                                            </div>
                                        </div>
                                        <div class="col-12 preview-column">
                                            <div class="card" style="height: 250px;">
                                                <div class="card-body" style="height: calc(100% - 2rem); padding: 0.75rem;">
                                                    <div class="markdown-preview" data-target="test_steps" style="height: 100%; overflow-y: auto; padding: 0.375rem;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 預期結果區域 -->
                            <div class="col-12 mb-4">
                                <label for="expected_result" class="form-label">
                                    <i class="fas fa-check-circle me-2"></i><span data-i18n="form.expectedResults">預期結果</span>
                                </label>
                                <div class="markdown-field-container" id="expected_result_container">
                                    <div class="row">
                                        <div class="col-12 d-none edit-column">
                                            <!-- 編輯框容器 -->
                                            <div class="form-control markdown-edit-container" style="padding: 0; height: 200px;">
                                                <!-- Markdown 工具列 -->
                                                <div class="markdown-toolbar px-2 py-1 border-bottom" data-target="expected_result" style="background-color: #f8f9fa; height: 32px; display: flex; align-items: center;">
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="**" data-i18n-title="markdown.bold">
                                                            <i class="fas fa-bold"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="*" data-i18n-title="markdown.italic">
                                                            <i class="fas fa-italic"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="`" data-i18n-title="markdown.code">
                                                            <i class="fas fa-code"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="# " data-i18n-title="markdown.heading1">H1</button>
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="## " data-i18n-title="markdown.heading2">H2</button>
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="### " data-i18n-title="markdown.heading3">H3</button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm me-1" role="group">
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="- " data-i18n-title="markdown.unorderedList">
                                                            <i class="fas fa-list-ul"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="1. " data-i18n-title="markdown.orderedList">
                                                            <i class="fas fa-list-ol"></i>
                                                        </button>
                                                    </div>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="[text](url)" data-i18n-title="markdown.link">
                                                            <i class="fas fa-link"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-secondary btn-xs" data-md="![alt](url)" data-i18n-title="markdown.image">
                                                            <i class="fas fa-image"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <textarea id="expected_result" name="expected_result" class="markdown-textarea" rows="4"
                                                        data-i18n-placeholder="testCase.expectedResultsPlaceholder"
                                                        style="border: none; border-radius: 0; height: calc(100% - 32px); resize: none; outline: none; padding: 0.375rem 0.75rem; width: 100%; box-sizing: border-box; overflow-y: auto;"></textarea>
                                            </div>
                                        </div>
                                        <div class="col-12 preview-column">
                                            <div class="card" style="height: 200px;">
                                                <div class="card-body" style="height: calc(100% - 2rem); padding: 0.75rem;">
                                                    <div class="markdown-preview" data-target="expected_result" style="height: 100%; overflow-y: auto; padding: 0.375rem;"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 附件區域 -->
                        <div class="mb-3">
                            <label for="attachmentUpload" class="form-label">
                                <i class="fas fa-paperclip me-2"></i><span data-i18n="form.attachments">附件</span>
                            </label>
                            <input type="file" class="form-control" id="attachmentUpload" multiple
                                   accept=".jpg,.jpeg,.png,.gif,.pdf,.doc,.docx,.xls,.xlsx,.txt">
                            <div class="form-text" data-i18n="form.attachmentHint">支援圖片、PDF、Office 文件，單檔最大 10MB</div>
                            <div id="attachmentsList" class="mt-2">
                                <!-- 附件列表將由 JavaScript 動態載入 -->
                            </div>
                        </div>
                    </div>

                    <!-- 固定按鈕區域 -->
                    <div class="fixed-buttons" style="flex-shrink: 0; padding: 1rem; border-top: 1px solid #dee2e6; background: #ffffff;">
                        <div class="d-flex justify-content-between align-items-center">
                            <!-- 模式切換按鈕 -->
                            <div class="d-flex align-items-center gap-2">
                                <div class="btn-group btn-group-sm" role="group" id="modeToggleGroup" style="display: none;">
                                    <button type="button" class="btn btn-secondary active" id="previewModeBtn">
                                        <i class="fas fa-eye me-1"></i><span data-i18n="form.browse">瀏覽</span>
                                    </button>
                                    <button type="button" class="btn btn-secondary" id="splitModeBtn" style="display: none;">
                                        <i class="fas fa-edit me-1"></i><span data-i18n="form.editMode">編輯</span>
                                    </button>
                                </div>
                                <button type="button" class="btn btn-info btn-sm" id="referenceTestCaseBtn" onclick="openReferenceTestCasePopup()">
                                    <i class="fas fa-search me-1"></i><span data-i18n="testCase.referenceTestCaseButton">參考測試案例</span>
                                </button>
                                <button type="button" class="btn btn-primary btn-sm" id="aiAssistUnifiedBtn">
                                    <i class="fas fa-magic me-1"></i><span data-i18n="aiAssist.button">AI 輔助</span>
                                </button>
                            </div>
                            <!-- 操作按鈕 -->
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel" style="display: none;">取消</button>
                                <button type="button" class="btn btn-success" id="cloneAndAddNextBtn" style="display: none;">
                                    <i class="fas fa-clone me-2"></i><span data-i18n="testCase.cloneAndAddNext">複製並新增下一筆</span>
                                </button>
                                <button type="button" class="btn btn-success" id="saveAndAddNextBtn" disabled style="display: none;">
                                    <i class="fas fa-plus me-2"></i><span data-i18n="form.saveAndNext">儲存並新增下一筆</span>
                                </button>
                                <button type="button" class="btn btn-primary" id="saveTestCaseBtn" disabled style="display: none;">
                                    <i class="fas fa-save me-2"></i><span data-i18n="common.save">儲存</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- AI 輔助預覽模態框 -->
<div class="modal fade" id="aiAssistModal" tabindex="-1" aria-labelledby="aiAssistModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content ai-assist-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="aiAssistModalLabel">
                    <i class="fas fa-magic text-primary me-2"></i>
                    <span data-i18n="aiAssist.title">AI 輔助</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="ai-assist-grid">
                    <div class="row g-2 align-items-end ai-assist-grid-header">
                        <div class="col-12 col-lg-1">
                            <span class="ai-assist-col-title" data-i18n="aiAssist.fieldColumn">欄位</span>
                        </div>
                        <div class="col-12 col-lg-3">
                            <span class="ai-assist-col-title" data-i18n="aiAssist.originalColumn">原內容</span>
                        </div>
                        <div class="col-12 col-lg-4">
                            <span class="ai-assist-col-title" data-i18n="aiAssist.revisedColumn">改寫內容</span>
                        </div>
                        <div class="col-12 col-lg-4">
                            <span class="ai-assist-col-title" data-i18n="aiAssist.previewColumn">Markdown 預覽</span>
                        </div>
                    </div>
                    <div class="row g-2 ai-assist-grid-row align-items-stretch" data-field="precondition">
                        <div class="col-12 col-lg-1">
                            <div class="form-check ai-assist-field-check">
                                <input class="form-check-input ai-assist-select" type="checkbox" id="aiAssistSelectPrecondition" checked>
                                <label class="form-check-label" for="aiAssistSelectPrecondition">
                                    <span data-i18n="testCase.preconditions">前置條件</span>
                                </label>
                            </div>
                        </div>
                        <div class="col-12 col-lg-3">
                            <textarea id="aiAssistOriginalPrecondition" class="form-control bg-light ai-assist-original" rows="6" readonly></textarea>
                        </div>
                        <div class="col-12 col-lg-4">
                            <textarea id="aiAssistRevisedPrecondition" class="form-control ai-assist-revised" rows="6" data-field="precondition"></textarea>
                        </div>
                        <div class="col-12 col-lg-4">
                            <div class="ai-assist-preview border rounded bg-white" id="aiAssistPreviewPrecondition"></div>
                        </div>
                    </div>
                    <div class="row g-2 ai-assist-grid-row align-items-stretch" data-field="test_steps">
                        <div class="col-12 col-lg-1">
                            <div class="form-check ai-assist-field-check">
                                <input class="form-check-input ai-assist-select" type="checkbox" id="aiAssistSelectSteps" checked>
                                <label class="form-check-label" for="aiAssistSelectSteps">
                                    <span data-i18n="form.testSteps">測試步驟</span>
                                </label>
                            </div>
                        </div>
                        <div class="col-12 col-lg-3">
                            <textarea id="aiAssistOriginalSteps" class="form-control bg-light ai-assist-original" rows="6" readonly></textarea>
                        </div>
                        <div class="col-12 col-lg-4">
                            <textarea id="aiAssistRevisedSteps" class="form-control ai-assist-revised" rows="6" data-field="test_steps"></textarea>
                        </div>
                        <div class="col-12 col-lg-4">
                            <div class="ai-assist-preview border rounded bg-white" id="aiAssistPreviewSteps"></div>
                        </div>
                    </div>
                    <div class="row g-2 ai-assist-grid-row align-items-stretch" data-field="expected_result">
                        <div class="col-12 col-lg-1">
                            <div class="form-check ai-assist-field-check">
                                <input class="form-check-input ai-assist-select" type="checkbox" id="aiAssistSelectExpectedResult" checked>
                                <label class="form-check-label" for="aiAssistSelectExpectedResult">
                                    <span data-i18n="form.expectedResults">預期結果</span>
                                </label>
                            </div>
                        </div>
                        <div class="col-12 col-lg-3">
                            <textarea id="aiAssistOriginalExpectedResult" class="form-control bg-light ai-assist-original" rows="6" readonly></textarea>
                        </div>
                        <div class="col-12 col-lg-4">
                            <textarea id="aiAssistRevisedExpectedResult" class="form-control ai-assist-revised" rows="6" data-field="expected_result"></textarea>
                        </div>
                        <div class="col-12 col-lg-4">
                            <div class="ai-assist-preview border rounded bg-white" id="aiAssistPreviewExpectedResult"></div>
                        </div>
                    </div>
                </div>
                <div class="ai-assist-suggestions mt-3">
                    <label class="form-label" data-i18n="aiAssist.suggestionsLabel">改善建議</label>
                    <div class="border rounded p-2 bg-light ai-assist-suggestions-panel">
                        <ul class="list-group list-group-flush small" id="aiAssistSuggestions"></ul>
                        <div class="text-muted small" id="aiAssistSuggestionsEmpty" data-i18n="aiAssist.noSuggestions">尚無改善建議</div>
                    </div>
                </div>
                <div class="ai-assist-status d-flex align-items-center mt-3 gap-2">
                    <div id="aiAssistLoading" class="d-none d-flex align-items-center gap-2 text-muted small">
                        <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
                        <span data-i18n="aiAssist.loading">正在生成 AI 建議...</span>
                    </div>
                    <div id="aiAssistError" class="text-danger small d-none"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="aiAssistRegenerateBtn" data-i18n="aiAssist.refine">開始改寫</button>
                <button type="button" class="btn btn-secondary" id="aiAssistApplySelectedBtn" data-i18n="aiAssist.applySelected">套用選取</button>
                <button type="button" class="btn btn-primary" id="aiAssistApplyAllBtn" data-i18n="aiAssist.applyAll">全部套用</button>
            </div>
        </div>
    </div>
</div>

<!-- 批次修改模態框 -->
<div class="modal fade" id="testCaseBatchModifyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit text-primary me-2"></i>
                    <span data-i18n="testCase.batchModify">批次修改</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">
                    <span data-i18n="testCase.batchModifyDescription">將對選中的</span>
                    <strong id="testCaseBatchModifyCount">0</strong>
                    <span data-i18n="testCase.itemsApplyChanges">個測試案例套用以下變更：</span>
                </p>

                <!-- TCG 單號批次設定 -->
                <div class="mb-3">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="batchModifyTCG">
                        <label class="form-check-label" for="batchModifyTCG">
                            <strong data-i18n="testCase.batchSetTCG">批次設定 JIRA Tickets</strong>
                        </label>
                    </div>
                    <div class="position-relative">
                        <!-- 顯示已選 TCG 的 tag 區塊，點擊可進入編輯 -->
                        <div id="batchTCGContainer" class="tcg-edit-area" data-i18n-title="tooltips.clickEditTcg" style="min-height: 32px; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; cursor: pointer;"></div>
                        <!-- 隱藏欄位：儲存多選值，以逗號+空白串接，沿用既有提交流程 -->
                        <input type="hidden" id="batchTCGInput" value="">
                        <!-- Dropdown 區塊（與列表一致） -->
                        <div id="batchTCGDropdown"
                             style="position: fixed; z-index: 1070; max-height: 220px; overflow-y: auto; display: none; background: white; border: 1px solid #ced4da; border-radius: 0.375rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                            <div class="p-2 text-muted small" data-i18n="testCase.tcgSearchHint">開始輸入以搜尋 JIRA Ticket...</div>
                        </div>
                    </div>
                    <small class="text-muted" data-i18n="testCase.tcgClearHint">留空可清除 JIRA Ticket 關聯</small>
                </div>

                <!-- 優先級批次設定 -->
                <div class="mb-3">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="batchModifyPriority">
                        <label class="form-check-label" for="batchModifyPriority">
                            <strong data-i18n="testCase.batchSetPriority">批次設定優先級</strong>
                        </label>
                    </div>
                    <select class="form-select" id="batchPrioritySelect" disabled>
                        <option value="" data-i18n="testCase.selectPriority">請選擇優先級</option>
                        <option value="High" data-i18n="testCase.priorityHigh">高</option>
                        <option value="Medium" data-i18n="testCase.priorityMedium">中</option>
                        <option value="Low" data-i18n="testCase.priorityLow">低</option>
                    </select>
                </div>

                <!-- 區段批次設定 -->
                <div class="mb-3">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="batchModifySection">
                        <label class="form-check-label" for="batchModifySection">
                            <strong data-i18n="testCase.batchSetSection" data-i18n-fallback="批次設定區段">批次設定區段</strong>
                        </label>
                    </div>
                    <select class="form-select" id="batchSectionSelect" disabled>
                        <option value="" data-i18n="testCase.selectSection" data-i18n-fallback="請選擇區段">請選擇區段</option>
                    </select>
                    <small class="text-muted" data-i18n="testCase.batchSectionHint" data-i18n-fallback="將選擇的測試案例移動到指定區段">將選擇的測試案例移動到指定區段</small>
                </div>

                <!-- Test Set 批次設定 -->
                <div class="mb-3">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="batchModifyTestSet">
                        <label class="form-check-label" for="batchModifyTestSet">
                            <strong data-i18n="testCase.batchSetTestSet" data-i18n-fallback="批次設定 Test Set">批次設定 Test Set</strong>
                        </label>
                    </div>
                    <select class="form-select" id="batchTestSetSelect" disabled>
                        <option value="" data-i18n="testCase.selectTestSet" data-i18n-fallback="請選擇 Test Set">請選擇 Test Set</option>
                    </select>
                    <small class="text-muted" data-i18n="testCase.batchTestSetHint" data-i18n-fallback="將選擇的測試案例移動到指定 Test Set（會自動設定為 Unassigned 區段）">將選擇的測試案例移動到指定 Test Set（會自動設定為 Unassigned 區段）</small>
                </div>

                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <span data-i18n="testCase.batchModifyNote">只會套用已勾選的項目，空白值將不會變更現有資料。</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="confirmTestCaseBatchModifyBtn">
                    <i class="fas fa-edit me-2"></i><span data-i18n="testCase.confirmModify">確認修改</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 刪除確認 Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i><span data-i18n="form.deleteConfirmation">確認刪除</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-3" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>警告：</strong><span data-i18n="form.deleteWarning">刪除操作無法復原，請謹慎確認</span>
                </div>
                <div id="deleteList">
                    <!-- 要刪除的項目列表 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-2"></i><span data-i18n="common.delete">確認刪除</span>
                </button>
            </div>
        </div>
    </div>
</div>


<!-- 批次複製 Modal -->
<div class="modal fade" id="testCaseBatchCopyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-copy me-2"></i>
                    <span data-i18n="testCase.batchCopy.title">批次複製</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 功能列 -->
                <div class="row g-3 align-items-end mb-3">
                    <div class="col-md-auto">
                        <div class="input-group">
                            <span class="input-group-text py-1" data-i18n="testCase.batchCopy.prefix">Prefix</span>
                            <input type="text" class="form-control form-control-sm flex-grow-0 w-auto" id="copyPrefixInput" placeholder="TCG-93178" style="max-width:16ch;" />
                            <button class="btn btn-primary btn-sm" id="applyCopyPrefixBtn"><span data-i18n="testCase.batchCopy.apply">Apply</span></button>
                        </div>
                    </div>
                    <div class="col-md-auto">
                        <div class="input-group">
                            <span class="input-group-text py-1" data-i18n="testCase.batchCopy.middleCode">Middle Code</span>
                            <input type="text" class="form-control form-control-sm flex-grow-0 w-auto" id="copyMiddleInput" placeholder="010" style="max-width:6ch;" />
                            <button class="btn btn-primary btn-sm" id="applyCopyMiddleBtn"><span data-i18n="testCase.batchCopy.apply">Apply</span></button>
                        </div>
                    </div>
                    <div class="col-md-auto">
                        <div class="input-group">
                            <span class="input-group-text py-1" data-i18n="testCase.batchCopy.suffixStart">Suffix (Start)</span>
                            <input type="text" class="form-control form-control-sm flex-grow-0 w-auto" id="copySuffixStartInput" placeholder="020" style="max-width:6ch;" />
                            <button class="btn btn-primary btn-sm" id="applyCopySuffixBtn"><span data-i18n="testCase.batchCopy.apply">Apply</span></button>
                        </div>
                    </div>
                </div>

                <!-- 選取統計：移除顯示數量 -->

                <!-- 列表 -->
                <div class="table-responsive" style="max-height: 52vh; overflow: auto;">
                    <table class="table table-hover table-sm align-middle">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width:40px;" class="text-center">
                                    <input type="checkbox" class="form-check-input" id="batchCopySelectAllTop">
                                </th>
                                <th style="width:220px;" data-i18n="testCase.testCaseNumber">Test Case Number</th>
                                <th style="width: 220px;" data-i18n="form.title">標題</th>
                            </tr>
                        </thead>
                        <tbody id="batchCopyTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="saveBatchCopyBtn">
                    <i class="fas fa-save me-2"></i><span data-i18n="testCase.batchCopy.save">儲存</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 批次複製預覽 Modal -->
<div class="modal fade" id="batchCopyPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-list-check me-2"></i>
                    <span data-i18n="testCase.batchCopy.previewTitle">確認新增列表</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive" style="max-height: 400px;">
                    <table class="table table-hover table-sm">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 40px;">#</th>
                                <th style="width: 200px;" data-i18n="testCase.testCaseNumber">測試案例編號</th>
                                <th data-i18n="form.title">標題</th>
                                <th style="width: 180px;" data-i18n="testCase.preconditions">前置條件</th>
                                <th style="width: 220px;" data-i18n="testCase.steps">測試步驟</th>
                                <th style="width: 220px;" data-i18n="testCase.expectedResults">預期結果</th>
                                <th style="width: 100px;" data-i18n="testCase.priority">優先級</th>
                            </tr>
                        </thead>
                        <tbody id="batchCopyPreviewList"></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="confirmBatchCopyBtn">
                    <i class="fas fa-check me-2"></i><span data-i18n="common.confirm">確認</span>
                </button>
            </div>
        </div>
    </div>
</div>


<!-- 大量新增 Test Case Modal (文字模式) -->
<div class="modal fade" id="bulkCreateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable modal-fullscreen-md-down" style="max-width: 90vw;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-layer-group me-2"></i>
                    <span data-i18n="testCase.bulkText.title">批次建立測試案例（文字模式）</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 說明文字 -->
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <span data-i18n="testCase.bulkText.help">每行一筆資料，格式為「單號,標題」。單號可不連續。</span>
                    <div class="mt-2">
                        <a href="/static/samples/bulk_test_cases_sample.csv" class="link-dark text-decoration-underline" download data-i18n="testCase.bulkText.sampleLink">下載範例 CSV</a>
                    </div>
                </div>

                <!-- Section 選擇 -->
                <div class="mb-3">
                    <label for="bulkCreateSectionSelect" class="form-label">
                        <span data-i18n="testCase.section">Section</span>
                    </label>
                    <select class="form-select" id="bulkCreateSectionSelect">
                        <option value="" data-i18n="testCase.selectSection" data-i18n-fallback="不指定（使用 Unassigned）">不指定（使用 Unassigned）</option>
                    </select>
                    <small class="form-text text-muted" data-i18n="testCase.bulkText.bulkCreateSectionHint">選擇此批次的所有測試案例要放入的區段</small>
                </div>

                <!-- 文字輸入區 -->
                <div class="mb-3">
                    <textarea
                        id="bulkTextInput"
                        class="form-control font-monospace"
                        rows="14"
                        data-i18n-placeholder="testCase.bulkText.placeholder"
                        placeholder="TC-1001,登入驗證,\"確認測試帳號存在\",\"1. 開啟登入頁; 2. 輸入正確帳密\",\"顯示主控台\",High
TC-1002,錯誤密碼流程,,輸入錯誤密碼,顯示錯誤訊息,Low
TC-1003,API 健康檢查,\"服務已啟動\",\"發送 GET /health\",\"回傳 200\",Medium"></textarea>
                </div>

                <!-- 狀態列 -->
                <div class="d-flex justify-content-between align-items-center">
                    <div id="bulkTextStatus" class="text-muted small">
                        <!-- 動態顯示解析狀態 -->
                    </div>
                    <div id="bulkTextValidation" class="text-danger small">
                        <!-- 顯示驗證錯誤 -->
                    </div>
                </div>

                <!-- 進度條（建立時顯示） -->
                <div id="bulkProgress" style="display:none" class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted" data-i18n="testCase.bulk.creating">建立中...</small>
                        <small class="text-muted" id="bulkProgressText">0/0</small>
                    </div>
                    <div class="progress" style="height:8px;">
                        <div class="progress-bar bg-primary" id="bulkProgressBar" style="width:0%"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="testCase.bulkTextButton.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="startBulkCreateBtn">
                    <i class="fas fa-save me-2"></i><span data-i18n="testCase.bulkTextButton.save">儲存</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 預覽確認 Modal -->
<div class="modal fade" id="bulkPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" style="max-width: 90vw;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-list-check me-2"></i>
                    <span data-i18n="testCase.bulkText.confirmTitle">確認新增列表</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted" id="bulkPreviewDesc">
                    <!-- 動態顯示數量 -->
                </p>
                <div class="table-responsive" style="max-height: 560px;">
                    <table class="table table-hover table-sm">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 40px;">#</th>
                                <th style="width: 200px;" data-i18n="testCase.testCaseNumber">測試案例編號</th>
                                <th data-i18n="form.title">標題</th>
                                <th style="width: 180px;" data-i18n="testCase.preconditions">前置條件</th>
                                <th style="width: 220px;" data-i18n="testCase.steps">測試步驟</th>
                                <th style="width: 220px;" data-i18n="testCase.expectedResults">預期結果</th>
                                <th style="width: 280px; min-width: 21ch;" data-i18n="testCase.tcgColumn">JIRA Tickets</th>
                                <th style="width: 100px;" data-i18n="testCase.priority">優先級</th>
                            </tr>
                        </thead>
                        <tbody id="bulkPreviewList">
                            <!-- 動態產生預覽列表 -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="testCase.bulkTextButton.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="confirmBulkCreateBtn">
                    <i class="fas fa-check me-2"></i><span data-i18n="testCase.bulkTextButton.confirm">確認新增</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 大量編輯 Test Case Modal -->
<div class="modal fade" id="bulkEditModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-table me-2"></i>
                    <span data-i18n="testCase.bulkEdit.title">大量編輯模式</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 工具列 -->
                <div class="bulk-edit-toolbar">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex gap-2 align-items-center">
                            <button type="button" class="btn btn-sm btn-secondary" id="bulkEditOpenSearchBtn">
                                <i class="fas fa-search me-1"></i><span data-i18n="testCase.bulkEdit.search">搜尋及取代</span>
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary" id="bulkEditUndoBtn" disabled>
                                <i class="fas fa-undo me-1"></i><span data-i18n="common.undo">復原</span>
                            </button>
                            <div class="vr"></div>
                            <span class="text-muted small" id="bulkEditStatus">
                                <span data-i18n="testCase.bulkEdit.editingCount" data-i18n-params='{"count":0}'>編輯 0 筆資料</span>
                            </span>
                        </div>
                        <div class="d-flex gap-2">
                            <span class="text-muted small" id="bulkEditChangeCount">
                                <span data-i18n="testCase.bulkEdit.changedCount" data-i18n-params='{"count":0}'>已修改 0 筆</span>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- 表格容器 -->
                <div class="bulk-edit-grid-container">
                    <table class="bulk-edit-grid" id="bulkEditGrid">
                        <thead>
                            <tr>
                                <th style="width: 40px;">#</th>
                                <th style="width: 180px;" data-i18n="testCase.testCaseNumber">測試案例編號</th>
                                <th style="width: 200px;" data-i18n="form.title">標題</th>
                                <th style="width: 100px;" data-i18n="testCase.priority">優先級</th>
                                <th style="width: 200px;" data-i18n="testCase.preconditions">前置條件</th>
                                <th style="width: 250px;" data-i18n="testCase.steps">測試步驟</th>
                                <th style="width: 200px;" data-i18n="testCase.expectedResults">預期結果</th>
                            </tr>
                        </thead>
                        <tbody id="bulkEditGridBody">
                            <!-- 動態產生列表 -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="saveBulkEditBtn">
                    <i class="fas fa-save me-2"></i><span data-i18n="common.save">儲存</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 搜尋及取代 Modal -->
<div class="modal fade" id="bulkEditSearchModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>
                    <span data-i18n="testCase.bulkEdit.searchReplace">搜尋及取代</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 搜尋表單 -->
                <div id="bulkEditSearchForm">
                    <div class="mb-3">
                        <label for="bulkEditSearchText" class="form-label" data-i18n="testCase.bulkEdit.searchText">搜尋內容</label>
                        <input type="text" class="form-control" id="bulkEditSearchText">
                    </div>
                    <div class="mb-3">
                        <label for="bulkEditReplaceText" class="form-label" data-i18n="testCase.bulkEdit.replaceText">取代內容</label>
                        <input type="text" class="form-control" id="bulkEditReplaceText">
                    </div>
                    <div class="mb-3">
                        <label for="bulkEditSearchColumn" class="form-label" data-i18n="testCase.bulkEdit.searchColumn">搜尋範圍</label>
                        <select class="form-select" id="bulkEditSearchColumn">
                            <option value="all" data-i18n="common.all">所有欄位</option>
                            <option value="title" data-i18n="form.title">標題</option>
                            <option value="precondition" data-i18n="testCase.preconditions">前置條件</option>
                            <option value="steps" data-i18n="testCase.steps">測試步驟</option>
                            <option value="expected_result" data-i18n="testCase.expectedResults">預期結果</option>
                        </select>
                    </div>
                </div>

                <!-- 搜尋結果列表 -->
                <div id="bulkEditSearchResults" style="display: none;">
                    <div class="mb-2">
                        <small class="text-muted">
                            找到 <strong id="bulkEditResultCount">0</strong> 個符合項目
                        </small>
                    </div>
                    <div class="d-flex gap-2 mb-2">
                        <button type="button" class="btn btn-sm btn-secondary" id="bulkEditSelectAllBtn">
                            <i class="fas fa-check-square me-1"></i>全選
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary" id="bulkEditDeselectAllBtn">
                            <i class="fas fa-square me-1"></i>反選
                        </button>
                    </div>
                    <div class="list-group" style="max-height: 400px; overflow-y: auto;" id="bulkEditResultsList">
                        <!-- 結果項目將動態添加在這裡 -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-info" id="bulkEditSearchBtn">
                    <i class="fas fa-search me-2"></i><span data-i18n="common.search">搜尋</span>
                </button>
                <button type="button" class="btn btn-primary" id="bulkEditReplaceBtn" style="display: none;">
                    <i class="fas fa-exchange-alt me-2"></i><span data-i18n="testCase.bulkEdit.replace">取代</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/test-case-management/core.js"></script>
<script src="/static/js/test-case-management/cache.js"></script>
<script src="/static/js/test-case-management/tcg.js"></script>
<script src="/static/js/test-case-management/init.js"></script>
<script src="/static/js/test-case-management/bulk.js"></script>
<script src="/static/js/test-case-management/modal.js"></script>
<script src="/static/js/test-case-management/quick-search.js"></script>
<script src="/static/js/test-case-management/utils.js"></script>
<script src="/static/js/test-case-management/ai-assist.js"></script>
<script src="/static/js/test-case-management/markdown.js"></script>
<script src="/static/js/test-case-management/attachments.js"></script>
<script src="/static/js/test-case-management/tcg-tooltip.js"></script>
<script src="/static/js/test-case-management/reference-test-case.js"></script>
<script src="/static/js/test-case-management/bulk-edit.js"></script>
<script src="/static/js/test-case-management/drag-selection.js"></script>

<!-- Test Case Set 和 Section 多語系翻譯 -->
<script src="/static/js/i18n-test-case-set.js"></script>

<!-- Test Case Set 整合模組 -->
<script src="/static/js/test-case-set-integration.js"></script>

<!-- Test Case Section List 側邊欄模組 -->
<script src="/static/js/test-case-section-list.js"></script>

<!-- Test Case 與 Section 整合模組 -->
<!-- Section 整合功能已移至 Modal 內建，不再需要外部整合模組 -->
<!-- <script src="/static/js/test-case-section-integration.js"></script> -->

<!-- Test Case 和 Section 拖拽功能 -->
<script src="/static/js/test-case-drag-drop.js"></script>

<!-- 跨 Test Case Set 複製/搬移功能 -->
<script src="/static/js/test-case-cross-set-ops.js"></script>

<!-- 初始化 Test Case Section List -->
<script src="/static/js/test-case-management/section-list-init.js"></script>
{% endblock %}

{% extends "base.html" %}

{% block title %}團隊管理 - Test Case Repository Web Tool{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/team-management.css">
{% endblock %}

{% block page_title_text %}
<span class="text-primary" data-i18n="team.management">團隊管理</span>
{% endblock %}

{% block page_subtitle_text %}
<span data-i18n="team.subtitle">管理各團隊的 Lark 多維表格連結設定</span>
{% endblock %}

{% block page_specific_actions %}
<div class="d-flex gap-2">
    <button type="button" class="btn btn-primary" id="createTeamBtn">
        <i class="fas fa-plus me-2"></i><span data-i18n="team.createTeam">新增團隊</span>
    </button>
    <!-- 匯入工具下拉選單 -->
    <div class="btn-group" role="group" id="importMenuGroup">
        <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-file-import me-2"></i><span>匯入工具</span>
        </button>
        <ul class="dropdown-menu">
            <li>
                <a class="dropdown-item" href="#" id="importUSMBtn">
                    <i class="fas fa-project-diagram me-2"></i><span>匯入 USM</span>
                </a>
            </li>
        </ul>
    </div>
    <!-- 數據與記錄下拉選單 -->
    <div class="btn-group" role="group" id="dataMenuGroup">
        <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-chart-bar me-2"></i><span data-i18n="dataMenu.title">數據與記錄</span>
        </button>
        <ul class="dropdown-menu">
            <li>
                <a class="dropdown-item" href="/audit-logs">
                    <i class="fas fa-clipboard-list me-2"></i><span data-i18n="audit.viewLogs">審計記錄</span>
                </a>
            </li>
            <li>
                <a class="dropdown-item" href="/team-statistics" id="teamStatsLink">
                    <i class="fas fa-chart-line me-2"></i><span data-i18n="user.menu.teamStatistics">團隊數據統計</span>
                </a>
            </li>
        </ul>
    </div>
    <button type="button" class="btn btn-primary" id="syncOrgBtn">
        <i class="fas fa-users me-2"></i><span data-i18n="orgSync.openButton">同步組織架構</span>
    </button>
    <button type="button" class="btn btn-secondary" id="refreshBtn">
        <i class="fas fa-sync-alt me-2"></i><span data-i18n="common.refresh">重新整理</span>
    </button>
    <a href="/" class="btn btn-secondary">
        <i class="fas fa-home me-2"></i><span data-i18n="navigation.backToHome">回到首頁</span>
    </a>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">


    <!-- 載入狀態 -->
    <div id="loading-state" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden" data-i18n="common.loading">載入中...</span>
        </div>
        <div class="mt-3 text-muted" data-i18n="messages.loadingTeams">載入團隊資料中...</div>
    </div>

    <!-- 團隊列表區域 -->
    <div id="teams-section">
        <div class="row" id="teams-container">
            <!-- 團隊卡片將在此處動態生成 -->
        </div>
    </div>

    <!-- 無團隊時的提示 -->
    <div id="no-teams-section" class="text-center py-5" style="display: none;">
        <i class="fas fa-users fa-3x text-muted mb-3"></i>
        <h5 class="text-muted mb-2" data-i18n="team.noTeams">尚未建立任何團隊</h5>
        <p class="text-muted" data-i18n="team.noTeamsHint">點擊上方「新增團隊」按鈕開始建立第一個團隊</p>
    </div>
</div>

<!-- 建立/編輯團隊模態視窗 -->
<div class="modal fade" id="teamModal" tabindex="-1" aria-labelledby="teamModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="teamModalLabel" data-i18n="team.createTeam">新增團隊</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-i18n-aria-label="common.close" aria-label="關閉"></button>
            </div>
            <div class="modal-body">
                <form id="teamForm">
                    <!-- 基本資訊 -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3" data-i18n="team.basicInfo">基本資訊</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="teamName" class="form-label"><span data-i18n="team.teamName">團隊名稱</span> <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="teamName" name="name" required 
                                       data-i18n-placeholder="team.teamNamePlaceholder">
                            </div>
                            <div class="col-md-6">
                                <label for="teamDescription" class="form-label" data-i18n="team.teamDescription">團隊描述</label>
                                <input type="text" class="form-control" id="teamDescription" name="description" 
                                       data-i18n-placeholder="team.teamDescriptionPlaceholder">
                            </div>
                        </div>
                    </div>

                    <!-- Lark 設定 -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-table me-2"></i><span data-i18n="team.larkSettings">Lark 多維表格設定</span>
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="wikiToken" class="form-label"><span data-i18n="team.wikiToken">Wiki Token</span> <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="wikiToken" name="wiki_token" required 
                                       data-i18n-placeholder="team.wikiTokenPlaceholder">
                                <div class="form-text" data-i18n="team.wikiTokenHelp">從 Lark 多維表格分享連結中取得</div>
                            </div>
                            <div class="col-md-6">
                                <label for="testCaseTableId" class="form-label"><span data-i18n="team.testCaseTableId">Test Case 表格 ID</span> <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="testCaseTableId" name="test_case_table_id" required 
                                       data-i18n-placeholder="team.testCaseTableIdPlaceholder">
                                <div class="form-text" data-i18n="team.testCaseTableIdHelp">測試案例表格的 ID</div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="d-flex align-items-center">
                                    <button type="button" class="btn btn-info" id="validateLarkBtn">
                                        <i class="fas fa-check me-2"></i><span data-i18n="team.validateConnection">驗證 Lark 連線</span>
                                    </button>
                                    <div id="larkValidationResult" class="ms-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>


                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="saveTeamBtn">
                    <i class="fas fa-save me-2"></i><span data-i18n="team.saveTeam">儲存團隊</span>
                </button>
            </div>
        </div>
    </div>
</div>


<!-- 刪除團隊確認模態視窗 -->
<div class="modal fade" id="deleteTeamModal" tabindex="-1" aria-labelledby="deleteTeamModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title d-flex align-items-center" id="deleteTeamModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span data-i18n="team.deleteTeam">刪除團隊</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" data-i18n-aria-label="common.close" aria-label="關閉"></button>
            </div>
            <div class="modal-body">
                <p id="deleteTeamConfirmMessage" class="mb-0">確定要刪除團隊嗎？此操作無法復原。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteTeamBtn" data-i18n="common.delete">刪除</button>
            </div>
        </div>
    </div>
    </div>

<!-- 同步功能框模態視窗 -->
<div class="modal fade" id="syncModal" tabindex="-1" aria-labelledby="syncModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="syncModalLabel">
                    <i class="fas fa-users me-2"></i><span data-i18n="orgSync.modalTitle">組織架構同步管理</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" data-i18n-aria-label="common.close" aria-label="關閉"></button>
            </div>
            <div class="modal-body">
                <!-- Tabs for sync categories -->
                <ul class="nav nav-tabs" id="syncTabs" role="tablist">
                    <!-- 人員管理分頁（預設隱藏，ADMIN+/SUPER_ADMIN 顯示） -->
                    <li class="nav-item" role="presentation" id="tab-personnel-li" style="display: none;">
                        <button class="nav-link active" id="tab-personnel" data-bs-toggle="tab" data-bs-target="#tab-pane-personnel" type="button" role="tab" aria-controls="tab-pane-personnel" aria-selected="true" data-testid="tab-personnel" data-i18n="personnel.tabTitle">人員管理</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-org" data-bs-toggle="tab" data-bs-target="#tab-pane-org" type="button" role="tab" aria-controls="tab-pane-org" aria-selected="false" data-testid="tab-org" data-i18n="orgSync.tabTitle">組織</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="tab-test-cases" data-bs-toggle="tab" data-bs-target="#tab-pane-test-cases" type="button" role="tab" aria-controls="tab-pane-test-cases" aria-selected="false" data-testid="tab-test-cases" data-i18n="tcSync.tabTitle">測試案例</button>
                    </li>
                </ul>
                <div class="tab-content pt-3" id="syncTabsContent">
                    <!-- 人員管理分頁內容 -->
                    <div class="tab-pane fade show active" id="tab-pane-personnel" role="tabpanel" aria-labelledby="tab-personnel">
                        <div class="row g-3">
                            <!-- 左欄：搜尋與使用者列表 -->
                            <div class="col-12 col-lg-4">
                                <div class="card h-100">
                                    <div class="card-header bg-light d-flex align-items-center">
                                        <i class="fas fa-user-friends me-2"></i>
                                        <strong data-i18n="personnel.userList">使用者清單</strong>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="mb-2">
                                            <input type="text" class="form-control form-control-sm" id="pm-search" placeholder="搜尋使用者（名稱/Email）" data-i18n-placeholder="personnel.searchPlaceholder">
                                        </div>
                                        <div id="pm-user-list" class="list-group small" style="max-height: 420px; overflow:auto;"></div>
                                    </div>
                                    <div class="card-footer d-flex justify-content-between align-items-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-secondary" id="pm-prev" data-i18n="personnel.prevPage">上一頁</button>
                                            <button class="btn btn-secondary" id="pm-next" data-i18n="personnel.nextPage">下一頁</button>
                                        </div>
                                        <small class="text-muted" id="pm-page-indicator" data-i18n="personnel.pageIndicator" data-i18n-params='{"page":1,"maxPage":1,"total":0}'>—</small>
                                    </div>
                                </div>
                            </div>
                            <!-- 右欄：詳情/編輯表單 -->
                            <div class="col-12 col-lg-8">
                                <div class="card h-100">
                                    <div class="card-header bg-light d-flex align-items-center">
                                        <i class="fas fa-id-card me-2"></i>
                                        <strong data-i18n="personnel.userDetail">使用者詳情</strong>
                                    </div>
                                    <div class="card-body">
                                        <div id="pm-select-user-prompt" class="text-center py-5" style="display:none;">
                                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                            <h5 class="text-muted mb-2" data-i18n="personnel.selectUser">Select User</h5>
                                            <p class="text-muted" data-i18n="personnel.selectUserHint">Click on a user from the list or click "New User" to create a new user</p>
                                        </div>
                                        <form id="pm-form" autocomplete="off" style="display:none;">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label class="form-label" data-i18n="personnel.username">Username</label> <span class="text-danger">*</span>
                                                    <input type="text" class="form-control" id="pm-username" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label" data-i18n="personnel.fullName">姓名</label>
                                                    <input type="text" class="form-control" id="pm-full-name">
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label" data-i18n="personnel.email">Email</label>
                                                    <input type="email" class="form-control" id="pm-email">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label" data-i18n="personnel.role">角色</label>
                                                    <select class="form-select" id="pm-role"></select>
                                                </div>
                                                <div class="col-md-3 d-flex align-items-end">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="pm-active">
                                                        <label class="form-check-label" for="pm-active" data-i18n="personnel.active">啟用</label>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label" data-i18n="personnel.larkUserId">Lark 使用者</label>
                                                    <div class="input-group position-relative">
                                                        <input type="text" class="form-control" id="pm-lark-search" placeholder="搜尋 Lark 使用者" data-i18n-placeholder="personnel.larkSearchPlaceholder" autocomplete="off">
                                                        <button class="btn btn-danger" type="button" id="pm-lark-unlink" data-i18n="personnel.unlink">解除</button>
                                                        <div class="dropdown-menu position-absolute w-100" id="pm-lark-dropdown" style="display:none; top:100%; z-index:1050; max-height:300px; overflow-y:auto;"></div>
                                                    </div>
                                                    <input type="hidden" id="pm-lark-id">
                                                    <div class="d-flex align-items-center mt-2 small" id="pm-lark-preview-box" style="display:none;">
                                                        <img id="pm-lark-avatar" src="" alt="avatar" class="rounded me-2" style="width:32px;height:32px;object-fit:cover;" onerror="this.style.display='none';">
                                                        <span id="pm-lark-name"></span>
                                                    </div>
                                                    <div id="pm-lark-not-configured" class="mt-2 text-muted small" style="display:none;">
                                                        <i class="fas fa-info-circle me-1"></i>
                                                        <span data-i18n="personnel.larkNotLinked">尚未連結 Lark 帳號</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label" data-i18n="personnel.primaryTeam">主要團隊</label>
                                                    <input type="text" class="form-control" id="pm-primary-team" disabled>
                                                </div>
                                            </div>
                                        </form>
                                        <div class="text-muted small mt-2" id="pm-dirty-hint" style="display:none;" data-i18n="personnel.unsaved">有未儲存的變更</div>
                                    </div>
                                    <div class="card-footer">
                                        <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center">
                                            <div class="btn-group flex-shrink-0" role="group">
                                                <button class="btn btn-primary text-nowrap" id="pm-create"><i class="fas fa-user-plus me-1"></i><span data-i18n="personnel.newUser">New User</span></button>
                                                <button class="btn btn-primary text-nowrap" id="pm-save"><i class="fas fa-save me-1"></i><span data-i18n="personnel.save">儲存</span></button>
                                            </div>
                                            <div class="btn-group flex-shrink-0" role="group">
                                                <button class="btn btn-warning text-nowrap" id="pm-reset"><i class="fas fa-key me-1"></i><span data-i18n="personnel.resetPassword">重設密碼</span></button>
                                                <button class="btn btn-danger text-nowrap" id="pm-delete"><i class="fas fa-trash me-1"></i><span data-i18n="personnel.delete">刪除</span></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
</div>
</div>


                    <div class="tab-pane fade" id="tab-pane-org" role="tabpanel" aria-labelledby="tab-org">
                        <!-- 同步狀態區域 -->
                        <div class="mb-4">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-info-circle me-2"></i><span data-i18n="orgSync.currentStatus">當前同步狀態</span>
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="syncStatusContent">
                                <div id="syncStatusLoading" class="text-center py-3" style="display: none;">
                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                    <span class="text-muted" data-i18n="orgSync.loadingStatus">載入狀態中...</span>
                                </div>
                                
                                <div id="syncStatusIdle" class="d-flex align-items-center" style="display: none;">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-check-circle text-success fa-2x"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-1 text-success" data-i18n="orgSync.idle">系統空閒</h6>
                                        <p class="mb-0 text-muted small" data-i18n="orgSync.readyToRun">準備執行新的同步作業</p>
                                        <div id="lastSyncTime" class="text-muted small mt-1"></div>
                                    </div>
                                </div>
                                
                                <div id="syncStatusRunning" class="d-flex align-items-center" style="display: none;">
                                    <div class="flex-shrink-0">
                                        <div class="spinner-border text-primary" role="status"></div>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-1 text-primary" data-i18n="orgSync.syncing">同步進行中</h6>
                                        <p class="mb-2 text-muted small" data-i18n="orgSync.syncingDesc">正在同步組織架構資料...</p>
                                <!-- 取消進度條與百分比，只保留狀態指示 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                        <!-- 組織統計區域 -->
                        <div class="mb-4">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="card-title mb-0">
                                        <i class="fas fa-chart-bar me-2"></i><span data-i18n="orgSync.statsTitle">組織架構統計</span>
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="orgStatsContent">
                                <div id="orgStatsLoading" class="text-center py-3" style="display: none;">
                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>
                                    <span class="text-muted" data-i18n="orgSync.statsLoading">載入統計資料中...</span>
                                </div>
                                
                                <div id="orgStatsData" class="text-muted" style="display: none;">
                                    <div class="d-flex flex-nowrap align-items-center org-compact-stats">
                                        <span class="stat me-3">
                                            <i class="fas fa-building text-info me-1" style="font-size: 0.95rem;"></i>
                                            <span class="fw-semibold" id="totalDepartments">-</span>
                                        </span>
                                        <span class="stat">
                                            <i class="fas fa-users text-success me-1" style="font-size: 0.95rem;"></i>
                                            <span class="fw-semibold" id="totalUsers">-</span>
                                        </span>
                                    </div>
                                </div>
                                
                                <div id="orgStatsError" class="text-center py-3 text-muted" style="display: none;">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <span data-i18n="orgSync.statsError">統計資料載入失敗</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                        <!-- 組織同步按鈕：分頁底部 -->
                        <div class="d-flex justify-content-end mt-3 pt-2 border-top">
                            <div class="btn-group no-stretch" role="group" aria-label="Sync Actions">
                                <button type="button" class="btn btn-primary" id="startDeptSyncBtn">
                                    <i class="fas fa-sitemap me-2"></i><span data-i18n="orgSync.departmentsSync">部門同步</span>
                                </button>
                                <button type="button" class="btn btn-primary" id="startUserSyncBtn">
                                    <i class="fas fa-address-book me-2"></i><span data-i18n="orgSync.contactsSync">用戶同步</span>
                                </button>
                                <button type="button" class="btn btn-primary" id="startSyncBtn">
                                    <i class="fas fa-play me-2"></i><span data-i18n="orgSync.fullSync">完整同步</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 測試案例同步分頁 -->
                    <div class="tab-pane fade" id="tab-pane-test-cases" role="tabpanel" aria-labelledby="tab-test-cases">
                        <div class="card mb-3">
                            <div class="card-header bg-light d-flex align-items-center">
                                <i class="fas fa-vial me-2"></i>
                                <strong data-i18n="tcSync.title">測試案例同步</strong>
                            </div>
                            <div class="card-body">
                                <div class="row g-3 align-items-end">
                                    <div class="col-md-6">
                                        <label for="tcSyncTeamSelect" class="form-label" data-i18n="tcSync.selectTeam">選擇團隊</label>
                                        <select class="form-select" id="tcSyncTeamSelect"></select>
                                    </div>
                                </div>
<div class="mt-3 text-muted small" id="tcSyncStatus"></div>
<!-- Diff 結果容器 -->
<div id="tcDiffContainer" class="mt-3"></div>
                            </div>
                        </div>
                        <!-- 測試案例同步按鈕：分頁底部（與組織分頁相同位置） -->
                        <div class="d-flex justify-content-end mt-3 pt-2 border-top" data-role="tab-only">
                            <div class="btn-group no-stretch" role="group" aria-label="tc-sync-modes">
                                <button class="btn btn-primary" id="btn-tc-init" data-testid="btn-tc-init" disabled>
                                    <i class="fas fa-download me-1"></i><span data-i18n="tcSync.modes.init">匯入（Lark → 系統）</span>
                                </button>
                                <button class="btn btn-secondary" id="btn-tc-diff" data-testid="btn-tc-diff" disabled>
                                    <i class="fas fa-exchange-alt me-1"></i><span data-i18n="tcSync.modes.diff">Diff（雙向比對）</span>
                                </button>
                                <button class="btn btn-success" id="btn-tc-full" data-testid="btn-tc-full" disabled>
                                    <i class="fas fa-upload me-1"></i><span data-i18n="tcSync.modes.full">上傳（系統 → Lark）</span>
                                </button>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/js/team-management/main.js"></script>

<!-- Hidden i18n texts for Organization Sync (used by JS without window.i18n.t) -->
<div id="org-sync-i18n" class="d-none">
    <span data-i18n="orgSync.openButton">同步組織架構</span>
    <span data-i18n="orgSync.modalTitle">組織架構同步管理</span>
    <span data-i18n="orgSync.currentStatus">當前同步狀態</span>
    <span data-i18n="orgSync.loadingStatus">載入狀態中...</span>
    <span data-i18n="orgSync.idle">系統空閒</span>
    <span data-i18n="orgSync.readyToRun">準備執行新的同步作業</span>
    <span data-i18n="orgSync.syncing">同步進行中</span>
    <span data-i18n="orgSync.syncingDesc">正在同步組織架構資料...</span>
    <span data-i18n="orgSync.preparing">準備開始...</span>
    <span data-i18n="orgSync.statsTitle">組織架構統計</span>
    <span data-i18n="orgSync.statsLoading">載入統計資料中...</span>
    <span data-i18n="orgSync.statsError">統計資料載入失敗</span>
    <span data-i18n="orgSync.departmentsStats">部門統計</span>
    <span data-i18n="orgSync.usersStats">用戶統計</span>
    <span data-i18n="orgSync.total">總數</span>
    <span data-i18n="orgSync.active">活躍</span>
    <span data-i18n="orgSync.fullSync">完整同步</span>
    <span data-i18n="orgSync.departmentsSync">部門同步</span>
    <span data-i18n="orgSync.contactsSync">用戶同步</span>
    <span data-i18n="orgSync.table.type">類型</span>
    <span data-i18n="orgSync.table.status">狀態</span>
    <span data-i18n="orgSync.table.startTime">開始時間</span>
    <span data-i18n="orgSync.table.endTime">結束時間</span>
    <span data-i18n="orgSync.table.duration">耗時</span>
    <span data-i18n="orgSync.table.stats">統計</span>
    <span data-i18n="orgSync.table.trigger">觸發者</span>
    <span data-i18n="orgSync.table.actions">操作</span>
    <span data-i18n="orgSync.lastSyncPrefix">最後同步:</span>
    <span data-i18n="orgSync.syncIdPrefix">同步ID:</span>
    <span data-i18n="orgSync.addTeamFirst">請先新增團隊後再執行同步</span>
    <span data-i18n="orgSync.syncStarted">組織架構同步已開始</span>
    <span data-i18n="orgSync.syncCompleted">組織架構同步已完成！</span>
    <span data-i18n="orgSync.syncCompletedWithIssues">同步完成，但可能有部分錯誤</span>
    <span data-i18n="orgSync.syncFailedPrefix">同步失敗</span>
    <span data-i18n="orgSync.startFailedPrefix">啟動同步失敗</span>
    <span data-i18n="orgSync.triggerFailedPrefix">觸發全域同步失敗</span>
    <span data-i18n="orgSync.statusTimeout">同步狀態檢查超時，請手動刷新頁面查看結果</span>
    <span data-i18n="orgSync.viewErrorDetails">查看錯誤詳情</span>
    <span data-i18n="orgSync.errorPrefix">同步錯誤</span>
    <span data-i18n="orgSync.status.completed">完成</span>
    <span data-i18n="orgSync.status.failed">失敗</span>
    <span data-i18n="orgSync.status.running">進行中</span>
    <span data-i18n="orgSync.status.unknown">未知</span>
    <span data-i18n="orgSync.type.full">完整同步</span>
    <span data-i18n="orgSync.type.departments">部門同步</span>
    <span data-i18n="orgSync.type.users">用戶同步</span>
    <span data-i18n="orgSync.labels.departments">部門</span>
    <span data-i18n="orgSync.labels.users">用戶</span>
</div>

<!-- 人員管理 i18n（僅少量，其他直接透過 data-i18n 使用全域字典） -->
<div id="personnel-i18n" class="d-none">
    <span data-i18n="personnel.tabTitle">人員管理</span>
    <span data-i18n="personnel.userList">使用者清單</span>
    <span data-i18n="personnel.userDetail">使用者詳情</span>
    <span data-i18n="personnel.fullName">姓名</span>
    <span data-i18n="personnel.role">角色</span>
    <span data-i18n="personnel.active">啟用</span>
    <span data-i18n="personnel.larkUserId">Lark 使用者 ID</span>
    <span data-i18n="personnel.preview">預覽</span>
    <span data-i18n="personnel.unlink">解除</span>
    <span data-i18n="personnel.primaryTeam">主要團隊</span>
    <span data-i18n="personnel.unsaved">有未儲存的變更</span>
    <span data-i18n="personnel.create">新增</span>
    <span data-i18n="personnel.save">儲存</span>
    <span data-i18n="personnel.resetPassword">重設密碼</span>
    <span data-i18n="personnel.deactivate">停用/刪除</span>
    <span data-i18n="personnel.searchPlaceholder">搜尋使用者（名稱/Email）</span>
</div>

<!-- USM 匯入模態框 -->
<div class="modal fade" id="usmImportModal" tabindex="-1" aria-labelledby="usmImportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="usmImportModalLabel">
                    <i class="fas fa-file-import me-2"></i>匯入 User Story Map
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="usmImportForm">
                    <!-- Lark URL 輸入 -->
                    <div class="mb-3">
                        <label for="larkUrlInput" class="form-label">
                            <i class="fas fa-link me-2"></i>Lark 多維表格 URL
                            <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="url" 
                            class="form-control" 
                            id="larkUrlInput" 
                            placeholder="https://igxy0zaeo1r.sg.larksuite.com/wiki/..." 
                            required
                        >
                        <small class="form-text text-muted">
                            輸入要匯入的 Lark 多維表格分享連結
                        </small>
                    </div>

                    <!-- 預覽按鈕 -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-info btn-sm" id="preprocessLarkTableBtn">
                            <i class="fas fa-cog me-1"></i>預處理
                        </button>
                        <span id="larkRecordCount" class="ms-2 text-muted small" style="display: none;"></span>
                    </div>

                    <!-- 根節點名稱 -->
                    <div class="mb-3">
                        <label for="rootNodeNameInput" class="form-label">
                            <i class="fas fa-star me-2"></i>根節點名稱
                            <span class="text-danger">*</span>
                        </label>
                        <input 
                            type="text" 
                            class="form-control" 
                            id="rootNodeNameInput" 
                            placeholder="輸入根節點的名稱"
                            required
                        >
                        <small class="form-text text-muted">
                            這將成為 User Story Map 的頂層節點名稱
                        </small>
                    </div>

                    <!-- 團隊選擇 -->
                    <div class="mb-3">
                        <label for="targetTeamSelect" class="form-label">
                            <i class="fas fa-users me-2"></i>目標團隊
                            <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="targetTeamSelect" required>
                            <option value="">-- 請選擇團隊 --</option>
                        </select>
                        <small class="form-text text-muted">
                            選擇要匯入到的團隊
                        </small>
                    </div>

                    <!-- 映射說明 -->
                    <div class="alert alert-info" role="alert">
                        <h6 class="alert-heading">
                            <i class="fas fa-info-circle me-2"></i>欄位映射
                        </h6>
                        <ul class="mb-0 small">
                            <li><strong>Features</strong> → 節點標題</li>
                            <li><strong>Criteria</strong> → 描述</li>
                            <li><strong>As a</strong> → 使用者角色</li>
                            <li><strong>I want</strong> → 需求描述</li>
                            <li><strong>TCG</strong> → JIRA Tickets</li>
                            <li><strong>Parent Tickets</strong> → 父節點關聯</li>
                            <li><strong>最底層節點</strong> → User Story 類型</li>
                            <li><strong>其他節點</strong> → Features 類型</li>
                        </ul>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>取消
                </button>
                <button type="button" class="btn btn-primary" id="confirmUSMImportBtn">
                    <i class="fas fa-file-import me-1"></i>開始匯入
                </button>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/personnel_management.js"></script>
<script src="/static/js/usm_import.js"></script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Test Case Sets - TCRT{% endblock %}

{% block page_title_text %}Test Case Sets{% endblock %}

{% block page_subtitle_text %}選擇或建立一個測試案例集合來開始管理測試案例{% endblock %}

{% block page_specific_actions %}
<a href="/" class="btn btn-secondary btn-sm">
  <i class="fas fa-home"></i> 回到首頁
</a>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

  <!-- Test Case Sets 卡片容器 -->
  <div class="row" id="testCaseSetsContainer">
    <!-- 動態生成的卡片會插入這裡 -->
  </div>

  <!-- 空狀態提示 -->
  <div id="emptyState" class="row d-none">
    <div class="col-12">
      <div class="card bg-light">
        <div class="card-body text-center py-5">
          <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
          <h5 class="text-muted" id="emptyStateTitle">沒有測試案例集合</h5>
          <p class="text-muted" id="emptyStateText">點擊下方卡片建立第一個測試案例集合</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Test Case Set CRUD Modal -->
<div class="modal fade" id="setModal" tabindex="-1" role="dialog" aria-labelledby="setModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="setModalLabel">新增測試案例集合</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="setForm">
          <div class="form-group mb-3">
            <label for="setName">集合名稱 <span class="text-danger">*</span></label>
            <input type="text" id="setName" class="form-control" placeholder="例如: Smoke Test Set" required>
            <small id="setNameError" class="text-danger d-none"></small>
            <small class="form-text text-muted">名稱必須全域唯一</small>
          </div>

          <div class="form-group mb-3">
            <label for="setDescription">描述</label>
            <textarea id="setDescription" class="form-control" rows="3" placeholder="描述此集合的用途..."></textarea>
          </div>

          <div id="formAlert" class="alert d-none" role="alert"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="setModalCloseBtn">取消</button>
        <button type="button" class="btn btn-primary" id="setModalSubmitBtn" onclick="submitSetForm()">
          <span id="submitBtnText">建立</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 刪除確認 Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">確認刪除</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="deleteConfirmText">確定要刪除此測試案例集合嗎？此操作無法撤銷。</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDelete()">刪除</button>
      </div>
    </div>
  </div>
</div>

<!-- Test Case Selection Modal for Creating Test Run from Set Card -->
<div class="modal fade" id="setCaseSelectModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-check-square"></i> 選擇測試案例
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- 搜尋工具列 -->
        <div class="mb-3">
          <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" id="setCaseSearchInput" placeholder="搜尋測試案例...">
          </div>
        </div>

        <!-- Section 樹狀結構和 Test Cases -->
        <div id="setCaseListContainer" style="max-height: 60vh; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.25rem; padding: 0.5rem;">
          <div class="text-center text-muted py-4">
            <div class="spinner-border spinner-border-sm" role="status">
              <span class="visually-hidden">載入中...</span>
            </div>
          </div>
        </div>

        <!-- 摘要信息 -->
        <div class="mt-3 pt-2 border-top">
          <small class="text-muted" id="setCaseSelectionSummary">已選 0 個測試案例</small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary" id="setCaseConfirmBtn">
          <i class="fas fa-arrow-right"></i> 建立 Test Run
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// 全域變數
let currentTeamId = null;
let testCaseSets = [];
let allTeams = [];
let currentEditingSetId = null;
let pendingDeleteSetId = null;

// 國際化
const i18n = {
  'testCaseSet': '測試案例集合',
  'selectOrCreate': '選擇或建立一個測試案例集合來開始管理測試案例',
  'addSet': '新增集合',
  'setName': '集合名稱',
  'setDescription': '描述',
  'createSet': '建立集合',
  'updateSet': '更新集合',
  'deleteSet': '刪除',
  'edit': '編輯',
  'enter': '進入',
  'testCasesCount': '個測試案例',
  'noTestCases': '沒有測試案例',
  'selectTeam': '選擇團隊...',
  'currentTeam': '當前團隊',
  'search': '搜尋集合',
  'searchPlaceholder': '輸入集合名稱...',
  'noTestCaseSets': '沒有測試案例集合',
  'createFirstSet': '點擊「新增集合」按鈕建立第一個測試案例集合',
  'nameRequired': '集合名稱必須全域唯一',
  'nameAlreadyExists': '集合名稱已存在',
  'defaultSetCannotDelete': '無法刪除預設集合',
  'deleteConfirm': '確定要刪除此測試案例集合嗎？此操作無法撤銷。',
  'loadingFailed': '載入資料失敗'
};

// 初始化
document.addEventListener('DOMContentLoaded', async function() {
  console.log('Test Case Sets page loaded');
  loadLanguage();

  // 從 localStorage 獲取當前選擇的團隊 (由 AppUtils.setCurrentTeam 設定)
  const savedTeam = localStorage.getItem('currentTeam');
  console.log('Saved team from localStorage:', savedTeam);

  if (savedTeam) {
    try {
      const team = JSON.parse(savedTeam);
      currentTeamId = team.id;
      console.log('Set currentTeamId to:', currentTeamId, 'Type:', typeof currentTeamId);

      // 檢查 AuthClient 是否準備好
      console.log('AuthClient available:', !!window.AuthClient);
      if (window.AuthClient) {
        console.log('AuthClient token:', window.AuthClient.getToken() ? 'present' : 'missing');
      }

      await loadTestCaseSets();
    } catch (error) {
      console.error('Error parsing team from localStorage:', error);
      showAlert('讀取團隊資訊失敗', 'danger');
    }
  } else {
    console.warn('No currentTeam found in localStorage');
    showAlert('未選擇團隊', 'warning');
  }
});

// 載入語言設定
function loadLanguage() {
  const lang = localStorage.getItem('userLanguage') || 'zh-TW';
  if (window.i18n_dict && window.i18n_dict[lang]) {
    Object.assign(i18n, window.i18n_dict[lang]);
    updatePageText();
  }
}

// 更新頁面文字
function updatePageText() {
  const createBtn = document.getElementById('createSetBtn');
  if (createBtn) {
    createBtn.innerHTML = `<i class="fas fa-plus"></i> ${i18n.addSet || 'Add Set'}`;
  }
}

// 載入 Test Case Sets
async function loadTestCaseSets() {
  if (!currentTeamId) {
    console.warn('No currentTeamId set, skipping loadTestCaseSets');
    return;
  }

  try {
    if (!window.AuthClient) {
      throw new Error('AuthClient 尚未初始化');
    }

    console.log(`Loading test case sets for team ${currentTeamId}`);
    const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-case-sets`);

    if (!response.ok) {
      const errorText = await response.text();
      console.error('API response not OK:', response.status, errorText);
      throw new Error(`Failed to load test case sets (${response.status})`);
    }

    testCaseSets = await response.json();
    console.log('Loaded test case sets:', testCaseSets);
    renderTestCaseSets();
  } catch (error) {
    console.error('Error loading test case sets:', error);
    showAlert(i18n.loadingFailed || 'Failed to load data', 'danger');
  }
}

// 渲染 Test Case Sets 卡片
function renderTestCaseSets() {
  const container = document.getElementById('testCaseSetsContainer');
  const emptyState = document.getElementById('emptyState');

  if (testCaseSets.length === 0) {
    container.innerHTML = `
      <div class="col-md-6 col-lg-4 mb-4">
        ${getAddTestCaseSetCardHtml()}
      </div>
    `;
    emptyState.classList.add('d-none');
    return;
  }

  emptyState.classList.add('d-none');

  const cardsHtml = testCaseSets.map(set => `
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card h-100 test-case-set-card" data-set-id="${set.id}">
        <div class="card-header bg-light border-bottom d-flex justify-content-between align-items-center">
          <h6 class="mb-0">${set.is_default ? '<i class="fas fa-star text-warning"></i> ' : ''}${escapeHtml(set.name)}</h6>
          <div class="dropdown">
            <button class="btn btn-sm btn-link" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fas fa-ellipsis-v"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" onclick="showEditSetModal(${set.id}, '${escapeHtml(set.name)}', '${escapeHtml(set.description || '')}'); return false;">
                <i class="fas fa-edit"></i> ${i18n.edit || 'Edit'}
              </a></li>
              ${!set.is_default ? `
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="#" onclick="showDeleteConfirm(${set.id}, '${escapeHtml(set.name)}'); return false;">
                <i class="fas fa-trash"></i> ${i18n.deleteSet || 'Delete'}
              </a></li>
              ` : ''}
            </ul>
          </div>
        </div>
        <div class="card-body">
          <p class="card-text text-muted text-truncate" title="${escapeHtml(set.description || '')}">
            ${set.description ? escapeHtml(set.description) : '<em>無描述</em>'}
          </p>
          <div class="mt-3 mb-3">
            <small class="text-muted">
              <i class="fas fa-list"></i>
              ${set.test_case_count || 0} ${i18n.testCasesCount || 'Test Cases'}
            </small>
          </div>
        </div>
        <div class="card-footer bg-white border-top d-flex gap-2">
          <button class="btn btn-primary flex-grow-1" onclick="navigateToSet(${set.id})">
            <i class="fas fa-arrow-right"></i> ${i18n.enter || 'Enter'}
          </button>
          <button class="btn btn-success" onclick="openSetCaseSelectModal(${set.id})" title="新增 Test Run">
            <i class="fas fa-plus"></i> <span class="d-none d-md-inline">Test Run</span>
          </button>
        </div>
      </div>
    </div>
  `).join('');

  container.innerHTML = cardsHtml + `
    <div class="col-md-6 col-lg-4 mb-4">
      ${getAddTestCaseSetCardHtml()}
    </div>
  `;
}

// 新增 Test Case Set 卡片 HTML
function getAddTestCaseSetCardHtml() {
  return `
    <div class="card h-100 add-test-case-set-card text-center" style="cursor: pointer; border: 2px dashed var(--tr-border-light); background-color: transparent;" onclick="showCreateSetModal()">
      <div class="card-body d-flex flex-column justify-content-center">
        <div class="text-primary rounded-circle d-flex align-items-center justify-content-center mx-auto mb-3"
             style="width: 48px; height: 48px; font-size: 18px; border: 2px dashed var(--tr-primary);">
          <i class="fas fa-plus"></i>
        </div>
        <h6 class="text-primary mb-1">${i18n.addSet || '新增測試案例集合'}</h6>
        <small class="text-muted">${i18n.createSetHint || '建立新的測試案例集合'}</small>
      </div>
    </div>
  `;
}

// 顯示新增 Set Modal
function showCreateSetModal() {
  currentEditingSetId = null;
  document.getElementById('setModalLabel').textContent = '新增測試案例集合';
  document.getElementById('submitBtnText').textContent = i18n.createSet || 'Create';
  document.getElementById('setForm').reset();
  document.getElementById('setNameError').classList.add('d-none');
  document.getElementById('formAlert').classList.add('d-none');
  const modal = new bootstrap.Modal(document.getElementById('setModal'));
  modal.show();
}

// 顯示編輯 Set Modal
function showEditSetModal(setId, name, description) {
  currentEditingSetId = setId;
  document.getElementById('setModalLabel').textContent = '編輯測試案例集合';
  document.getElementById('submitBtnText').textContent = i18n.updateSet || 'Update';
  document.getElementById('setName').value = name;
  document.getElementById('setDescription').value = description;
  document.getElementById('setNameError').classList.add('d-none');
  document.getElementById('formAlert').classList.add('d-none');
  const modal = new bootstrap.Modal(document.getElementById('setModal'));
  modal.show();
}

// 提交 Set 表單
async function submitSetForm() {
  const name = document.getElementById('setName').value.trim();
  const description = document.getElementById('setDescription').value.trim();
  const nameError = document.getElementById('setNameError');
  const formAlert = document.getElementById('formAlert');

  console.log('Submitting form:', { name, description, currentTeamId, currentEditingSetId });

  nameError.classList.add('d-none');
  formAlert.classList.add('d-none');

  if (!name) {
    nameError.textContent = '集合名稱不可空白';
    nameError.classList.remove('d-none');
    return;
  }

  if (!currentTeamId) {
    formAlert.textContent = '請先選擇團隊';
    formAlert.classList.add('alert-danger');
    formAlert.classList.remove('d-none');
    return;
  }

  try {
    const submitBtn = document.getElementById('setModalSubmitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>處理中...';

    const requestBody = JSON.stringify({ name, description });
    console.log('Request body:', requestBody);

    if (currentEditingSetId) {
      // 更新
      console.log(`Updating set ${currentEditingSetId}`);
      const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-case-sets/${currentEditingSetId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: requestBody
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Failed to update set');
      }
    } else {
      // 新增
      console.log('Creating new set');
      const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-case-sets`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: requestBody
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Failed to create set');
      }
    }

    // 關閉 Modal 並重新載入
    bootstrap.Modal.getInstance(document.getElementById('setModal')).hide();
    await loadTestCaseSets();

  } catch (error) {
    console.error('Error submitting form:', error);
    formAlert.textContent = error.message || 'Error occurred';
    formAlert.classList.add('alert-danger');
    formAlert.classList.remove('d-none');
  } finally {
    const submitBtn = document.getElementById('setModalSubmitBtn');
    submitBtn.disabled = false;
    submitBtn.innerHTML = currentEditingSetId ? (i18n.updateSet || 'Update') : (i18n.createSet || 'Create');
  }
}

// 顯示刪除確認
function showDeleteConfirm(setId, setName) {
  pendingDeleteSetId = setId;
  const confirmText = document.getElementById('deleteConfirmText');
  confirmText.textContent = `確定要刪除「${setName}」嗎？此操作無法撤銷。`;
  const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
  modal.show();
}

// 確認刪除
async function confirmDelete() {
  if (!pendingDeleteSetId) return;

  try {
    const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-case-sets/${pendingDeleteSetId}`, {
      method: 'DELETE'
    });

    if (!response.ok) {
      throw new Error('Failed to delete set');
    }

    bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
    await loadTestCaseSets();
    showAlert('集合已刪除', 'success');

  } catch (error) {
    console.error('Error deleting set:', error);
    showAlert('刪除失敗: ' + error.message, 'danger');
  } finally {
    pendingDeleteSetId = null;
  }
}

// 導航到 Test Case Set
function navigateToSet(setId) {
  // 保存當前選擇的 Set ID
  sessionStorage.setItem('selectedTestCaseSetId', setId);
  // 導航到 Test Case Management
  window.location.href = `/test-case-management?set_id=${setId}`;
}

// 顯示警告訊息
function showAlert(message, type = 'info') {
  const alertHtml = `
    <div class="alert alert-${type} alert-dismissible fade show" role="alert" style="margin-bottom: 12px;">
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  `;

  const flashMessagesContainer = document.getElementById('flash-messages');
  if (!flashMessagesContainer) {
    console.warn('Flash messages container not found');
    return;
  }

  // 建立一個包含訊息的容器
  const alertDiv = document.createElement('div');
  alertDiv.innerHTML = alertHtml;
  const alertElement = alertDiv.firstElementChild;

  flashMessagesContainer.appendChild(alertElement);

  // 自動移除
  setTimeout(() => {
    if (alertElement && alertElement.parentElement) {
      alertElement.remove();
    }
  }, 5000);
}

// HTML 轉義
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}

// ==================== Test Case Selection for Test Run Creation ====================
let currentTestCaseSetId = null;
let setTestCaseData = {
  sections: [],
  testCases: [],
  selectedCases: new Set(),
  filteredCases: []
};
let setSelectModalInstance = null;

/**
 * 打開從 Test Case Set 卡片建立 Test Run 的選擇畫面
 */
async function openSetCaseSelectModal(setId) {
  currentTestCaseSetId = setId;
  setTestCaseData.selectedCases.clear();

  const modalEl = document.getElementById('setCaseSelectModal');
  if (!setSelectModalInstance) {
    setSelectModalInstance = new bootstrap.Modal(modalEl);
  }

  setSelectModalInstance.show();

  // 載入該 Set 的 Sections 和 Test Cases
  await loadSetSectionsAndTestCases(setId);
  renderSetCaseList();
}

/**
 * 載入指定 Test Case Set 的 Sections 和 Test Cases
 */
async function loadSetSectionsAndTestCases(setId) {
  try {
    // 載入 Sections (樹狀結構)
    const sectionsResponse = await window.AuthClient.fetch(
      `/api/test-case-sets/${setId}/sections`,
      { method: 'GET' }
    );

    if (!sectionsResponse.ok) {
      throw new Error('Failed to load sections');
    }

    setTestCaseData.sections = await sectionsResponse.json();

    // 載入該 Set 內的所有 Test Cases
    const casesResponse = await window.AuthClient.fetch(
      `/api/teams/${currentTeamId}/testcases?set_id=${setId}&limit=10000`,
      { method: 'GET' }
    );

    if (!casesResponse.ok) {
      throw new Error('Failed to load test cases');
    }

    setTestCaseData.testCases = await casesResponse.json();
    setTestCaseData.filteredCases = setTestCaseData.testCases;

    console.log('Loaded sections structure:', setTestCaseData.sections);
    console.log('Loaded test cases:', setTestCaseData.testCases);
    console.log('Full data:', setTestCaseData);
  } catch (error) {
    console.error('Error loading sections and test cases:', error);
    document.getElementById('setCaseListContainer').innerHTML =
      '<div class="alert alert-danger">載入失敗，請重試</div>';
  }
}

/**
 * 檢查是否為 Unassigned Section
 */
function isUnassignedSection(section) {
  if (!section || !section.name) return false;
  return section.name.trim().toLowerCase() === 'unassigned';
}

/**
 * 取得 Section 及其直接子 Section 下的所有 Test Cases（不包括孫層級及以下）
 */
function getDirectTestCasesInSection(section) {
  // 只取該 Section 直接包含的 test cases
  const directCases = setTestCaseData.testCases.filter(tc => tc.test_case_section_id === section.id);
  return directCases;
}

/**
 * 取得 Section 及其所有子 Section 下的所有 Test Cases
 */
function getAllTestCasesInSection(section, allSections) {
  const allCases = [];

  // 加入該 Section 直接包含的 test cases
  const directCases = setTestCaseData.testCases.filter(tc => tc.test_case_section_id === section.id);
  allCases.push(...directCases);

  // 遞迴加入所有子 Section 的 test cases
  const childSections = section.children || [];
  childSections.forEach(child => {
    const childCases = getAllTestCasesInSection(child, allSections);
    allCases.push(...childCases);
  });

  return allCases;
}

/**
 * 對 Section 進行排序，確保 Unassigned 排在最後
 */
function sortSectionsForDisplay(sections) {
  if (!sections || sections.length === 0) return [];

  const unassignedSections = [];
  const normalSections = [];

  sections.forEach(section => {
    if (isUnassignedSection(section)) {
      unassignedSections.push(section);
    } else {
      normalSections.push(section);
    }
  });

  // Normal sections + Unassigned sections
  return [...normalSections, ...unassignedSections];
}

/**
 * 渲染 Test Case 列表（含嵌套 Section 結構）
 */
function renderSetCaseList() {
  const container = document.getElementById('setCaseListContainer');
  const searchValue = document.getElementById('setCaseSearchInput').value.toLowerCase();

  // 應用搜尋
  let filteredCases = setTestCaseData.testCases.filter(testCase => {
    const matchesSearch = testCase.test_case_number.toLowerCase().includes(searchValue) ||
                          testCase.title.toLowerCase().includes(searchValue);
    return matchesSearch;
  });

  setTestCaseData.filteredCases = filteredCases;

  // 建立 case 對應 section 的快速查詢 Map（只包含直接 child cases，不包含孫代）
  const casesBySectionId = {};
  filteredCases.forEach(tc => {
    const sectionId = tc.test_case_section_id || null;
    if (!casesBySectionId[sectionId]) {
      casesBySectionId[sectionId] = [];
    }
    casesBySectionId[sectionId].push(tc);
  });

  // 遞迴渲染 Section 樹
  let html = '<div class="set-case-list">';

  function renderSectionTree(sections, level = 0) {
    if (!sections || sections.length === 0) return '';

    // 對 sections 進行排序，確保 Unassigned 放最後
    const sortedSections = sortSectionsForDisplay(sections);

    return sortedSections.map(section => {
      const sectionId = `section-${section.id}`;
      const isExpanded = sessionStorage.getItem(sectionId) !== 'collapsed';

      // 該 section 直接包含的 test cases（僅搜尋篩選）
      const sectionCases = casesBySectionId[section.id] || [];
      
      // 計算包含子 section 的總 test case 數量
      function countCasesInSectionTree(sec) {
        let count = casesBySectionId[sec.id]?.length || 0;
        if (sec.children && sec.children.length > 0) {
          count += sec.children.reduce((sum, child) => sum + countCasesInSectionTree(child), 0);
        }
        return count;
      }
      const totalCaseCount = countCasesInSectionTree(section);

      // 子 Section
      const childSections = section.children || [];
      const hasChildSections = childSections.length > 0;

      // 總是顯示 Section 標頭（包含 Unassigned），不再依賴內容判斷
      const hasDirectCases = sectionCases.length > 0;
      const hasContent = hasDirectCases || hasChildSections;

      // 強制顯示標頭（包含 Unassigned 即使沒有內容）
      // if (!hasContent) return '';

      // 取得該 Section 子樹所有 cases（搜尋過濾後）
      const subtreeCases = [];
      (function collect(sec){
        const arr = casesBySectionId[sec.id] || [];
        subtreeCases.push(...arr);
        (sec.children || []).forEach(collect);
      })(section);

      // 檢查子樹 cases 的選擇狀態（含所有子層）
      const allDirectSelected = subtreeCases.length > 0 &&
                                subtreeCases.every(tc => setTestCaseData.selectedCases.has(tc.record_id));
      const someDirectSelected = subtreeCases.length > 0 &&
                                 subtreeCases.some(tc => setTestCaseData.selectedCases.has(tc.record_id));
      const indentLevel = level * 20;
      let sectionHtml = `
        <div class="section-group" style="margin-left: ${indentLevel}px;">
          <!-- Section Header -->
          <div class="section-header d-flex align-items-center py-2 px-2 border-bottom" style="background-color: #e8eef5;">
            <input type="checkbox"
                   class="section-checkbox me-2"
                   data-section-id="${section.id}"
                   ${allDirectSelected ? 'checked' : ''}
                   ${someDirectSelected && !allDirectSelected ? 'data-indeterminate="true"' : ''}
                   onchange="handleSectionCheckboxChange(${section.id}, this.checked)">
            <button class="btn btn-link btn-sm p-0 me-2"
                    onclick="toggleSectionExpand(${section.id})"
                    style="width: 24px; height: 24px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; text-decoration: none;"
                    onmouseover="this.style.textDecoration='none'"
                    onmouseout="this.style.textDecoration='none'">
              <i class="fas fa-chevron-${isExpanded ? 'down' : 'right'}"></i>
            </button>
            <span class="fw-500 flex-grow-1">${escapeHtml(section.name)}</span>
            <small class="text-muted">(${totalCaseCount})</small>
          </div>

          <!-- Test Cases and Child Sections -->
          <div class="section-content ${isExpanded ? '' : 'd-none'}" id="content-section-${section.id}">
            <!-- Direct test cases under this section -->
            ${sectionCases.map(testCase => `
              <div class="case-item d-flex align-items-center py-2 px-3" style="background-color: #f8f9fa; border-bottom: 1px solid #e9ecef;">
                <input type="checkbox"
                       class="case-checkbox me-3"
                       data-case-id="${testCase.record_id}"
                       ${setTestCaseData.selectedCases.has(testCase.record_id) ? 'checked' : ''}
                       onchange="handleCaseCheckboxChange('${testCase.record_id}', this.checked)">
                <code class="me-2" style="min-width: 100px; flex-shrink: 0; color: rgb(194, 54, 120); font-size: inherit; font-weight: 500;">${escapeHtml(testCase.test_case_number)}</code>
                <div class="flex-grow-1 text-truncate">${escapeHtml(testCase.title)}</div>
                ${testCase.priority ? `<span class="badge bg-secondary ms-2">${escapeHtml(testCase.priority)}</span>` : ''}
              </div>
            `).join('')}

            <!-- Child Sections -->
            ${renderSectionTree(childSections, level + 1)}
          </div>
        </div>
      `;

      return sectionHtml;
    }).join('');
  }

  if (!setTestCaseData.sections || setTestCaseData.sections.length === 0) {
    html += '<div class="alert alert-info">沒有符合的測試案例</div>';
  } else {
    html += renderSectionTree(setTestCaseData.sections);
  }

  html += '</div>';
  container.innerHTML = html;

  // 修復 indeterminate 狀態的 checkbox
  document.querySelectorAll('[data-indeterminate="true"]').forEach(checkbox => {
    checkbox.indeterminate = true;
  });

  updateSetCaseSelectionSummary();

  // 綁定搜尋事件
  setupSetCaseEventListeners();
}

/**
 * 處理 Section Checkbox 變更（只選擇該 Section 直接包含的 test cases）
 */
function handleSectionCheckboxChange(sectionId, isChecked) {
  // 找到該 Section 對象
  function findSection(sections, id) {
    for (let section of sections) {
      if (section.id === id) {
        return section;
      }
      if (section.children) {
        const found = findSection(section.children, id);
        if (found) return found;
      }
    }
    return null;
  }

  const section = findSection(setTestCaseData.sections, sectionId);
  if (!section) return;

  // 獲取搜尋過濾後的 cases
  const searchValue = document.getElementById('setCaseSearchInput').value.toLowerCase();
  const filteredCases = setTestCaseData.testCases.filter(testCase => {
    const matchesSearch = testCase.test_case_number.toLowerCase().includes(searchValue) ||
                          testCase.title.toLowerCase().includes(searchValue);
    return matchesSearch;
  });

  // 收集該 Section 與其所有子 Section 的 id
  function collectSectionIds(sec, acc = new Set()) {
    acc.add(sec.id);
    (sec.children || []).forEach(child => collectSectionIds(child, acc));
    return acc;
  }
  const sectionIds = collectSectionIds(section);

  // 取得該 Section 子樹下且通過搜尋的所有 test cases
  const subtreeCases = filteredCases.filter(tc => sectionIds.has(tc.test_case_section_id));

  // 選中或取消選中該 Section 子樹下的所有 cases
  subtreeCases.forEach(testCase => {
    if (isChecked) {
      setTestCaseData.selectedCases.add(testCase.record_id);
    } else {
      setTestCaseData.selectedCases.delete(testCase.record_id);
    }
  });

  renderSetCaseList();
}

/**
 * 處理 Test Case Checkbox 變更
 */
function handleCaseCheckboxChange(caseId, isChecked) {
  if (isChecked) {
    setTestCaseData.selectedCases.add(caseId);
  } else {
    setTestCaseData.selectedCases.delete(caseId);
  }

  renderSetCaseList();
}

/**
 * 切換 Section 展開/收合
 */
function toggleSectionExpand(sectionId) {
  const sectionId_key = `section-${sectionId}`;
  const isCurrentlyExpanded = sessionStorage.getItem(sectionId_key) !== 'collapsed';

  if (isCurrentlyExpanded) {
    sessionStorage.setItem(sectionId_key, 'collapsed');
  } else {
    sessionStorage.removeItem(sectionId_key);
  }

  renderSetCaseList();
}

/**
 * 設置搜尋事件監聽
 */
function setupSetCaseEventListeners() {
  document.getElementById('setCaseSearchInput').addEventListener('input', renderSetCaseList);
  
  // 綁定「建立 Test Run」按鈕
  const confirmBtn = document.getElementById('setCaseConfirmBtn');
  if (confirmBtn) {
    confirmBtn.addEventListener('click', confirmSetCaseSelection);
    console.log('[SetCaseSelect] Confirm button event listener bound');
  }
}

/**
 * 更新選擇摘要
 */
function updateSetCaseSelectionSummary() {
  const count = setTestCaseData.selectedCases.size;
  document.getElementById('setCaseSelectionSummary').textContent = `已選 ${count} 個測試案例`;
}

/**
 * 確認選擇並建立 Test Run
 */
async function confirmSetCaseSelection() {
  console.log('[SetCaseSelect] confirmSetCaseSelection called');
  
  // 立即保存調試信息到 localStorage
  const debugInfo = {
    timestamp: new Date().toISOString(),
    step: 'confirmSetCaseSelection_called',
    selectedCasesCount: setTestCaseData.selectedCases.size,
    selectedCaseIds: Array.from(setTestCaseData.selectedCases).join(','),
    currentTestCaseSetId: currentTestCaseSetId,
    currentTeamId: currentTeamId
  };
  
  console.log('[SetCaseSelect] Debug info at start:', debugInfo);
  localStorage.setItem('setTestCaseDebug', JSON.stringify(debugInfo));

  if (setTestCaseData.selectedCases.size === 0) {
    alert('請至少選擇一個測試案例');
    console.warn('[SetCaseSelect] No cases selected');
    return;
  }

  try {
    const selectedCaseIds = Array.from(setTestCaseData.selectedCases).join(',');
    console.log('[SetCaseSelect] selectedCaseIds:', selectedCaseIds);
    
    sessionStorage.setItem('testRunSetId', currentTestCaseSetId);
    sessionStorage.setItem('testRunSelectedCaseIds', selectedCaseIds);
    console.log('[SetCaseSelect] Session storage set. testRunSetId:', currentTestCaseSetId);
    console.log('[SetCaseSelect] Session storage set. testRunSelectedCaseIds:', selectedCaseIds);

    // 最後更新 localStorage，準備跳轉
    debugInfo.step = 'ready_to_redirect';
    debugInfo.sessionStorageSet = true;
    localStorage.setItem('setTestCaseDebug', JSON.stringify(debugInfo));

    // 導航到 Test Run 建立頁面
    const redirectUrl = `/test-run-management?team_id=${currentTeamId}&set_id=${currentTestCaseSetId}`;
    console.log('[SetCaseSelect] Redirecting to:', redirectUrl);
    
    debugInfo.step = 'redirecting';
    debugInfo.redirectUrl = redirectUrl;
    localStorage.setItem('setTestCaseDebug', JSON.stringify(debugInfo));
    
    window.location.href = redirectUrl;
  } catch (error) {
    console.error('[SetCaseSelect] Error confirming case selection:', error);
    debugInfo.step = 'error';
    debugInfo.error = error.message;
    localStorage.setItem('setTestCaseDebug', JSON.stringify(debugInfo));
    alert('建立失敗，請重試');
  }
}


</script>

<!-- Test Case Set 和 Section 多語系翻譯 -->
<script src="/static/js/i18n-test-case-set.js"></script>

<style>
.test-case-set-card {
  transition: all 0.3s ease;
  border: 1px solid #e9ecef;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.test-case-set-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  transform: translateY(-2px);
}

.test-case-set-card .dropdown-menu {
  min-width: 150px;
}

.test-case-set-card .card-header {
  padding: 1rem;
}

.test-case-set-card .card-footer {
  padding: 0.75rem 1rem;
}

.test-case-set-card .btn-primary {
  font-weight: 500;
}

/* Test Case Selection Modal Styles */
.set-case-list {
  font-size: 0.9rem;
}

.section-group {
  margin-bottom: 0.5rem;
}

.section-header {
  cursor: pointer;
  transition: background-color 0.2s;
}

.section-header:hover {
  background-color: #e9ecef !important;
}

.section-header .fw-500 {
  font-weight: 500;
}

.section-content {
  background-color: #f9f9f9;
  transition: all 0.3s ease;
}

.section-content.d-none {
  display: none !important;
}

.case-item {
  transition: background-color 0.2s;
}

.case-item:hover {
  background-color: #f0f8ff;
}

.case-number {
  font-family: monospace;
}

.case-title {
  font-weight: 500;
  margin: 0.25rem 0;
}

/* Indeterminate checkbox styling */
input[type="checkbox"]:indeterminate {
  background-color: #0dcaf0;
  border-color: #0dcaf0;
}
</style>
{% endblock %}

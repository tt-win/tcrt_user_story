{% extends "base.html" %}

{% block title %}Test Case Sets - TCRT{% endblock %}

{% block page_title_text %}Test Case Sets{% endblock %}

{% block page_subtitle_text %}選擇或建立一個測試案例集合來開始管理測試案例{% endblock %}

{% block page_specific_actions %}
<button class="btn btn-primary btn-sm" id="createSetBtn" onclick="showCreateSetModal()">
  <i class="fas fa-plus"></i> 新增集合
</button>
<a href="/" class="btn btn-secondary btn-sm">
  <i class="fas fa-home"></i> 回到首頁
</a>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

  <!-- Test Case Sets 卡片容器 -->
  <div class="row" id="testCaseSetsContainer">
    <!-- 動態生成的卡片會插入這裡 -->
  </div>

  <!-- 空狀態提示 -->
  <div id="emptyState" class="row d-none">
    <div class="col-12">
      <div class="card bg-light">
        <div class="card-body text-center py-5">
          <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
          <h5 class="text-muted" id="emptyStateTitle">沒有測試案例集合</h5>
          <p class="text-muted" id="emptyStateText">點擊「新增集合」按鈕建立第一個測試案例集合</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Test Case Set CRUD Modal -->
<div class="modal fade" id="setModal" tabindex="-1" role="dialog" aria-labelledby="setModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="setModalLabel">新增測試案例集合</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="setForm">
          <div class="form-group mb-3">
            <label for="setName">集合名稱 <span class="text-danger">*</span></label>
            <input type="text" id="setName" class="form-control" placeholder="例如: Smoke Test Set" required>
            <small id="setNameError" class="text-danger d-none"></small>
            <small class="form-text text-muted">名稱必須全域唯一</small>
          </div>

          <div class="form-group mb-3">
            <label for="setDescription">描述</label>
            <textarea id="setDescription" class="form-control" rows="3" placeholder="描述此集合的用途..."></textarea>
          </div>

          <div id="formAlert" class="alert d-none" role="alert"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="setModalCloseBtn">取消</button>
        <button type="button" class="btn btn-primary" id="setModalSubmitBtn" onclick="submitSetForm()">
          <span id="submitBtnText">建立</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- 刪除確認 Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">確認刪除</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="deleteConfirmText">確定要刪除此測試案例集合嗎？此操作無法撤銷。</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDelete()">刪除</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// 全域變數
let currentTeamId = null;
let testCaseSets = [];
let allTeams = [];
let currentEditingSetId = null;
let pendingDeleteSetId = null;

// 國際化
const i18n = {
  'testCaseSet': '測試案例集合',
  'selectOrCreate': '選擇或建立一個測試案例集合來開始管理測試案例',
  'addSet': '新增集合',
  'setName': '集合名稱',
  'setDescription': '描述',
  'createSet': '建立集合',
  'updateSet': '更新集合',
  'deleteSet': '刪除',
  'edit': '編輯',
  'enter': '進入',
  'testCasesCount': '個測試案例',
  'noTestCases': '沒有測試案例',
  'selectTeam': '選擇團隊...',
  'currentTeam': '當前團隊',
  'search': '搜尋集合',
  'searchPlaceholder': '輸入集合名稱...',
  'noTestCaseSets': '沒有測試案例集合',
  'createFirstSet': '點擊「新增集合」按鈕建立第一個測試案例集合',
  'nameRequired': '集合名稱必須全域唯一',
  'nameAlreadyExists': '集合名稱已存在',
  'defaultSetCannotDelete': '無法刪除預設集合',
  'deleteConfirm': '確定要刪除此測試案例集合嗎？此操作無法撤銷。',
  'loadingFailed': '載入資料失敗'
};

// 初始化
document.addEventListener('DOMContentLoaded', async function() {
  console.log('Test Case Sets page loaded');
  loadLanguage();

  // 從 localStorage 獲取當前選擇的團隊 (由 AppUtils.setCurrentTeam 設定)
  const savedTeam = localStorage.getItem('currentTeam');
  console.log('Saved team from localStorage:', savedTeam);

  if (savedTeam) {
    try {
      const team = JSON.parse(savedTeam);
      currentTeamId = team.id;
      console.log('Set currentTeamId to:', currentTeamId, 'Type:', typeof currentTeamId);

      // 檢查 AuthClient 是否準備好
      console.log('AuthClient available:', !!window.AuthClient);
      if (window.AuthClient) {
        console.log('AuthClient token:', window.AuthClient.getToken() ? 'present' : 'missing');
      }

      await loadTestCaseSets();
    } catch (error) {
      console.error('Error parsing team from localStorage:', error);
      showAlert('讀取團隊資訊失敗', 'danger');
    }
  } else {
    console.warn('No currentTeam found in localStorage');
    showAlert('未選擇團隊', 'warning');
  }
});

// 載入語言設定
function loadLanguage() {
  const lang = localStorage.getItem('userLanguage') || 'zh-TW';
  if (window.i18n_dict && window.i18n_dict[lang]) {
    Object.assign(i18n, window.i18n_dict[lang]);
    updatePageText();
  }
}

// 更新頁面文字
function updatePageText() {
  const createBtn = document.getElementById('createSetBtn');
  if (createBtn) {
    createBtn.innerHTML = `<i class="fas fa-plus"></i> ${i18n.addSet || 'Add Set'}`;
  }
}

// 載入 Test Case Sets
async function loadTestCaseSets() {
  if (!currentTeamId) {
    console.warn('No currentTeamId set, skipping loadTestCaseSets');
    return;
  }

  try {
    if (!window.AuthClient) {
      throw new Error('AuthClient 尚未初始化');
    }

    console.log(`Loading test case sets for team ${currentTeamId}`);
    const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-case-sets`);

    if (!response.ok) {
      const errorText = await response.text();
      console.error('API response not OK:', response.status, errorText);
      throw new Error(`Failed to load test case sets (${response.status})`);
    }

    testCaseSets = await response.json();
    console.log('Loaded test case sets:', testCaseSets);
    renderTestCaseSets();
  } catch (error) {
    console.error('Error loading test case sets:', error);
    showAlert(i18n.loadingFailed || 'Failed to load data', 'danger');
  }
}

// 渲染 Test Case Sets 卡片
function renderTestCaseSets() {
  const container = document.getElementById('testCaseSetsContainer');
  const emptyState = document.getElementById('emptyState');

  if (testCaseSets.length === 0) {
    container.innerHTML = '';
    emptyState.classList.remove('d-none');
    return;
  }

  emptyState.classList.add('d-none');

  container.innerHTML = testCaseSets.map(set => `
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card h-100 test-case-set-card" data-set-id="${set.id}">
        <div class="card-header bg-light border-bottom d-flex justify-content-between align-items-center">
          <h6 class="mb-0">${set.is_default ? '<i class="fas fa-star text-warning"></i> ' : ''}${escapeHtml(set.name)}</h6>
          <div class="dropdown">
            <button class="btn btn-sm btn-link" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fas fa-ellipsis-v"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" onclick="showEditSetModal(${set.id}, '${escapeHtml(set.name)}', '${escapeHtml(set.description || '')}'); return false;">
                <i class="fas fa-edit"></i> ${i18n.edit || 'Edit'}
              </a></li>
              ${!set.is_default ? `
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="#" onclick="showDeleteConfirm(${set.id}, '${escapeHtml(set.name)}'); return false;">
                <i class="fas fa-trash"></i> ${i18n.deleteSet || 'Delete'}
              </a></li>
              ` : ''}
            </ul>
          </div>
        </div>
        <div class="card-body">
          <p class="card-text text-muted text-truncate" title="${escapeHtml(set.description || '')}">
            ${set.description ? escapeHtml(set.description) : '<em>無描述</em>'}
          </p>
          <div class="mt-3 mb-3">
            <small class="text-muted">
              <i class="fas fa-list"></i>
              ${set.test_case_count || 0} ${i18n.testCasesCount || 'Test Cases'}
            </small>
          </div>
        </div>
        <div class="card-footer bg-white border-top">
          <button class="btn btn-primary w-100" onclick="navigateToSet(${set.id})">
            <i class="fas fa-arrow-right"></i> ${i18n.enter || 'Enter'}
          </button>
        </div>
      </div>
    </div>
  `).join('');
}


// 顯示新增 Set Modal
function showCreateSetModal() {
  currentEditingSetId = null;
  document.getElementById('setModalLabel').textContent = '新增測試案例集合';
  document.getElementById('submitBtnText').textContent = i18n.createSet || 'Create';
  document.getElementById('setForm').reset();
  document.getElementById('setNameError').classList.add('d-none');
  document.getElementById('formAlert').classList.add('d-none');
  const modal = new bootstrap.Modal(document.getElementById('setModal'));
  modal.show();
}

// 顯示編輯 Set Modal
function showEditSetModal(setId, name, description) {
  currentEditingSetId = setId;
  document.getElementById('setModalLabel').textContent = '編輯測試案例集合';
  document.getElementById('submitBtnText').textContent = i18n.updateSet || 'Update';
  document.getElementById('setName').value = name;
  document.getElementById('setDescription').value = description;
  document.getElementById('setNameError').classList.add('d-none');
  document.getElementById('formAlert').classList.add('d-none');
  const modal = new bootstrap.Modal(document.getElementById('setModal'));
  modal.show();
}

// 提交 Set 表單
async function submitSetForm() {
  const name = document.getElementById('setName').value.trim();
  const description = document.getElementById('setDescription').value.trim();
  const nameError = document.getElementById('setNameError');
  const formAlert = document.getElementById('formAlert');

  console.log('Submitting form:', { name, description, currentTeamId, currentEditingSetId });

  nameError.classList.add('d-none');
  formAlert.classList.add('d-none');

  if (!name) {
    nameError.textContent = '集合名稱不可空白';
    nameError.classList.remove('d-none');
    return;
  }

  if (!currentTeamId) {
    formAlert.textContent = '請先選擇團隊';
    formAlert.classList.add('alert-danger');
    formAlert.classList.remove('d-none');
    return;
  }

  try {
    const submitBtn = document.getElementById('setModalSubmitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>處理中...';

    const requestBody = JSON.stringify({ name, description });
    console.log('Request body:', requestBody);

    if (currentEditingSetId) {
      // 更新
      console.log(`Updating set ${currentEditingSetId}`);
      const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-case-sets/${currentEditingSetId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: requestBody
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Failed to update set');
      }
    } else {
      // 新增
      console.log('Creating new set');
      const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-case-sets`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: requestBody
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Failed to create set');
      }
    }

    // 關閉 Modal 並重新載入
    bootstrap.Modal.getInstance(document.getElementById('setModal')).hide();
    await loadTestCaseSets();

  } catch (error) {
    console.error('Error submitting form:', error);
    formAlert.textContent = error.message || 'Error occurred';
    formAlert.classList.add('alert-danger');
    formAlert.classList.remove('d-none');
  } finally {
    const submitBtn = document.getElementById('setModalSubmitBtn');
    submitBtn.disabled = false;
    submitBtn.innerHTML = currentEditingSetId ? (i18n.updateSet || 'Update') : (i18n.createSet || 'Create');
  }
}

// 顯示刪除確認
function showDeleteConfirm(setId, setName) {
  pendingDeleteSetId = setId;
  const confirmText = document.getElementById('deleteConfirmText');
  confirmText.textContent = `確定要刪除「${setName}」嗎？此操作無法撤銷。`;
  const modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
  modal.show();
}

// 確認刪除
async function confirmDelete() {
  if (!pendingDeleteSetId) return;

  try {
    const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-case-sets/${pendingDeleteSetId}`, {
      method: 'DELETE'
    });

    if (!response.ok) {
      throw new Error('Failed to delete set');
    }

    bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
    await loadTestCaseSets();
    showAlert('集合已刪除', 'success');

  } catch (error) {
    console.error('Error deleting set:', error);
    showAlert('刪除失敗: ' + error.message, 'danger');
  } finally {
    pendingDeleteSetId = null;
  }
}

// 導航到 Test Case Set
function navigateToSet(setId) {
  // 保存當前選擇的 Set ID
  sessionStorage.setItem('selectedTestCaseSetId', setId);
  // 導航到 Test Case Management
  window.location.href = `/test-case-management?set_id=${setId}`;
}

// 顯示警告訊息
function showAlert(message, type = 'info') {
  const alertHtml = `
    <div class="alert alert-${type} alert-dismissible fade show" role="alert" style="margin-bottom: 12px;">
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  `;

  const flashMessagesContainer = document.getElementById('flash-messages');
  if (!flashMessagesContainer) {
    console.warn('Flash messages container not found');
    return;
  }

  // 建立一個包含訊息的容器
  const alertDiv = document.createElement('div');
  alertDiv.innerHTML = alertHtml;
  const alertElement = alertDiv.firstElementChild;

  flashMessagesContainer.appendChild(alertElement);

  // 自動移除
  setTimeout(() => {
    if (alertElement && alertElement.parentElement) {
      alertElement.remove();
    }
  }, 5000);
}

// HTML 轉義
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}
</script>

<!-- Test Case Set 和 Section 多語系翻譯 -->
<script src="/static/js/i18n-test-case-set.js"></script>

<style>
.test-case-set-card {
  transition: all 0.3s ease;
  border: 1px solid #e9ecef;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.test-case-set-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  transform: translateY(-2px);
}

.test-case-set-card .dropdown-menu {
  min-width: 150px;
}

.test-case-set-card .card-header {
  padding: 1rem;
}

.test-case-set-card .card-footer {
  padding: 0.75rem 1rem;
}

.test-case-set-card .btn-primary {
  font-weight: 500;
}
</style>
{% endblock %}

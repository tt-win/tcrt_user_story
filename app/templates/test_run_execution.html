{% extends "base.html" %}

{% block title %}{{ i18n.t('testRun.execution') if i18n else 'Test Run 執行' }} - Test Case Repository Web Tool{% endblock %}

{% block head %}
<!-- Markdown 編輯器相關資源 -->
<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<link rel="stylesheet" href="/static/css/test-run-execution.css">
{% endblock %}

{% block page_title_text %}
<span data-i18n="testRun.execution">Test Run 執行</span>
{% endblock %}

{% block page_subtitle_text %}
<span id="test-run-subtitle">執行測試案例並記錄結果</span>
{% endblock %}

{% block page_specific_actions %}
<div class="d-flex gap-2">
    <button type="button" class="btn btn-success" id="startBtn" style="display: none;">
        <i class="fas fa-play me-2"></i><span data-i18n="testRun.startExecution">開始執行</span>
    </button>
    <button type="button" class="btn btn-warning" id="completeBtn" style="display: none;">
        <i class="fas fa-stop me-2"></i><span data-i18n="testRun.completeExecution">結束執行</span>
    </button>
    <button type="button" class="btn btn-info" id="restartBtn" style="display: none;">
        <i class="fas fa-redo me-2"></i><span data-i18n="testRun.restartExecution">重新執行</span>
    </button>
    <div class="ms-auto d-flex gap-2">
        <button type="button" class="btn btn-primary" id="exportBtn">
            <i class="fas fa-chart-pie me-2"></i><span data-i18n="testRun.chartsReports">Charts & Reports</span>
        </button>
        <button type="button" class="btn btn-secondary" id="refreshBtn">
            <i class="fas fa-sync-alt me-2"></i><span data-i18n="common.refresh">重新整理</span>
        </button>
        <div class="btn-group" role="group" id="jumpToTestRunGroup" style="display: none;">
            <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-arrow-right me-2"></i><span data-i18n="common.jumpTo">跳至</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" id="jumpToTestRunDropdown">
                <!-- 其他 Test Runs 會在此動態列出 -->
            </ul>
        </div>
        <a href="/test-run-management" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i><span data-i18n="navigation.backToManagement">回到管理</span>
        </a>
        <a href="/" class="btn btn-secondary">
            <i class="fas fa-home me-2"></i><span data-i18n="navigation.backToHome">首頁</span>
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid test-run-execution">
    <!-- 移除全頁載入狀態，改在列表區顯示載入動畫 -->

    <!-- Test Run 資訊與控制區 -->
    <div id="test-run-header" style="display: none;">
        <!-- 統計資訊區域已簡化 -->

        <!-- 統計資訊和批次操作一體化區域 -->
        <div class="execution-stats-wrapper">
            <div class="d-flex flex-wrap gap-3 align-items-stretch">
            <!-- 統計資訊 -->
            <div class="execution-stats flex-grow-1">
                <div class="stat-item">
                    <div class="stat-number" id="total-count">0</div>
                    <div class="stat-label" data-i18n="testRun.totalItems">總項目</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="executed-count">0</div>
                    <div class="stat-label" data-i18n="testRun.executedItems">已執行</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number text-success" id="passed-count">0</div>
                    <div class="stat-label" data-i18n="testRun.passedItems">Passed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number text-danger" id="failed-count">0</div>
                    <div class="stat-label" data-i18n="testRun.failedItems">Failed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="execution-rate">0%</div>
                    <div class="stat-label" data-i18n="testRun.executionRate">執行率</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="pass-rate">0%</div>
                    <div class="stat-label" data-i18n="testRun.passRate">通過率</div>
                </div>
                <div class="stat-item bug-tickets-card" onclick="showBugTicketsModal()" style="cursor: pointer;">
                    <div class="stat-number text-warning" id="bug-tickets-count">0</div>
                    <div class="stat-label" data-i18n="testRun.bugTicketsCount">Bug Tickets</div>
                </div>
                <div class="stat-item filter-stat" id="executionFilterToggle" role="button" tabindex="0" aria-haspopup="true" aria-expanded="false" aria-controls="executionFilterPanel">
                    <div class="stat-number" id="executionFilterMatched">0</div>
                    <div class="stat-label" data-i18n="testRun.filtersApplied">已篩選</div>
                </div>
            </div>
            <!-- 批次操作工具區 -->
            <div id="batchOperationsToolbar" class="d-none d-flex align-items-center gap-2 ms-lg-auto mb-2 mb-lg-0">
                <button type="button" class="btn btn-secondary btn-sm" id="clearSelectionExecBtn" data-i18n-title="common.clearSelection" title="清除選取">
                    <i class="fas fa-xmark"></i>
                </button>
                <span class="text-muted" id="selectedItemsCount" data-i18n="testRun.selectedItemsCount" data-i18n-params='{"count": 0}'>已選取 0 個項目</span>
                <button type="button" class="btn btn-primary btn-sm" id="batchModifyBtn">
                    <i class="fas fa-edit me-2"></i><span data-i18n="testRun.batchModify">批次修改</span>
                </button>
                <button type="button" class="btn btn-danger btn-sm" id="batchDeleteBtn">
                    <i class="fas fa-trash me-2"></i><span data-i18n="testRun.batchDelete">批次刪除</span>
                </button>
            </div>
            </div> <!-- /d-flex stats + toolbar -->

            <div id="executionFilterPanel" class="execution-filter-panel" role="dialog" aria-modal="false" aria-labelledby="executionFilterTitle">
                <div class="filter-panel-header">
                    <div class="d-flex align-items-center gap-2">
                        <i class="fas fa-filter text-primary"></i>
                        <h6 class="mb-0" id="executionFilterTitle" data-i18n="common.filter">篩選</h6>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="resetExecutionFiltersBtn" data-i18n="testRun.filterReset">清除篩選</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="closeExecutionFiltersBtn" data-i18n-title="common.close" title="關閉" aria-label="Close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="filter-panel-body">
                    <div>
                        <label class="form-label mb-2" data-i18n="testRun.testResult">測試結果</label>
                        <div class="filter-status-options">
                            <div class="form-check">
                                <input class="form-check-input execution-status-filter" type="checkbox" id="executionStatusAll" value="ALL" checked>
                                <label class="form-check-label" for="executionStatusAll" data-i18n="testRun.allStatuses">全部狀態</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input execution-status-filter" type="checkbox" id="executionStatusPassed" value="Passed" checked>
                                <label class="form-check-label" for="executionStatusPassed" data-i18n="testRun.passed">通過</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input execution-status-filter" type="checkbox" id="executionStatusFailed" value="Failed" checked>
                                <label class="form-check-label" for="executionStatusFailed" data-i18n="testRun.failed">失敗</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input execution-status-filter" type="checkbox" id="executionStatusRetest" value="Retest" checked>
                                <label class="form-check-label" for="executionStatusRetest" data-i18n="testRun.retest">重測</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input execution-status-filter" type="checkbox" id="executionStatusNotAvailable" value="Not Available" checked>
                                <label class="form-check-label" for="executionStatusNotAvailable" data-i18n="testRun.notAvailable">不適用</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input execution-status-filter" type="checkbox" id="executionStatusPending" value="Pending" checked>
                                <label class="form-check-label" for="executionStatusPending" data-i18n="testRun.pending">待處理</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input execution-status-filter" type="checkbox" id="executionStatusNotRequired" value="Not Required" checked>
                                <label class="form-check-label" for="executionStatusNotRequired" data-i18n="testRun.notRequired">不需要</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input execution-status-filter" type="checkbox" id="executionStatusSkip" value="Skip" checked>
                                <label class="form-check-label" for="executionStatusSkip" data-i18n="testRun.skip">跳過</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input execution-status-filter" type="checkbox" id="executionStatusNotExecuted" value="Not Executed" checked>
                                <label class="form-check-label" for="executionStatusNotExecuted" data-i18n="testRun.notExecuted">未執行</label>
                            </div>
                        </div>
                    </div>

                    <div class="filter-search-controls">
                        <div class="filter-field case-field">
                            <label class="form-label" data-i18n="testRun.caseNumber">案例編號</label>
                            <input
                                type="text"
                                class="form-control"
                                id="filterCaseNumberInput"
                                data-i18n-placeholder="testRun.filterCaseNumberPlaceholder"
                                placeholder="{{ i18n.t('testRun.filterCaseNumberPlaceholder') if i18n else '輸入案例編號關鍵字' }}"
                            >
                        </div>
                        <div class="filter-field title-field">
                            <label class="form-label" data-i18n="testRun.caseTitle">標題</label>
                            <input
                                type="text"
                                class="form-control"
                                id="filterTitleInput"
                                data-i18n-placeholder="testRun.filterTitlePlaceholder"
                                placeholder="{{ i18n.t('testRun.filterTitlePlaceholder') if i18n else '輸入標題關鍵字' }}"
                            >
                        </div>
                    </div>

                    <div class="filter-priority-assignee-row">
                        <div class="filter-field priority-field">
                            <label class="form-label" data-i18n="testRun.priority">優先級</label>
                            <select class="form-select" id="filterPrioritySelect">
                                <option value="ALL" data-i18n="testRun.filterPriorityAll">全部優先級</option>
                                <option value="High" data-i18n="priority.high">高</option>
                                <option value="Medium" data-i18n="priority.medium">中</option>
                                <option value="Low" data-i18n="priority.low">低</option>
                            </select>
                        </div>
                        <div class="filter-field assignee-field">
                            <label class="form-label" data-i18n="testRun.assignee">執行者</label>
                            <input
                                type="text"
                                class="form-control"
                                id="filterAssigneeInput"
                                data-assignee-selector
                                data-i18n-placeholder="testRun.filterAssigneePlaceholder"
                                placeholder="{{ i18n.t('testRun.filterAssigneePlaceholder') if i18n else '搜尋並選擇執行者' }}"
                            >
                            <div id="filterAssigneeChips" class="filter-assignee-chips"></div>
                        </div>
                    </div>

                </div>
            </div>
        </div> <!-- /execution-stats-wrapper -->
    </div> <!-- /test-run-header -->

    <!-- 篩選 + Section 清單 + 列表 (左右欄版型) -->
    <!-- Test Run Items 表格 -->
        <div id="test-run-items-container" class="test-run-items-container" style="display: none; min-width:0;">
            <!-- 列表區載入動畫（預設隱藏） -->
            <div id="items-loading" class="align-items-center justify-content-center py-5 d-none" style="min-height: 240px;">
                <div class="text-center text-muted">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div class="mt-2" data-i18n="testRun.loadingItems">載入測試項目中...</div>
                </div>
            </div>

            <div class="test-run-items-table">
                <table class="table table-hover table-sm">
                    <thead>
                        <tr id="table-header-row">
                            <th id="checkbox-header">
                                <input type="checkbox" class="form-check-input" id="selectAllItemsCheckbox">
                            </th>
                            <th id="th-tre-number" class="sortable" style="cursor: pointer;">
                                <span data-i18n="testRun.caseNumber">案例編號</span>
                                <span class="sort-indicator ms-1"></span>
                            </th>
                            <th id="th-tre-title" class="sortable" style="cursor: pointer;">
                                <span data-i18n="testRun.caseTitle">標題</span>
                                <span class="sort-indicator ms-1"></span>
                            </th>
                            <th id="th-tre-priority" class="sortable" style="cursor: pointer;">
                                <span data-i18n="testRun.priority">優先級</span>
                                <span class="sort-indicator ms-1"></span>
                            </th>
                            <th id="th-tre-result" class="sortable" style="cursor: pointer;">
                                <span data-i18n="testRun.testResult">測試結果</span>
                                <span class="sort-indicator ms-1"></span>
                            </th>
                            <th id="th-tre-assignee" class="sortable" style="cursor: pointer;">
                                <span data-i18n="testRun.assignee">執行者</span>
                                <span class="sort-indicator ms-1"></span>
                            </th>
                            <th id="th-tre-executed" class="sortable" style="cursor: pointer;">
                                <span data-i18n="testRun.executedAt">執行時間</span>
                                <span class="sort-indicator ms-1"></span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="items-table-body">
                        <!-- Test Run Items 將在此處動態載入 -->
                    </tbody>
                </table>
            </div>
        </div>
</div>

<!-- Test Run Item 詳情 Modal -->
<div class="modal fade" id="itemDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-clipboard-list me-2"></i>
                    <span data-i18n="testRun.itemDetails">測試項目詳情</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="item-detail-content">
                <!-- 詳情內容將動態載入 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.close">關閉</button>
            </div>
        </div>
    </div>
</div>

<!-- 確認對話框 -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    <span data-i18n="common.confirm">確認操作</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirm-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="confirm-action-btn" data-i18n="common.confirm">確認</button>
            </div>
        </div>
    </div>
</div>

<!-- 批次修改模態框 -->
<div class="modal fade" id="batchModifyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit text-primary me-2"></i>
                    <span data-i18n="testRun.batchModify">批次修改</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">
                    <span data-i18n="testRun.batchModifyDescription">將對選中的</span>
                    <strong id="batchModifyCount">0</strong>
                    <span data-i18n="testRun.itemsApplyChanges">個項目套用以下變更：</span>
                </p>
                
                <!-- 執行者批次設定 -->
                <div class="mb-3">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="batchModifyAssignee" checked>
                        <label class="form-check-label" for="batchModifyAssignee">
                            <strong data-i18n="testRun.batchSetAssignee">批次設定執行者</strong>
                        </label>
                    </div>
                    <input type="text" class="form-control" id="batchAssigneeInput" 
                           data-assignee-selector
                           data-i18n-placeholder="testRun.enterAssigneeName"
                           placeholder="{{ i18n.t('testRun.enterAssigneeName') if i18n else '輸入執行者姓名' }}">
                </div>
                
                <!-- 測試結果批次設定 -->
                <div class="mb-3" id="batchResultSection">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="batchModifyResult">
                        <label class="form-check-label" for="batchModifyResult">
                            <strong data-i18n="testRun.batchSetResult">批次設定測試結果</strong>
                            <br><small class="text-muted" data-i18n="testRun.onlyActiveStatus">（僅適用於執行中狀態）</small>
                        </label>
                    </div>
                    <select class="form-select" id="batchResultSelect" disabled>
                        <option value="">Select Result</option>
                        <option value="Passed">Passed</option>
                        <option value="Failed">Failed</option>
                        <option value="Retest">Retest</option>
                        <option value="Not Available">Not Available</option>
                        <option value="Pending">Pending</option>
                        <option value="Not Required">Not Required</option>
                        <option value="Skip">Skip</option>
                    </select>
                </div>

                <!-- 註釋批次設定 -->
                <div class="mb-3">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="batchModifyComment">
                        <label class="form-check-label" for="batchModifyComment">
                            <strong data-i18n="testRun.batchSetComment">批次設定註釋</strong>
                        </label>
                    </div>
                    <textarea
                        class="form-control"
                        id="batchCommentInput"
                        rows="2"
                        disabled
                        data-i18n-placeholder="testRun.enterComment"
                        placeholder="{{ i18n.t('testRun.enterComment') if i18n else '輸入註釋內容' }}"
                    ></textarea>
                </div>
                
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <span data-i18n="testRun.batchModifyNote">只會套用已勾選的項目，空白值將不會變更現有資料。</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="confirmBatchModifyBtn">
                    <i class="fas fa-edit me-2"></i><span data-i18n="testRun.confirmModify">確認修改</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 重新執行模態框 -->
<div class="modal fade" id="restartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-redo text-info me-2"></i>
                    <span data-i18n="testRun.restartExecution">重新執行 Test Run</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3" data-i18n="testRun.selectRestartMode">請選擇重新執行模式：</p>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="restartMode" id="restartAll" value="all" checked>
                    <label class="form-check-label" for="restartAll">
                        <strong data-i18n="testRun.restartAllItems">全部重新執行</strong>
                        <br><small class="text-muted" data-i18n="testRun.restartAllDescription">清空所有項目的測試結果，重新開始執行</small>
                    </label>
                </div>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="restartMode" id="restartFailed" value="failed">
                    <label class="form-check-label" for="restartFailed">
                        <strong data-i18n="testRun.restartFailedItems">只執行失敗的項目</strong>
                        <br><small class="text-muted" data-i18n="testRun.restartFailedDescription">只清空標記為「失敗」和「重測」的項目結果</small>
                    </label>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="restartMode" id="restartPending" value="pending">
                    <label class="form-check-label" for="restartPending">
                        <strong data-i18n="testRun.restartPendingItems">只執行未完成的項目</strong>
                        <br><small class="text-muted" data-i18n="testRun.restartPendingDescription">只清空尚未執行的項目，保留已通過的結果</small>
                    </label>
                </div>
                <div class="mb-3">
                    <label for="rerunNameInput" class="form-label" data-i18n="testRun.rerunNameLabel">新的 Test Run 名稱</label>
                    <input type="text" class="form-control" id="rerunNameInput" placeholder="Rerun - ">
                    <small class="text-muted" data-i18n="testRun.rerunNameHint">預設為「Rerun - 原有名稱」</small>
                </div>
                
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span data-i18n="testRun.restartWarning">重新執行會將 Test Run 狀態重置為「執行中」，請確認後繼續。</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-info" id="confirmRestartBtn">
                    <i class="fas fa-redo me-2"></i><span data-i18n="testRun.confirmRestart">確認重新執行</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Case 詳細資料 Modal -->
<div class="modal fade" id="testCaseDetailModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header align-items-center">
                <h5 class="modal-title d-flex align-items-center">
                    <i class="fas fa-tasks me-2"></i>
                    <span data-i18n="testRun.testCaseDetails">Test Case 詳細資料</span>
                </h5>
                <!-- Test Result 下拉/Badge：緊貼在標題後面 -->
                <div id="testCaseDetailHeaderResult" class="ms-3" style="min-width: 170px;"></div>
                <!-- 標頭靠右：上一隻 / 下一隻 / 關閉 -->
                <div class="d-flex align-items-center gap-2 ms-auto">
                    <button type="button" class="btn btn-primary btn-sm" id="copyExecCaseLinkBtn">
                        <i class="fas fa-link me-1"></i><span data-i18n="common.copyLink">複製連結</span>
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" id="prevExecCaseBtn" title="上一隻">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" id="nextExecCaseBtn" title="下一隻">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                <div id="testCaseDetailLoading" class="text-center py-4">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    <span data-i18n="common.loading">載入中...</span>
                </div>
                <!-- 三欄佈局區域 -->
                <div id="testCaseDetailBodyRow" class="d-none" style="flex: 1; min-height: 0; display: flex; gap: 16px;">
                    <!-- 左欄：Test Case 詳情 (40%) -->
                    <div id="testCaseDetailLeft" style="flex: 0 0 calc(40% - 11px); min-width: 0; display: flex; flex-direction: column; overflow: hidden;">
                        <!-- 固定區：Basic Info + 測試詳情標題 -->
                        <div id="testCaseDetailFixed" style="display:none;"></div>
                        <!-- 可捲動區：僅測試詳情內容 -->
                        <div id="testCaseDetailScrollable" style="display:none;"></div>
                    </div>

                    <!-- 中欄：Timeline + Bug Tickets (30%) -->
                    <aside id="testCaseDetailMiddlePane" style="flex: 0 0 calc(30% - 11px); border-left: 1px solid var(--tr-border-light); padding-left: 12px; display: none; min-width: 280px; flex-direction: column; overflow: hidden;">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <h6 class="mb-0"><i class="fas fa-history me-2"></i><span data-i18n="testRun.resultHistory">結果歷程</span></h6>
                            <button type="button" id="refreshTimelineBtn" class="btn btn-secondary text-secondary p-0" title="刷新" style="border: none; background: none;"><i class="fas fa-sync-alt"></i></button>
                        </div>
                        <div id="timelineLoading" class="text-center py-2" style="display:none;">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <div id="timelineEmpty" class="text-muted small" style="display:none;">
                            <i class="fas fa-info-circle me-1"></i><span data-i18n="testRun.noHistory">尚無歷程</span>
                        </div>
                        <div id="timelineList" style="height: 200px; overflow-y: auto; flex-shrink: 0;"></div>

                        <!-- Bug Tickets 區域 -->
                        <div class="mt-3 border-top pt-3" style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <h6 class="mb-0"><i class="fas fa-bug me-2"></i><span data-i18n="testRun.bugTickets">Bug Tickets</span></h6>
                                <button type="button" id="addBugTicketBtn" class="btn btn-secondary text-secondary p-0" data-i18n-title="testRun.addBugTicket" style="border: none; background: none;">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div id="bugTicketsLoading" class="text-center py-2" style="display:none;">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                            <div id="bugTicketsEmpty" class="text-muted small" style="display:none;">
                                <i class="fas fa-info-circle me-1"></i><span data-i18n="testRun.noBugTickets">尚無關聯的 Bug Tickets</span>
                            </div>
                            <div id="bugTicketsList" style="flex: 1; overflow-y: auto; min-height: 150px;"></div>
                        </div>
                    </aside>

                    <!-- 右欄：Test Results + Comment (30%) -->
                    <aside id="testCaseDetailRightPane" style="flex: 0 0 calc(30% - 11px); border-left: 1px solid var(--tr-border-light); padding-left: 12px; display: none; min-width: 280px; flex-direction: column; overflow: hidden;">
                        <!-- Test Results 區域 -->
                        <div style="flex: 0 0 50%; display: flex; flex-direction: column; min-height: 0; overflow: hidden;">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <h6 class="mb-0">
                                    <i class="fas fa-file-alt me-2"></i>
                                    <span data-i18n="testRun.testResults">Test Results</span>
                                </h6>
                                <button type="button" id="uploadTestResultsBtn" class="btn btn-secondary text-secondary p-0"
                                        data-i18n-title="testRun.uploadTestResults" style="border: none; background: none;">
                                    <i class="fas fa-upload"></i>
                                </button>
                            </div>

                            <!-- 檔案列表區域 -->
                            <div id="testResultsLoading" class="text-center py-2" style="display:none;">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                            <div id="testResultsEmpty" class="text-muted small mb-2" style="display:none;">
                                <i class="fas fa-info-circle me-1"></i><span data-i18n="testRun.noTestResults">尚無測試結果檔案</span>
                            </div>
                            <div id="testResultsList" style="flex: 1; overflow-y: auto; min-height: 100px;"></div>

                            <!-- 上傳狀態區（覆蓋檔案列表區域） -->
                            <div id="testResultsUploadArea" class="test-results-upload-zone mb-2" style="display:none; flex: 1; min-height: 100px;">
                                <div class="upload-dropzone border-2 border-dashed border-secondary rounded p-3 text-center">
                                    <div id="uploadDropText">
                                        <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                        <p class="mb-1" data-i18n="testRun.dropFilesHere">拖曳檔案到此處或點擊上傳</p>
                                        <small class="text-muted" data-i18n="testRun.supportedFormats">支援 PNG, JPG, JPEG, GIF, PDF, TXT, LOG, ZIP, JSON, XML, MP4 (最大 50MB)</small>
                                    </div>
                                    <input type="file" id="testResultsFileInput" multiple accept=".png,.jpg,.jpeg,.gif,.pdf,.txt,.log,.zip,.json,.xml,.mp4,video/mp4,video/quicktime" style="display:none;">
                                </div>

                                <!-- 上傳進度區 -->
                                <div id="uploadProgressArea" style="display:none;">
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div id="uploadProgressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <div id="uploadStatus" class="small text-center"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Comment 區域 -->
                        <div class="border-top pt-3" style="flex: 0 0 50%; display: flex; flex-direction: column; min-height: 0; overflow: hidden; margin-top: 0;">
                            <div class="d-flex align-items-center justify-content-between mb-2" style="flex-shrink: 0;">
                                <h6 class="mb-0">
                                    <i class="fas fa-comment me-2"></i>
                                    <span data-i18n="testRun.comment">Comment</span>
                                </h6>
                                <button type="button" id="editCommentBtn" class="btn btn-secondary text-secondary p-0"
                                        data-i18n-title="testRun.editComment" style="border: none; background: none;">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            <div id="commentContent" class="text-muted small" style="flex: 1; overflow-y: auto; white-space: pre-wrap; padding: 12px; background-color: #f8f9fa; border-radius: 6px;">
                                <span data-i18n="testRun.noComment">尚無註釋</span>
                            </div>
                        </div>
                    </aside>
                </div>
                <div id="testCaseDetailError" style="display: none;">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span data-i18n="testRun.loadTestCaseError">載入 Test Case 詳細資料失敗</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <button type="button" class="btn btn-info" id="referenceTestCaseExecBtn" style="display: none;">
                        <i class="fas fa-search me-2"></i>
                        <span data-i18n="testCase.referenceTestCaseButton">參考測試案例</span>
                    </button>
                </div>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>
                        <span data-i18n="common.close">關閉</span>
                    </button>
                    <button type="button" class="btn btn-primary" id="openFullTestCaseBtn" style="display: none;">
                        <i class="fas fa-external-link-alt me-2"></i>
                        <span data-i18n="testRun.openInTestCaseManagement">在測試案例管理中開啟</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bug Ticket 新增模態框 -->
<div class="modal fade" id="addBugTicketModal" tabindex="-1" aria-labelledby="addBugTicketModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addBugTicketModalLabel">
                    <i class="fas fa-bug me-2"></i><span data-i18n="testRun.addBugTicket">新增 Bug Ticket</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addBugTicketForm">
                    <div class="mb-3">
                        <label for="bugTicketNumber" class="form-label"><span data-i18n="testRun.ticketNumber">Ticket 編號</span></label>
                        <input type="text" class="form-control" id="bugTicketNumber" placeholder="例如: PRJ-123" required>
                        <div class="form-text"><span data-i18n="testRun.ticketNumberHelp">請輸入 JIRA Ticket 編號</span></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <span data-i18n="common.cancel">取消</span>
                </button>
                <button type="button" class="btn btn-primary" id="confirmAddBugTicket">
                    <i class="fas fa-plus me-2"></i><span data-i18n="common.create">新增</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 刪除 Bug Ticket 確認對話框 -->
<div class="modal fade" id="deleteBugTicketModal" tabindex="-1" aria-labelledby="deleteBugTicketModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteBugTicketModalLabel">
                    <i class="fas fa-trash me-2"></i><span data-i18n="testRun.deleteBugTicket">刪除 Bug Ticket</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><span data-i18n="testRun.confirmDeleteBugTicket">確定要刪除這個 Bug Ticket 嗎？</span></p>
                <div class="text-center">
                    <strong id="deleteBugTicketNumber" class="text-primary"></strong>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <span data-i18n="common.cancel">取消</span>
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBugTicket">
                    <i class="fas fa-trash me-2"></i><span data-i18n="common.delete">刪除</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bug Tickets 摘要 Modal -->
<div class="modal fade" id="bugTicketsSummaryModal" tabindex="-1" aria-labelledby="bugTicketsSummaryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bugTicketsSummaryModalLabel">
                    <i class="fas fa-bug me-2"></i><span data-i18n="testRun.bugTicketsSummary">Bug Tickets 摘要</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="bugTicketsSummaryLoading" class="text-center py-4" style="display:none;">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    <span data-i18n="testRun.loadingBugTickets">載入 Bug Tickets 中...</span>
                </div>
                
                <div id="bugTicketsSummaryEmpty" class="text-center py-4 text-muted" style="display:none;">
                    <i class="fas fa-info-circle me-2"></i>
                    <span data-i18n="testRun.noBugTicketsInRun">此 Test Run 尚無 Bug Tickets</span>
                </div>
                
                <div id="bugTicketsSummaryContent" style="display:none;">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="btn-group btn-group-sm" role="group" aria-label="Status Filter">
                                <button type="button" class="btn btn-secondary active" data-status="ALL" data-i18n="testRun.statusFilter.all" onclick="filterBugTicketsByStatus('ALL')">All</button>
                                <button type="button" class="btn btn-warning" data-status="OPEN" data-i18n="testRun.statusFilter.open" onclick="filterBugTicketsByStatus('OPEN')">Open</button>
                                <button type="button" class="btn btn-primary" data-status="TO DO" data-i18n="testRun.statusFilter.toDo" onclick="filterBugTicketsByStatus('TO DO')">To Do</button>
                                <button type="button" class="btn btn-info" data-status="IN PROGRESS" data-i18n="testRun.statusFilter.inProgress" onclick="filterBugTicketsByStatus('IN PROGRESS')">In Progress</button>
                                <button type="button" class="btn btn-success" data-status="RESOLVED" data-i18n="testRun.statusFilter.resolved" onclick="filterBugTicketsByStatus('RESOLVED')">Resolved</button>
                                <button type="button" class="btn btn-secondary" data-status="SCHEDULED" data-i18n="testRun.statusFilter.scheduled" onclick="filterBugTicketsByStatus('SCHEDULED')">Scheduled</button>
                                <button type="button" class="btn btn-secondary" data-status="CLOSED" data-i18n="testRun.statusFilter.closed" onclick="filterBugTicketsByStatus('CLOSED')">Closed</button>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="refreshBugTicketsStatus()">
                                <i class="fas fa-sync-alt me-1"></i><span data-i18n="testRun.refreshBugStatus">重新整理狀態</span>
                            </button>
                        </div>
                    </div>
                    <div id="bugTicketsSummaryList" style="max-height: 500px; overflow-y: auto;">
                        <!-- Bug tickets cards will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="/static/js/assignee-selector.js"></script>


<!-- Charts & Reports Modal -->
<div class="modal fade" id="chartsReportsModal" tabindex="-1" aria-labelledby="chartsReportsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chartsReportsModalLabel">
                    <i class="fas fa-chart-pie me-2"></i>
                    <span data-i18n="testRun.chartsReports">Charts & Reports</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="position: relative;">
                <!-- 載入覆蓋層 -->
                <div id="chartsLoadingOverlay" class="position-absolute w-100 h-100 d-flex align-items-center justify-content-center bg-white" style="z-index: 1000; display: none; top: 0; left: 0;">
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <div data-i18n="testRun.loadingCharts">載入圖表中...</div>
                    </div>
                </div>
                
                <!-- 錯誤訊息 -->
                <div id="chartsErrorMessage" class="alert alert-danger text-center" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span data-i18n="testRun.chartsLoadError">圖表載入失敗，請重新整理後再試</span>
                </div>
                
                <!-- 報告標題區域 -->
                <div class="text-center mb-4">
                    <h2 class="display-6">
                        <i class="fas fa-chart-pie me-3 text-primary"></i>
                        <span data-i18n="testRun.executionAnalytics">Test Run 執行分析報告</span>
                    </h2>
                    <p class="lead text-muted" data-i18n="testRun.analyticsSubtitle">測試執行狀態分布與統計分析</p>
                </div>
                
                <!-- 基本資訊區域 -->
                <div class="row mb-4 report-section">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <span data-i18n="testRun.basicInfo">基本資訊</span>
                                </h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td><span data-i18n="testRun.configName">名稱</span></td>
                                        <td id="reportTestRunName">-</td>
                                    </tr>
                                    <tr>
                                        <td><span data-i18n="testRun.testEnvironment">測試環境</span></td>
                                        <td id="reportEnvironment">-</td>
                                    </tr>
                                    <tr>
                                        <td><span data-i18n="testRun.buildNumber">建置版本</span></td>
                                        <td id="reportBuildNumber">-</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-chart-bar me-2"></i>
                                    <span data-i18n="testRun.executionSummary">執行摘要</span>
                                </h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td><span data-i18n="testRun.totalItems">總項目</span></td>
                                        <td id="reportTotalItems">0</td>
                                    </tr>
                                    <tr>
                                        <td><span data-i18n="testRun.executedItems">已執行</span></td>
                                        <td id="reportExecutedItems">0</td>
                                    </tr>
                                    <tr>
                                        <td><span data-i18n="testRun.executionRate">執行率</span></td>
                                        <td id="reportExecutionRate">0%</td>
                                    </tr>
                                    <tr>
                                        <td><span data-i18n="testRun.passRate">Pass Rate</span></td>
                                        <td id="reportPassRate">0%</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 圖表區域 -->
                <div class="row report-section">
                    <div class="col-lg-6 mb-4">
                        <div class="card chart-container">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-chart-pie me-2 text-primary"></i>
                                    <span data-i18n="testRun.statusDistribution">測試結果狀態分布</span>
                                </h6>
                                <div style="position: relative; height: 400px;">
                                    <canvas id="statusPieChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6 mb-4">
                        <div class="card chart-container">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-chart-bar me-2 text-success"></i>
                                    <span data-i18n="testRun.priorityDistribution">優先級分布</span>
                                </h6>
                                <div style="position: relative; height: 400px;">
                                    <canvas id="priorityBarChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 統計卡片 -->
                <div class="row report-section">
                    <div class="col-md-3 mb-3">
                        <div class="card text-center border-left-success">
                            <div class="card-body">
                                <div class="h4 text-success mb-1" id="chartPassedCount">0</div>
                                <div class="text-muted" data-i18n="testRun.passedItems">Passed</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center border-left-danger">
                            <div class="card-body">
                                <div class="h4 text-danger mb-1" id="chartFailedCount">0</div>
                                <div class="text-muted" data-i18n="testRun.failedItems">Failed</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center border-left-warning">
                            <div class="card-body">
                                <div class="h4 text-warning mb-1" id="chartRetestCount">0</div>
                                <div class="text-muted" data-i18n="testRun.retestItems">Retest</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center border-left-secondary">
                            <div class="card-body">
                                <div class="h4 text-secondary mb-1" id="chartNotAvailableCount">0</div>
                                <div class="text-muted" data-i18n="testRun.notAvailable">Not Available</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center border-left-warning">
                            <div class="card-body">
                                <div class="h4 text-muted mb-1" id="chartPendingCount">0</div>
                                <div class="text-muted" data-i18n="testRun.pending">Pending</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center border-left-secondary">
                            <div class="card-body">
                                <div class="h4 text-secondary mb-1" id="chartNotRequiredCount">0</div>
                                <div class="text-muted" data-i18n="testRun.notRequired">Not Required</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
              <div class="d-flex align-items-center w-100 gap-3 flex-wrap">
                <button type="button" class="btn btn-primary" id="generateHTMLBtn" onclick="generateHtmlReport()">
                  <i class="fas fa-file-alt me-2" id="generateIcon"></i>
                  <span id="generateText" data-i18n="testRun.generateHtmlButton">產生並複製連結</span>
                </button>
                <button type="button" class="btn btn-secondary ms-auto" data-bs-dismiss="modal">
                  <span data-i18n="common.close">關閉</span>
                </button>
              </div>
            </div>
        </div>
    </div>
</div>



<script src="/static/js/test-run-execution/core.js"></script>
<script src="/static/js/test-run-execution/utils.js"></script>
<script src="/static/js/test-run-execution/sections.js"></script>
<script src="/static/js/test-run-execution/filters.js"></script>
<script src="/static/js/test-run-execution/render.js"></script>
<script src="/static/js/test-run-execution/data.js"></script>
<script src="/static/js/test-run-execution/tooltips.js"></script>
<script src="/static/js/test-run-execution/tickets.js"></script>

<!-- Chart.js 相關 CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="/static/js/test-run-execution/reports.js"></script>
<script src="/static/js/test-run-execution/results.js"></script>
<script src="/static/js/test-run-execution/init.js"></script>
{% endblock %}

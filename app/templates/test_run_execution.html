{% extends "base.html" %}

{% block title %}{{ i18n.t('testRun.execution') if i18n else 'Test Run 執行' }} - Test Case Repository Web Tool{% endblock %}

{% block head %}
<!-- Markdown 編輯器相關資源 -->
<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

<!-- Markdown 格式快捷鍵處理 -->
<script>
/**
 * 通用的 Markdown 格式化函數
 * 為 textarea 中的選中文本添加 Markdown 格式
 *
 * @param {HTMLTextAreaElement} textarea - 目標 textarea 元素
 * @param {string} format - 格式類型: 'bold' | 'italic' | 'underline'
 */
function applyMarkdownFormat(textarea, format) {
    if (!textarea) return;

    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    const beforeText = textarea.value.substring(0, start);
    const afterText = textarea.value.substring(end);

    let formattedText;
    let newCursorPos;

    if (!selectedText) {
        // 如果沒有選中文本，只插入格式標記
        switch(format) {
            case 'bold':
                formattedText = '**文字**';
                newCursorPos = start + 2;
                break;
            case 'italic':
                formattedText = '_文字_';
                newCursorPos = start + 1;
                break;
            case 'underline':
                formattedText = '<u>文字</u>';
                newCursorPos = start + 3;
                break;
            default:
                return;
        }
    } else {
        // 有選中文本時，使用選中的文本
        switch(format) {
            case 'bold':
                formattedText = `**${selectedText}**`;
                newCursorPos = end + 4;
                break;
            case 'italic':
                formattedText = `_${selectedText}_`;
                newCursorPos = end + 2;
                break;
            case 'underline':
                formattedText = `<u>${selectedText}</u>`;
                newCursorPos = end + 7;
                break;
            default:
                return;
        }
    }

    // 更新 textarea 內容
    textarea.value = beforeText + formattedText + afterText;

    // 恢復光標位置
    setTimeout(() => {
        textarea.selectionStart = newCursorPos;
        textarea.selectionEnd = newCursorPos;
        textarea.focus();
    }, 0);

    // 觸發 input 事件以通知變更
    textarea.dispatchEvent(new Event('input', { bubbles: true }));
}

/**
 * 為 textarea 添加 Markdown 快捷鍵監聽
 * Ctrl/Cmd + B -> Bold
 * Ctrl/Cmd + I -> Italic
 * Ctrl/Cmd + U -> Underline
 *
 * @param {HTMLTextAreaElement} textarea - 目標 textarea 元素
 */
function setupMarkdownHotkeys(textarea) {
    if (!textarea) return;

    textarea.addEventListener('keydown', (e) => {
        const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
        const isCtrlOrCmd = isMac ? e.metaKey : e.ctrlKey;

        if (!isCtrlOrCmd) return;

        switch(e.key.toLowerCase()) {
            case 'b':
                e.preventDefault();
                applyMarkdownFormat(textarea, 'bold');
                break;
            case 'i':
                e.preventDefault();
                applyMarkdownFormat(textarea, 'italic');
                break;
            case 'u':
                e.preventDefault();
                applyMarkdownFormat(textarea, 'underline');
                break;
        }
    });
}
</script>

<!-- Markdown 顯示樣式 -->
<style>
#commentContent {
    word-break: break-word;
}

#commentContent h1,
#commentContent h2,
#commentContent h3,
#commentContent h4,
#commentContent h5,
#commentContent h6 {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
    font-weight: 600;
}

#commentContent h1 { font-size: 1.5em; }
#commentContent h2 { font-size: 1.3em; }
#commentContent h3 { font-size: 1.1em; }
#commentContent h4 { font-size: 1em; }

#commentContent p {
    margin-bottom: 0.5em;
}

#commentContent ul,
#commentContent ol {
    margin-bottom: 0.5em;
    padding-left: 1.5em;
}

#commentContent li {
    margin-bottom: 0.2em;
}

#commentContent code {
    background-color: #f5f5f5;
    padding: 0.2em 0.4em;
    border-radius: 3px;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9em;
}

#commentContent pre {
    background-color: #f5f5f5;
    padding: 0.8em;
    border-radius: 4px;
    overflow-x: auto;
    margin-bottom: 0.5em;
}

#commentContent pre code {
    background-color: transparent;
    padding: 0;
    border-radius: 0;
}

#commentContent blockquote {
    border-left: 3px solid #ddd;
    padding-left: 0.8em;
    margin-left: 0;
    margin-bottom: 0.5em;
    color: #666;
}

#commentContent a {
    color: #0066cc;
    text-decoration: none;
}

#commentContent a:hover {
    text-decoration: underline;
}

#commentContent table {
    border-collapse: collapse;
    margin-bottom: 0.5em;
}

#commentContent table th,
#commentContent table td {
    border: 1px solid #ddd;
    padding: 0.5em;
    text-align: left;
}

#commentContent table th {
    background-color: #f5f5f5;
    font-weight: 600;
}

#commentContent hr {
    border: none;
    border-top: 2px solid #ddd;
    margin: 0.5em 0;
}

#commentContent strong,
#commentContent em {
    font-weight: 600;
}
</style>

<script>
// 初始化「跳至」菜單 - 快速切換 Test Runs
async function initJumpToTestRunMenu() {
    const jumpToTestRunGroup = document.getElementById('jumpToTestRunGroup');
    const jumpToTestRunDropdown = document.getElementById('jumpToTestRunDropdown');

    if (!jumpToTestRunGroup || !jumpToTestRunDropdown || !testRunConfig || !testRunConfig.set_id) {
        return; // 如果沒有 set_id，不顯示菜單
    }

    try {
        const teamId = currentTeamId;
        if (!teamId) {
            return;
        }

        // 獲取該 Test Run Set 中的所有 Test Runs
        const response = await window.AuthClient.fetch(
            `/api/teams/${teamId}/test-run-sets/${testRunConfig.set_id}`
        );

        if (!response.ok) {
            return;
        }

        const setData = await response.json();
        const testRuns = setData.test_runs || [];

        // 過濾出不是當前 Test Run 的所有 Test Runs
        const otherTestRuns = Array.isArray(testRuns) ?
                             testRuns.filter(tr => tr.id !== currentConfigId) :
                             [];

        if (otherTestRuns.length === 0) {
            // 如果沒有其他 Test Runs，隱藏菜單
            jumpToTestRunGroup.style.display = 'none';
            return;
        }

        // 清空現有菜單項
        jumpToTestRunDropdown.innerHTML = '';

        // 添加每個 Test Run 為菜單項
        otherTestRuns.forEach(testRun => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.className = 'dropdown-item';
            a.href = '#';
            a.style.cursor = 'pointer';

            const statusIcon = testRun.status === 'active' ? 'play-circle' :
                              testRun.status === 'draft' ? 'file-alt' :
                              testRun.status === 'completed' ? 'check-circle' :
                              'archive';
            a.innerHTML = `<i class="fas fa-${statusIcon} me-2"></i>${escapeHtml(testRun.name)}`;

            a.addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = `/test-run-execution?config_id=${testRun.id}&team_id=${teamId}`;
            });

            li.appendChild(a);
            jumpToTestRunDropdown.appendChild(li);
        });

        // 顯示菜單
        jumpToTestRunGroup.style.display = 'block';

    } catch (error) {
        console.error('Failed to initialize jump to test run menu:', error);
        jumpToTestRunGroup.style.display = 'none';
    }
}

function setupQuickSearch_TR() {
    if (!document.getElementById('quickSearchOverlay')) {
        const overlay = document.createElement('div');
        overlay.id = 'quickSearchOverlay';
        overlay.style.cssText = 'position:fixed;inset:0;z-index:1060;display:none;background:rgba(0,0,0,0.35)';
        overlay.innerHTML = `
          <div class="position-fixed" style="top:34vh; left:50%; transform: translateX(-50%); width:min(720px, 92vw);">
            <div class="card shadow">
              <div class="card-body p-2">
                <input id="quickSearchInput" type="text" class="form-control form-control-lg" placeholder="${window.i18n ? window.i18n.t('testRun.searchTestCases') : '搜尋測試案例...'}" autocomplete="off" />
                <div id="quickSearchResults" class="list-group list-group-flush" style="max-height:30vh; overflow:auto;"></div>
              </div>
            </div>
          </div>`;
        document.body.appendChild(overlay);
        // 語言切換時即時更新 placeholder
        try {
            const applyPlaceholder = () => {
                const el = document.getElementById('quickSearchInput');
                if (!el) return;
                if (window.i18n && window.i18n.isReady && window.i18n.isReady()) {
                    let text = window.i18n.t('testRun.searchTestCases');
                    if (!text || text === 'testRun.searchTestCases') {
                        // 後備：沿用 testCase 的搜尋文案或硬編碼中文
                        const alt = window.i18n.t('testCase.searchTestCases');
                        text = (alt && alt !== 'testCase.searchTestCases') ? alt : '搜尋測試案例...';
                    }
                    el.placeholder = text;
                } else {
                    el.placeholder = '搜尋測試案例...';
                }
            };
            applyPlaceholder();
            document.addEventListener('languageChanged', applyPlaceholder);
            document.addEventListener('i18nReady', applyPlaceholder);
        } catch (_) {}
        overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeQuickSearch_TR(); });
    }
    document.addEventListener('keydown', function(e){
        const tag = (e.target && e.target.tagName || '').toLowerCase();
        const isTyping = ['input','textarea','select'].includes(tag) || (e.target && e.target.isContentEditable);
        if (!isTyping && e.key === '/' && !e.ctrlKey && !e.metaKey && !e.altKey) {
            e.preventDefault();
            openQuickSearch_TR();
        }
    });
}
function openQuickSearch_TR() {
    const overlay = document.getElementById('quickSearchOverlay');
    const input = document.getElementById('quickSearchInput');
    const results = document.getElementById('quickSearchResults');
    if (!overlay || !input || !results) return;
    overlay.style.display = 'block';
    input.value = '';
    results.innerHTML = '';
    input.focus();
    const handleKey = (e) => {
        if (e.key === 'Escape') { closeQuickSearch_TR(); return; }
        if (e.key === 'Enter') {
            const active = results.querySelector('.active');
            if (active) { active.click(); }
        } else if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
            e.preventDefault();
            const items = Array.from(results.querySelectorAll('.list-group-item'));
            if (items.length === 0) return;
            let idx = items.findIndex(li => li.classList.contains('active'));
            if (idx < 0) idx = 0;
            idx = (e.key === 'ArrowDown') ? Math.min(idx+1, items.length-1) : Math.max(idx-1, 0);
            items.forEach(li => li.classList.remove('active'));
            items[idx].classList.add('active');
            items[idx].scrollIntoView({ block:'nearest' });
        }
    };
    input.onkeydown = handleKey;
    input.oninput = () => quickSearchRender_TR(input.value, results);
}
function closeQuickSearch_TR() {
    const overlay = document.getElementById('quickSearchOverlay');
    if (overlay) overlay.style.display = 'none';
}
function quickSearchRender_TR(query, container) {
    const q = (query || '').trim().toLowerCase();
    let matches = [];
    if (q.length > 0) {
        matches = (testRunItems || []).filter(it => {
            const num = (it.test_case_number || '').toLowerCase();
            const title = (it.title || '').toLowerCase();
            return num.includes(q) || title.includes(q);
        }).slice(0, 100);
    }
    if (matches.length === 0) {
        const noText = window.i18n ? window.i18n.t('errors.noMatchingTestCases') : '沒有找到符合條件的測試案例';
        container.innerHTML = `<div class="list-group-item text-muted">${noText}</div>`;
        return;
    }
    container.innerHTML = matches.map((it, idx) => `
      <button type="button" class="list-group-item list-group-item-action ${idx===0?'active':''}" data-num="${it.test_case_number}">
        <div class="d-flex justify-content-between align-items-center">
          <code class="me-2" style="color: rgb(194, 54, 120); font-weight: 500;">${escapeHtml(it.test_case_number || '')}</code>
          <span class="text-truncate">${escapeHtml(it.title || '')}</span>
        </div>
      </button>`).join('');
    
    // 重新應用翻譯到新生成的內容
    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(container);
    }
    container.querySelectorAll('.list-group-item').forEach(btn => {
        btn.addEventListener('click', async () => {
            const tcNum = btn.getAttribute('data-num');
            closeQuickSearch_TR();
            if (tcNum) {
                await showTestCaseDetailModal(tcNum);
            }
        });
    });
}
</script>
<script>
// Configure marked to treat single newlines as <br> so previews show line breaks
if (window.marked && typeof window.marked.setOptions === 'function') {
    window.marked.setOptions({
        breaks: true,
        gfm: true,
        headerIds: false,
        mangle: false
    });
}
</script>

<!-- Test Run 執行頁面樣式 -->
<style>
/* Test Run 執行頁面整體布局 */
.test-run-execution {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0; /* Allow flex item to shrink below content size */
    height: calc(100vh - var(--header-height) - var(--footer-height) - 16px);
    overflow: hidden;
}



/* 統計資訊樣式 */

.execution-stats-wrapper {
    position: relative;
    width: 100%;
}

.execution-stats {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
    align-items: stretch;
}

.filter-status-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 0.5rem;
    align-items: center;
}

.filter-status-options .form-check {
    margin-bottom: 0;
    display: flex;
    align-items: center;
    gap: 0.25rem;
    white-space: nowrap;
}

@media (max-width: 576px) {
    .filter-status-options {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
    }
}

.filter-search-controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    align-items: start;
}

.filter-search-controls .form-label {
    font-size: 0.75rem;
    color: var(--tr-text-muted);
    margin-bottom: 0.25rem;
}

.filter-field {
    display: flex;
    flex-direction: column;
    min-width: 200px;
}

.case-field {
    min-width: 200px;
}

.title-field {
    min-width: 250px;
}

.priority-field {
    min-width: 160px;
}

.priority-field select {
    width: 100%;
}

.assignee-field {
    min-width: 250px;
}

/* 優先級和執行者專用行樣式 */
.filter-priority-assignee-row {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 1rem;
    align-items: start;
}

.filter-priority-assignee-row .priority-field {
    min-width: 160px;
}

.filter-priority-assignee-row .assignee-field {
    min-width: 250px;
}

@media (max-width: 992px) {
    .filter-search-controls {
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.75rem;
    }

    .filter-field {
        min-width: 180px;
    }

    .title-field,
    .assignee-field {
        min-width: 200px;
    }

    .filter-priority-assignee-row {
        grid-template-columns: 1fr 1.5fr;
        gap: 0.75rem;
    }
}

@media (max-width: 768px) {
    .filter-search-controls {
        grid-template-columns: 1fr;
        gap: 0.75rem;
    }

    .filter-field {
        min-width: 0;
        width: 100%;
    }

    .filter-priority-assignee-row {
        grid-template-columns: 1fr;
        gap: 0.75rem;
    }
}

.filter-assignee-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
    min-height: 1.5rem;
    width: 100%;
    margin-top: 0.25rem;
    padding: 0.25rem 0;
}

.filter-chip {
    background: var(--tr-bg-light);
    border: 1px solid var(--tr-border-light);
    border-radius: 999px;
    padding: 0.15rem 0.6rem;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    font-size: 0.75rem;
    line-height: 1.1;
}

.filter-chip-remove {
    border: none;
    background: transparent;
    color: inherit;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    cursor: pointer;
}

.filter-chip-remove i {
    pointer-events: none;
}

.stat-item.filter-stat {
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.stat-item.filter-stat:hover,
.stat-item.filter-stat:focus {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(13, 110, 253, 0.2);
    outline: none;
}

.stat-item.filter-stat.active {
    border-color: var(--tr-primary);
    box-shadow: 0 4px 10px rgba(13, 110, 253, 0.25);
}

.execution-filter-panel {
    position: absolute;
    top: 0;
    left: 0;
    width: min(680px, 100%);
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(12px) saturate(1.2);
    -webkit-backdrop-filter: blur(12px) saturate(1.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 0.75rem;
    padding: 1rem;
    box-shadow:
        0 8px 32px rgba(15, 23, 42, 0.12),
        0 2px 8px rgba(15, 23, 42, 0.08),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
    display: none;
    z-index: 1050;
    box-sizing: border-box;
}

.execution-filter-panel.show {
    display: block;
    animation: glassPanelFadeIn 0.3s ease-out;
}

@keyframes glassPanelFadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px) scale(0.95);
        backdrop-filter: blur(0px);
        -webkit-backdrop-filter: blur(0px);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
        backdrop-filter: blur(12px) saturate(1.2);
        -webkit-backdrop-filter: blur(12px) saturate(1.2);
    }
}

.filter-panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(222, 226, 230, 0.6);
    background: rgba(255, 255, 255, 0.1);
    margin: -1rem -1rem 1rem -1rem;
    padding: 0.75rem 1rem 0.5rem 1rem;
    border-radius: 0.75rem 0.75rem 0 0;
}

.filter-panel-body {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

/* 磨砂玻璃面板內的表單元素樣式 */
.execution-filter-panel .form-control,
.execution-filter-panel .form-select {
    background: rgba(255, 255, 255, 0.7);
    border: 1px solid rgba(222, 226, 230, 0.5);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    transition: all 0.2s ease;
}

.execution-filter-panel .form-control:focus,
.execution-filter-panel .form-select:focus {
    background: rgba(255, 255, 255, 0.9);
    border-color: rgba(74, 144, 226, 0.6);
    box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.15);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
}

.execution-filter-panel .form-check-input {
    background-color: rgba(255, 255, 255, 0.8);
    border: 1px solid rgba(222, 226, 230, 0.6);
}

.execution-filter-panel .form-check-input:checked {
    background-color: var(--tr-primary);
    border-color: var(--tr-primary);
}

@media (max-width: 767.98px) {
    .execution-filter-panel {
        width: calc(100% - 1rem);
        left: 0.5rem;
        right: 0.5rem;
        max-width: none;
    }
}

.stat-item {
    background: var(--tr-bg-light);
    padding: 0.375rem 0.75rem;
    border-radius: 0.375rem;
    border: 1px solid var(--tr-border-light);
    min-width: 120px;
    text-align: center;
    transition: all 0.2s ease;
}

/* Bug Tickets 卡片 hover 效果 */
.stat-item.bug-tickets-card:hover {
    background: #fff3cd;
    border-color: #ffc107;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(255, 193, 7, 0.2);
}

.stat-number {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--tr-primary);
    line-height: 1.2;
}

.stat-label {
    font-size: 0.8rem;
    color: var(--tr-text-muted);
    line-height: 1.2;
}

/* Test Run Items 表格樣式 */
.test-run-items-container {
    flex: 1;
    min-height: 0;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--tr-border-light);
    border-radius: 0.375rem;
    width: 100%;
    max-width: 100%;
}

.test-run-items-table {
    flex: 1;
    min-height: 0;
    overflow-y: auto;
    overflow-x: auto;
    width: 100%;
}

.test-run-items-table table {
    margin-bottom: 0;
    width: 100%;
}

.test-run-items-table th {
    position: sticky;
    top: 0;
    background: var(--tr-bg-sidebar);
    z-index: 10;
    border-bottom: 2px solid var(--tr-border);
    vertical-align: middle;
    padding: 0.75rem 0.5rem;
    font-weight: 600;
    white-space: nowrap; /* 防止標頭折行 */
}

.test-run-items-table td {
    vertical-align: middle;
    padding: 0.75rem 0.5rem;
}

/* 表格欄位寬度標準化 */
.test-run-items-table th:nth-child(1), 
.test-run-items-table td:nth-child(1) { /* checkbox */
    width: 25px;
    min-width: 25px;
    text-align: center;
    padding: 0.5rem 0.25rem;
}

.test-run-items-table th:nth-child(2), 
.test-run-items-table td:nth-child(2) { /* 案例編號 */
    width: 170px;
    min-width: 170px;
    text-align: left;
}

.test-run-items-table th:nth-child(3), 
.test-run-items-table td:nth-child(3) { /* 標題 */
    min-width: 200px;
    text-align: left;
}

.test-run-items-table th:nth-child(4), 
.test-run-items-table td:nth-child(4) { /* 優先級 */
    width: 160px;
    min-width: 160px;
    text-align: center;
}

.test-run-items-table th:nth-child(5), 
.test-run-items-table td:nth-child(5) { /* 測試結果 */
    width: 170px;
    min-width: 170px;
    text-align: center;
}

.test-run-items-table th:nth-child(6), 
.test-run-items-table td:nth-child(6) { /* 執行者 */
    width: 175px;
    min-width: 175px;
    text-align: center;
}

.test-run-items-table th:nth-child(7), 
.test-run-items-table td:nth-child(7) { /* 執行時間 */
    width: 160px;
    min-width: 160px;
    text-align: center;
}



/* 測試結果選擇器樣式 */
.result-selector {
    min-width: 140px;
}

.result-selector select {
    border: none;
    background: transparent;
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
}

/* 大尺寸測試結果選擇器 */
.result-selector-lg {
    min-width: 150px;
    text-align: center; /* 讓容器內文字置中（對部分瀏覽器有幫助） */
}

.result-selector-lg select {
    font-size: 0.95rem;
    padding: 0.375rem 0.75rem;
    border: 1px solid var(--tr-border-light);
    border-radius: 0.25rem;
    text-align: center;           /* 置中文本 */
    text-align-last: center;      /* 大多數瀏覽器對齊選中項 */
    -moz-text-align-last: center; /* Firefox 專用前綴 */
}

/* 作為回退，讓下拉選項本身也置中 */
.result-selector-lg select option {
    text-align: center;
}

/* 大尺寸優先級 badge */
.priority-badge-lg {
    font-size: 0.85rem;
    padding: 0.4rem 0.8rem;
    font-weight: 500;
    min-width: 150px;
}

/* 大尺寸測試結果 badge */
.result-badge-lg {
    font-size: 0.85rem;
    padding: 0.4rem 0.8rem;
    font-weight: 500;
    display: inline-block;        /* 讓寬度可控制並可置中內容 */
    text-align: center;           /* 置中文本 */
    min-width: 140px;             /* 與下拉寬度接近，視覺對齊 */
}

/* 執行者編輯器樣式 */
.assignee-editor {
    border: 1px solid transparent;
    background: transparent;
    transition: all 0.2s ease;
    text-align: center;
    width: 100%;
}

.assignee-editor:hover {
    border-color: var(--tr-border-light);
    background: var(--tr-bg-light);
}

.assignee-editor:focus {
    border-color: var(--tr-primary);
    background: white;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.1);
}

.result-passed { color: var(--tr-success-dark); background: var(--tr-success-light); }
.result-failed { color: var(--tr-danger-dark); background: var(--tr-danger-light); }
.result-retest { color: var(--tr-warning-dark); background: var(--tr-warning-light); }
.result-na { color: var(--tr-secondary-dark); background: var(--tr-secondary-light); }
.result-pending { color: var(--tr-text-muted); background: var(--tr-bg-light); }
.result-not-required { color: #495057; background: #e9ecef; }
.result-skip { color: #0d6efd; background: #e7f1ff; }

/* 操作按鈕樣式 */
.item-actions {
    display: flex;
    gap: 0.25rem;
}

.btn-icon-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

/* 可點擊項目樣式 */
.test-run-items-table a {
    color: var(--tr-primary);
    cursor: pointer;
}

.test-run-items-table a:hover {
    color: var(--tr-primary-dark, #0056b3);
    text-decoration: underline !important;
}

.test-run-items-table code a {
    color: inherit;
}

.test-run-items-table code a:hover {
    color: var(--tr-primary);
}

/* 表格行 hover 效果優化 */
.test-run-items-table tbody tr:hover {
    background-color: var(--tr-bg-light, #f8f9fa);
    transition: background-color 0.15s ease-in-out;
}

.tre-section-row {
    background: #f5f7fb;
    font-weight: 600;
}

.tre-section-row .section-toggle {
    cursor: pointer;
}

.tre-section-row td {
    border-top: 2px solid var(--tr-border-light, #e5e7eb);
}

/* 表格整體美化 */
.test-run-items-table table {
    border-collapse: separate;
    border-spacing: 0;
}

.test-run-items-table th:first-child {
    border-top-left-radius: 0.375rem;
}

.test-run-items-table th:last-child {
    border-top-right-radius: 0.375rem;
}

/* Checkbox 欄位狀態控制 */
.checkbox-cell {
    width: 25px !important;
    padding: 0.5rem 0.25rem !important;
}

/* 隱藏 checkbox 欄位的樣式（completed 狀態） */
.test-run-items-table.hide-checkbox #checkbox-header,
.test-run-items-table.hide-checkbox .checkbox-cell {
    width: 0 !important;
    padding: 0 !important;
    min-width: 0 !important;
    max-width: 0 !important;
    visibility: collapse !important;
    border: none !important;
}

/* 批次操作工具區樣式（統一與 Test Case Management） */
#batchOperationsToolbar {
    white-space: nowrap; /* 保持單行，不加背景與邊框 */
}

/* 響應式調整 */
@media (max-width: 768px) {
    .execution-stats {
        justify-content: center;
    }
    
    .stat-item {
        min-width: 100px;
    }
    
    /* 小螢幕時批次操作區域換行顯示 */
    .d-flex.flex-wrap.gap-3.align-items-center {
        flex-direction: column;
        align-items: stretch !important;
        gap: 1rem !important;
    }
    
    #batchOperationsToolbar {
        justify-content: center;
    }
    
    /* 小螢幕時隱藏部分欄位 */
    .test-run-items-table th:nth-child(7),
    .test-run-items-table td:nth-child(7) {
        display: none;
    }
}
/* Test Case 詳細資料 Modal 內部固定與捲動區域 - 全螢幕三欄佈局 */
#testCaseDetailModal .modal-dialog {
    max-width: 95vw;
    width: 95vw;
    max-height: 92vh;
    margin: 2vh auto;
}
#testCaseDetailModal .modal-content {
    display: flex;
    height: 92vh;
    max-height: 92vh;
}
#testCaseDetailModal .modal-body {
    display: flex;
    flex-direction: column;
    overflow: hidden;
}
#testCaseDetailFixed { flex: 0 0 auto; }
#testCaseDetailScrollable { flex: 1 1 auto; overflow-y: auto; min-height: 0; max-height: 100%; }

/* Bug Tickets Summary Modal 樣式 */
#bugTicketsSummaryModal .modal-dialog {
    max-width: 800px;
    max-height: 90vh;
}

#bugTicketsSummaryModal .modal-content {
    height: 600px;
    display: flex;
    flex-direction: column;
}

#bugTicketsSummaryModal .modal-body {
    flex: 1;
    padding: 1rem;
    overflow-y: auto;
}

/* 確保 Bug Tickets 內容區域可見 */
#bugTicketsSummaryContent {
    width: 100%;
    min-height: 200px;
}

#bugTicketsList {
    width: 100%;
    min-height: 100px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.5rem;
}

#bugTicketsSummaryList {
    width: 100%;
    min-height: 100px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 0.5rem;
}

/* Bug tickets 卡片樣式 */
.bug-ticket-card {
    border: 1px solid var(--tr-border-light);
    border-radius: 0.5rem;
    background: white;
    margin-bottom: 1rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.2s ease;
    overflow: hidden;
}

.bug-ticket-card:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

.bug-ticket-card-body {
    display: flex;
    min-height: 120px;
}

.bug-ticket-left-panel {
    flex: 0 0 200px;
    background: #f8f9fa;
    border-right: 1px solid var(--tr-border-light);
    padding: 1rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
}

.bug-ticket-number {
    font-weight: 600;
    color: var(--tr-primary);
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    text-decoration: none;
}

.bug-ticket-number:hover {
    text-decoration: underline;
    color: var(--tr-primary);
}

.bug-ticket-status {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.bug-ticket-summary {
    font-size: 0.8rem;
    color: var(--tr-text-muted);
    line-height: 1.3;
    text-align: center;
}

.bug-ticket-right-panel {
    flex: 1;
    padding: 1rem;
}

.test-cases-header {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--tr-text-dark);
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.test-cases-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    max-height: 200px;
    overflow-y: auto;
}

.test-case-item {
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--tr-border-light);
    border-radius: 0.25rem;
    background: #f8f9fa;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.85rem;
}

.test-case-item:hover {
    background: #e9ecef;
    border-color: var(--tr-primary);
    transform: translateX(2px);
}

.test-case-number {
    font-weight: 600;
    color: var(--tr-primary);
}

.test-case-result {
    font-size: 0.75rem;
    padding: 0.1rem 0.4rem;
    border-radius: 0.2rem;
    margin-left: auto;
}

/* 空狀態樣式 */
.bug-tickets-empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--tr-text-muted);
    text-align: center;
}

.bug-tickets-empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.3;
}

/* 響應式設計 */
@media (max-width: 768px) {
    #bugTicketsSummaryModal .modal-dialog {
        max-width: 95vw;
        margin: 0.5rem;
    }
    
    #bugTicketsSummaryModal .modal-content {
        height: 85vh;
    }
    
    .bug-ticket-card-body {
        flex-direction: column;
        min-height: auto;
    }
    
    .bug-ticket-left-panel {
        flex: none;
        border-right: none;
        border-bottom: 1px solid var(--tr-border-light);
        padding: 0.75rem;
    }
    
    .bug-ticket-right-panel {
        padding: 0.75rem;
    }
    
    .test-cases-list {
        max-height: 150px;
    }
}

/* Timeline 樣式 */
.timeline-item { position: relative; padding-left: 1rem; margin-bottom: 0.75rem; }
.timeline-item::before { content: ''; position: absolute; left: 0.38rem; top: 0.2rem; width: 8px; height: 8px; border-radius: 50%; background-color: var(--tr-primary, #0d6efd); }
.timeline-item .time { font-size: 0.75rem; color: var(--tr-text-muted); }
.timeline-item .status { font-size: 0.85rem; font-weight: 500; }
.timeline-divider { height: 1px; background: var(--tr-border-light); margin: 0.25rem 0 0.5rem; }

/* 淡色區塊配色（保留配色，不影響捲動） */
.section-block { padding: 0.75rem; border-radius: 0.375rem; border: 1px solid var(--tr-border-light); }
.section-precondition { background: rgba(13, 110, 253, 0.06); border-color: rgba(13, 110, 253, 0.2); }
.section-steps { background: rgba(255, 193, 7, 0.08); border-color: rgba(255, 193, 7, 0.25); }
.section-expected { background: rgba(25, 135, 84, 0.08); border-color: rgba(25, 135, 84, 0.25); }
.section-attachments { background: rgba(108, 117, 125, 0.06); border-color: rgba(108, 117, 125, 0.25); }

/* Section 清單（依 Test Run Items 的 Section 分組） */
.tre-section-tree {
    max-height: 320px;
    overflow-y: auto;
    border: 1px solid var(--tr-border-light);
    border-radius: 0.5rem;
    padding: 0.5rem;
    background: #fff;
}

.tre-section-node {
    padding: 0.35rem 0.5rem;
    border-radius: 0.35rem;
    transition: background-color 0.2s;
}

.tre-section-node:hover {
    background-color: #f5f7fb;
}

.tre-section-node.active {
    background-color: #e7f1ff;
    border: 1px solid #d0e4ff;
}

.tre-section-toggle {
    border: none;
    background: transparent;
    width: 28px;
    height: 28px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.tre-section-label {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-weight: 600;
}

.tre-section-count {
    font-size: 0.8rem;
}

/* AssigneeSelector 在 Modal 中的樣式調整 */
#testCaseDetailModal .assignee-selector-container {
    width: 100%;
}

#testCaseDetailModal .assignee-selector-container .form-control {
    text-align: left;
}

/* Basic Info 區域樣式 */
.basic-info-body {
    padding-top: 0.25rem;
    padding-bottom: 0.25rem;
}

.basic-info-table {
    line-height: 1.2;
}

.basic-info-label {
    font-weight: 600;
    width: 15%;
    font-size: 0.85rem;
    padding: 0.15rem 0.5rem;
}

.basic-info-label-top {
    vertical-align: top;
}

.basic-info-value {
    padding: 0.15rem 0.5rem;
}

.basic-info-code {
    font-size: 0.85rem;
}

.basic-info-title {
    word-break: break-word;
    font-size: 0.9rem;
}

.basic-info-badge {
    font-size: 0.75rem;
}

.basic-info-input {
    font-size: 0.9rem;
}

/* Scrollable Content 區域樣式 */
.scrollable-content-card {
    border: none;
}

.scrollable-content-body {
    padding: 1rem;
}

/* Content Markdown 樣式 */
.content-markdown {
    font-size: 0.9rem;
}

#testCaseDetailModal .assignee-selector-dropdown {
    z-index: 1060; /* 高於 Modal 的 z-index */
    left: 0;
    right: auto;
    text-align: left;
}

#testCaseDetailModal .assignee-selector-item {
    text-align: left;
    justify-content: flex-start;
}

/* Markdown 內容樣式（Test Case Detail Modal） */
#testCaseDetailModal .markdown-preview {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    line-height: 1.6;
}
#testCaseDetailModal .markdown-preview h1,
#testCaseDetailModal .markdown-preview h2,
#testCaseDetailModal .markdown-preview h3,
#testCaseDetailModal .markdown-preview h4,
#testCaseDetailModal .markdown-preview h5,
#testCaseDetailModal .markdown-preview h6 {
    margin-top: 1rem;
    margin-bottom: 0.5rem;
    font-weight: 600;
}
#testCaseDetailModal .markdown-preview h1 { font-size: 1.4rem; }
#testCaseDetailModal .markdown-preview h2 { font-size: 1.2rem; }
#testCaseDetailModal .markdown-preview h3 { font-size: 1.05rem; }
#testCaseDetailModal .markdown-preview h4 { font-size: 0.95rem; }
#testCaseDetailModal .markdown-preview h5 { font-size: 0.9rem; }
#testCaseDetailModal .markdown-preview h6 { font-size: 0.85rem; }
#testCaseDetailModal .markdown-preview ul,
#testCaseDetailModal .markdown-preview ol {
    padding-left: 1.5rem;
    margin-bottom: 1rem;
}
#testCaseDetailModal .markdown-preview code {
    background-color: var(--tr-bg-sidebar);
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
}
#testCaseDetailModal .markdown-preview pre {
    background-color: var(--tr-bg-sidebar);
    padding: 0.75rem;
    border-radius: 0.375rem;
    overflow-x: auto;
}
#testCaseDetailModal .markdown-preview pre code {
    background: none;
    padding: 0;
}
#testCaseDetailModal .markdown-preview a {
    color: var(--tr-primary);
    text-decoration: none;
}
#testCaseDetailModal .markdown-preview a:hover {
    text-decoration: underline;
}
#testCaseDetailModal .markdown-preview blockquote {
    border-left: 4px solid var(--tr-primary);
    margin: 1rem 0;
    padding-left: 1rem;
    color: var(--tr-text-muted);
}
#testCaseDetailModal .markdown-preview table {
    border-collapse: collapse;
    width: 100%;
    margin: 1rem 0;
}
#testCaseDetailModal .markdown-preview th,
#testCaseDetailModal .markdown-preview td {
    border: 1px solid var(--tr-border-light);
    padding: 0.5rem;
    text-align: left;
}
#testCaseDetailModal .markdown-preview th {
    background-color: var(--tr-bg-light);
    font-weight: 600;
}
</style>
{% endblock %}

{% block page_title_text %}
<span data-i18n="testRun.execution">Test Run 執行</span>
{% endblock %}

{% block page_subtitle_text %}
<span id="test-run-subtitle">執行測試案例並記錄結果</span>
{% endblock %}

{% block page_specific_actions %}
<div class="d-flex gap-2">
    <button type="button" class="btn btn-success" id="startBtn" style="display: none;">
        <i class="fas fa-play me-2"></i><span data-i18n="testRun.startExecution">開始執行</span>
    </button>
    <button type="button" class="btn btn-warning" id="completeBtn" style="display: none;">
        <i class="fas fa-stop me-2"></i><span data-i18n="testRun.completeExecution">結束執行</span>
    </button>
    <button type="button" class="btn btn-info" id="restartBtn" style="display: none;">
        <i class="fas fa-redo me-2"></i><span data-i18n="testRun.restartExecution">重新執行</span>
    </button>
    <div class="ms-auto d-flex gap-2">
        <button type="button" class="btn btn-primary" id="exportBtn">
            <i class="fas fa-chart-pie me-2"></i><span data-i18n="testRun.chartsReports">Charts & Reports</span>
        </button>
        <button type="button" class="btn btn-secondary" id="refreshBtn">
            <i class="fas fa-sync-alt me-2"></i><span data-i18n="common.refresh">重新整理</span>
        </button>
        <div class="btn-group" role="group" id="jumpToTestRunGroup" style="display: none;">
            <button type="button" class="btn btn-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-arrow-right me-2"></i><span data-i18n="common.jumpTo">跳至</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" id="jumpToTestRunDropdown">
                <!-- 其他 Test Runs 會在此動態列出 -->
            </ul>
        </div>
        <a href="/test-run-management" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i><span data-i18n="navigation.backToManagement">回到管理</span>
        </a>
        <a href="/" class="btn btn-secondary">
            <i class="fas fa-home me-2"></i><span data-i18n="navigation.backToHome">首頁</span>
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid test-run-execution">
    <!-- 移除全頁載入狀態，改在列表區顯示載入動畫 -->

    <!-- Test Run 資訊與控制區 -->
    <div id="test-run-header" style="display: none;">
        <!-- 統計資訊區域已簡化 -->

        <!-- 統計資訊和批次操作一體化區域 -->
        <div class="execution-stats-wrapper">
            <div class="d-flex flex-wrap gap-3 align-items-stretch">
            <!-- 統計資訊 -->
            <div class="execution-stats flex-grow-1">
                <div class="stat-item">
                    <div class="stat-number" id="total-count">0</div>
                    <div class="stat-label" data-i18n="testRun.totalItems">總項目</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="executed-count">0</div>
                    <div class="stat-label" data-i18n="testRun.executedItems">已執行</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number text-success" id="passed-count">0</div>
                    <div class="stat-label" data-i18n="testRun.passedItems">Passed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number text-danger" id="failed-count">0</div>
                    <div class="stat-label" data-i18n="testRun.failedItems">Failed</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="execution-rate">0%</div>
                    <div class="stat-label" data-i18n="testRun.executionRate">執行率</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="pass-rate">0%</div>
                    <div class="stat-label" data-i18n="testRun.passRate">通過率</div>
                </div>
                <div class="stat-item bug-tickets-card" onclick="showBugTicketsModal()" style="cursor: pointer;">
                    <div class="stat-number text-warning" id="bug-tickets-count">0</div>
                    <div class="stat-label" data-i18n="testRun.bugTicketsCount">Bug Tickets</div>
                </div>
                <div class="stat-item filter-stat" id="executionFilterToggle" role="button" tabindex="0" aria-haspopup="true" aria-expanded="false" aria-controls="executionFilterPanel">
                    <div class="stat-number" id="executionFilterMatched">0</div>
                    <div class="stat-label" data-i18n="testRun.filtersApplied">已篩選</div>
                </div>
            </div>
            <!-- 批次操作工具區 -->
            <div id="batchOperationsToolbar" class="d-none d-flex align-items-center gap-2 ms-lg-auto mb-2 mb-lg-0">
                <button type="button" class="btn btn-secondary btn-sm" id="clearSelectionExecBtn" data-i18n-title="common.clearSelection" title="清除選取">
                    <i class="fas fa-xmark"></i>
                </button>
                <span class="text-muted" id="selectedItemsCount" data-i18n="testRun.selectedItemsCount" data-i18n-params='{"count": 0}'>已選取 0 個項目</span>
                <button type="button" class="btn btn-primary btn-sm" id="batchModifyBtn">
                    <i class="fas fa-edit me-2"></i><span data-i18n="testRun.batchModify">批次修改</span>
                </button>
                <button type="button" class="btn btn-danger btn-sm" id="batchDeleteBtn">
                    <i class="fas fa-trash me-2"></i><span data-i18n="testRun.batchDelete">批次刪除</span>
                </button>
            </div>
            </div> <!-- /d-flex stats + toolbar -->

            <div id="executionFilterPanel" class="execution-filter-panel" role="dialog" aria-modal="false" aria-labelledby="executionFilterTitle">
                <div class="filter-panel-header">
                    <div class="d-flex align-items-center gap-2">
                        <i class="fas fa-filter text-primary"></i>
                        <h6 class="mb-0" id="executionFilterTitle" data-i18n="common.filter">篩選</h6>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="resetExecutionFiltersBtn" data-i18n="testRun.filterReset">清除篩選</button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="closeExecutionFiltersBtn" data-i18n-title="common.close" title="關閉" aria-label="Close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="filter-panel-body">
                    <div>
                        <label class="form-label mb-2" data-i18n="testRun.testResult">測試結果</label>
                        <div class="filter-status-options">
                            <div class="form-check">
                                <input class="form-check-input execution-status-filter" type="checkbox" id="executionStatusAll" value="ALL" checked>
                                <label class="form-check-label" for="executionStatusAll" data-i18n="testRun.allStatuses">全部狀態</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input execution-status-filter" type="checkbox" id="executionStatusPassed" value="Passed" checked>
                                <label class="form-check-label" for="executionStatusPassed" data-i18n="testRun.passed">通過</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input execution-status-filter" type="checkbox" id="executionStatusFailed" value="Failed" checked>
                                <label class="form-check-label" for="executionStatusFailed" data-i18n="testRun.failed">失敗</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input execution-status-filter" type="checkbox" id="executionStatusRetest" value="Retest" checked>
                                <label class="form-check-label" for="executionStatusRetest" data-i18n="testRun.retest">重測</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input execution-status-filter" type="checkbox" id="executionStatusNotAvailable" value="Not Available" checked>
                                <label class="form-check-label" for="executionStatusNotAvailable" data-i18n="testRun.notAvailable">不適用</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input execution-status-filter" type="checkbox" id="executionStatusPending" value="Pending" checked>
                                <label class="form-check-label" for="executionStatusPending" data-i18n="testRun.pending">待處理</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input execution-status-filter" type="checkbox" id="executionStatusNotRequired" value="Not Required" checked>
                                <label class="form-check-label" for="executionStatusNotRequired" data-i18n="testRun.notRequired">不需要</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input execution-status-filter" type="checkbox" id="executionStatusSkip" value="Skip" checked>
                                <label class="form-check-label" for="executionStatusSkip" data-i18n="testRun.skip">跳過</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input execution-status-filter" type="checkbox" id="executionStatusNotExecuted" value="Not Executed" checked>
                                <label class="form-check-label" for="executionStatusNotExecuted" data-i18n="testRun.notExecuted">未執行</label>
                            </div>
                        </div>
                    </div>

                    <div class="filter-search-controls">
                        <div class="filter-field case-field">
                            <label class="form-label" data-i18n="testRun.caseNumber">案例編號</label>
                            <input
                                type="text"
                                class="form-control"
                                id="filterCaseNumberInput"
                                data-i18n-placeholder="testRun.filterCaseNumberPlaceholder"
                                placeholder="{{ i18n.t('testRun.filterCaseNumberPlaceholder') if i18n else '輸入案例編號關鍵字' }}"
                            >
                        </div>
                        <div class="filter-field title-field">
                            <label class="form-label" data-i18n="testRun.caseTitle">標題</label>
                            <input
                                type="text"
                                class="form-control"
                                id="filterTitleInput"
                                data-i18n-placeholder="testRun.filterTitlePlaceholder"
                                placeholder="{{ i18n.t('testRun.filterTitlePlaceholder') if i18n else '輸入標題關鍵字' }}"
                            >
                        </div>
                    </div>

                    <div class="filter-priority-assignee-row">
                        <div class="filter-field priority-field">
                            <label class="form-label" data-i18n="testRun.priority">優先級</label>
                            <select class="form-select" id="filterPrioritySelect">
                                <option value="ALL" data-i18n="testRun.filterPriorityAll">全部優先級</option>
                                <option value="High" data-i18n="priority.high">高</option>
                                <option value="Medium" data-i18n="priority.medium">中</option>
                                <option value="Low" data-i18n="priority.low">低</option>
                            </select>
                        </div>
                        <div class="filter-field assignee-field">
                            <label class="form-label" data-i18n="testRun.assignee">執行者</label>
                            <input
                                type="text"
                                class="form-control"
                                id="filterAssigneeInput"
                                data-assignee-selector
                                data-i18n-placeholder="testRun.filterAssigneePlaceholder"
                                placeholder="{{ i18n.t('testRun.filterAssigneePlaceholder') if i18n else '搜尋並選擇執行者' }}"
                            >
                            <div id="filterAssigneeChips" class="filter-assignee-chips"></div>
                        </div>
                    </div>

                </div>
            </div>
        </div> <!-- /execution-stats-wrapper -->
    </div> <!-- /test-run-header -->

    <!-- 篩選 + Section 清單 + 列表 (左右欄版型) -->
    <!-- Test Run Items 表格 -->
        <div id="test-run-items-container" class="test-run-items-container" style="display: none; min-width:0;">
            <!-- 列表區載入動畫（預設隱藏） -->
            <div id="items-loading" class="align-items-center justify-content-center py-5 d-none" style="min-height: 240px;">
                <div class="text-center text-muted">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div class="mt-2" data-i18n="testRun.loadingItems">載入測試項目中...</div>
                </div>
            </div>

            <div class="test-run-items-table">
                <table class="table table-hover table-sm">
                    <thead>
                        <tr id="table-header-row">
                            <th id="checkbox-header">
                                <input type="checkbox" class="form-check-input" id="selectAllItemsCheckbox">
                            </th>
                            <th id="th-tre-number" class="sortable" style="cursor: pointer;">
                                <span data-i18n="testRun.caseNumber">案例編號</span>
                                <span class="sort-indicator ms-1"></span>
                            </th>
                            <th id="th-tre-title" class="sortable" style="cursor: pointer;">
                                <span data-i18n="testRun.caseTitle">標題</span>
                                <span class="sort-indicator ms-1"></span>
                            </th>
                            <th id="th-tre-priority" class="sortable" style="cursor: pointer;">
                                <span data-i18n="testRun.priority">優先級</span>
                                <span class="sort-indicator ms-1"></span>
                            </th>
                            <th id="th-tre-result" class="sortable" style="cursor: pointer;">
                                <span data-i18n="testRun.testResult">測試結果</span>
                                <span class="sort-indicator ms-1"></span>
                            </th>
                            <th id="th-tre-assignee" class="sortable" style="cursor: pointer;">
                                <span data-i18n="testRun.assignee">執行者</span>
                                <span class="sort-indicator ms-1"></span>
                            </th>
                            <th id="th-tre-executed" class="sortable" style="cursor: pointer;">
                                <span data-i18n="testRun.executedAt">執行時間</span>
                                <span class="sort-indicator ms-1"></span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="items-table-body">
                        <!-- Test Run Items 將在此處動態載入 -->
                    </tbody>
                </table>
            </div>
        </div>
</div>

<!-- Test Run Item 詳情 Modal -->
<div class="modal fade" id="itemDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-clipboard-list me-2"></i>
                    <span data-i18n="testRun.itemDetails">測試項目詳情</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="item-detail-content">
                <!-- 詳情內容將動態載入 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.close">關閉</button>
            </div>
        </div>
    </div>
</div>

<!-- 確認對話框 -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    <span data-i18n="common.confirm">確認操作</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirm-message"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="confirm-action-btn" data-i18n="common.confirm">確認</button>
            </div>
        </div>
    </div>
</div>

<!-- 批次修改模態框 -->
<div class="modal fade" id="batchModifyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit text-primary me-2"></i>
                    <span data-i18n="testRun.batchModify">批次修改</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">
                    <span data-i18n="testRun.batchModifyDescription">將對選中的</span>
                    <strong id="batchModifyCount">0</strong>
                    <span data-i18n="testRun.itemsApplyChanges">個項目套用以下變更：</span>
                </p>
                
                <!-- 執行者批次設定 -->
                <div class="mb-3">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="batchModifyAssignee" checked>
                        <label class="form-check-label" for="batchModifyAssignee">
                            <strong data-i18n="testRun.batchSetAssignee">批次設定執行者</strong>
                        </label>
                    </div>
                    <input type="text" class="form-control" id="batchAssigneeInput" 
                           data-assignee-selector
                           data-i18n-placeholder="testRun.enterAssigneeName"
                           placeholder="{{ i18n.t('testRun.enterAssigneeName') if i18n else '輸入執行者姓名' }}">
                </div>
                
                <!-- 測試結果批次設定 -->
                <div class="mb-3" id="batchResultSection">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="batchModifyResult">
                        <label class="form-check-label" for="batchModifyResult">
                            <strong data-i18n="testRun.batchSetResult">批次設定測試結果</strong>
                            <br><small class="text-muted" data-i18n="testRun.onlyActiveStatus">（僅適用於執行中狀態）</small>
                        </label>
                    </div>
                    <select class="form-select" id="batchResultSelect" disabled>
                        <option value="">Select Result</option>
                        <option value="Passed">Passed</option>
                        <option value="Failed">Failed</option>
                        <option value="Retest">Retest</option>
                        <option value="Not Available">Not Available</option>
                        <option value="Pending">Pending</option>
                        <option value="Not Required">Not Required</option>
                        <option value="Skip">Skip</option>
                    </select>
                </div>

                <!-- 註釋批次設定 -->
                <div class="mb-3">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="batchModifyComment">
                        <label class="form-check-label" for="batchModifyComment">
                            <strong data-i18n="testRun.batchSetComment">批次設定註釋</strong>
                        </label>
                    </div>
                    <textarea
                        class="form-control"
                        id="batchCommentInput"
                        rows="2"
                        disabled
                        data-i18n-placeholder="testRun.enterComment"
                        placeholder="{{ i18n.t('testRun.enterComment') if i18n else '輸入註釋內容' }}"
                    ></textarea>
                </div>
                
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <span data-i18n="testRun.batchModifyNote">只會套用已勾選的項目，空白值將不會變更現有資料。</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-primary" id="confirmBatchModifyBtn">
                    <i class="fas fa-edit me-2"></i><span data-i18n="testRun.confirmModify">確認修改</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 重新執行模態框 -->
<div class="modal fade" id="restartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-redo text-info me-2"></i>
                    <span data-i18n="testRun.restartExecution">重新執行 Test Run</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3" data-i18n="testRun.selectRestartMode">請選擇重新執行模式：</p>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="restartMode" id="restartAll" value="all" checked>
                    <label class="form-check-label" for="restartAll">
                        <strong data-i18n="testRun.restartAllItems">全部重新執行</strong>
                        <br><small class="text-muted" data-i18n="testRun.restartAllDescription">清空所有項目的測試結果，重新開始執行</small>
                    </label>
                </div>
                
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="restartMode" id="restartFailed" value="failed">
                    <label class="form-check-label" for="restartFailed">
                        <strong data-i18n="testRun.restartFailedItems">只執行失敗的項目</strong>
                        <br><small class="text-muted" data-i18n="testRun.restartFailedDescription">只清空標記為「失敗」和「重測」的項目結果</small>
                    </label>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="restartMode" id="restartPending" value="pending">
                    <label class="form-check-label" for="restartPending">
                        <strong data-i18n="testRun.restartPendingItems">只執行未完成的項目</strong>
                        <br><small class="text-muted" data-i18n="testRun.restartPendingDescription">只清空尚未執行的項目，保留已通過的結果</small>
                    </label>
                </div>
                <div class="mb-3">
                    <label for="rerunNameInput" class="form-label" data-i18n="testRun.rerunNameLabel">新的 Test Run 名稱</label>
                    <input type="text" class="form-control" id="rerunNameInput" placeholder="Rerun - ">
                    <small class="text-muted" data-i18n="testRun.rerunNameHint">預設為「Rerun - 原有名稱」</small>
                </div>
                
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span data-i18n="testRun.restartWarning">重新執行會將 Test Run 狀態重置為「執行中」，請確認後繼續。</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.cancel">取消</button>
                <button type="button" class="btn btn-info" id="confirmRestartBtn">
                    <i class="fas fa-redo me-2"></i><span data-i18n="testRun.confirmRestart">確認重新執行</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Case 詳細資料 Modal -->
<div class="modal fade" id="testCaseDetailModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header align-items-center">
                <h5 class="modal-title d-flex align-items-center">
                    <i class="fas fa-tasks me-2"></i>
                    <span data-i18n="testRun.testCaseDetails">Test Case 詳細資料</span>
                </h5>
                <!-- Test Result 下拉/Badge：緊貼在標題後面 -->
                <div id="testCaseDetailHeaderResult" class="ms-3" style="min-width: 170px;"></div>
                <!-- 標頭靠右：上一隻 / 下一隻 / 關閉 -->
                <div class="d-flex align-items-center gap-2 ms-auto">
                    <button type="button" class="btn btn-primary btn-sm" id="copyExecCaseLinkBtn">
                        <i class="fas fa-link me-1"></i><span data-i18n="common.copyLink">複製連結</span>
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" id="prevExecCaseBtn" title="上一隻">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" id="nextExecCaseBtn" title="下一隻">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                <div id="testCaseDetailLoading" class="text-center py-4">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    <span data-i18n="common.loading">載入中...</span>
                </div>
                <!-- 三欄佈局區域 -->
                <div id="testCaseDetailBodyRow" class="d-none" style="flex: 1; min-height: 0; display: flex; gap: 16px;">
                    <!-- 左欄：Test Case 詳情 (40%) -->
                    <div id="testCaseDetailLeft" style="flex: 0 0 calc(40% - 11px); min-width: 0; display: flex; flex-direction: column; overflow: hidden;">
                        <!-- 固定區：Basic Info + 測試詳情標題 -->
                        <div id="testCaseDetailFixed" style="display:none;"></div>
                        <!-- 可捲動區：僅測試詳情內容 -->
                        <div id="testCaseDetailScrollable" style="display:none;"></div>
                    </div>

                    <!-- 中欄：Timeline + Bug Tickets (30%) -->
                    <aside id="testCaseDetailMiddlePane" style="flex: 0 0 calc(30% - 11px); border-left: 1px solid var(--tr-border-light); padding-left: 12px; display: none; min-width: 280px; flex-direction: column; overflow: hidden;">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <h6 class="mb-0"><i class="fas fa-history me-2"></i><span data-i18n="testRun.resultHistory">結果歷程</span></h6>
                            <button type="button" id="refreshTimelineBtn" class="btn btn-secondary text-secondary p-0" title="刷新" style="border: none; background: none;"><i class="fas fa-sync-alt"></i></button>
                        </div>
                        <div id="timelineLoading" class="text-center py-2" style="display:none;">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <div id="timelineEmpty" class="text-muted small" style="display:none;">
                            <i class="fas fa-info-circle me-1"></i><span data-i18n="testRun.noHistory">尚無歷程</span>
                        </div>
                        <div id="timelineList" style="height: 200px; overflow-y: auto; flex-shrink: 0;"></div>

                        <!-- Bug Tickets 區域 -->
                        <div class="mt-3 border-top pt-3" style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <h6 class="mb-0"><i class="fas fa-bug me-2"></i><span data-i18n="testRun.bugTickets">Bug Tickets</span></h6>
                                <button type="button" id="addBugTicketBtn" class="btn btn-secondary text-secondary p-0" data-i18n-title="testRun.addBugTicket" style="border: none; background: none;">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <div id="bugTicketsLoading" class="text-center py-2" style="display:none;">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                            <div id="bugTicketsEmpty" class="text-muted small" style="display:none;">
                                <i class="fas fa-info-circle me-1"></i><span data-i18n="testRun.noBugTickets">尚無關聯的 Bug Tickets</span>
                            </div>
                            <div id="bugTicketsList" style="flex: 1; overflow-y: auto; min-height: 150px;"></div>
                        </div>
                    </aside>

                    <!-- 右欄：Test Results + Comment (30%) -->
                    <aside id="testCaseDetailRightPane" style="flex: 0 0 calc(30% - 11px); border-left: 1px solid var(--tr-border-light); padding-left: 12px; display: none; min-width: 280px; flex-direction: column; overflow: hidden;">
                        <!-- Test Results 區域 -->
                        <div style="flex: 0 0 50%; display: flex; flex-direction: column; min-height: 0; overflow: hidden;">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <h6 class="mb-0">
                                    <i class="fas fa-file-alt me-2"></i>
                                    <span data-i18n="testRun.testResults">Test Results</span>
                                </h6>
                                <button type="button" id="uploadTestResultsBtn" class="btn btn-secondary text-secondary p-0"
                                        data-i18n-title="testRun.uploadTestResults" style="border: none; background: none;">
                                    <i class="fas fa-upload"></i>
                                </button>
                            </div>

                            <!-- 檔案列表區域 -->
                            <div id="testResultsLoading" class="text-center py-2" style="display:none;">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                            <div id="testResultsEmpty" class="text-muted small mb-2" style="display:none;">
                                <i class="fas fa-info-circle me-1"></i><span data-i18n="testRun.noTestResults">尚無測試結果檔案</span>
                            </div>
                            <div id="testResultsList" style="flex: 1; overflow-y: auto; min-height: 100px;"></div>

                            <!-- 上傳狀態區（覆蓋檔案列表區域） -->
                            <div id="testResultsUploadArea" class="test-results-upload-zone mb-2" style="display:none; flex: 1; min-height: 100px;">
                                <div class="upload-dropzone border-2 border-dashed border-secondary rounded p-3 text-center">
                                    <div id="uploadDropText">
                                        <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                        <p class="mb-1" data-i18n="testRun.dropFilesHere">拖曳檔案到此處或點擊上傳</p>
                                        <small class="text-muted" data-i18n="testRun.supportedFormats">支援 PNG, JPG, JPEG, GIF, PDF, TXT, LOG, ZIP, JSON, XML, MP4 (最大 50MB)</small>
                                    </div>
                                    <input type="file" id="testResultsFileInput" multiple accept=".png,.jpg,.jpeg,.gif,.pdf,.txt,.log,.zip,.json,.xml,.mp4,video/mp4,video/quicktime" style="display:none;">
                                </div>

                                <!-- 上傳進度區 -->
                                <div id="uploadProgressArea" style="display:none;">
                                    <div class="progress mb-2" style="height: 20px;">
                                        <div id="uploadProgressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <div id="uploadStatus" class="small text-center"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Comment 區域 -->
                        <div class="border-top pt-3" style="flex: 0 0 50%; display: flex; flex-direction: column; min-height: 0; overflow: hidden; margin-top: 0;">
                            <div class="d-flex align-items-center justify-content-between mb-2" style="flex-shrink: 0;">
                                <h6 class="mb-0">
                                    <i class="fas fa-comment me-2"></i>
                                    <span data-i18n="testRun.comment">Comment</span>
                                </h6>
                                <button type="button" id="editCommentBtn" class="btn btn-secondary text-secondary p-0"
                                        data-i18n-title="testRun.editComment" style="border: none; background: none;">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                            <div id="commentContent" class="text-muted small" style="flex: 1; overflow-y: auto; white-space: pre-wrap; padding: 12px; background-color: #f8f9fa; border-radius: 6px;">
                                <span data-i18n="testRun.noComment">尚無註釋</span>
                            </div>
                        </div>
                    </aside>
                </div>
                <div id="testCaseDetailError" style="display: none;">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span data-i18n="testRun.loadTestCaseError">載入 Test Case 詳細資料失敗</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <button type="button" class="btn btn-info" id="referenceTestCaseExecBtn" style="display: none;">
                        <i class="fas fa-search me-2"></i>
                        <span data-i18n="testCase.referenceTestCaseButton">參考測試案例</span>
                    </button>
                </div>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>
                        <span data-i18n="common.close">關閉</span>
                    </button>
                    <button type="button" class="btn btn-primary" id="openFullTestCaseBtn" style="display: none;">
                        <i class="fas fa-external-link-alt me-2"></i>
                        <span data-i18n="testRun.openInTestCaseManagement">在測試案例管理中開啟</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bug Ticket 新增模態框 -->
<div class="modal fade" id="addBugTicketModal" tabindex="-1" aria-labelledby="addBugTicketModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addBugTicketModalLabel">
                    <i class="fas fa-bug me-2"></i><span data-i18n="testRun.addBugTicket">新增 Bug Ticket</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addBugTicketForm">
                    <div class="mb-3">
                        <label for="bugTicketNumber" class="form-label"><span data-i18n="testRun.ticketNumber">Ticket 編號</span></label>
                        <input type="text" class="form-control" id="bugTicketNumber" placeholder="例如: PRJ-123" required>
                        <div class="form-text"><span data-i18n="testRun.ticketNumberHelp">請輸入 JIRA Ticket 編號</span></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <span data-i18n="common.cancel">取消</span>
                </button>
                <button type="button" class="btn btn-primary" id="confirmAddBugTicket">
                    <i class="fas fa-plus me-2"></i><span data-i18n="common.create">新增</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 刪除 Bug Ticket 確認對話框 -->
<div class="modal fade" id="deleteBugTicketModal" tabindex="-1" aria-labelledby="deleteBugTicketModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteBugTicketModalLabel">
                    <i class="fas fa-trash me-2"></i><span data-i18n="testRun.deleteBugTicket">刪除 Bug Ticket</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><span data-i18n="testRun.confirmDeleteBugTicket">確定要刪除這個 Bug Ticket 嗎？</span></p>
                <div class="text-center">
                    <strong id="deleteBugTicketNumber" class="text-primary"></strong>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <span data-i18n="common.cancel">取消</span>
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBugTicket">
                    <i class="fas fa-trash me-2"></i><span data-i18n="common.delete">刪除</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bug Tickets 摘要 Modal -->
<div class="modal fade" id="bugTicketsSummaryModal" tabindex="-1" aria-labelledby="bugTicketsSummaryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bugTicketsSummaryModalLabel">
                    <i class="fas fa-bug me-2"></i><span data-i18n="testRun.bugTicketsSummary">Bug Tickets 摘要</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="bugTicketsSummaryLoading" class="text-center py-4" style="display:none;">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    <span data-i18n="testRun.loadingBugTickets">載入 Bug Tickets 中...</span>
                </div>
                
                <div id="bugTicketsSummaryEmpty" class="text-center py-4 text-muted" style="display:none;">
                    <i class="fas fa-info-circle me-2"></i>
                    <span data-i18n="testRun.noBugTicketsInRun">此 Test Run 尚無 Bug Tickets</span>
                </div>
                
                <div id="bugTicketsSummaryContent" style="display:none;">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="btn-group btn-group-sm" role="group" aria-label="Status Filter">
                                <button type="button" class="btn btn-secondary active" data-status="ALL" data-i18n="testRun.statusFilter.all" onclick="filterBugTicketsByStatus('ALL')">All</button>
                                <button type="button" class="btn btn-warning" data-status="OPEN" data-i18n="testRun.statusFilter.open" onclick="filterBugTicketsByStatus('OPEN')">Open</button>
                                <button type="button" class="btn btn-primary" data-status="TO DO" data-i18n="testRun.statusFilter.toDo" onclick="filterBugTicketsByStatus('TO DO')">To Do</button>
                                <button type="button" class="btn btn-info" data-status="IN PROGRESS" data-i18n="testRun.statusFilter.inProgress" onclick="filterBugTicketsByStatus('IN PROGRESS')">In Progress</button>
                                <button type="button" class="btn btn-success" data-status="RESOLVED" data-i18n="testRun.statusFilter.resolved" onclick="filterBugTicketsByStatus('RESOLVED')">Resolved</button>
                                <button type="button" class="btn btn-secondary" data-status="SCHEDULED" data-i18n="testRun.statusFilter.scheduled" onclick="filterBugTicketsByStatus('SCHEDULED')">Scheduled</button>
                                <button type="button" class="btn btn-secondary" data-status="CLOSED" data-i18n="testRun.statusFilter.closed" onclick="filterBugTicketsByStatus('CLOSED')">Closed</button>
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="refreshBugTicketsStatus()">
                                <i class="fas fa-sync-alt me-1"></i><span data-i18n="testRun.refreshBugStatus">重新整理狀態</span>
                            </button>
                        </div>
                    </div>
                    <div id="bugTicketsSummaryList" style="max-height: 500px; overflow-y: auto;">
                        <!-- Bug tickets cards will be rendered here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="/static/js/assignee-selector.js"></script>
<script>
// Test Run 執行頁面
let currentConfigId = null;
let currentTeamId = null; // 由 AppUtils 取得，無則退回 1
let testRunConfig = null;
let testRunItems = [];
const EXECUTION_STATUS_VALUES = ['Passed', 'Failed', 'Retest', 'Not Available', 'Pending', 'Not Required', 'Skip', 'Not Executed'];
const executionFilterState = {
    statuses: new Set(['ALL']),
    searchNumber: '',
    searchTitle: '',
    priority: 'ALL',
    assignees: []
};

// Section 篩選
let treSections = [];
let sectionIndexById = new Map(); // id -> { name, parentId }
let sectionDisplayNameCache = new Map();
let sectionHydrationInFlight = false;
let treSectionFilterId = null;
let treSectionFilterIds = null; // Set of allowed section ids (string)，含子節點，'unassigned' 為未指派
let executionFilterInitialized = false;
let executionFilterAssigneeSelector = null;
let executionFilterPanelEl = null;
let executionFilterToggleBtn = null;
let executionFilterIsOpen = false;
let executionFilterResizeHandler = null;
let executionFilterI18nBound = false;
let executionFilterOriginalSelectTexts = new Map();
const debounceExecutionFilter = (fn, delay = 250) => {
    let timer;
    return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(null, args), delay);
    };
};

const TRE_PERMISSION_DEFAULTS = {
    role: 'viewer',
    isViewer: true,
    canStart: false,
    canComplete: false,
    canRestart: false,
    canUpdateResults: false,
    canAssign: false,
    canBatchModify: false,
    canBatchDelete: false,
    canUploadResults: false,
    canManageBugTickets: false,
};

let testRunExecutionPermissions = { ...TRE_PERMISSION_DEFAULTS };

function getTrePermissions() {
    return window._testRunExecutionPermissions || testRunExecutionPermissions || TRE_PERMISSION_DEFAULTS;
}

function setElementVisibility(elementId, isVisible) {
    const element = document.getElementById(elementId);
    if (!element) return;

    if (!element.dataset.defaultDisplay || element.dataset.defaultDisplay === 'none') {
        let defaultDisplay = '';
        if (element.classList.contains('d-flex')) {
            defaultDisplay = 'flex';
        } else if (element.classList.contains('btn-group')) {
            defaultDisplay = 'inline-flex';
        } else if (element.tagName === 'BUTTON' || element.classList.contains('btn')) {
            defaultDisplay = 'inline-block';
        } else if (element.tagName === 'INPUT' || element.tagName === 'SELECT' || element.tagName === 'TEXTAREA') {
            defaultDisplay = 'block';
        } else {
            const computed = window.getComputedStyle(element).display;
            if (computed && computed !== 'none') {
                defaultDisplay = computed;
            }
        }
        element.dataset.defaultDisplay = defaultDisplay || '';
    }

    if (isVisible) {
        element.classList.remove('d-none');
        const displayValue = element.dataset.defaultDisplay;
        if (displayValue) {
            element.style.setProperty('display', displayValue, 'important');
        } else {
            element.style.removeProperty('display');
        }
        if (typeof element.disabled !== 'undefined') {
            element.disabled = false;
        }
    } else {
        element.classList.add('d-none');
        element.style.setProperty('display', 'none', 'important');
        if (typeof element.disabled !== 'undefined') {
            element.disabled = true;
        }
    }
}

function showExecutionPermissionDenied() {
    const message = (window.i18n && window.i18n.isReady())
        ? window.i18n.t('messages.permissionDenied')
        : 'No permission to perform this action';
    if (window.AppUtils && typeof window.AppUtils.showWarning === 'function') {
        window.AppUtils.showWarning(message);
    } else {
        alert(message);
    }
}

async function applyTestRunExecutionPermissions() {
    const defaults = { ...TRE_PERMISSION_DEFAULTS };

    if (!window.AuthClient) {
        testRunExecutionPermissions = defaults;
        window._testRunExecutionPermissions = defaults;
        return defaults;
    }

    let components = {};
    try {
        const resp = await window.AuthClient.fetch('/api/permissions/ui-config?page=test_run_execution');
        if (resp && resp.ok) {
            const payload = await resp.json();
            if (payload && payload.components) {
                components = payload.components;
            }
        }
    } catch (error) {
        console.warn('Failed to fetch Test Run Execution UI permissions:', error);
    }

    let role = 'viewer';
    try {
        const info = await window.AuthClient.getUserInfo();
        if (info && info.role) {
            role = String(info.role).toLowerCase();
        }
    } catch (error) {
        console.warn('Failed to resolve user role, fallback to viewer:', error);
    }

    const resolved = {
        role,
        isViewer: role === 'viewer',
        canStart: !!components.startBtn,
        canComplete: !!components.completeBtn,
        canRestart: !!components.restartBtn,
        canBatchModify: !!components.batchModifyBtn,
        canBatchDelete: !!components.batchDeleteBtn,
        canUpdateResults: !!components.resultEditor,
        canAssign: !!components.assigneeEditor,
        canUploadResults: !!components.uploadTestResultsBtn,
        canManageBugTickets: !!components.addBugTicketBtn,
    };

    if (!resolved.isViewer) {
        resolved.canStart = true;
        resolved.canComplete = true;
        resolved.canRestart = true;
        resolved.canBatchModify = resolved.canBatchModify || true;
        resolved.canBatchDelete = resolved.canBatchDelete || true;
        resolved.canUpdateResults = true;
        resolved.canAssign = true;
        resolved.canUploadResults = true;
        resolved.canManageBugTickets = true;
    }

    testRunExecutionPermissions = resolved;
    window._testRunExecutionPermissions = resolved;

    setElementVisibility('batchOperationsToolbar', resolved.canBatchModify || resolved.canBatchDelete);
    setElementVisibility('batchModifyBtn', resolved.canBatchModify);
    setElementVisibility('batchDeleteBtn', resolved.canBatchDelete);

    const uploadBtn = document.getElementById('uploadTestResultsBtn');
    if (uploadBtn) {
        if (resolved.canUploadResults) {
            uploadBtn.style.display = '';
            uploadBtn.disabled = false;
            uploadBtn.classList.remove('disabled');
            uploadBtn.removeAttribute('aria-disabled');
        } else {
            uploadBtn.style.display = 'none';
            uploadBtn.disabled = true;
            uploadBtn.classList.add('disabled');
            uploadBtn.setAttribute('aria-disabled', 'true');
        }
    }
    const uploadArea = document.getElementById('testResultsUploadArea');
    if (uploadArea && !resolved.canUploadResults) {
        uploadArea.style.display = 'none';
    }

    const addBugTicketBtn = document.getElementById('addBugTicketBtn');
    if (addBugTicketBtn) {
        if (resolved.canManageBugTickets) {
            addBugTicketBtn.style.display = '';
            addBugTicketBtn.disabled = false;
            addBugTicketBtn.classList.remove('disabled');
        } else {
            addBugTicketBtn.style.display = 'none';
            addBugTicketBtn.disabled = true;
            addBugTicketBtn.classList.add('disabled');
        }
    }
    const confirmAddBugTicketBtn = document.getElementById('confirmAddBugTicket');
    if (confirmAddBugTicketBtn) {
        confirmAddBugTicketBtn.disabled = !resolved.canManageBugTickets;
    }
    const confirmDeleteBugTicketBtn = document.getElementById('confirmDeleteBugTicket');
    if (confirmDeleteBugTicketBtn) {
        confirmDeleteBugTicketBtn.disabled = !resolved.canManageBugTickets;
    }
    const bugTicketNumberInput = document.getElementById('bugTicketNumber');
    if (bugTicketNumberInput) {
        if (resolved.canManageBugTickets) {
            bugTicketNumberInput.removeAttribute('disabled');
        } else {
            bugTicketNumberInput.setAttribute('disabled', 'true');
        }
    }

    try {
        updateItemSelectionUI();
    } catch (_) {}

    return resolved;
}
// ===== 排序狀態（TRE） =====
let treSortField = 'number'; // number|title|priority|result|assignee|executed
let treSortOrder = 'asc';

function initializeExecutionFilters() {
    if (executionFilterInitialized) return;

    executionFilterPanelEl = document.getElementById('executionFilterPanel');
    executionFilterToggleBtn = document.getElementById('executionFilterToggle');

    if (!executionFilterPanelEl || !executionFilterToggleBtn) {
        return;
    }

    executionFilterPanelEl.addEventListener('click', (event) => event.stopPropagation());
    executionFilterToggleBtn.addEventListener('click', toggleExecutionFilterPanel);
    executionFilterToggleBtn.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
            event.preventDefault();
            toggleExecutionFilterPanel();
        }
    });
    executionFilterToggleBtn.setAttribute('aria-expanded', 'false');

    const closeBtn = document.getElementById('closeExecutionFiltersBtn');
    if (closeBtn) {
        closeBtn.addEventListener('click', () => closeExecutionFilterPanel());
    }

    executionFilterInitialized = true;
    retranslateExecutionFilterUI();

    if (!executionFilterI18nBound) {
        executionFilterI18nBound = true;
        try {
            document.addEventListener('i18nReady', retranslateExecutionFilterUI);
        } catch (_) {}
        try {
            document.addEventListener('languageChanged', retranslateExecutionFilterUI);
        } catch (_) {}
        if (window.i18n && typeof window.i18n.on === 'function') {
            try { window.i18n.on('languageChanged', retranslateExecutionFilterUI); } catch (_) {}
            try { window.i18n.on('loaded', retranslateExecutionFilterUI); } catch (_) {}
        }
    }

    const statusCheckboxes = document.querySelectorAll('.execution-status-filter');
    statusCheckboxes.forEach(cb => {
        cb.addEventListener('change', handleExecutionStatusChange);
    });
    updateExecutionStatusFiltersFromUI();

    const caseInput = document.getElementById('filterCaseNumberInput');
    if (caseInput) {
        caseInput.addEventListener('input', debounceExecutionFilter(event => {
            const value = (event && event.target && event.target.value) ? event.target.value : '';
            executionFilterState.searchNumber = value.trim().toLowerCase();
            renderTestRunItems();
        }));
    }

    const titleInput = document.getElementById('filterTitleInput');
    if (titleInput) {
        titleInput.addEventListener('input', debounceExecutionFilter(event => {
            const value = (event && event.target && event.target.value) ? event.target.value : '';
            executionFilterState.searchTitle = value.trim().toLowerCase();
            renderTestRunItems();
        }));
    }

    const prioritySelect = document.getElementById('filterPrioritySelect');
    if (prioritySelect) {
        if (!executionFilterOriginalSelectTexts.has(prioritySelect)) {
            const defaultTexts = {};
            Array.from(prioritySelect.options).forEach(option => {
                defaultTexts[option.value || option.textContent] = option.textContent;
            });
            executionFilterOriginalSelectTexts.set(prioritySelect, defaultTexts);
        }
        prioritySelect.addEventListener('change', (event) => {
            executionFilterState.priority = event.target.value || 'ALL';
            renderTestRunItems();
        });
    }

    const resetBtn = document.getElementById('resetExecutionFiltersBtn');
    if (resetBtn) {
        resetBtn.addEventListener('click', resetExecutionFilters);
    }

    const chipsContainer = document.getElementById('filterAssigneeChips');
    if (chipsContainer) {
        chipsContainer.addEventListener('click', (event) => {
            const target = event.target.closest('[data-remove-index]');
            if (!target) return;
            const index = parseInt(target.dataset.removeIndex, 10);
            if (!isNaN(index)) {
                removeExecutionFilterAssignee(index);
            }
        });
    }

    const assigneeInput = document.getElementById('filterAssigneeInput');
    if (assigneeInput && window.AssigneeSelector) {
        if (executionFilterAssigneeSelector) {
            try { executionFilterAssigneeSelector.destroy(); } catch (_) {}
        }
        executionFilterAssigneeSelector = new AssigneeSelector(assigneeInput, {
            teamId: currentTeamId,
            allowCustomValue: false,
            placeholder: (window.i18n && typeof window.i18n.t === 'function')
                ? window.i18n.t('testRun.filterAssigneePlaceholder')
                : '搜尋並選擇執行者',
            searchPlaceholder: (window.i18n && typeof window.i18n.t === 'function')
                ? window.i18n.t('testRun.filterAssigneePlaceholder')
                : '搜尋並選擇執行者',
            onSelect: (contact) => {
                addExecutionFilterAssignee(contact);
                try { executionFilterAssigneeSelector.setValue(''); } catch (_) {}
                executionFilterAssigneeSelector.selectedContact = null;
                executionFilterAssigneeSelector.originalValue = '';
            }
        });
        executionFilterAssigneeSelector.setValue('');
        executionFilterAssigneeSelector.selectedContact = null;
        executionFilterAssigneeSelector.originalValue = '';
    }

    renderExecutionFilterAssigneeChips();
    updateExecutionFilterSummary(testRunItems.length, testRunItems.length);
    applyExecutionFilterTranslations();
}

function toggleExecutionFilterPanel() {
    if (executionFilterIsOpen) {
        closeExecutionFilterPanel();
    } else {
        openExecutionFilterPanel();
    }
}

function positionExecutionFilterPanel() {
    if (!executionFilterPanelEl || !executionFilterToggleBtn) return;

    const wrapper = executionFilterPanelEl.closest('.execution-stats-wrapper') || executionFilterPanelEl.parentElement;
    const wrapperRect = wrapper ? wrapper.getBoundingClientRect() : null;
    const toggleRect = executionFilterToggleBtn.getBoundingClientRect();
    const viewportWidth = document.documentElement.clientWidth || window.innerWidth;

    const availableWidth = wrapperRect ? wrapperRect.width : viewportWidth;
    const maxPanelWidth = 680;
    const baseWidth = Math.min(maxPanelWidth, availableWidth);
    const minWidth = Math.min(360, availableWidth);
    const targetWidth = Math.max(minWidth, baseWidth);
    const panelWidth = Math.min(viewportWidth, targetWidth);
    executionFilterPanelEl.style.width = `${panelWidth}px`;
    executionFilterPanelEl.style.right = '';

    const referenceLeft = wrapperRect ? wrapperRect.left : 0;
    const desiredLeft = (toggleRect.right - referenceLeft) + 12; // 與卡片保持一些間距
    const maxLeft = Math.max(0, (wrapperRect ? wrapperRect.width : viewportWidth) - panelWidth);
    const clampedLeft = Math.max(0, Math.min(desiredLeft, maxLeft));
    executionFilterPanelEl.style.left = `${clampedLeft}px`;

    const topOffset = wrapperRect ? toggleRect.top - wrapperRect.top : 0;
    executionFilterPanelEl.style.top = `${topOffset}px`;
}

function openExecutionFilterPanel() {
    if (!executionFilterPanelEl || executionFilterIsOpen) return;
    retranslateExecutionFilterUI();
    executionFilterPanelEl.classList.add('show');
    positionExecutionFilterPanel();
    executionFilterIsOpen = true;
    if (executionFilterToggleBtn) {
        executionFilterToggleBtn.classList.add('active');
        executionFilterToggleBtn.setAttribute('aria-expanded', 'true');
    }
    document.addEventListener('click', handleExecutionFilterOutsideClick);
    document.addEventListener('keydown', handleExecutionFilterKeydown);
    executionFilterResizeHandler = () => positionExecutionFilterPanel();
    window.addEventListener('resize', executionFilterResizeHandler, { passive: true });
    setTimeout(() => {
        try {
            const firstInput = executionFilterPanelEl.querySelector('input, select, button');
            if (firstInput) firstInput.focus({ preventScroll: true });
        } catch (_) {}
    }, 20);
}

function retranslateExecutionFilterUI() {
    if (!window.i18n || typeof window.i18n.retranslate !== 'function') return;
    try {
        if (executionFilterPanelEl) {
            window.i18n.retranslate(executionFilterPanelEl);
        }
    } catch (_) {}
    try {
        if (executionFilterToggleBtn) {
            window.i18n.retranslate(executionFilterToggleBtn);
        }
    } catch (_) {}
    applyExecutionFilterTranslations();
}

function applyExecutionFilterTranslations() {
    const prioritySelect = document.getElementById('filterPrioritySelect');
    if (!prioritySelect) return;

    const originalTexts = executionFilterOriginalSelectTexts.get(prioritySelect) || {};
    Array.from(prioritySelect.options).forEach(option => {
        const key = option.getAttribute('data-i18n');
        if (!key) return;
        const translated = (window.i18n && typeof window.i18n.t === 'function')
            ? window.i18n.t(key)
            : null;
        const isTranslated = translated && translated !== key;
        const fallback = originalTexts[option.value || option.textContent] || option.textContent;
        option.textContent = isTranslated ? translated : fallback;
    });
}

function closeExecutionFilterPanel() {
    if (!executionFilterPanelEl || !executionFilterIsOpen) return;
    executionFilterPanelEl.classList.remove('show');
    executionFilterIsOpen = false;
    if (executionFilterToggleBtn) {
        executionFilterToggleBtn.classList.remove('active');
        executionFilterToggleBtn.setAttribute('aria-expanded', 'false');
    }
    document.removeEventListener('click', handleExecutionFilterOutsideClick);
    document.removeEventListener('keydown', handleExecutionFilterKeydown);
    if (executionFilterResizeHandler) {
        window.removeEventListener('resize', executionFilterResizeHandler);
        executionFilterResizeHandler = null;
    }
}

function handleExecutionFilterOutsideClick(event) {
    if (!executionFilterPanelEl || !executionFilterIsOpen) return;
    const target = event.target;
    if (executionFilterPanelEl.contains(target)) return;
    if (executionFilterToggleBtn && executionFilterToggleBtn.contains(target)) return;
    closeExecutionFilterPanel();
}

function handleExecutionFilterKeydown(event) {
    if (event.key === 'Escape') {
        closeExecutionFilterPanel();
    }
}

function handleExecutionStatusChange(event) {
    const value = event.target.value;
    if (value === 'ALL') {
        const shouldSelectAll = event.target.checked;
        document.querySelectorAll('.execution-status-filter').forEach(cb => {
            if (cb.value !== 'ALL') cb.checked = shouldSelectAll;
        });
    } else if (!event.target.checked) {
        const allCheckbox = document.querySelector('.execution-status-filter[value="ALL"]');
        if (allCheckbox) allCheckbox.checked = false;
    }
    updateExecutionStatusFiltersFromUI();
    renderTestRunItems();
}

function updateExecutionStatusFiltersFromUI() {
    const checkboxes = Array.from(document.querySelectorAll('.execution-status-filter'));
    if (!checkboxes.length) return;
    const allCheckbox = checkboxes.find(cb => cb.value === 'ALL');
    const specificCheckboxes = checkboxes.filter(cb => cb.value !== 'ALL');
    const selectedSpecific = specificCheckboxes.filter(cb => cb.checked).map(cb => cb.value);

    if (!selectedSpecific.length) {
        specificCheckboxes.forEach(cb => { cb.checked = true; });
        if (allCheckbox) allCheckbox.checked = true;
        executionFilterState.statuses = new Set(['ALL']);
        return;
    }

    if (selectedSpecific.length === specificCheckboxes.length) {
        if (allCheckbox) allCheckbox.checked = true;
        executionFilterState.statuses = new Set(['ALL']);
    } else {
        if (allCheckbox) allCheckbox.checked = false;
        executionFilterState.statuses = new Set(selectedSpecific);
    }
}

function addExecutionFilterAssignee(contact) {
    if (!contact) return;
    const displayName = (contact.display_name || contact.name || '').trim();
    if (!displayName) return;
    const identifier = contact.id || displayName;
    const normalized = displayName.toLowerCase();

    const exists = executionFilterState.assignees.some(a => a.id === identifier || a.lowercase === normalized);
    if (exists) return;

    executionFilterState.assignees.push({
        id: identifier,
        name: displayName,
        lowercase: normalized
    });

    renderExecutionFilterAssigneeChips();
    renderTestRunItems();
}

function removeExecutionFilterAssignee(index) {
    if (index < 0 || index >= executionFilterState.assignees.length) return;
    executionFilterState.assignees.splice(index, 1);
    renderExecutionFilterAssigneeChips();
    renderTestRunItems();
}

function renderExecutionFilterAssigneeChips() {
    const container = document.getElementById('filterAssigneeChips');
    if (!container) return;

    if (!executionFilterState.assignees.length) {
        container.innerHTML = '';
        if (executionFilterAssigneeSelector) {
            executionFilterAssigneeSelector.setValue('');
            executionFilterAssigneeSelector.selectedContact = null;
            executionFilterAssigneeSelector.originalValue = '';
        }
        return;
    }

    const chipsHtml = executionFilterState.assignees
        .map((assignee, index) => `
            <span class="filter-chip" data-chip-index="${index}">
                <span>${escapeHtml(assignee.name)}</span>
                <button type="button" class="filter-chip-remove" data-remove-index="${index}" aria-label="Remove">
                    <i class="fas fa-times"></i>
                </button>
            </span>
        `)
        .join('');
    container.innerHTML = chipsHtml;
}

function resetExecutionFilters() {
    const statusCheckboxes = document.querySelectorAll('.execution-status-filter');
    statusCheckboxes.forEach(cb => { cb.checked = true; });
    const allCheckbox = document.querySelector('.execution-status-filter[value="ALL"]');
    if (allCheckbox) allCheckbox.checked = true;
    updateExecutionStatusFiltersFromUI();
    executionFilterState.statuses = new Set(['ALL']);

    executionFilterState.searchNumber = '';
    executionFilterState.searchTitle = '';
    executionFilterState.priority = 'ALL';
    executionFilterState.assignees = [];

    const caseInput = document.getElementById('filterCaseNumberInput');
    if (caseInput) caseInput.value = '';
    const titleInput = document.getElementById('filterTitleInput');
    if (titleInput) titleInput.value = '';
    const prioritySelect = document.getElementById('filterPrioritySelect');
    if (prioritySelect) prioritySelect.value = 'ALL';
    if (executionFilterAssigneeSelector) {
        executionFilterAssigneeSelector.setValue('');
        executionFilterAssigneeSelector.selectedContact = null;
        executionFilterAssigneeSelector.originalValue = '';
    }

    renderExecutionFilterAssigneeChips();
    renderTestRunItems();
}

function updateExecutionFilterSummary(matched, total) {
    const matchedEl = document.getElementById('executionFilterMatched');
    if (matchedEl) {
        matchedEl.textContent = String(matched);
    }

    const tooltipText = (window.i18n && typeof window.i18n.t === 'function')
        ? window.i18n.t('testRun.filterMatchCount', { matched, total })
        : `${matched} / ${total}`;

    if (executionFilterToggleBtn) {
        executionFilterToggleBtn.setAttribute('title', tooltipText);
        executionFilterToggleBtn.setAttribute('aria-label', tooltipText);
    }
}

function getExecutionItemStatus(item) {
    const result = (item && item.test_result) ? String(item.test_result).trim() : '';
    return result ? result : 'Not Executed';
}

function getItemSectionId(item) {
    if (!item) return null;
    if (item.__exec_section_key) {
        return item.__exec_section_key === 'unassigned' ? null : item.__exec_section_key;
    }
    const sec = item.test_case_section || item.section || {};
    const explicit =
        item.__exec_section_id ||
        item.test_case_section_id ||
        sec.id || sec.section_id || sec.record_id || sec.parent_id ||
        item.section_id || item.section_record_id ||
        item.test_case_section_record_id;
    if (explicit) {
        item.__exec_section_id = item.__exec_section_id || explicit;
        item.test_case_section_id = item.test_case_section_id || explicit;
        item.__exec_section_key = String(explicit);
        return explicit;
    }
    // fallback：若只有名稱仍建立分組鍵，避免全部落到 Unassigned
    const nameKey = item.__exec_section_name || sec.name;
    if (nameKey) {
        item.__exec_section_key = `name:${nameKey}`;
        return item.__exec_section_key;
    }
    item.__exec_section_key = 'unassigned';
    return null;
}

function hasSectionInfo(item) {
    if (!item) return false;
    const sec = item.test_case_section || {};
    return !!(
        item.__exec_section_id ||
        item.test_case_section_id ||
        sec.id || sec.section_id || sec.record_id
    );
}

function normalizeRunItemSectionInfo(items) {
    (items || []).forEach(it => {
        if (!it) return;
        const sec = it.test_case_section || {};
        const sid = it.__exec_section_id || it.test_case_section_id || sec.id || sec.section_id || sec.record_id || null;
        if (sid) {
            it.__exec_section_id = it.__exec_section_id || sid;
            it.test_case_section_id = it.test_case_section_id || sid;
            it.test_case_section = it.test_case_section || {};
            if (!it.test_case_section.id) it.test_case_section.id = sid;
            it.__exec_section_key = String(sid);
        }
        const secName = it.__exec_section_name || sec.name;
        if (secName) {
            it.__exec_section_name = secName;
            it.test_case_section = it.test_case_section || {};
            if (!it.test_case_section.name) it.test_case_section.name = secName;
        }
        if (!it.__exec_section_key) {
            it.__exec_section_key = sid ? String(sid) : 'unassigned';
        }
    });
}

function resetSectionDisplayNameCache() {
    sectionDisplayNameCache = new Map();
}

function getSectionDisplayName(sid, sections) {
    if (sid === 'unassigned') {
        return window.i18n && window.i18n.isReady()
            ? (window.i18n.t('testRun.unassigned.label') || window.i18n.t('testRun.unassigned'))
            : 'Unassigned';
    }

    const key = String(sid);
    if (sectionDisplayNameCache.has(key)) {
        return sectionDisplayNameCache.get(key);
    }

    // 0. 透過索引從 parent chain 還原完整路徑
    if (sectionIndexById && sectionIndexById.size > 0) {
        const path = [];
        let cursor = key;
        let guard = 0;
        while (sectionIndexById.has(cursor) && guard < 50) {
            const entry = sectionIndexById.get(cursor);
            path.unshift(entry.name || `Section ${cursor}`);
            if (!entry.parentId) break;
            cursor = entry.parentId;
            guard += 1;
        }
        if (path.length) {
            const result = path.join(' > ');
            sectionDisplayNameCache.set(key, result);
            return result;
        }
    }

    // 1. Try to find path in treSections (Tree data)
    if (sections && sections.length > 0) {
        const findPath = (nodes, targetId, currentPath) => {
            for (const node of nodes) {
                if (String(node.id) === String(targetId)) {
                    return [...currentPath, node.name];
                }
                if (node.children && node.children.length > 0) {
                    const found = findPath(node.children, targetId, [...currentPath, node.name]);
                    if (found) return found;
                }
            }
            return null;
        };
        const pathArr = findPath(sections, key, []);
        if (pathArr) {
            const result = pathArr.join(' > ');
            sectionDisplayNameCache.set(key, result);
            return result;
        }
    }

    // 2. Fallback: Use item info (limited to immediate parent based on current API)
    const itemWithSec = (testRunItems || []).find(it => String(getItemSectionId(it)) === key);
    if (itemWithSec && itemWithSec.test_case_section) {
        const s = itemWithSec.test_case_section;
        if (s.parent) {
            const result = `${s.parent.name} > ${s.name}`;
            sectionDisplayNameCache.set(key, result);
            return result;
        }
        if (s.name) {
            const result = s.name;
            sectionDisplayNameCache.set(key, result);
            return result;
        }
    }

    const fallback = `Section ${key}`;
    sectionDisplayNameCache.set(key, fallback);
    return fallback;
}

function getFilteredTestRunItems() {
    const numberKeyword = executionFilterState.searchNumber;
    const titleKeyword = executionFilterState.searchTitle;
    const priorityFilter = executionFilterState.priority;
    const assigneeFilters = executionFilterState.assignees.map(a => a.lowercase);
    const matchAllStatuses = executionFilterState.statuses.has('ALL');
    const hasSectionSelections = treSectionFilterIds && treSectionFilterIds.size > 0;

    return (testRunItems || []).filter(item => {
        const itemStatus = getExecutionItemStatus(item);
        if (!matchAllStatuses && !executionFilterState.statuses.has(itemStatus)) {
            return false;
        }

        if (hasSectionSelections) {
            const sid = getItemSectionId(item);
            const key = sid === null || typeof sid === 'undefined' ? 'unassigned' : String(sid);
            if (!treSectionFilterIds.has(key)) return false;
        }

        if (numberKeyword) {
            const numberValue = (item.test_case_number || '').toLowerCase();
            if (!numberValue.includes(numberKeyword)) return false;
        }

        if (titleKeyword) {
            const titleValue = (item.title || '').toLowerCase();
            if (!titleValue.includes(titleKeyword)) return false;
        }

        if (priorityFilter !== 'ALL') {
            if ((item.priority || '') !== priorityFilter) return false;
        }

        if (assigneeFilters.length) {
            const assigneeName = (item.assignee_name || (item.assignee && item.assignee.name) || '').toLowerCase();
            if (!assigneeName) return false;
            if (!assigneeFilters.some(name => assigneeName === name)) return false;
        }

        return true;
    });
}

function setTreSort(field) {
    if (treSortField === field) {
        treSortOrder = (treSortOrder === 'asc') ? 'desc' : 'asc';
    } else {
        treSortField = field;
        treSortOrder = 'asc';
    }
    renderTestRunItems();
}

function updateTreSortIndicators() {
    try {
        const map = {
            number: document.querySelector('#th-tre-number .sort-indicator'),
            title: document.querySelector('#th-tre-title .sort-indicator'),
            priority: document.querySelector('#th-tre-priority .sort-indicator'),
            result: document.querySelector('#th-tre-result .sort-indicator'),
            assignee: document.querySelector('#th-tre-assignee .sort-indicator'),
            executed: document.querySelector('#th-tre-executed .sort-indicator')
        };
        Object.values(map).forEach(el => { if (el) el.textContent = ''; });
        const target = map[treSortField];
        if (target) target.textContent = (treSortOrder === 'asc') ? '▲' : '▼';
    } catch (_) {}
}

function sortTestRunItems() {
    const priRank = v => ({ High: 3, Medium: 2, Low: 1 }[v] || 0);
    const resRank = v => ({ Passed: 6, Failed: 5, Retest: 4, 'Not Available': 3, 'Not Required': 2, Skip: 2, Pending: 1 }[v] || 0);
    const assigneeOf = it => (it.assignee_name || (it.assignee && it.assignee.name) || '').toLowerCase();
    const parseNumberSegments = str => {
        try {
            if (!str) return [];
            const ms = String(str).match(/\d+/g);
            return ms ? ms.map(s => parseInt(s, 10)) : [];
        } catch (_) { return []; }
    };
    const compareByNumericParts = (aStr, bStr) => {
        const aSeg = parseNumberSegments(aStr);
        const bSeg = parseNumberSegments(bStr);
        const len = Math.min(aSeg.length, bSeg.length);
        for (let i = 0; i < len; i++) {
            if (aSeg[i] !== bSeg[i]) return aSeg[i] - bSeg[i];
        }
        return aSeg.length - bSeg.length;
    };
    const cmp = (a, b) => {
        switch (treSortField) {
            case 'number':
                return compareByNumericParts(a.test_case_number || '', b.test_case_number || '');
            case 'title':
                return (a.title || '').toLowerCase().localeCompare((b.title || '').toLowerCase());
            case 'priority':
                return priRank(a.priority) - priRank(b.priority);
            case 'result':
                return resRank(a.test_result) - resRank(b.test_result);
            case 'assignee':
                return assigneeOf(a).localeCompare(assigneeOf(b));
            case 'executed':
                return new Date(a.executed_at || 0) - new Date(b.executed_at || 0);
            default:
                return 0;
        }
    };
    try {
        testRunItems.sort((a, b) => {
            const r = cmp(a, b);
            return treSortOrder === 'asc' ? r : -r;
        });
    } catch (_) {}
}
let itemDetailModal = null;
let confirmModal = null;
let restartModal = null;
let batchModifyModal = null;
let selectedItems = new Set(); // 追踪選中的測試執行項目
// Shift 連續多選的錨點索引
let lastItemCheckboxIndex = null;
// Test Case 詳細快取（localStorage），以測試案例編號為 key
const TEST_CASE_CACHE_PREFIX = 'tr_exec_tc_cache_v1';
const TEST_CASE_CACHE_TTL_MS = 60 * 60 * 1000; // 1 小時
const TEST_CASE_UPDATE_EVENT_KEY = 'testCaseUpdatedEvent';

window.addEventListener('storage', (event) => {
    if (event.key !== TEST_CASE_UPDATE_EVENT_KEY || !event.newValue) return;
    try {
        const data = JSON.parse(event.newValue);
        applyExternalTestCaseUpdate(data);
    } catch (err) {
        console.debug('忽略無法解析的 test case 更新事件:', err);
    }
});

// 頁面初始化
document.addEventListener('DOMContentLoaded', async function() {
    await applyTestRunExecutionPermissions();
    if (window.AuthClient && typeof window.AuthClient.on === 'function') {
        try {
            window.AuthClient.on('authReady', async () => {
                await applyTestRunExecutionPermissions();
                if (testRunConfig) {
                    updateControlButtons(testRunConfig.status);
                    renderTestRunItems();
                }
            });
        } catch (_) {}
    }
    // 從 URL 參數取得必要參數
    const urlParams = new URLSearchParams(window.location.search);
    currentConfigId = parseInt(urlParams.get('config_id'));
    const teamParam = urlParams.get('team_id') || urlParams.get('teamId') || urlParams.get('team');
    window.__PENDING_TC_FROM_URL__ = urlParams.get('tc') || urlParams.get('test_case_number') || null;

    if (!currentConfigId) {
        AppUtils.showError('{{ i18n.t("testRun.missingConfigId") if i18n else "缺少測試執行配置 ID" }}');
        window.location.href = '/test-run-management';
        return;
    }

    // 若 URL 有 team_id 且目前尚未設定 current team，先寫入
    try {
        const cur = AppUtils.getCurrentTeam && AppUtils.getCurrentTeam();
        if (teamParam && (!cur || !cur.id) && AppUtils.setCurrentTeam) {
            const parsedTeam = parseInt(teamParam);
            if (!isNaN(parsedTeam)) AppUtils.setCurrentTeam({ id: parsedTeam });
        }
    } catch (_) {}

    initializePage();
    bindEventListeners();
    bindBugTicketEvents();
    setupQuickSearch_TR();
    // 在加載配置後初始化跳至菜單
    setTimeout(() => {
        if (testRunConfig && testRunConfig.set_id) {
            initJumpToTestRunMenu();
        }
    }, 500);

    // 確保 i18n 系統準備好後立即套用翻譯
    setTimeout(() => {
        if (typeof applyExecutionFilterTranslations === 'function') {
            applyExecutionFilterTranslations();
        }
    }, 100);
    // 左下角熱鍵提示
    if (!document.getElementById('quickSearchHint')) {
        const hint = document.createElement('div');
        hint.id = 'quickSearchHint';
        hint.className = 'position-fixed';
        hint.style.cssText = 'left:12px; bottom:12px; z-index:1040; opacity:0.85; pointer-events:none;';
        const label = window.i18n && window.i18n.isReady() ? (window.i18n.t('hotkeys.quickSearch') || 'Press / for quick search') : 'Press / for quick search';
        hint.innerHTML = `<span class="badge bg-secondary-subtle text-secondary border" style="--bs-bg-opacity:.65;">${label}</span>`;
        document.body.appendChild(hint);
        // i18n 準備完成時同步更新
        document.addEventListener('i18nReady', () => {
            const text = window.i18n ? (window.i18n.t('hotkeys.quickSearch') || 'Press / for quick search') : 'Press / for quick search';
            const badge = document.querySelector('#quickSearchHint .badge');
            if (badge) badge.textContent = text;
            // 同時更新執行過濾器的翻譯
            if (typeof applyExecutionFilterTranslations === 'function') {
                applyExecutionFilterTranslations();
            }
        });
        document.addEventListener('languageChanged', () => {
            const text = window.i18n ? (window.i18n.t('hotkeys.quickSearch') || 'Press / for quick search') : 'Press / for quick search';
            const badge = document.querySelector('#quickSearchHint .badge');
            if (badge) badge.textContent = text;
            // 同時更新執行過濾器的翻譯
            if (typeof applyExecutionFilterTranslations === 'function') {
                applyExecutionFilterTranslations();
            }
        });
    }
});

function initializePage() {
    // 監聽全域 team 變更事件，隨時更新 URL 的 team_id
    try {
        window.addEventListener('teamChanged', function(e) {
            const newTeam = e && e.detail && e.detail.team;
            if (newTeam && newTeam.id) {
                // 更新目前使用中的 teamId，確保後續快取用正確的 key 寫入
                currentTeamId = newTeam.id;
                ensureTeamIdInUrl_TRE(newTeam.id);
                if (executionFilterAssigneeSelector) {
                    executionFilterAssigneeSelector.options.teamId = currentTeamId;
                    try { executionFilterAssigneeSelector.refresh(); } catch (_) {}
                }
            }
        });
    } catch (_) {}
    // 取得目前團隊 ID（與管理頁一致），無則暫用 1
    currentTeamId = AppUtils.getCurrentTeam()?.id;
    if (!currentTeamId) {
        currentTeamId = 1;
    }
    // 確保網址列包含 team_id（不重新載入頁面）
    try { ensureTeamIdInUrl_TRE(currentTeamId); } catch (_) {}

    initializeExecutionFilters();

    itemDetailModal = new bootstrap.Modal(document.getElementById('itemDetailModal'));
    confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
    restartModal = new bootstrap.Modal(document.getElementById('restartModal'));
    batchModifyModal = new bootstrap.Modal(document.getElementById('batchModifyModal'));
    
    // 綁定重新執行確認按鈕事件
    document.getElementById('confirmRestartBtn').addEventListener('click', handleRestartConfirm);
    
    // 綁定批次修改相關事件
    document.getElementById('confirmBatchModifyBtn').addEventListener('click', handleBatchModifyConfirm);
    document.getElementById('batchModifyAssignee').addEventListener('change', toggleBatchAssigneeInput);
    document.getElementById('batchModifyResult').addEventListener('change', toggleBatchResultSelect);
    document.getElementById('batchModifyComment').addEventListener('change', toggleBatchCommentInput);
    
    // 初始化 AssigneeSelector 元件（批次修改模態框中的）
    if (window.AssigneeSelector && currentTeamId) {
        // 為批次修改的 input 初始化 AssigneeSelector
        const batchInput = document.getElementById('batchAssigneeInput');
        if (batchInput && batchInput.dataset.assigneeSelector !== undefined) {
            const options = {
                teamId: currentTeamId,
                allowCustomValue: true,  // 批次修改允許自定義值
                onSelect: () => {}
            };
            
            if (batchInput._assigneeSelector) {
                batchInput._assigneeSelector.destroy();
            }
            batchInput._assigneeSelector = new AssigneeSelector(batchInput, options);
        }
    }
    
    loadTestRunConfig();
}


function bindEventListeners() {
    const permissions = getTrePermissions();

    const refreshBtnEl = document.getElementById('refreshBtn');
    if (refreshBtnEl) {
        refreshBtnEl.addEventListener('click', async () => {
            const refreshBtn = document.getElementById('refreshBtn');
            const originalHTML = refreshBtn.innerHTML;

            refreshBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status"></span>${window.i18n ? window.i18n.t('common.refresh') : '重新整理'}`;
            refreshBtn.disabled = true;

            try {
                try {
                    const TEST_CASES_CACHE_KEY = 'test_cases_list_cache_v1';
                    const keys = Object.keys(localStorage);
                    keys.forEach(key => {
                        if (key.startsWith(TEST_CASES_CACHE_KEY)) {
                            localStorage.removeItem(key);
                        }
                    });
                } catch (e) {
                    console.debug('清除 Test Case Management 快取失敗:', e);
                }

                try {
                    const keys = Object.keys(localStorage);
                    keys.forEach(key => {
                        if (key.startsWith('tr_exec_tc_cache_v1')) {
                            localStorage.removeItem(key);
                        }
                    });
                } catch (e) {
                    console.debug('清除個別快取失敗:', e);
                }

                await loadTestRunItemsWithoutLoading();
                await updateStatistics();
                try {
                    await refreshBugTicketsStatus();
                } catch (e) {
                    console.debug('更新 Bug Tickets 狀態失敗:', e);
                }
                try {
                    const modalEl = document.getElementById('testCaseDetailModal');
                    const isShown = modalEl && modalEl.classList.contains('show');
                    if (isShown && currentDetailTestCase && currentDetailTestCase.test_case_number) {
                        renderResultHistoryTimeline({ test_case_number: currentDetailTestCase.test_case_number });
                    }
                } catch (_) {}
                try {
                    const bugModalEl = document.getElementById('bugTicketsSummaryModal');
                    const isBugModalShown = bugModalEl && bugModalEl.classList.contains('show');
                    if (isBugModalShown) {
                        await loadBugTicketsSummary();
                    }
                } catch (_) {}

                AppUtils.showSuccess(window.i18n ? window.i18n.t('messages.dataReloaded') : '資料已重新載入');

            } finally {
                refreshBtn.innerHTML = originalHTML;
                refreshBtn.disabled = false;
            }
        });
    }

    const startBtn = document.getElementById('startBtn');
    if (startBtn) {
        startBtn.addEventListener('click', () => {
            if (!getTrePermissions().canStart) {
                showExecutionPermissionDenied();
                return;
            }
            confirmStatusChange('active', '{{ i18n.t("testRun.startExecutionConfirm") if i18n else "開始執行此 Test Run？" }}');
        });
    }

    const completeBtn = document.getElementById('completeBtn');
    if (completeBtn) {
        completeBtn.addEventListener('click', () => {
            if (!getTrePermissions().canComplete) {
                showExecutionPermissionDenied();
                return;
            }
            confirmStatusChange('completed', '{{ i18n.t("testRun.completeExecutionConfirm") if i18n else "結束此 Test Run？結束後將無法再修改測試結果。" }}');
        });
    }

    const restartBtn = document.getElementById('restartBtn');
    if (restartBtn) {
        restartBtn.addEventListener('click', () => {
            if (!getTrePermissions().canRestart) {
                showExecutionPermissionDenied();
                return;
            }
            showRestartModal();
        });
    }

    const selectAllCheckbox = document.getElementById('selectAllItemsCheckbox');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', toggleSelectAllItems);
    }

    const batchModifyBtn = document.getElementById('batchModifyBtn');
    if (batchModifyBtn) {
        batchModifyBtn.addEventListener('click', () => {
            if (!getTrePermissions().canBatchModify) {
                showExecutionPermissionDenied();
                return;
            }
            showBatchModifyModal();
        });
    }

    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    if (batchDeleteBtn) {
        batchDeleteBtn.addEventListener('click', () => {
            if (!getTrePermissions().canBatchDelete) {
                showExecutionPermissionDenied();
                return;
            }
            showBatchDeleteConfirm();
        });
    }

    const clearSelectionExecBtn = document.getElementById('clearSelectionExecBtn');
    if (clearSelectionExecBtn) {
        clearSelectionExecBtn.addEventListener('click', clearSelectedItems);
    }

    document.addEventListener('change', function(e) {
        if (e.target && e.target.classList && e.target.classList.contains('test-run-item-checkbox')) {
            if (!(getTrePermissions().canBatchModify || getTrePermissions().canBatchDelete)) {
                e.target.checked = false;
                showExecutionPermissionDenied();
                updateItemSelectionUI();
                return;
            }
            const itemId = parseInt(e.target.value);
            if (e.target.checked) {
                selectedItems.add(itemId);
            } else {
                selectedItems.delete(itemId);
            }
            updateItemSelectionUI();
        }
    });

    document.addEventListener('click', function(e) {
        const cb = e.target;
        if (!cb.classList || !cb.classList.contains('test-run-item-checkbox')) return;
        if (!(getTrePermissions().canBatchModify || getTrePermissions().canBatchDelete)) {
            cb.checked = false;
            showExecutionPermissionDenied();
            updateItemSelectionUI();
            return;
        }

        const checkboxes = Array.from(document.querySelectorAll('.test-run-item-checkbox'));
        const currentIndex = checkboxes.indexOf(cb);
        if (currentIndex === -1) return;

        if (e.shiftKey && lastItemCheckboxIndex !== null && lastItemCheckboxIndex !== -1) {
            const start = Math.min(lastItemCheckboxIndex, currentIndex);
            const end = Math.max(lastItemCheckboxIndex, currentIndex);
            const shouldCheck = cb.checked;

            for (let i = start; i <= end; i++) {
                const c = checkboxes[i];
                if (c.checked !== shouldCheck) {
                    c.checked = shouldCheck;
                }
                const id = parseInt(c.value);
                if (shouldCheck) {
                    selectedItems.add(id);
                } else {
                    selectedItems.delete(id);
                }
            }
            updateItemSelectionUI();
        }

        lastItemCheckboxIndex = currentIndex;
    });
}

async function loadTestRunConfig() {
    try {
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        testRunConfig = await response.json();
        updateHeader();
        await loadTreSections();
        await loadTestRunItems();
        await updateStatistics();
        
    } catch (error) {
        console.error('Failed to load Test Run config:', error);
        AppUtils.showError('{{ i18n.t("testRun.loadFailed") if i18n else "載入失敗" }}' + ': ' + error.message);
    } finally {
        hideItemsLoading();
    }
}

async function loadTestRunItems() {
    try {
        showItemsLoading();
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/?limit=10000`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        testRunItems = await response.json();
        // 預設按 Test Case Number 升冪排序（與 Test Case Management 一致）
        try {
            testRunItems.sort((a, b) => {
                const aNumber = a && a.test_case_number ? a.test_case_number : '';
                const bNumber = b && b.test_case_number ? b.test_case_number : '';
                return aNumber.localeCompare(bNumber);
            });
        } catch (_) { /* 忽略排序中的非致命錯誤 */ }
        // 先用現有資料渲染，避免因預抓而阻塞頁面
        normalizeRunItemSectionInfo(testRunItems);
        rebuildSectionIndexFromItems(testRunItems);
        renderTestRunItems();
        renderTreSectionTree();
        hideItemsLoading();
        scheduleSectionHydration(testRunItems);
        
    } catch (error) {
        console.error('Failed to load test items:', error);
        AppUtils.showError('{{ i18n.t("testRun.loadItemsFailed") if i18n else "載入測試項目失敗" }}' + ': ' + error.message);
        hideItemsLoading();
    }
}

// 不顯示載入動畫的版本（用於 Refresh）
async function loadTestRunItemsWithoutLoading() {
    try {
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/?limit=10000`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        testRunItems = await response.json();
        // 預設按 Test Case Number 升冪排序（與 Test Case Management 一致）
        try {
            testRunItems.sort((a, b) => {
                const aNumber = a && a.test_case_number ? a.test_case_number : '';
                const bNumber = b && b.test_case_number ? b.test_case_number : '';
                return aNumber.localeCompare(bNumber);
            });
        } catch (_) { /* 忽略排序中的非致命錯誤 */ }
        
        normalizeRunItemSectionInfo(testRunItems);
        rebuildSectionIndexFromItems(testRunItems);
        // 直接渲染，不顯示載入動畫
        renderTestRunItems();
        renderTreSectionTree();
        scheduleSectionHydration(testRunItems);
        
    } catch (error) {
        console.error('Failed to load test items:', error);
        AppUtils.showError('{{ i18n.t("testRun.loadItemsFailed") if i18n else "載入測試項目失敗" }}' + ': ' + error.message);
    }
}

async function loadTreSections() {
    if (!testRunConfig || !testRunConfig.set_id) {
        treSections = [];
        sectionIndexById = new Map();
        renderTreSectionTree();
        return;
    }
    try {
        const resp = await window.AuthClient.fetch(`/api/test-case-sets/${testRunConfig.set_id}/sections`);
        if (resp.ok) {
            treSections = await resp.json();
        } else {
            treSections = [];
        }
    } catch (e) {
        console.warn('loadTreSections failed', e);
        treSections = [];
    }
    // 建立扁平索引，方便還原完整 parent chain
    sectionIndexById = new Map();
    const upsertIndex = (id, name, parentId) => {
        const key = String(id);
        const existing = sectionIndexById.get(key) || {};
        sectionIndexById.set(key, {
            name: name || existing.name || `Section ${key}`,
            parentId: parentId !== undefined ? (parentId !== null ? String(parentId) : null) : (existing.parentId ?? null)
        });
    };
    const indexSections = (nodes, parentId = null) => {
        (nodes || []).forEach(node => {
            const id = node && node.id != null ? String(node.id) : null;
            if (!id) return;
            const pId = node.parent_id ?? (node.parent && node.parent.id != null ? node.parent.id : parentId);
            upsertIndex(id, node.name, pId);
            if (node.children && node.children.length) {
                indexSections(node.children, id);
            }
        });
    };
    indexSections(treSections, null);
    resetSectionDisplayNameCache();
    renderTreSectionTree();
}

function updateHeader() {
    if (!testRunConfig) return;

    // 更新頁面副標題 - 使用 i18n 翻譯
    const subtitleText = window.i18n ?
        window.i18n.t('testRun.currentExecutionWithName', { name: testRunConfig.name }, `現在執行：${testRunConfig.name}`) :
        `現在執行：${testRunConfig.name}`;
    document.getElementById('test-run-subtitle').textContent = subtitleText;
    
    // 顯示對應的控制按鈕
    updateControlButtons(testRunConfig.status);
    
    // 顯示頁面內容
    document.getElementById('test-run-header').style.display = 'block';
    const itemsContainer = document.getElementById('test-run-items-container');
    if (itemsContainer) {
        itemsContainer.style.display = '';
    }
}

function updateControlButtons(status) {
    const permissions = getTrePermissions();
    // 隱藏所有按鈕
    const startBtn = document.getElementById('startBtn');
    const completeBtn = document.getElementById('completeBtn');
    const restartBtn = document.getElementById('restartBtn');

    if (startBtn) startBtn.style.display = 'none';
    if (completeBtn) completeBtn.style.display = 'none';
    if (restartBtn) restartBtn.style.display = 'none';
    
    // 根據狀態顯示對應按鈕
    switch (status) {
        case 'draft':
            if (startBtn && permissions.canStart) {
                startBtn.style.display = 'inline-block';
            }
            break;
        case 'active':
            if (completeBtn && permissions.canComplete) {
                completeBtn.style.display = 'inline-block';
            }
            break;
        case 'completed':
            if (restartBtn && permissions.canRestart) {
                restartBtn.style.display = 'inline-block';
            }
            break;
    }
    
    // 更新批量修改按鈕狀態
    const batchModifyBtn = document.getElementById('batchModifyBtn');
    if (batchModifyBtn) {
        const allowModify = permissions.canBatchModify && status !== 'completed';
        if (!allowModify) {
            batchModifyBtn.disabled = true;
            batchModifyBtn.classList.add('disabled');
            batchModifyBtn.title = window.i18n && window.i18n.isReady() 
                ? window.i18n.t('testRun.cannotEditCompleted')
                : '已完成的 Test Run 不可編輯 Test Case';
        } else {
            batchModifyBtn.disabled = false;
            batchModifyBtn.classList.remove('disabled');
            batchModifyBtn.removeAttribute('title');
        }
    }

    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    if (batchDeleteBtn) {
        const allowDelete = permissions.canBatchDelete && status !== 'completed';
        batchDeleteBtn.disabled = !allowDelete;
        if (!allowDelete) {
            batchDeleteBtn.classList.add('disabled');
        } else {
            batchDeleteBtn.classList.remove('disabled');
        }
    }
}

function renderTestRunItems() {
    const tbody = document.getElementById('items-table-body');
    const permissions = getTrePermissions();
    const canUpdate = permissions.canUpdateResults && testRunConfig && testRunConfig.status === 'active';

    // 更新表格標頭顯示
    updateTableHeader();
    // 依排序設定排序並更新指示
    sortTestRunItems();
    updateTreSortIndicators();

    const filteredItems = getFilteredTestRunItems();
    updateExecutionFilterSummary(filteredItems.length, testRunItems.length);

    const showCheckbox = shouldShowCheckbox(testRunConfig ? testRunConfig.status : 'draft');

    // 依 Section 分組
    const sectionMap = new Map();
    const sectionNameById = new Map();
    const sectionOrder = [];

    filteredItems.forEach(item => {
        const sidRaw = getItemSectionId(item);
        const sid = sidRaw ? String(sidRaw) : 'unassigned';
        if (!sectionMap.has(sid)) sectionMap.set(sid, []);
        sectionMap.get(sid).push(item);
        // Populate sectionNameById from item's section info if available
        if (sid !== 'unassigned' && item.test_case_section && item.test_case_section.name) {
            sectionNameById.set(sid, item.test_case_section.name);
        } else if (sid === 'unassigned') {
            sectionNameById.set('unassigned', window.i18n && window.i18n.isReady() ? (window.i18n.t('testRun.unassigned.label') || window.i18n.t('testRun.unassigned')) : 'Unassigned');
        }
    });

    const finalSectionOrder = [];
    const explicitUnassignedIds = []; // 儲存名稱為 "Unassigned" 的實體 Section ID

    // 1. 從 treSections (已排序的樹狀結構) 收集 Section ID
    function collectOrderedSectionsFromTree(sections) {
        (sections || []).forEach(sec => {
            const sid = String(sec.id);
            const isUnassignedByName = (sec.name || '').trim().toLowerCase() === 'unassigned';
            
            // Populate sectionNameById (important for display)
            sectionNameById.set(sid, sec.name || `Section ${sid}`);

            if (sectionMap.has(sid) && sectionMap.get(sid).length > 0) {
                if (isUnassignedByName) {
                    explicitUnassignedIds.push(sid);
                } else {
                    finalSectionOrder.push(sid);
                }
            }
            
            if (sec.children && sec.children.length) collectOrderedSectionsFromTree(sec.children);
        });
    }
    collectOrderedSectionsFromTree(treSections || []);

    // 2. 找出 sectionMap 中有但 finalSectionOrder + explicitUnassignedIds 中沒有的 section (孤立 Section)
    const knownSections = new Set([...finalSectionOrder, ...explicitUnassignedIds]);
    const orphanSections = [];
    sectionMap.forEach((_, sid) => {
        if (sid !== 'unassigned' && !knownSections.has(sid)) {
            orphanSections.push(sid);
        }
    });
    
    // 對孤立 Section 排序，並檢查名稱是否為 Unassigned
    orphanSections.sort((a, b) => {
        return a.localeCompare(b);
    });
    
    // 將孤立 Section 分流 (一般 vs Unassigned)
    orphanSections.forEach(sid => {
        const name = (sectionNameById.get(sid) || '').toLowerCase();
        if (name === 'unassigned') {
            explicitUnassignedIds.push(sid);
        } else {
            finalSectionOrder.push(sid);
        }
    });

    // 3. 將 "Unassigned" 實體 Section 放到列表後方
    finalSectionOrder.push(...explicitUnassignedIds);

    // 4. 確保 Virtual Unassigned (null ID) 永遠在最後
    if (sectionMap.has('unassigned') && sectionMap.get('unassigned').length > 0) {
        finalSectionOrder.push('unassigned');
    }

    // 將最終排序應用到 sectionOrder
    sectionOrder.push(...finalSectionOrder);

    const rows = [];
    sectionOrder.forEach(sid => {
        const items = sectionMap.get(sid) || [];
        if (!items.length) return;
        
        const displayName = getSectionDisplayName(sid, treSections);
        
        const collapsed = sessionStorage.getItem(`tre-section-${sid}`) === 'collapsed';
        const caret = collapsed ? 'fa-chevron-right' : 'fa-chevron-down';
        const colspan = showCheckbox ? 7 : 6;
        rows.push(`
            <tr class="tre-section-row" data-section-id="${sid}">
                <td colspan="${colspan}">
                    <div class="d-flex align-items-center gap-2">
                        <i class="fas ${caret} section-toggle" data-section-id="${sid}"></i>
                        <span>${escapeHtml(displayName)}</span>
                        <span class="badge bg-light text-muted">${items.length}</span>
                    </div>
                </td>
            </tr>
        `);
        items.forEach((item, idx) => {
            const rowHtml = createItemRow(item, idx + 1, canUpdate);
            const wrapped = collapsed ? rowHtml.replace('<tr ', '<tr style="display:none" ') : rowHtml;
            rows.push(wrapped.replace('<tr ', `<tr data-section-id="${sid}" `));
        });
    });

    if (!rows.length) {
        const colspan = showCheckbox ? 7 : 6;
        tbody.innerHTML = `
            <tr class="no-items">
                <td colspan="${colspan}" class="text-center text-muted py-4" data-i18n="testRun.noItemsAfterFilter">
                    目前沒有符合篩選條件的項目
                </td>
            </tr>
        `;
        if (window.i18n && window.i18n.isReady()) window.i18n.retranslate(tbody);
        updateItemSelectionUI();
        hideItemsLoading();
        return;
    }

    tbody.innerHTML = rows.join('');
    
    // 重新應用翻譯到新生成的內容
    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(tbody);
    }
    
    // 綁定事件處理器
    bindItemEventHandlers(canUpdate);
    // Section 展開/收合事件
    tbody.querySelectorAll('.section-toggle').forEach(icon => {
        icon.addEventListener('click', () => {
            const sid = icon.getAttribute('data-section-id');
            const key = `tre-section-${sid}`;
            const collapsed = sessionStorage.getItem(key) === 'collapsed';
            if (collapsed) sessionStorage.removeItem(key); else sessionStorage.setItem(key, 'collapsed');
            renderTestRunItems();
        });
    });
    updateItemSelectionUI();

    // 嘗試處理從 URL 帶入的 tc（只執行一次）
    tryOpenTcFromUrlOnce();

    // 確保載入動畫關閉，顯示列表
    hideItemsLoading();
}

function buildSectionCounts(items, sections) {
    const keyCounts = new Map();

    (items || []).forEach(item => {
        const sid = getItemSectionId(item);
        const key = (sid === null || typeof sid === 'undefined') ? 'unassigned' : String(sid);
        keyCounts.set(key, (keyCounts.get(key) || 0) + 1);
    });

    const totals = new Map();
    const countNode = (node) => {
        if (!node || node.id == null) return 0;
        const filterKeys = collectSectionFilterKeys(node, new Set());
        let total = 0;
        filterKeys.forEach(key => {
            total += keyCounts.get(key) || 0;
        });
        const sid = String(node.id);
        totals.set(sid, total);
        (node.children || []).forEach(child => countNode(child));
        return total;
    };

    (sections || []).forEach(sec => countNode(sec));

    return {
        sectionIdToCount: totals,
        unassignedCount: keyCounts.get('unassigned') || 0,
    };
}

function collectSectionIds(section, acc = new Set()) {
    if (!section || section.id == null) return acc;
    const sid = String(section.id);
    acc.add(sid);
    (section.children || []).forEach(child => collectSectionIds(child, acc));
    return acc;
}

function collectSectionFilterKeys(section, acc = new Set()) {
    if (!section) return acc;
    if (section.id != null) {
        acc.add(String(section.id));
    }
    if (section.name) {
        acc.add(`name:${section.name}`);
    }
    (section.children || []).forEach(child => collectSectionFilterKeys(child, acc));
    return acc;
}

function getSectionSelectionState(section) {
    if (!treSectionFilterIds || treSectionFilterIds.size === 0) {
        return { checked: false, indeterminate: false };
    }
    const subtreeIds = collectSectionIds(section, new Set());
    let selectedCount = 0;
    subtreeIds.forEach(id => {
        if (treSectionFilterIds.has(id)) selectedCount += 1;
    });
    if (selectedCount === 0) return { checked: false, indeterminate: false };
    if (selectedCount === subtreeIds.size) return { checked: true, indeterminate: false };
    return { checked: false, indeterminate: true };
}

function renderTreSectionTree() {
    const container = document.getElementById('treSectionTree');
    if (!container) return;
    const items = testRunItems || [];
    const { sectionIdToCount, unassignedCount } = buildSectionCounts(items, treSections);

    const renderNodes = (sections, level = 0) => {
        return sections.map(sec => {
            const sid = String(sec.id);
            const count = sectionIdToCount.get(sid) || 0;
            const indent = level * 16;
            const key = `tre-section-${sid}`;
            const collapsed = sessionStorage.getItem(key) === 'collapsed';
            const hasChildren = Array.isArray(sec.children) && sec.children.length > 0;
            const label = getSectionDisplayName(sid, treSections);
            const selectionState = getSectionSelectionState(sec);
            const checkedAttr = selectionState.checked ? 'checked' : '';
            const indeterminateAttr = selectionState.indeterminate ? 'data-indeterminate="true"' : '';
            const isActive = selectionState.checked || selectionState.indeterminate;
            return `
                <div class="tre-section-node ${isActive ? 'active' : ''}" data-section-id="${sid}" style="margin-left:${indent}px;">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center gap-2 flex-grow-1">
                            ${hasChildren ? `
                                <button class="tre-section-toggle" data-toggle-id="${sid}" aria-label="toggle">
                                    <i class="fas fa-chevron-${collapsed ? 'right' : 'down'}"></i>
                                </button>` : `<span style="width:28px;"></span>`}
                            <div class="form-check m-0 d-flex align-items-center gap-2 flex-grow-1">
                                <input class="form-check-input tre-section-check" type="checkbox" id="treSectionCheck-${sid}" data-section-id="${sid}" ${checkedAttr} ${indeterminateAttr}>
                                <label class="form-check-label tre-section-label" for="treSectionCheck-${sid}">
                                    ${escapeHtml(label || sec.name || `Section #${sid}`)}
                                </label>
                            </div>
                        </div>
                        <span class="badge bg-light text-muted tre-section-count">${count}</span>
                    </div>
                    ${hasChildren ? `
                        <div class="${collapsed ? 'd-none' : ''}" data-children-of="${sid}">
                            ${renderNodes(sec.children, level + 1)}
                        </div>` : ''}
                </div>
            `;
        }).join('');
    };

    const isUnassignedActive = treSectionFilterIds && treSectionFilterIds.has('unassigned');
    const unassignedHtml = `
        <div class="tre-section-node ${isUnassignedActive ? 'active' : ''}">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2 flex-grow-1">
                    <span style="width:28px;"></span>
                    <div class="form-check m-0 d-flex align-items-center gap-2 flex-grow-1">
                        <input class="form-check-input tre-section-check" type="checkbox" id="treSectionCheck-unassigned" data-section-id="unassigned" ${isUnassignedActive ? 'checked' : ''}>
                        <label class="form-check-label tre-section-label" for="treSectionCheck-unassigned">
                            ${window.i18n && window.i18n.isReady() ? (window.i18n.t('testRun.unassigned.label') || window.i18n.t('testRun.unassigned')) : 'Unassigned'}
                        </label>
                    </div>
                </div>
                <span class="badge bg-light text-muted tre-section-count">${unassignedCount}</span>
            </div>
        </div>`;

    if (!treSections || treSections.length === 0) {
        container.innerHTML = unassignedHtml;
    } else {
        container.innerHTML = renderNodes(treSections) + unassignedHtml;
    }

    container.querySelectorAll('.tre-section-check').forEach(input => {
        if (input.dataset.indeterminate === 'true') {
            input.indeterminate = true;
        }
        input.addEventListener('change', () => {
            const sid = input.getAttribute('data-section-id');
            if (!treSectionFilterIds) treSectionFilterIds = new Set();
            if (sid === 'unassigned') {
                if (input.checked) {
                    treSectionFilterIds.add('unassigned');
                } else {
                    treSectionFilterIds.delete('unassigned');
                }
            } else {
                const targetSection = findSectionById(sid, treSections);
                const targetKeys = targetSection
                    ? collectSectionFilterKeys(targetSection, new Set())
                    : new Set([String(sid)]);
                targetKeys.forEach(id => {
                    if (input.checked) {
                        treSectionFilterIds.add(String(id));
                    } else {
                        treSectionFilterIds.delete(String(id));
                    }
                });
            }
            if (treSectionFilterIds.size === 0) {
                treSectionFilterIds = null;
            }
            renderTreSectionTree();
            renderTestRunItems();
        });
    });

    container.querySelectorAll('.tre-section-toggle').forEach(btn => {
        btn.addEventListener('click', () => {
            const sid = btn.getAttribute('data-toggle-id');
            const key = `tre-section-${sid}`;
            const collapsed = sessionStorage.getItem(key) === 'collapsed';
            if (collapsed) sessionStorage.removeItem(key); else sessionStorage.setItem(key, 'collapsed');
            renderTreSectionTree();
        });
    });

    const clearBtn = document.getElementById('clearTreSectionFilterBtn');
    if (clearBtn) {
        clearBtn.onclick = () => {
            treSectionFilterIds = null;
            renderTreSectionTree();
            renderTestRunItems();
        };
    }

    if (window.i18n && window.i18n.isReady()) window.i18n.retranslate(container);
}

function findSectionById(id, sections) {
    for (const sec of sections || []) {
        if (String(sec.id) === String(id)) return sec;
        const child = findSectionById(id, sec.children || []);
        if (child) return child;
    }
    return null;
}


// 初始化表頭排序點擊事件（一次性）
(function initTreHeaderSorting(){
  const bind = (id, field) => {
    const el = document.getElementById(id);
    if (el && !el._sortBound) {
      el.addEventListener('click', () => setTreSort(field));
      el._sortBound = true;
    }
  };
  bind('th-tre-number', 'number');
  bind('th-tre-title', 'title');
  bind('th-tre-priority', 'priority');
  bind('th-tre-result', 'result');
  bind('th-tre-assignee', 'assignee');
  bind('th-tre-executed', 'executed');
})();

// 列表區載入動畫控制（顯示空框 + spinner）
function showItemsLoading() {
    try {
        const container = document.getElementById('test-run-items-container');
        const loading = document.getElementById('items-loading');
        const tableWrap = container.querySelector('.test-run-items-table');
        if (container) container.style.display = '';
        if (loading) {
            loading.classList.remove('d-none');
            loading.classList.add('d-flex');
            loading.style.display = '';
        }
        if (tableWrap) tableWrap.style.display = 'none';
        const tbody = document.getElementById('items-table-body');
        if (tbody) tbody.innerHTML = '';
    } catch (_) {}
}

function hideItemsLoading() {
    try {
        const container = document.getElementById('test-run-items-container');
        const loading = document.getElementById('items-loading');
        const tableWrap = container.querySelector('.test-run-items-table');
        if (loading) {
            loading.classList.remove('d-flex');
            loading.classList.add('d-none');
            loading.style.display = '';
        }
        if (tableWrap) tableWrap.style.display = 'block';
    } catch (_) {}
}

function shouldShowCheckbox(status) {
    const permissions = getTrePermissions();
    if (!(permissions.canBatchModify || permissions.canBatchDelete)) {
        return false;
    }
    return status === 'draft' || status === 'active';
}

function updateTableHeader() {
    const table = document.querySelector('.test-run-items-table');
    const checkboxHeader = document.getElementById('checkbox-header');
    const showCheckbox = shouldShowCheckbox(testRunConfig ? testRunConfig.status : 'draft');

    if (showCheckbox) {
        table.classList.remove('hide-checkbox');
        if (checkboxHeader) {
            checkboxHeader.style.display = '';
            checkboxHeader.style.visibility = '';
            checkboxHeader.style.width = '';
            checkboxHeader.style.padding = '';
        }
    } else {
        table.classList.add('hide-checkbox');
        if (checkboxHeader) {
            // Completely hide the column while maintaining table structure
            checkboxHeader.style.width = '0';
            checkboxHeader.style.padding = '0';
            checkboxHeader.style.minWidth = '0';
            checkboxHeader.style.maxWidth = '0';
            checkboxHeader.style.visibility = 'collapse';
        }
        // 清空選擇狀態
        selectedItems.clear();
        updateItemSelectionUI();
    }
}
function createItemRow(item, index, canUpdate) {
    const permissions = getTrePermissions();
    const resultClass = getResultClass(item.test_result);
    const resultText = getResultText(item.test_result);
    const executedAt = item.executed_at ? AppUtils.formatDate(item.executed_at, 'datetime') : '-';
    const assigneeName = (item.assignee_name || (item.assignee && item.assignee.name)) || '-';
    const canEditAssignee = permissions.canAssign && testRunConfig && testRunConfig.status !== 'completed' && testRunConfig.status !== 'archived';
    const showCheckbox = shouldShowCheckbox(testRunConfig ? testRunConfig.status : 'draft');
    const hasExecutionHistory = item.executed_at !== null && item.executed_at !== undefined;
    const isDeleted = !!item.__testCaseDeleted;
    const deletedBadge = `<span class="badge bg-danger-subtle text-danger ms-2">已刪除</span>`;

    const safeTitle = escapeHtml(item.title || '');
    const titleCellContent = isDeleted
        ? `<span class="text-muted" title="${safeTitle || '測試案例已刪除'}">${safeTitle || '測試案例已刪除'}</span>${deletedBadge}`
        : `<a href="#" class="text-decoration-none" onclick="navigateToTestCase('${item.test_case_number}'); return false;">${safeTitle}</a>`;

    const priorityLabel = isDeleted ? '-' : (item.priority || 'Medium');
    const priorityBadgeClass = isDeleted ? 'badge bg-secondary-subtle text-muted priority-badge-lg border border-secondary-subtle' : 'badge bg-secondary priority-badge-lg';

    return `
        <tr data-item-id="${item.id}">
            <td class="checkbox-cell">
                <input type="checkbox" class="form-check-input test-run-item-checkbox" value="${item.id}">
            </td>
            <td><code style="color: rgb(194, 54, 120); font-weight: 500;"><a href="#" class="text-decoration-none" style="color: rgb(194, 54, 120);" onclick="navigateToTestCase('${item.test_case_number}'); return false;">${escapeHtml(item.test_case_number)}</a></code></td>
            <td class="text-truncate" title="${safeTitle || (isDeleted ? '測試案例已刪除' : '')}">${titleCellContent}</td>
            <td><span class="${priorityBadgeClass}">${escapeHtml(priorityLabel)}</span></td>
            <td>
                ${canUpdate ? `
                    <select class="form-select result-selector-lg ${resultClass}"
                            data-item-id="${item.id}" onchange="updateTestResult(${item.id}, this.value)">
                        ${!hasExecutionHistory ? `<option value="">${escapeHtml('{{ i18n.t("testRun.notExecuted") if i18n else "Not Executed" }}')}</option>` : ''}
                        <option value="Passed" ${item.test_result === 'Passed' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.passed") if i18n else "Passed" }}')}</option>
                        <option value="Failed" ${item.test_result === 'Failed' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.failed") if i18n else "Failed" }}')}</option>
                        <option value="Retest" ${item.test_result === 'Retest' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.retest") if i18n else "Retest" }}')}</option>
                        <option value="Not Available" ${item.test_result === 'Not Available' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.notAvailable") if i18n else "Not Available" }}')}</option>
                        <option value="Pending" ${item.test_result === 'Pending' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.pending") if i18n else "Pending" }}')}</option>
                        <option value="Not Required" ${item.test_result === 'Not Required' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.notRequired") if i18n else "Not Required" }}')}</option>
                        <option value="Skip" ${item.test_result === 'Skip' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.skip") if i18n else "Skip" }}')}</option>
                    </select>
                ` : `
                    <span class="badge result-badge-lg ${resultClass}">${resultText}</span>
                `}
            </td>
            <td>
                ${canEditAssignee ? `
                    <input type="text" class="form-control form-control-sm assignee-editor"
                           value="${escapeHtml(assigneeName === '-' ? '' : assigneeName)}"
                           data-item-id="${item.id}"
                           data-assignee-selector
                           data-i18n-placeholder="testRun.enterAssigneeName"
                           placeholder="{{ i18n.t('testRun.enterAssigneeName') if i18n else '輸入執行者姓名' }}"
                           onblur="updateAssignee(${item.id}, this.value)">
                ` : `
                    ${assigneeName}
                `}
            </td>
            <td class="small text-muted">${executedAt}</td>
        </tr>
    `;
}

function bindItemEventHandlers(canUpdate) {
    const permissions = getTrePermissions();

    if (canUpdate && permissions.canUpdateResults) {
        document.querySelectorAll('.result-selector, .result-selector-lg').forEach(select => {
            select.addEventListener('change', function() {
                updateSelectClass(this);
            });
            updateSelectClass(select);
        });
    }

    if (permissions.canAssign && window.initAssigneeSelectors && currentTeamId) {
        document.querySelectorAll('.assignee-editor[data-assignee-selector]').forEach(input => {
            if (input._assigneeSelector) {
                input._assigneeSelector.destroy();
            }
        });

        document.querySelectorAll('.assignee-editor[data-assignee-selector]').forEach(input => {
            const itemId = parseInt(input.dataset.itemId);

            if (input._assigneeSelector) {
                input._assigneeSelector.destroy();
            }

            const options = {
                teamId: currentTeamId,
                allowCustomValue: true,
                onSelect: (contact) => {
                    updateAssignee(itemId, contact.name);
                },
                onClear: () => {
                    updateAssignee(itemId, '');
                }
            };

            input._assigneeSelector = new AssigneeSelector(input, options);
        });
    }
}

function updateSelectClass(select) {
    const value = select.value;
    const hasSm = select.classList.contains('form-select-sm');
    const sizeClass = hasSm ? 'form-select-sm ' : '';
    select.className = `form-select ${sizeClass}result-selector-lg ${getResultClass(value)}`;
}

async function updateTestResult(itemId, result) {
    if (!getTrePermissions().canUpdateResults) {
        showExecutionPermissionDenied();
        return;
    }
    try {
        const executedAt = result ? new Date().toISOString() : null;
        
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/${itemId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                test_result: result || null,
                executed_at: executedAt
            })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        // 更新本地資料
        const itemIndex = testRunItems.findIndex(item => item.id === itemId);
        if (itemIndex !== -1) {
            testRunItems[itemIndex].test_result = result || null;
            testRunItems[itemIndex].executed_at = executedAt;
        }
        
        // 更新統計
        await updateStatistics();

        // 重新渲染列表頁以反映更新
        renderTestRunItems();

        // 若詳情 Modal 開啟中且為同一測試案例，刷新右側 timeline 和標題區域
        try {
            const modalEl = document.getElementById('testCaseDetailModal');
            const isShown = modalEl && modalEl.classList.contains('show');
            const item = testRunItems.find(i => i.id === itemId);
            if (isShown && item && currentDetailTestCase && currentDetailTestCase.test_case_number === item.test_case_number) {
                // 刷新標題區域的 Test Result 顯示
                renderModalHeaderResult(currentDetailTestCase);
                // 刷新右側 timeline
                renderResultHistoryTimeline({ test_case_number: item.test_case_number });
            }
        } catch (_) {}
        
    } catch (error) {
        console.error('Failed to update test result:', error);
        AppUtils.showError('{{ i18n.t("testRun.updateFailed") if i18n else "更新失敗" }}' + ': ' + error.message);
        // 重新載入項目以恢復狀態
        await loadTestRunItems();
    }
}

// 顯示統計載入狀態
function showStatsLoading() {
    const statIds = ['total-count', 'executed-count', 'passed-count', 'failed-count', 'execution-rate', 'pass-rate', 'bug-tickets-count'];
    statIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }
    });
}

// 隱藏統計載入狀態並恢復數字顯示
function hideStatsLoading() {
    const statIds = ['total-count', 'executed-count', 'passed-count', 'failed-count', 'execution-rate', 'pass-rate', 'bug-tickets-count'];
    statIds.forEach(id => {
        const element = document.getElementById(id);
        if (element && element.innerHTML.includes('fa-spinner')) {
            element.textContent = '0';
        }
    });
}

async function updateStatistics() {
    try {
        // 顯示載入動畫
        showStatsLoading();
        
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/statistics`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const stats = await response.json();
        
        document.getElementById('total-count').textContent = stats.total_runs;
        document.getElementById('executed-count').textContent = stats.executed_runs;
        document.getElementById('passed-count').textContent = stats.passed_runs;
        document.getElementById('failed-count').textContent = stats.failed_runs;
        document.getElementById('bug-tickets-count').textContent = stats.unique_bug_tickets_count || 0;
        // 顯示為無條件捨去之整數百分比
        document.getElementById('execution-rate').textContent = Math.floor(stats.execution_rate) + '%';
        // 通過率顯示為無條件捨去之整數百分比
        document.getElementById('pass-rate').textContent = Math.floor(stats.pass_rate) + '%';

        // 添加前端診斷日誌來驗證 API 返回的數據
        console.warn('FRONTEND_PASS_RATE_DEBUG: 接收到的統計數據:', {
            total_runs: stats.total_runs,
            executed_runs: stats.executed_runs,
            passed_runs: stats.passed_runs,
            failed_runs: stats.failed_runs,
            execution_rate: stats.execution_rate,
            pass_rate: stats.pass_rate,
            total_pass_rate: stats.total_pass_rate
        });
        console.warn('FRONTEND_PASS_RATE_DEBUG: 計算驗證:', {
            expected_pass_rate: stats.executed_runs > 0 ? (stats.passed_runs / stats.executed_runs * 100) : 0,
            received_pass_rate: stats.pass_rate,
            is_match: Math.abs((stats.executed_runs > 0 ? (stats.passed_runs / stats.executed_runs * 100) : 0) - stats.pass_rate) < 0.01
        });
        
        // 同步配置統計
        await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/sync`);
        
    } catch (error) {
        console.error('Failed to update statistics:', error);
        // 錯誤時也要隱藏載入動畫
        hideStatsLoading();
    }
}

function showItemDetail(itemId) {
    const item = testRunItems.find(i => i.id === itemId);
    if (!item) return;
    
    const basicInfoLabel = '{{ i18n.t("testRun.basicInfo") if i18n else "基本資訊" }}';
    const executionInfoLabel = '{{ i18n.t("testRun.executionInfo") if i18n else "執行資訊" }}';
    const testCaseNumberLabel = '{{ i18n.t("testRun.testCaseNumber") if i18n else "測試案例編號" }}';
    const titleLabel = '{{ i18n.t("common.title") if i18n else "標題" }}';
    const priorityLabel = '{{ i18n.t("testRun.priority") if i18n else "優先級" }}';
    const testResultLabel = '{{ i18n.t("testRun.testResult") if i18n else "測試結果" }}';
    const executorLabel = '{{ i18n.t("testRun.executor") if i18n else "執行者" }}';
    const executionTimeLabel = '{{ i18n.t("testRun.executionTime") if i18n else "執行時間" }}';
    const executionDurationLabel = '{{ i18n.t("testRun.executionDuration") if i18n else "執行時長" }}';
    const attachmentCountLabel = '{{ i18n.t("testRun.attachmentCount") if i18n else "附件數量" }}';
    const preconditionsLabel = '{{ i18n.t("testRun.preconditions") if i18n else "前置條件" }}';
    const testStepsLabel = '{{ i18n.t("testRun.testSteps") if i18n else "測試步驟" }}';
    const expectedResultsLabel = '{{ i18n.t("testRun.expectedResults") if i18n else "預期結果" }}';
    const minutesLabel = '{{ i18n.t("testRun.minutes") if i18n else "分鐘" }}';
    const isDeleted = !!item.__testCaseDeleted;
    const titleValue = escapeHtml(item.title || (isDeleted ? '測試案例已刪除' : ''));
    const priorityValue = isDeleted ? '-' : (item.priority || 'Medium');
    const deletedNote = isDeleted ? `<span class="badge bg-danger-subtle text-danger ms-2">已刪除</span>` : '';
    
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6>${basicInfoLabel}</h6>
                <table class="table table-sm">
                    <tr><td>${testCaseNumberLabel}</td><td><code style="color: rgb(194, 54, 120); font-weight: 500;">${escapeHtml(item.test_case_number)}</code></td></tr>
                    <tr><td>${titleLabel}</td><td><span class="${isDeleted ? 'text-muted' : ''}">${titleValue || '-'}</span>${deletedNote}</td></tr>
                    <tr><td>${priorityLabel}</td><td>${escapeHtml(priorityValue)}</td></tr>
                    <tr><td>${testResultLabel}</td><td><span class="badge ${getResultClass(item.test_result)}">${getResultText(item.test_result)}</span></td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>${executionInfoLabel}</h6>
                <table class="table table-sm">
                    <tr><td>${executorLabel}</td><td>${escapeHtml(item.assignee_name || '-')}</td></tr>
                    <tr><td>${executionTimeLabel}</td><td>${item.executed_at ? AppUtils.formatDate(item.executed_at, 'datetime') : '-'}</td></tr>
                    <tr><td>${executionDurationLabel}</td><td>${item.execution_duration ? item.execution_duration + ' ' + minutesLabel : '-'}</td></tr>
                    <tr><td>${attachmentCountLabel}</td><td>${item.attachment_count || 0}</td></tr>
                </table>
            </div>
        </div>
        ${!isDeleted && item.precondition ? `<div class="mt-3"><h6>${preconditionsLabel}</h6><p class="text-muted">${escapeHtml(item.precondition)}</p></div>` : ''}
        ${!isDeleted && item.steps ? `<div class="mt-3"><h6>${testStepsLabel}</h6><p class="text-muted">${escapeHtml(item.steps).replace(/\n/g, '<br>')}</p></div>` : ''}
        ${!isDeleted && item.expected_result ? `<div class="mt-3"><h6>${expectedResultsLabel}</h6><p class="text-muted">${escapeHtml(item.expected_result)}</p></div>` : ''}
    `;
    
    document.getElementById('item-detail-content').innerHTML = content;
    itemDetailModal.show();
}

function confirmStatusChange(newStatus, message) {
    const permissions = getTrePermissions();
    if ((newStatus === 'active' && !permissions.canStart) || (newStatus === 'completed' && !permissions.canComplete)) {
        showExecutionPermissionDenied();
        return;
    }
    document.getElementById('confirm-message').textContent = message;
    const confirmBtn = document.getElementById('confirm-action-btn');
    
    confirmBtn.onclick = async () => {
        try {
            await changeTestRunStatus(newStatus);
            confirmModal.hide();
        } catch (error) {
            AppUtils.showError('{{ i18n.t("testRun.statusChangeFailed") if i18n else "狀態變更失敗" }}' + ': ' + error.message);
        }
    };
    
    confirmModal.show();
}

async function changeTestRunStatus(newStatus) {
    const permissions = getTrePermissions();
    if ((newStatus === 'active' && !permissions.canStart) || (newStatus === 'completed' && !permissions.canComplete)) {
        showExecutionPermissionDenied();
        throw new Error('permission_denied');
    }
    try {
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: newStatus })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        testRunConfig.status = newStatus;
        updateHeader();
        
        // 重新渲染項目以更新 checkbox 顯示和編輯權限
        renderTestRunItems();
        
        const statusMsg = {
            'active': '{{ i18n.t("testRun.executionStarted") if i18n else "已開始執行" }}',
            'completed': '{{ i18n.t("testRun.executionCompleted") if i18n else "已結束執行" }}'
        };
        
        AppUtils.showSuccess(statusMsg[newStatus] || '{{ i18n.t("testRun.statusUpdated") if i18n else "狀態已更新" }}');
        
    } catch (error) {
        console.error('Failed to change status:', error);
        throw error;
    }
}

function showRestartModal() {
    if (!getTrePermissions().canRestart) {
        showExecutionPermissionDenied();
        return;
    }
    if (!testRunConfig || testRunConfig.status !== 'completed') {
        AppUtils.showWarning('{{ i18n.t("testRun.onlyCompletedCanRestart") if i18n else "只有已完成的 Test Run 才能重新執行" }}');
        return;
    }
    
    // 重置選項為默認值
    document.getElementById('restartAll').checked = true;
    // 預設名稱：Rerun - 原有名稱
    const input = document.getElementById('rerunNameInput');
    if (input) {
        const base = (testRunConfig && testRunConfig.name) ? `Rerun - ${testRunConfig.name}` : 'Rerun -';
        input.value = base;
    }
    restartModal.show();
}

async function handleRestartConfirm() {
    if (!getTrePermissions().canRestart) {
        showExecutionPermissionDenied();
        return;
    }
    const selectedMode = document.querySelector('input[name="restartMode"]:checked');
    if (!selectedMode) {
        AppUtils.showWarning('{{ i18n.t("testRun.selectRestartMode") if i18n else "請選擇重新執行模式" }}');
        return;
    }
    
    try {
        await restartTestRun(selectedMode.value);
        restartModal.hide();
        
    } catch (error) {
        AppUtils.showError('{{ i18n.t("testRun.restartFailed") if i18n else "重新執行失敗" }}' + ': ' + error.message);
    }
}

async function restartTestRun(mode) {
    if (!getTrePermissions().canRestart) {
        showExecutionPermissionDenied();
        throw new Error('permission_denied');
    }
    try {
        // 調用重新執行 API
        const nameInput = document.getElementById('rerunNameInput');
        const newName = nameInput && nameInput.value ? nameInput.value.trim() : '';
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/restart`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: mode, name: newName })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        const newId = result && result.new_config_id;
        if (!newId) throw new Error('Missing new_config_id');
        AppUtils.showSuccess('{{ i18n.t("testRun.rerunCreated") if i18n else "已建立新的 Test Run" }}');
        window.location.href = `/test-run-execution?config_id=${encodeURIComponent(newId)}`;
        
    } catch (error) {
        const consoleMsg = window.i18n && window.i18n.isReady() 
            ? window.i18n.t('testRun.restartFailed')
            : '重新執行 Test Run 失敗';
        console.error(consoleMsg + ':', error);
        throw error;
    }
}

// 輔助函數（狀態文字映射已移除，因為不再需要狀態指示器）

function getResultClass(result) {
    const classMap = {
        'Passed': 'result-passed',
        'Failed': 'result-failed', 
        'Retest': 'result-retest',
        'Not Available': 'result-na',
        'Pending': 'result-pending',
        'Not Required': 'result-not-required',
        'Skip': 'result-skip'
    };
    return classMap[result] || 'result-pending';
}

function getResultText(result) {
    const textMap = {
        'Passed': '{{ i18n.t("testRun.passed") if i18n else "Passed" }}',
        'Failed': '{{ i18n.t("testRun.failed") if i18n else "Failed" }}',
        'Retest': '{{ i18n.t("testRun.retest") if i18n else "Retest" }}',
        'Not Available': '{{ i18n.t("testRun.notAvailable") if i18n else "Not Available" }}',
        'Pending': '{{ i18n.t("testRun.pending") if i18n else "Pending" }}',
        'Not Required': '{{ i18n.t("testRun.notRequired") if i18n else "Not Required" }}',
        'Skip': '{{ i18n.t("testRun.skip") if i18n else "Skip" }}'
    };
    return textMap[result] || '{{ i18n.t("testRun.notExecuted") if i18n else "Not Executed" }}';
}

/**
 * 根據檔案名稱取得對應的檔案圖標
 */
function getFileIcon(fileName) {
    if (!fileName) return 'fas fa-file';

    const lowerName = fileName.toLowerCase();

    // PDF
    if (lowerName.endsWith('.pdf')) {
        return 'fas fa-file-pdf text-danger';
    }

    // Word
    if (lowerName.endsWith('.doc') || lowerName.endsWith('.docx')) {
        return 'fas fa-file-word text-primary';
    }

    // Excel
    if (lowerName.endsWith('.xls') || lowerName.endsWith('.xlsx')) {
        return 'fas fa-file-excel text-success';
    }

    // PowerPoint
    if (lowerName.endsWith('.ppt') || lowerName.endsWith('.pptx')) {
        return 'fas fa-file-powerpoint text-warning';
    }

    // Images
    if (lowerName.match(/\.(jpg|jpeg|png|gif|bmp|svg|webp)$/)) {
        return 'fas fa-file-image text-info';
    }

    // Archive
    if (lowerName.match(/\.(zip|rar|7z|tar|gz)$/)) {
        return 'fas fa-file-archive text-secondary';
    }

    // Video
    if (lowerName.match(/\.(mp4|avi|mov|mkv|flv|wmv)$/)) {
        return 'fas fa-file-video text-danger';
    }

    // Audio
    if (lowerName.match(/\.(mp3|wav|flac|aac|ogg)$/)) {
        return 'fas fa-file-audio text-primary';
    }

    // Text
    if (lowerName.match(/\.(txt|log|csv)$/)) {
        return 'fas fa-file-lines text-secondary';
    }

    // Default
    return 'fas fa-file text-muted';
}

// 全頁載入已移除，使用列表區載入動畫（showItemsLoading/hideItemsLoading）

function toggleSelectAllItems() {
    if (!(getTrePermissions().canBatchModify || getTrePermissions().canBatchDelete)) {
        const selectAll = document.getElementById('selectAllItemsCheckbox');
        if (selectAll) selectAll.checked = false;
        showExecutionPermissionDenied();
        updateItemSelectionUI();
        return;
    }
    const selectAll = document.getElementById('selectAllItemsCheckbox').checked;
    const checkboxes = document.querySelectorAll('.test-run-item-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll;
        const itemId = parseInt(checkbox.value);
        if (selectAll) {
            selectedItems.add(itemId);
        } else {
            selectedItems.delete(itemId);
        }
    });
    
    updateItemSelectionUI();
    // 重置 Shift 多選錨點
    lastItemCheckboxIndex = null;
}

function clearSelectedItems() {
    try {
        document.querySelectorAll('.test-run-item-checkbox').forEach(cb => cb.checked = false);
    } catch (_) {}
    const header = document.getElementById('selectAllItemsCheckbox');
    if (header) header.checked = false;
    selectedItems.clear();
    updateItemSelectionUI();
    lastItemCheckboxIndex = null;
}

function updateItemSelectionUI() {
    const totalCheckboxes = document.querySelectorAll('.test-run-item-checkbox').length;
    const selectedCount = selectedItems.size;
    const selectAllCheckbox = document.getElementById('selectAllItemsCheckbox');
    const toolbar = document.getElementById('batchOperationsToolbar');
    const countDisplay = document.getElementById('selectedItemsCount');

    if (!toolbar) {
        return;
    }

    const applyToolbarVisibility = (visible) => {
        if (visible) {
            toolbar.classList.remove('d-none');
            const defaultDisplay = toolbar.dataset.defaultDisplay || 'flex';
            toolbar.style.setProperty('display', defaultDisplay, 'important');
        } else {
            toolbar.classList.add('d-none');
            toolbar.style.setProperty('display', 'none', 'important');
        }
    };
    
    // 如果不顯示 checkbox，隱藏工具列
    if (!shouldShowCheckbox(testRunConfig ? testRunConfig.status : 'draft')) {
        applyToolbarVisibility(false);
        return;
    }
    
    // 更新全選 checkbox 狀態
    if (selectAllCheckbox) {
        if (selectedCount === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
            applyToolbarVisibility(false);
        } else if (selectedCount === totalCheckboxes) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
            applyToolbarVisibility(true);
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
            applyToolbarVisibility(true);
        }
    } else {
        applyToolbarVisibility(selectedCount > 0);
    }
    
    // 更新選中項目計數
    if (countDisplay) {
        if (window.i18n && window.i18n.isReady()) {
            countDisplay.textContent = window.i18n.t('testRun.selectedItemsCount', {count: selectedCount});
        } else {
            countDisplay.textContent = `已選取 ${selectedCount} 個項目`;
        }
        countDisplay.setAttribute('data-i18n-params', JSON.stringify({count: selectedCount}));
    }
}

function getBatchAssigneePrefillValue() {
    if (!selectedItems || selectedItems.size === 0) return '';
    let resolved = null;
    selectedItems.forEach(itemId => {
        const item = (testRunItems || []).find(it => it.id === itemId);
        if (!item) return;
        const name = (item.assignee_name || (item.assignee && item.assignee.name) || '').trim();
        if (!name) {
            resolved = '';
            return;
        }
        if (resolved === null) {
            resolved = name;
        } else if (resolved !== name) {
            resolved = '';
        }
    });
    return resolved || '';
}

function syncBatchAssigneeInput(value) {
    const input = document.getElementById('batchAssigneeInput');
    if (!input) return;
    const nextValue = value ? String(value) : '';
    if (input._assigneeSelector && typeof input._assigneeSelector.setValue === 'function') {
        input._assigneeSelector.setValue(nextValue);
    } else {
        input.value = nextValue;
    }
}

function getBatchAssigneeValue() {
    const input = document.getElementById('batchAssigneeInput');
    if (!input) return '';
    let value = (input.value || '').trim();
    if (value) return value;
    if (input._assigneeSelector && input._assigneeSelector.displayInput) {
        value = (input._assigneeSelector.displayInput.value || '').trim();
        if (value && typeof input._assigneeSelector.setValue === 'function') {
            input._assigneeSelector.setValue(value);
        }
    }
    return value;
}

function showBatchModifyModal() {
    if (!getTrePermissions().canBatchModify) {
        showExecutionPermissionDenied();
        return;
    }
    if (selectedItems.size === 0) {
        const noSelectionMsg = window.i18n && window.i18n.isReady() 
            ? window.i18n.t('testRun.noItemsSelected')
            : '{{ i18n.t("testRun.noItemsSelected") if i18n else "請先選擇要修改的項目" }}';
        AppUtils.showWarning(noSelectionMsg);
        return;
    }
    
    // 檢查 Test Run 狀態，已完成的不允許編輯
    if (testRunConfig && testRunConfig.status === 'completed') {
        const completedEditMsg = window.i18n && window.i18n.isReady() 
            ? window.i18n.t('testRun.cannotEditCompleted')
            : '{{ i18n.t("testRun.cannotEditCompleted") if i18n else "已完成的 Test Run 不可編輯 Test Case" }}';
        AppUtils.showWarning(completedEditMsg);
        return;
    }
    
    // 更新選中項目數量
    document.getElementById('batchModifyCount').textContent = selectedItems.size;
    
    // 根據當前狀態顯示/隱藏測試結果選項
    const canUpdateResult = testRunConfig && testRunConfig.status === 'active';
    const resultSection = document.getElementById('batchResultSection');
    
    if (canUpdateResult) {
        resultSection.style.display = 'block';
    } else {
        resultSection.style.display = 'none';
        document.getElementById('batchModifyResult').checked = false;
    }
    
    // 重置表單
    syncBatchAssigneeInput(getBatchAssigneePrefillValue());
    document.getElementById('batchResultSelect').value = '';
    document.getElementById('batchModifyAssignee').checked = true;
    document.getElementById('batchModifyResult').checked = false;
    document.getElementById('batchCommentInput').value = '';
    document.getElementById('batchModifyComment').checked = false;
    
    toggleBatchAssigneeInput();
    toggleBatchResultSelect();
    toggleBatchCommentInput();
    
    batchModifyModal.show();
}

function toggleBatchAssigneeInput() {
    const checkbox = document.getElementById('batchModifyAssignee');
    const input = document.getElementById('batchAssigneeInput');
    input.disabled = !checkbox.checked;
}

function toggleBatchResultSelect() {
    const checkbox = document.getElementById('batchModifyResult');
    const select = document.getElementById('batchResultSelect');
    select.disabled = !checkbox.checked;
}

function toggleBatchCommentInput() {
    const checkbox = document.getElementById('batchModifyComment');
    const input = document.getElementById('batchCommentInput');
    input.disabled = !checkbox.checked;
}

async function handleBatchModifyConfirm() {
    if (!getTrePermissions().canBatchModify) {
        showExecutionPermissionDenied();
        return;
    }
    try {
        const modifyAssignee = document.getElementById('batchModifyAssignee').checked;
        const modifyResult = document.getElementById('batchModifyResult').checked;
        const modifyComment = document.getElementById('batchModifyComment').checked;
        const assigneeName = getBatchAssigneeValue();
        const testResult = document.getElementById('batchResultSelect').value;
        const comment = document.getElementById('batchCommentInput').value.trim();
        
        if (!modifyAssignee && !modifyResult && !modifyComment) {
            const selectOptionMsg = window.i18n && window.i18n.isReady() 
                ? window.i18n.t('testRun.selectAtLeastOneOption')
                : '{{ i18n.t("testRun.selectAtLeastOneOption") if i18n else "請至少選擇一個要修改的項目" }}';
            AppUtils.showWarning(selectOptionMsg);
            return;
        }
        
        if (modifyAssignee && !assigneeName) {
            const enterAssigneeMsg = window.i18n && window.i18n.isReady() 
                ? window.i18n.t('testRun.enterAssigneeName')
                : '{{ i18n.t("testRun.enterAssigneeName") if i18n else "請輸入執行者姓名" }}';
            AppUtils.showWarning(enterAssigneeMsg);
            return;
        }
        
        if (modifyResult && !testResult) {
            const selectResultMsg = window.i18n && window.i18n.isReady() 
                ? window.i18n.t('testRun.selectTestResult')
                : '{{ i18n.t("testRun.selectTestResult") if i18n else "請選擇測試結果" }}';
            AppUtils.showWarning(selectResultMsg);
            return;
        }

        if (modifyComment && !comment) {
            const enterCommentMsg = window.i18n && window.i18n.isReady()
                ? window.i18n.t('testRun.enterComment')
                : '{{ i18n.t("testRun.enterComment") if i18n else "請輸入註釋內容" }}';
            AppUtils.showWarning(enterCommentMsg);
            return;
        }
        
        await batchModifyItems({ modifyAssignee, modifyResult, modifyComment, assigneeName, testResult, comment });
        batchModifyModal.hide();
        
    } catch (error) {
        const batchFailedMsg = window.i18n && window.i18n.isReady() 
            ? window.i18n.t('testRun.batchModifyFailed')
            : '{{ i18n.t("testRun.batchModifyFailed") if i18n else "批次修改失敗" }}';
        AppUtils.showError(batchFailedMsg + ': ' + error.message);
    }
}

async function batchModifyItems(modifications) {
    if (!getTrePermissions().canBatchModify) {
        showExecutionPermissionDenied();
        throw new Error('permission_denied');
    }
    try {
        const itemsToModify = Array.from(selectedItems);

        // 為每個選中的項目建立更新資料
        const updates = itemsToModify.map(itemId => {
            const updateData = { id: itemId };

            if (modifications.modifyAssignee) {
                updateData.assignee_name = modifications.assigneeName || null;
            }

            if (modifications.modifyResult) {
                updateData.test_result = modifications.testResult;
                updateData.executed_at = new Date().toISOString();
            }

            if (modifications.modifyComment) {
                updateData.comment = modifications.comment;
            }

            return updateData;
        });

        // 批次修改 API 調用（使用正確的端點）
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/batch-update-results`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                updates: updates
            })
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(`HTTP ${response.status}: ${errorData.detail || 'Unknown error'}`);
        }

        // 解析API響應
        const result = await response.json();

        // 樂觀更新本地列表（避免等待重載也能即時看到變更）
        try {
            updates.forEach(u => {
                const id = u.id;
                const idx = testRunItems.findIndex(it => it.id === id);
                if (idx !== -1) {
                    if ('assignee_name' in u) {
                        testRunItems[idx].assignee_name = (u.assignee_name || null);
                    }
                    if ('test_result' in u) {
                        testRunItems[idx].test_result = (u.test_result || null);
                        testRunItems[idx].executed_at = u.executed_at || new Date().toISOString();
                    }
                }
            });
            renderTestRunItems();
        } catch (_) {}

        // 再從伺服器重載一次，確保資料正確
        await loadTestRunItems();
        await updateStatistics();

        // 若詳情 Modal 開啟中則刷新 timeline（以目前顯示的 test case）
        try {
            const modalEl = document.getElementById('testCaseDetailModal');
            const isShown = modalEl && modalEl.classList.contains('show');
            if (isShown && currentDetailTestCase && currentDetailTestCase.test_case_number) {
                renderResultHistoryTimeline({ test_case_number: currentDetailTestCase.test_case_number });
                const detailItem = testRunItems.find(it => it.test_case_number === currentDetailTestCase.test_case_number);
                if (detailItem && detailItem.id) {
                    loadComment(detailItem.id);
                }
            }
        } catch (_) {}

        // 清空選擇狀態並更新 UI
        selectedItems.clear();
        updateItemSelectionUI();

        // 顯示成功訊息，包括處理結果
        if (result.success) {
            const successMsg = window.i18n && window.i18n.isReady()
                ? window.i18n.t('testRun.batchModifySuccess', {count: result.success_count})
                : `成功修改 ${result.success_count} 個測試執行項目`;
            AppUtils.showSuccess(successMsg);
        } else {
            // 部分成功的情況
            const partialMsg = window.i18n && window.i18n.isReady()
                ? window.i18n.t('testRun.batchModifyPartial', {success: result.success_count, total: result.processed_count})
                : `已處理 ${result.processed_count} 個項目，成功 ${result.success_count} 個`;
            AppUtils.showWarning(partialMsg);

            if (result.error_messages && result.error_messages.length > 0) {
                console.warn('批次修改錯誤:', result.error_messages);
            }
        }

    } catch (error) {
        const consoleMsg = window.i18n && window.i18n.isReady()
            ? window.i18n.t('testRun.batchModifyFailed')
            : '批次修改測試執行項目失敗';
        console.error(consoleMsg + ':', error);
        throw error;
    }
}

// 顯示批次刪除確認對話框
function showBatchDeleteConfirm() {
    if (!getTrePermissions().canBatchDelete) {
        showExecutionPermissionDenied();
        return;
    }
    if (selectedItems.size === 0) {
        const noSelectionMsg = window.i18n && window.i18n.isReady()
            ? window.i18n.t('testRun.noItemsSelected')
            : '{{ i18n.t("testRun.noItemsSelected") if i18n else "請先選擇要刪除的項目" }}';
        AppUtils.showWarning(noSelectionMsg);
        return;
    }

    const confirmMessage = window.i18n && window.i18n.isReady()
        ? window.i18n.t('testRun.batchDeleteConfirm', {count: selectedItems.size})
        : `確定要刪除選中的 ${selectedItems.size} 個測試執行項目嗎？\n\n⚠️ 警告：此操作將同時清除所有相關的測試歷程記錄，此動作無法復原！`;

    // 為批次刪除添加特殊的警告樣式
    const modalDialog = document.querySelector('#confirmModal .modal-dialog');
    const modalContent = document.querySelector('#confirmModal .modal-content');
    const modalHeader = document.querySelector('#confirmModal .modal-header');
    const confirmBtn = document.getElementById('confirm-action-btn');

    // 保存原始樣式
    const originalClasses = {
        dialog: modalDialog.className,
        content: modalContent.className,
        header: modalHeader.className,
        btn: confirmBtn.className
    };

    // 應用危險操作的樣式
    modalDialog.className = 'modal-dialog modal-dialog-centered modal-dialog-scrollable';
    modalContent.className = 'modal-content border-danger';
    modalHeader.className = 'modal-header bg-danger text-white';
    confirmBtn.className = 'btn btn-danger';

    // 更新標題圖標和文字
    const modalTitle = document.querySelector('#confirmModal .modal-title');
    modalTitle.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        <span data-i18n="testRun.batchDeleteWarning">危險操作警告</span>
    `;

    document.getElementById('confirm-message').innerHTML = confirmMessage.replace(/\n/g, '<br>');

    // 設置確認按鈕事件
    confirmBtn.onclick = async () => {
        try {
            await batchDeleteItems();
            confirmModal.hide();
        } catch (error) {
            AppUtils.showError('{{ i18n.t("testRun.batchDeleteFailed") if i18n else "批次刪除失敗" }}' + ': ' + error.message);
        }
    };

    // 當對話框隱藏時恢復原始樣式
    const modalElement = document.getElementById('confirmModal');
    modalElement.addEventListener('hidden.bs.modal', function() {
        modalDialog.className = originalClasses.dialog;
        modalContent.className = originalClasses.content;
        modalHeader.className = originalClasses.header;
        confirmBtn.className = originalClasses.btn;
        modalTitle.innerHTML = `
            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
            <span data-i18n="common.confirm">確認操作</span>
        `;
    }, { once: true });

    confirmModal.show();
}

// 批次刪除測試執行項目
async function batchDeleteItems() {
    if (!getTrePermissions().canBatchDelete) {
        showExecutionPermissionDenied();
        throw new Error('permission_denied');
    }
    try {
        const itemsToDelete = Array.from(selectedItems);
        let successCount = 0;
        let errorMessages = [];

        // 逐個刪除項目（因為可能沒有批次刪除 API）
        for (const itemId of itemsToDelete) {
            try {
                const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/${itemId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    successCount++;
                    // 從本地列表中移除已刪除的項目
                    const idx = testRunItems.findIndex(it => it.id === itemId);
                    if (idx !== -1) {
                        testRunItems.splice(idx, 1);
                    }
                } else {
                    let errorMessage = 'Unknown error';
                    try {
                        const errorData = await response.json();
                        if (typeof errorData.detail === 'string') {
                            errorMessage = errorData.detail;
                        } else if (errorData.detail && typeof errorData.detail === 'object') {
                            errorMessage = JSON.stringify(errorData.detail);
                        } else if (errorData.message) {
                            errorMessage = errorData.message;
                        }
                    } catch (e) {
                        errorMessage = response.statusText || 'Request failed';
                    }
                    errorMessages.push(`項目 ${itemId}: ${errorMessage}`);
                }
            } catch (error) {
                errorMessages.push(`項目 ${itemId}: ${error.message}`);
            }
        }

        // 重新渲染列表
        renderTestRunItems();

        // 重新載入項目和統計
        await loadTestRunItems();
        await updateStatistics();

        // 若詳情 Modal 開啟中且顯示的項目已被刪除，則關閉 Modal
        try {
            const modalEl = document.getElementById('testCaseDetailModal');
            const isShown = modalEl && modalEl.classList.contains('show');
            if (isShown && currentDetailTestCase) {
                const item = testRunItems.find(i => i.test_case_number === currentDetailTestCase.test_case_number);
                if (!item) {
                    // 如果當前顯示的項目已被刪除，關閉 Modal
                    const modal = bootstrap.Modal.getInstance(modalEl);
                    if (modal) modal.hide();
                }
            }
        } catch (_) {}

        // 清空選擇狀態並更新 UI
        selectedItems.clear();
        updateItemSelectionUI();

        // 顯示結果訊息
        if (successCount === itemsToDelete.length) {
            // 全部成功
            const successMsg = window.i18n && window.i18n.isReady()
                ? window.i18n.t('testRun.batchDeleteSuccess', {count: successCount})
                : `成功刪除 ${successCount} 個測試執行項目及其測試歷程`;
            AppUtils.showSuccess(successMsg);
        } else if (successCount > 0) {
            // 部分成功
            const partialMsg = window.i18n && window.i18n.isReady()
                ? window.i18n.t('testRun.batchDeletePartial', {success: successCount, total: itemsToDelete.length})
                : `已處理 ${itemsToDelete.length} 個項目，成功刪除 ${successCount} 個測試執行項目`;
            AppUtils.showWarning(partialMsg);

            if (errorMessages.length > 0) {
                console.warn('批次刪除錯誤:', errorMessages);
            }
        } else {
            // 全部失敗
            const failMsg = window.i18n && window.i18n.isReady()
                ? window.i18n.t('testRun.batchDeleteFailed')
                : '批次刪除失敗';
            throw new Error(`${failMsg}: ${errorMessages.join(', ')}`);
        }

    } catch (error) {
        const consoleMsg = window.i18n && window.i18n.isReady()
            ? window.i18n.t('testRun.batchDeleteFailed')
            : '批次刪除測試執行項目失敗';
        console.error(consoleMsg + ':', error);
        throw error;
    }
}

function navigateToTestCase(testCaseNumber) {
    if (!testCaseNumber) {
        AppUtils.showWarning('{{ i18n.t("testRun.invalidTestCaseNumber") if i18n else "無效的測試案例編號" }}');
        return;
    }

    try {
        if (Array.isArray(testRunItems)) {
            const item = testRunItems.find(it => it.test_case_number === testCaseNumber);
            if (item && item.__testCaseDeleted) {
                AppUtils.showWarning('此測試案例已刪除');
                return;
            }
        }
    } catch (_) {}
    
    // 顯示 Test Case 詳細資料 Modal
    showTestCaseDetailModal(testCaseNumber);
}

// Test Case 詳細資料 Modal 相關函數
let testCaseDetailModalInstance = null;
let currentDetailTestCase = null; // 目前顯示於執行頁 Modal 的 Test Case，用於鍵盤導航

// 初始化 Test Case 詳細資料 Modal 中的 AssigneeSelector
function initializeTestCaseAssigneeSelector(testCase) {
    if (!getTrePermissions().canAssign) return;
    if (!window.AssigneeSelector || !currentTeamId) return;

    const assigneeInput = document.querySelector('#testCaseDetailModal .assignee-editor[data-assignee-selector]');
    if (!assigneeInput) return;

    // 清理之前的實例
    if (assigneeInput._assigneeSelector) {
        assigneeInput._assigneeSelector.destroy();
    }

    const options = {
        teamId: currentTeamId,
        allowCustomValue: true,
        onSelect: (contact) => {
            // 更新當前 Test Run Item 的 assignee（以本地 SQLite 為準）
            const item = (testRunItems || []).find(i => i.test_case_number === testCase.test_case_number);
            if (item) updateAssignee(item.id, contact.name);
        },
        onClear: () => {
            const item = (testRunItems || []).find(i => i.test_case_number === testCase.test_case_number);
            if (item) updateAssignee(item.id, '');
        }
    };

    assigneeInput._assigneeSelector = new AssigneeSelector(assigneeInput, options);
}

// 已移除：原先更新 Test Case 的 Assignee（改為只更新 Test Run Item 的本地欄位）

function handleAttachmentSummaryClick(event) {
    try {
        if (event) {
            event.preventDefault();
        }
        const link = event && event.currentTarget ? event.currentTarget : null;
        const canScroll = link && link.dataset ? link.dataset.canScroll === 'true' : true;
        if (!canScroll) {
            return false;
        }
        scrollToAttachments();
    } catch (_) {
        return false;
    }
    return false;
}

async function showTestCaseDetailModal(testCaseNumber) {
    // 初始化 Modal
    const modalElement = document.getElementById('testCaseDetailModal');
    if (!testCaseDetailModalInstance) {
        testCaseDetailModalInstance = new bootstrap.Modal(modalElement);
    }
    const permissions = getTrePermissions();
    
    // 確保這個 Modal 有最高的 z-index (高於其他 Modal)
    // Bug Tickets Summary Modal 預設是 1055，所以設置為 1080 確保在上層
    modalElement.style.zIndex = '1080';
    
    // 設置 Modal 事件監聽器來處理 backdrop z-index
    modalElement.addEventListener('shown.bs.modal', function() {
        // 找到最新的 backdrop 並設置正確的 z-index
        const backdrops = document.querySelectorAll('.modal-backdrop');
        if (backdrops.length > 0) {
            // 設置最新的 backdrop 有較高的 z-index
            const latestBackdrop = backdrops[backdrops.length - 1];
            latestBackdrop.style.zIndex = '1079';
        }
        
        // 確保 Modal 本身的 z-index 是最高的
        modalElement.style.zIndex = '1080';
    });
    
    // 重置 Modal 狀態
    document.getElementById('testCaseDetailLoading').style.display = 'block';
    const fixedDiv = document.getElementById('testCaseDetailFixed');
    const scrollDiv = document.getElementById('testCaseDetailScrollable');
    fixedDiv.style.display = 'none';
    scrollDiv.style.display = 'none';
    document.getElementById('testCaseDetailError').style.display = 'none';
    document.getElementById('openFullTestCaseBtn').style.display = 'none';
    // 在載入期間先隱藏/清空標頭的 Test Result，避免顯示舊資料
    const headerResult = document.getElementById('testCaseDetailHeaderResult');
    if (headerResult) {
        headerResult.innerHTML = '';
        headerResult.style.visibility = 'hidden';
    }
    
    // 顯示 Modal
    testCaseDetailModalInstance.show();
    // 綁定鍵盤左右鍵支援
    const modalEl = document.getElementById('testCaseDetailModal');
    if (!modalEl._keydownBound) {
        modalEl.addEventListener('shown.bs.modal', function() {
            document.addEventListener('keydown', handleExecDetailModalKeydown);
        });
        modalEl.addEventListener('hidden.bs.modal', function() {
            document.removeEventListener('keydown', handleExecDetailModalKeydown);
        });
        modalEl._keydownBound = true;
    }
    
    try {
        // 載入 Test Case 資料
        await loadTestCaseDetail(testCaseNumber);
    } catch (error) {
        console.error('Failed to load test case detail:', error);
        showTestCaseDetailError();
    }
}

async function loadTestCaseDetail(testCaseNumber) {
    try {
        // 先嘗試從跨頁快取讀取
        const cached = await getCachedTestCase(testCaseNumber);
        const isFresh = cached && (Date.now() - cached.ts) < TEST_CASE_CACHE_TTL_MS;
        const hasAttachments = cached && cached.data && Array.isArray(cached.data.attachments) && cached.data.attachments.length > 0;
        // 若快取新鮮且包含附件，直接使用；否則改以 by-number 拉完整詳情（含附件）
        if (isFresh && hasAttachments) {
            displayTestCaseDetail(cached.data);
            return;
        }

        // 先以 by-number 取得完整詳情（含附件）
        const resp = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/testcases/by-number/${encodeURIComponent(testCaseNumber)}`);
        if (resp.ok) {
            const testCase = await resp.json();
            setCachedTestCase(testCaseNumber, testCase);
            displayTestCaseDetail(testCase);
            return;
        }

        // 後備：用列表搜尋（可能不含附件，僅避免完全失敗）
        const url = new URL(`/api/teams/${currentTeamId}/testcases/`, window.location.origin);
        url.searchParams.set('search', testCaseNumber);
        url.searchParams.set('limit', '1');
        const response = await window.AuthClient.fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const testCases = await response.json();
        if (!Array.isArray(testCases) || testCases.length === 0) {
            throw new Error('找不到指定的測試案例');
        }
        const fallback = testCases.find(tc => tc.test_case_number === testCaseNumber) || testCases[0];
        setCachedTestCase(testCaseNumber, fallback);
        displayTestCaseDetail(fallback);
        
    } catch (error) {
        console.error('Error loading test case detail:', error);
        throw error;
    }
}

function displayTestCaseDetail(testCase) {
    const permissions = getTrePermissions();

    // 隱藏載入狀態
    document.getElementById('testCaseDetailLoading').style.display = 'none';
    
    // 準備顯示資料
    const fixedDiv = document.getElementById('testCaseDetailFixed');
    const scrollDiv = document.getElementById('testCaseDetailScrollable');
    const openBtn = document.getElementById('openFullTestCaseBtn');
    
    // 生成詳細資料 HTML（拆分固定與可捲動內容）
    const { fixedHtml, scrollableHtml } = createTestCaseDetailHtml(testCase);
    fixedDiv.innerHTML = fixedHtml;
    scrollDiv.innerHTML = scrollableHtml;
    
    // 顯示內容和開啟按鈕
    const bodyRow = document.getElementById('testCaseDetailBodyRow');
    const referenceBtn = document.getElementById('referenceTestCaseExecBtn');
    if (bodyRow) bodyRow.classList.remove('d-none');
    fixedDiv.style.display = 'block';
    scrollDiv.style.display = 'block';
    openBtn.style.display = 'inline-block';
    if (referenceBtn) referenceBtn.style.display = 'inline-block';
    // 記錄目前展示的 Test Case，供鍵盤導航使用
    currentDetailTestCase = testCase;
    
    // 設定開啟按鈕的點擊事件
    openBtn.onclick = function() {
        const url = `/test-case-management?tc=${encodeURIComponent(testCase.test_case_number)}&team_id=${encodeURIComponent(currentTeamId)}&minimal=1&mode=edit`;
        window.open(url, 'TestCaseEditor', 'width=1200,height=800,noopener,noreferrer');
    };
    
    // 設定參考測試案例按鈕的點擊事件（改為開啟瀏覽器彈窗）
    if (referenceBtn) {
        referenceBtn.onclick = function() {
            const url = `/test-case-reference?team_id=${encodeURIComponent(currentTeamId)}`;
            window.open(url, 'TestCaseReference', 'width=1200,height=800,noopener,noreferrer');
        };
    }
    
    // 應用 i18n 翻譯
    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(fixedDiv);
        window.i18n.retranslate(scrollDiv);
    }

    // 在標頭區渲染 Test Result 下拉或唯讀 badge
    renderModalHeaderResult(testCase);

    // 渲染右側 Timeline（結果歷程）
    renderResultHistoryTimeline(testCase);
    
    // 載入 Bug Tickets 和 Test Results
    const testRunItem = (testRunItems || []).find(item => item.test_case_number === testCase.test_case_number);
    if (testRunItem && testRunItem.id) {
        loadBugTickets(testRunItem.id);

        // 初始化 Test Results 管理器
        initializeTestResults(
            testRunItem.id,
            testCase.test_case_number,
            currentTeamId,
            currentConfigId
        );

        // 載入 Comment
        loadComment(testRunItem.id);
    }
    // 載入完成後再顯示，避免切換時顯示上一筆資料
    const headerResult = document.getElementById('testCaseDetailHeaderResult');
    if (headerResult) {
        headerResult.style.visibility = 'visible';
    }

    // 綁定上一隻、下一隻按鈕
    const prevBtn = document.getElementById('prevExecCaseBtn');
    const nextBtn = document.getElementById('nextExecCaseBtn');
    if (prevBtn && nextBtn) {
        prevBtn.onclick = () => navigateExecCase(testCase, -1);
        nextBtn.onclick = () => navigateExecCase(testCase, 1);
        // 依序號狀態啟用/停用
        const idx = (testRunItems || []).findIndex(i => i.test_case_number === testCase.test_case_number);
        prevBtn.disabled = idx <= 0;
        nextBtn.disabled = idx < 0 || idx >= testRunItems.length - 1;
    }

    // 綁定複製連結按鈕（Test Case 詳情）
    try {
        const copyBtn = document.getElementById('copyExecCaseLinkBtn');
        if (copyBtn) {
            copyBtn.onclick = () => {
                const teamId = getCurrentTeamId();
                const cfgId = (typeof currentConfigId !== 'undefined' && currentConfigId) ? currentConfigId : new URLSearchParams(window.location.search).get('config_id');
                const url = buildTreUrl(cfgId, teamId, testCase.test_case_number);
                if (window.AppUtils && typeof AppUtils.showCopyModal === 'function') {
                    AppUtils.showCopyModal(url);
                } else {
                    const promptLabel = (window.i18n && typeof window.i18n.t === 'function')
                        ? window.i18n.t('copyModal.prompt', {}, '請手動複製此連結：')
                        : '請手動複製此連結：';
                    window.prompt(promptLabel, url);
                }
            };
        }
    } catch (_) {}

    // 初始化 AssigneeSelector
    initializeTestCaseAssigneeSelector(testCase);

    // 控制 Bug Tickets 新增按鈕狀態
    const addBugTicketBtn = document.getElementById('addBugTicketBtn');
    if (addBugTicketBtn && testRunConfig) {
        const canAddBugTickets = permissions.canManageBugTickets && testRunConfig.status !== 'completed' && testRunConfig.status !== 'archived';
        addBugTicketBtn.disabled = !canAddBugTickets;
        addBugTicketBtn.style.opacity = canAddBugTickets ? '1' : '0.3';
        addBugTicketBtn.style.cursor = canAddBugTickets ? 'pointer' : 'not-allowed';
    }

    // 控制 Comment 編輯按鈕狀態
    const editCommentBtn = document.getElementById('editCommentBtn');
    if (editCommentBtn && testRunConfig) {
        const canEditComments = permissions.canUpdateResults && testRunConfig.status !== 'completed' && testRunConfig.status !== 'archived';
        editCommentBtn.disabled = !canEditComments;
        editCommentBtn.style.opacity = canEditComments ? '1' : '0.3';
        editCommentBtn.style.cursor = canEditComments ? 'pointer' : 'not-allowed';

        if (canEditComments) {
            editCommentBtn.onclick = () => {
                const testRunItem = (testRunItems || []).find(item => item.test_case_number === testCase.test_case_number);
                if (testRunItem && testRunItem.id) {
                    editComment(testRunItem.id);
                }
            };
        }
    }
}

// 生成基本資訊區域的 HTML
function generateBasicInfoHtml(testCase) {
    // 以 Test Run Item 的 assignee_name 為準（本地 DB），而非 Test Case 的 assignee
    const itemForCase = (testRunItems || []).find(i => i.test_case_number === testCase.test_case_number);
    const assigneeName = itemForCase ? (itemForCase.assignee_name || '') : '';
    const permissions = getTrePermissions();
    const canAssign = permissions.canAssign && testRunConfig && testRunConfig.status !== 'completed' && testRunConfig.status !== 'archived';
    const tcgNumbers = Array.isArray(testCase.tcg)
        ? testCase.tcg.flatMap(t => {
            if (t && Array.isArray(t.text_arr) && t.text_arr.length) {
                return t.text_arr;
            }
            if (t && t.text) {
                return String(t.text)
                    .split(/[\s,，、|/]+/)
                    .map(s => s.trim())
                    .filter(Boolean);
            }
            if (typeof t === 'string') {
                return String(t)
                    .split(/[\s,，、|/]+/)
                    .map(s => s.trim())
                    .filter(Boolean);
            }
            return [];
        }).filter(Boolean)
        : [];
    const attachmentCount = Array.isArray(testCase.attachments) ? testCase.attachments.length : 0;

    const tcgTagsHtml = tcgNumbers.map(num => {
        const safe = escapeHtml(num);
        return '<span class="tcg-tag" style="margin-right:4px;" onclick="showTCGPreviewInTestRun(\'' + safe + '\', event)" title="' + safe + '">' + safe + '</span>';
    }).join('');

    const assigneeCell = canAssign
        ? `<input type="text" class="form-control form-control-sm assignee-editor basic-info-input"
               value="${escapeHtml(assigneeName || '')}"
               data-assignee-selector
               data-test-case-id="${testCase.test_case_number}"
               placeholder="{{ i18n.t('testRun.enterAssigneeName') if i18n else '輸入執行者姓名' }}">`
        : `<span class="text-muted">${escapeHtml(assigneeName || '-')}</span>`;

    return `
        <!-- Basic Info 區域 -->
        <div class="card mb-2">
            <div class="card-header py-1">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <span data-i18n=\"testRun.basicInfo\">基本資訊</span>
                </h6>
            </div>
            <div class="card-body px-2 basic-info-body">
                <table class="table table-sm table-borderless mb-0 basic-info-table">
                    <tr>
                        <td class="basic-info-label" data-i18n=\"testRun.testCaseNumber\">編號</td>
                        <td class="basic-info-value"><code class="basic-info-code">${escapeHtml(testCase.test_case_number)}</code></td>
                        <td class="basic-info-label">${tcgNumbers.length ? 'TCG' : ''}</td>
                        <td class="basic-info-value">${tcgNumbers.length ? tcgTagsHtml : ''}</td>
                    </tr>
                    <tr>
                        <td class="basic-info-label" data-i18n="testRun.title">標題</td>
                        <td class="basic-info-value basic-info-title" colspan="3">${escapeHtml(testCase.title)}</td>
                    </tr>
                    <tr>
                        <td class="basic-info-label" data-i18n="testRun.priority">優先級</td>
                        <td class="basic-info-value"><span class="badge bg-secondary basic-info-badge">${escapeHtml(testCase.priority || 'Medium')}</span></td>
                        <td class="basic-info-label" data-i18n="testRun.assignee">執行者</td>
                        <td class="basic-info-value">${assigneeCell}</td>
                    </tr>
                    <tr>
                        <td class="basic-info-label basic-info-label-top" data-i18n="testRun.attachments">附件</td>
                        <td colspan="3" class="basic-info-value">
                            <div class="d-flex align-items-center">
                                <a href="#"
                                   id="attachmentCountLink"
                                   class="text-decoration-none ${attachmentCount > 0 ? '' : 'text-muted disabled-attachment-link'}"
                                   data-can-scroll="${attachmentCount > 0 ? 'true' : 'false'}"
                                   ${attachmentCount > 0 ? '' : 'aria-disabled="true" tabindex="-1"'}
                                   onclick="return handleAttachmentSummaryClick(event);"
                                   title="${escapeHtml('{{ i18n.t("testRun.attachments") if i18n else "附件" }}')}">
                                    <i class="fas fa-paperclip me-1"></i>
                                    <span id="attachmentCountValue">${attachmentCount}</span>
                                    <span data-i18n="testRun.files">個文件</span>
                                </a>
                            </div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
        <!-- Test Details 標題（固定） -->
        <div class="card mb-2">
            <div class="card-header py-2">
                <h6 class="card-title mb-0">
                    <i class="fas fa-clipboard-list me-2"></i>
                    <span data-i18n="testRun.testDetails">測試詳情</span>
                </h6>
            </div>
        </div>`;
}

// 生成可捲動內容區域的 HTML
function generateScrollableContentHtml(testCase) {
    const attachments = Array.isArray(testCase.attachments) ? testCase.attachments : [];
    const attachmentCount = attachments.length;

    return `
        <div class="card scrollable-content-card">
            <div class="card-body scrollable-content-body">
                ${testCase.precondition ? `
                <div class="mb-3">
                    <h6 class="mb-2" data-i18n="testRun.precondition">前置條件</h6>
                    <div class="section-block section-precondition">
                        <div class="markdown-preview mb-0 content-markdown">${renderMarkdown(testCase.precondition)}</div>
                    </div>
                </div>
                ` : ''}
                ${testCase.steps ? `
                <div class="mb-3">
                    <h6 class="mb-2" data-i18n="testRun.steps">測試步驟</h6>
                    <div class="section-block section-steps">
                        <div class="markdown-preview mb-0 content-markdown">${renderMarkdown(testCase.steps)}</div>
                    </div>
                </div>
                ` : ''}
                ${testCase.expected_result ? `
                <div class="mb-3">
                    <h6 class="mb-2" data-i18n="testRun.expectedResult">預期結果</h6>
                    <div class="section-block section-expected">
                        <div class="markdown-preview mb-0 content-markdown">${renderMarkdown(testCase.expected_result)}</div>
                    </div>
                </div>
                ` : ''}
                ${attachmentCount > 0 ? `
                <div class="mt-3" id="attachmentsSection">
                    <h6 class="mb-2" data-i18n="testRun.attachments">附件</h6>
                    <div class="section-block section-attachments">
                    <div class="d-flex flex-wrap align-items-center">
                        ${attachments.map((attachment, index) => {
                            const fileExtension = attachment.name ? attachment.name.split('.').pop().toLowerCase() : '';
                            let iconClass = 'fas fa-file';
                            let iconColor = 'text-secondary';
                            switch(fileExtension) {
                                case 'pdf': iconClass = 'fas fa-file-pdf'; iconColor = 'text-danger'; break;
                                case 'doc': case 'docx': iconClass = 'fas fa-file-word'; iconColor = 'text-primary'; break;
                                case 'xls': case 'xlsx': iconClass = 'fas fa-file-excel'; iconColor = 'text-success'; break;
                                case 'jpg': case 'jpeg': case 'png': case 'gif': case 'bmp': case 'webp': iconClass = 'fas fa-file-image'; iconColor = 'text-info'; break;
                                case 'txt': iconClass = 'fas fa-file-alt'; iconColor = 'text-secondary'; break;
                                case 'zip': case 'rar': case '7z': iconClass = 'fas fa-file-archive'; iconColor = 'text-warning'; break;
                                default: iconClass = 'fas fa-file'; iconColor = 'text-secondary';
                            }
                            const attachmentToken = attachment.file_token || attachment.token || '';
                            const attachmentName = attachment.name || ('附件 ' + (index + 1));
                            const attachmentUrl = attachment.url || '';
                            return '<span class="d-inline-flex align-items-center me-3 mb-2 attachment-item" '
                                + 'style="cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 0.25rem; transition: background-color 0.15s;" '
                                + 'onclick="handleAttachmentClick(\'' + escapeHtml(attachmentName) + '\', \'' + attachmentToken + '\', \'' + attachmentUrl + '\')" '
                                + 'onmouseover="this.style.backgroundColor=\'var(--tr-bg-light)\'" '
                                + 'onmouseout="this.style.backgroundColor=\'transparent\'" '
                                + 'title="點擊查看附件: ' + escapeHtml(attachmentName) + '">'
                                + '<i class="' + iconClass + ' ' + iconColor + ' me-1"></i>'
                                + '<small style="text-decoration: underline; color: var(--tr-primary);">' + escapeHtml(attachmentName) + '</small>'
                                + '</span>';
                        }).join('')}
                    </div>
                    </div>
                </div>
                ` : ''}
            </div>
        </div>`;
}

function createTestCaseDetailHtml(testCase) {
    const fixedHtml = generateBasicInfoHtml(testCase);
    const scrollableHtml = generateScrollableContentHtml(testCase);

    return { fixedHtml, scrollableHtml };
}


function renderModalHeaderResult(testCase) {
    const container = document.getElementById('testCaseDetailHeaderResult');
    if (!container) return;

    const item = getItemByTestCaseNumber(testCase.test_case_number);
    const currentResult = item ? (item.test_result || '') : '';
    const canEdit = testRunConfig && testRunConfig.status === 'active';
    const hasExecutionHistory = item && item.executed_at !== null && item.executed_at !== undefined;

    if (canEdit && item) {
        container.innerHTML = `
            <select class="form-select form-select-sm result-selector-lg ${getResultClass(currentResult)}"
                    onchange="updateSelectClass(this); updateTestResult(${item.id}, this.value)">
                ${!hasExecutionHistory ? `<option value="">${escapeHtml('{{ i18n.t("testRun.notExecuted") if i18n else "Not Executed" }}')}</option>` : ''}
                <option value="Passed" ${currentResult === 'Passed' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.passed") if i18n else "Passed" }}')}</option>
                <option value="Failed" ${currentResult === 'Failed' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.failed") if i18n else "Failed" }}')}</option>
                <option value="Retest" ${currentResult === 'Retest' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.retest") if i18n else "Retest" }}')}</option>
                <option value="Not Available" ${currentResult === 'Not Available' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.notAvailable") if i18n else "Not Available" }}')}</option>
                <option value="Pending" ${currentResult === 'Pending' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.pending") if i18n else "Pending" }}')}</option>
                <option value="Not Required" ${currentResult === 'Not Required' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.notRequired") if i18n else "Not Required" }}')}</option>
                <option value="Skip" ${currentResult === 'Skip' ? 'selected' : ''}>${escapeHtml('{{ i18n.t("testRun.skip") if i18n else "Skip" }}')}</option>
            </select>
        `;
        const select = container.querySelector('select');
        if (select) updateSelectClass(select);
    } else {
        container.innerHTML = `
            <span class="badge result-badge-lg ${getResultClass(currentResult)}">${getResultText(currentResult)}</span>
        `;
    }
}

// 依 test_case_number 找到對應 item
function getItemByTestCaseNumber(testCaseNumber) {
    return (testRunItems || []).find(i => i.test_case_number === testCaseNumber);
}

async function renderResultHistoryTimeline(testCase) {
    try {
        const middlePane = document.getElementById('testCaseDetailMiddlePane');
        const rightPane = document.getElementById('testCaseDetailRightPane');
        const loading = document.getElementById('timelineLoading');
        const empty = document.getElementById('timelineEmpty');
        const list = document.getElementById('timelineList');
        if (!middlePane || !rightPane || !list) return;

        // 顯示中欄和右欄 (使用 flex 佈局)
        middlePane.style.display = 'flex';
        rightPane.style.display = 'flex';
        loading.style.display = 'block';
        empty.style.display = 'none';
        list.innerHTML = '';

        const item = getItemByTestCaseNumber(testCase.test_case_number);
        if (!item) { loading.style.display = 'none'; empty.style.display = 'block'; return; }
        
        // 設定當前項目 ID 供 Bug Ticket 功能使用
        currentItemIdForBugTicket = item.id;

        const resp = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/${item.id}/result-history?limit=50`);
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const records = await resp.json();
        loading.style.display = 'none';

        if (!Array.isArray(records) || records.length === 0) {
            empty.style.display = 'block';
            return;
        }

        // 生成 timeline 項目
        const rows = records.map(r => {
            const time = r.changed_at ? AppUtils.formatDate(r.changed_at, 'datetime') : '';
            const from = r.prev_result ? getResultText(r.prev_result) : '{{ i18n.t("testRun.notExecuted") if i18n else "Not Executed" }}';
            const to = r.new_result ? getResultText(r.new_result) : '{{ i18n.t("testRun.notExecuted") if i18n else "Not Executed" }}';
            const badgeFrom = `<span class="badge ${getResultClass(r.prev_result)}">${from}</span>`;
            const badgeTo = `<span class="badge ${getResultClass(r.new_result)}">${to}</span>`;
            const who = r.changed_by_name || '';
            const reason = r.change_reason ? `<div class="text-muted small">${escapeHtml(r.change_reason)}</div>` : '';
            return `
                <div class="timeline-item">
                    <div class="time">${time}${who ? ` · ${escapeHtml(who)}` : ''}</div>
                    <div class="status">${badgeFrom} <i class="fas fa-arrow-right mx-1"></i> ${badgeTo}</div>
                    ${reason}
                    <div class="timeline-divider"></div>
                </div>
            `;
        }).join('');
        list.innerHTML = rows;

        // Bug Tickets 在 displayTestCaseDetail 中載入

        // 綁定刷新按鈕
        const refreshBtn = document.getElementById('refreshTimelineBtn');
        if (refreshBtn) refreshBtn.onclick = () => renderResultHistoryTimeline(testCase);
    } catch (e) {
        const loading = document.getElementById('timelineLoading');
        const empty = document.getElementById('timelineEmpty');
        if (loading) loading.style.display = 'none';
        if (empty) empty.style.display = 'block';
        console.warn('load result history failed:', e);
    }
}

// 點擊 Basic Info 的附件摘要時，捲動到內容區的附件區塊
function scrollToAttachments() {
    try {
        const container = document.getElementById('testCaseDetailScrollable');
        const target = container ? container.querySelector('#attachmentsSection') : null;
        if (container && target) {
            const top = target.offsetTop - 8; // 預留一點上邊距
            container.scrollTo({ top, behavior: 'smooth' });
        }
    } catch (_) {}
}

// 鍵盤支援：在執行頁的 Test Case 詳細 Modal 使用左右鍵切換
function handleExecDetailModalKeydown(e) {
    try {
        const modal = document.getElementById('testCaseDetailModal');
        if (!modal || !modal.classList.contains('show')) return;
        // 避免在輸入元件或可編輯區域觸發
        const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
        const isEditable = e.target && (e.target.isContentEditable || tag === 'input' || tag === 'textarea' || tag === 'select');
        if (isEditable) return;
        if (!currentDetailTestCase) return;
        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            navigateExecCase(currentDetailTestCase, -1);
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            navigateExecCase(currentDetailTestCase, 1);
        }
    } catch (_) {}
}

// ====== 跨頁快取（IndexedDB + gzip）工具 ======
async function getCachedTestCase(testCaseNumber) {
    try {
        const res = await TRCache.getExecDetail(currentTeamId, testCaseNumber, TEST_CASE_CACHE_TTL_MS);
        if (res) {
            console.debug('[CACHE][EXEC] HIT', { teamId: currentTeamId, testCaseNumber, ts: res.ts });
        } else {
            console.debug('[CACHE][EXEC] MISS', { teamId: currentTeamId, testCaseNumber });
        }
        return res;
    } catch (e) {
        console.debug('[CACHE][EXEC] MISS (error)', { teamId: currentTeamId, testCaseNumber, error: e && e.message });
        return null;
    }
}

async function setCachedTestCase(testCaseNumber, testCaseData) {
    try {
        if (!currentTeamId) { console.debug('[CACHE][EXEC] SKIP WRITE: no teamId', { testCaseNumber }); return; }
        if (!testCaseNumber) { console.debug('[CACHE][EXEC] SKIP WRITE: no testCaseNumber'); return; }

        // 若快取已存在且內容相同，避免重覆寫入
        try {
            const existing = await TRCache.getExecDetail(currentTeamId, testCaseNumber, TEST_CASE_CACHE_TTL_MS);
            const pick = (tc) => {
                if (!tc) return null;
                return {
                    record_id: tc.record_id || null,
                    test_case_number: tc.test_case_number || null,
                    title: tc.title || null,
                    priority: tc.priority || null,
                    precondition: tc.precondition || null,
                    steps: tc.steps || null,
                    expected_result: tc.expected_result || null,
                    updated_at: tc.updated_at || null,
                    attachment_count: Array.isArray(tc.attachments) ? tc.attachments.length : 0,
                };
            };
            const eq = (a, b) => JSON.stringify(a) === JSON.stringify(b);
            if (existing && eq(pick(existing.data), pick(testCaseData))) {
                console.debug('[CACHE][EXEC] SKIP WRITE: identical', { teamId: currentTeamId, testCaseNumber });
                return;
            }
        } catch (_) {}

        console.debug('[CACHE][EXEC] WRITE', { teamId: currentTeamId, testCaseNumber });
        await TRCache.setExecDetail(currentTeamId, testCaseNumber, testCaseData);
    } catch (e) {
        console.debug('[CACHE][EXEC] WRITE FAILED', { teamId: currentTeamId, testCaseNumber, error: e && e.message });
    }
}

// 判斷是否為新鮮快取
function isFreshCache(cached) {
    return cached && (Date.now() - cached.ts) < TEST_CASE_CACHE_TTL_MS;
}

// 以 test_case_number 從後端取得詳細並寫入快取
async function fetchAndCacheTestCase(testCaseNumber) {
    if (!testCaseNumber) return;
    try {
        const url = new URL(`/api/teams/${currentTeamId}/testcases/`, window.location.origin);
        url.searchParams.set('search', testCaseNumber);
        url.searchParams.set('limit', '1');
        const resp = await window.AuthClient.fetch(url);
        if (!resp.ok) return;
        const list = await resp.json();
        const tc = Array.isArray(list) ? list.find(t => t.test_case_number === testCaseNumber) : null;
        if (tc) await setCachedTestCase(testCaseNumber, tc);
    } catch (_) {}
}

// 針對目前的 Test Run Items 預先載入所有 Test Case 詳細
async function prefetchTestCasesForItems(items) {
    try {
        const numbers = (items || []).map(i => i.test_case_number).filter(Boolean);
        if (numbers.length === 0) return;
        // 過濾已新鮮快取者（非同步檢查）
        const toFetch = [];
        for (const n of numbers) {
            const cached = await getCachedTestCase(n);
            if (!isFreshCache(cached)) toFetch.push(n);
        }
        console.debug('[CACHE][EXEC] Prefetch plan', { teamId: currentTeamId, total: numbers.length, needFetch: toFetch.length });
        if (toFetch.length === 0) return;
        // 控制併發量，避免過多同時請求
        const queue = Array.from(new Set(toFetch)); // 去重
        const concurrency = 5;
        const workers = new Array(Math.min(concurrency, queue.length)).fill(0).map(async () => {
            while (queue.length > 0) {
                const n = queue.pop(); // 先取出，再 await，避免競態
                await fetchAndCacheTestCase(n);
            }
        });
        await Promise.all(workers);
    } catch (e) {
        console.debug('prefetch test cases skipped:', e);
    }
}

// 避免一次性抓取全團隊：僅預先抓取缺少 section 的 items
async function preloadAllTeamTestCasesForRun(items) {
    try {
        const targets = (items || []).filter(it => !hasSectionInfo(it));
        if (!targets.length) return;
        await prefetchTestCasesForItems(targets);
    } catch (e) {
        console.debug('preloadAllTeamTestCasesForRun failed, fallback to prefetch each:', e);
        await prefetchTestCasesForItems(items);
    }
}

// 補齊 items 的 Section 資訊（從快取/預抓資料帶入）
async function hydrateItemSections(items) {
    if (!Array.isArray(items)) return 0;
    const targets = items.filter(it => !hasSectionInfo(it));
    if (!targets.length) return 0;
    let changed = 0;
    const queue = [...targets];
    const concurrency = Math.min(6, queue.length);
    const workers = new Array(concurrency).fill(0).map(async () => {
        while (queue.length > 0) {
            const it = queue.pop();
            if (!it) continue;
            // 若已經有 section id / 名稱就跳過
            const hasId = it.test_case_section_id || (it.test_case_section && (it.test_case_section.id || it.test_case_section.section_id || it.test_case_section.record_id));
            const hasName = it.test_case_section && it.test_case_section.name;
            if (hasId && hasName) continue;

            // 嘗試從預抓的 __exec_section_* 帶入
            if (it.__exec_section_id || it.__exec_section_name) {
                it.test_case_section = it.test_case_section || {};
                if (it.__exec_section_id) {
                    it.test_case_section.id = it.__exec_section_id;
                    it.test_case_section_id = it.test_case_section_id || it.__exec_section_id;
                }
                if (it.__exec_section_name && !it.test_case_section.name) {
                    it.test_case_section.name = it.__exec_section_name;
                }
                continue;
            }

            // 從快取撈 test case 詳細補上 section
            try {
                const cached = await getCachedTestCase(it.test_case_number);
                if (cached && cached.data) {
                    const tc = cached.data;
                    const sec = tc.test_case_section || {};
                    if (sec.id || sec.section_id || sec.record_id) {
                        const sid = sec.id || sec.section_id || sec.record_id;
                        it.test_case_section = it.test_case_section || {};
                        it.test_case_section.id = sid;
                        it.test_case_section_id = it.test_case_section_id || sid;
                        it.__exec_section_id = it.__exec_section_id || sid;
                    }
                    if (sec.name) {
                        it.test_case_section = it.test_case_section || {};
                        it.test_case_section.name = it.test_case_section.name || sec.name;
                        it.__exec_section_name = it.__exec_section_name || sec.name;
                    }
                    changed += 1;
                }
            } catch (_) {
                /* ignore */
            }
        }
    });
    await Promise.all(workers);
    return changed;
}

// 從 items 的 section parent 鏈補充索引（API 可能只給單層）
function rebuildSectionIndexFromItems(items) {
    if (!sectionIndexById) sectionIndexById = new Map();
    const upsert = (id, name, parentId) => {
        if (id == null) return;
        const key = String(id);
        const existing = sectionIndexById.get(key) || {};
        sectionIndexById.set(key, {
            name: name || existing.name || `Section ${key}`,
            parentId: parentId !== undefined ? (parentId !== null ? String(parentId) : null) : (existing.parentId ?? null)
        });
    };
    const visitSectionChain = (section) => {
        if (!section || section.id == null) return;
        const id = section.id || section.section_id || section.record_id;
        const parentId = section.parent?.id ?? section.parent_id ?? null;
        upsert(id, section.name, parentId);
        if (parentId && section.parent) {
            visitSectionChain(section.parent);
        }
    };
    (items || []).forEach(it => {
        if (it && it.test_case_section) {
            visitSectionChain(it.test_case_section);
        }
    });
    resetSectionDisplayNameCache();
}

function scheduleSectionHydration(items) {
    if (sectionHydrationInFlight) return;
    const targets = (items || []).filter(it => !hasSectionInfo(it));
    if (!targets.length) return;

    const run = async () => {
        sectionHydrationInFlight = true;
        try {
            await preloadAllTeamTestCasesForRun(targets);
            const changed = await hydrateItemSections(targets);
            if (changed > 0) {
                normalizeRunItemSectionInfo(items);
                rebuildSectionIndexFromItems(items);
                renderTestRunItems();
                renderTreSectionTree();
            }
        } catch (e) {
            console.debug('scheduleSectionHydration failed:', e);
        } finally {
            sectionHydrationInFlight = false;
        }
    };

    if (typeof requestIdleCallback === 'function') {
        requestIdleCallback(() => run(), { timeout: 1000 });
    } else {
        setTimeout(run, 0);
    }
}

// 在 Test Run 項目清單中，根據目前 Test Case 移動到前/後一筆
async function navigateExecCase(currentTestCase, step) {
    if (!Array.isArray(testRunItems) || testRunItems.length === 0) return;
    const idx = testRunItems.findIndex(i => i.test_case_number === currentTestCase.test_case_number);
    if (idx < 0) return;
    const newIdx = idx + step;
    if (newIdx < 0 || newIdx >= testRunItems.length) return;
    const nextItem = testRunItems[newIdx];
    if (!nextItem) return;
    // 重用現有流程：以 test_case_number 載入詳細
    await showTestCaseDetailModal(nextItem.test_case_number);
}

// 移除 Modal 內更新結果的輔助函式（已回滾設計）

function showTestCaseDetailError() {
    const loadingEl = document.getElementById('testCaseDetailLoading');
    const bodyRowEl = document.getElementById('testCaseDetailBodyRow');
    const errorEl = document.getElementById('testCaseDetailError');

    if (loadingEl) loadingEl.style.display = 'none';
    if (bodyRowEl) bodyRowEl.style.display = 'none';
    if (errorEl) errorEl.style.display = 'block';
}

async function updateAssignee(itemId, assigneeName) {
    if (!getTrePermissions().canAssign) {
        showExecutionPermissionDenied();
        return;
    }
    try {
        // 清理輸入值
        const cleanAssignee = assigneeName ? assigneeName.trim() : '';
        
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/${itemId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                assignee_name: cleanAssignee || null
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        // 更新本地資料
        const itemIndex = testRunItems.findIndex(item => item.id === itemId);
        if (itemIndex !== -1) {
            testRunItems[itemIndex].assignee_name = cleanAssignee || null;
        }
        
        // 不顯示成功訊息，讓編輯過程更流暢
        
    } catch (error) {
        console.error('Failed to update assignee:', error);
        AppUtils.showError('{{ i18n.t("testRun.updateAssigneeFailed") if i18n else "更新執行者失敗" }}' + ': ' + error.message);
        
        // 恢復原始值
        const input = document.querySelector(`input[data-item-id="${itemId}"]`);
        if (input) {
            const originalItem = testRunItems.find(item => item.id === itemId);
            input.value = originalItem ? (originalItem.assignee_name || '') : '';
        }
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// Markdown 渲染輔助函數
function renderMarkdown(content) {
    if (!content) return '';
    
    if (typeof marked !== 'undefined') {
        try {
            return marked.parse(content);
        } catch (error) {
            console.error('Markdown parse error:', error);
            // 如果 Markdown 渲染失敗，回退到純文字顯示
            return `<pre style="white-space: pre-wrap; font-size: 0.9rem;">${escapeHtml(content)}</pre>`;
        }
    } else {
        // 如果 marked 庫未載入，回退到純文字顯示
        return `<pre style="white-space: pre-wrap; font-size: 0.9rem;">${escapeHtml(content)}</pre>`;
    }
}

// 處理附件點擊事件
function handleAttachmentClick(attachmentName, fileToken, fileUrl) {
    // 1) 本地附件：直接打開 /attachments 相對路徑
    if (fileUrl && fileUrl.trim().startsWith('/attachments')) {
        window.open(fileUrl, '_blank', 'noopener,noreferrer');
        return;
    }
    
    // 2) 絕對 URL：直接開啟
    if (fileUrl && /^(https?:)?\/\//i.test(fileUrl.trim())) {
        window.open(fileUrl, '_blank', 'noopener,noreferrer');
        return;
    }

    // 3) 仍需走代理（保留相容）
    if ((fileToken && fileToken.trim() !== '') || (fileUrl && fileUrl.trim() !== '')) {
        try {
            const proxyUrl = new URL(`/api/attachments/teams/${currentTeamId}/attachments/download`, window.location.origin);
            if (fileUrl && fileUrl.trim() !== '') {
                proxyUrl.searchParams.set('file_url', fileUrl);
            } else if (fileToken && fileToken.trim() !== '') {
                proxyUrl.searchParams.set('file_token', fileToken);
            }
            if (attachmentName && attachmentName.trim() !== '') {
                proxyUrl.searchParams.set('filename', attachmentName);
            }
            window.open(proxyUrl.toString(), '_blank', 'noopener,noreferrer');
            return;
        } catch (error) {
            console.error('構建代理下載 URL 失敗:', error);
        }
    }
    
    // 4) 沒有可用資訊：顯示說明
    showAttachmentInfo(attachmentName, fileToken, fileUrl);
}

// 顯示附件信息
function showAttachmentInfo(attachmentName, fileToken, fileUrl) {
    const modalHtml = `
        <div class="modal fade" id="attachmentInfoModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-paperclip me-2"></i>
                            <span data-i18n="testRun.attachmentDetails">附件詳情</span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <table class="table table-borderless">
                            <tr>
                                <td class="fw-bold" data-i18n="testRun.attachmentName">附件名稱:</td>
                                <td>${escapeHtml(attachmentName)}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold">File Token:</td>
                                <td><code style="font-size: 0.8rem; word-break: break-all;">${escapeHtml(fileToken)}</code></td>
                            </tr>
                            ${fileUrl ? `
                            <tr>
                                <td class="fw-bold">URL:</td>
                                <td><a href="${escapeHtml(fileUrl)}" target="_blank" rel="noopener">${escapeHtml(fileUrl)}</a></td>
                            </tr>
                            ` : ''}
                        </table>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <span data-i18n="testRun.attachmentNote">此附件存儲在 Lark 中。如需下載，請前往原始 Lark 多維表格查看。</span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="common.close">關閉</button>
                        ${(fileUrl || fileToken) ? `
                        <button type="button" class="btn btn-primary" onclick="handleAttachmentDownload('${escapeHtml(attachmentName)}', '${fileToken}', '${escapeHtml(fileUrl)}')">
                            <i class="fas fa-download me-2"></i>
                            <span data-i18n="testRun.downloadAttachment">下載附件</span>
                        </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>`;
    
    // 移除舊的模態框（如果存在）
    const existingModal = document.getElementById('attachmentInfoModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // 添加新的模態框到頁面
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // 顯示模態框
    const modal = new bootstrap.Modal(document.getElementById('attachmentInfoModal'));
    
    // 應用翻譯（如果可用）
    if (window.i18n && window.i18n.isReady()) {
        window.i18n.retranslate(document.getElementById('attachmentInfoModal'));
    }
    
    modal.show();
    
    // 模態框關閉後清理
    document.getElementById('attachmentInfoModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}

// 處理附件下載（從信息模態框中）
function handleAttachmentDownload(attachmentName, fileToken, fileUrl) {
    // 1) 本地附件：直接開啟 /attachments 相對路徑
    if (fileUrl && fileUrl.trim().startsWith('/attachments')) {
        window.open(fileUrl, '_blank', 'noopener,noreferrer');
        return;
    }
    // 2) 絕對 URL：直接開啟
    if (fileUrl && /^(https?:)?\/\//i.test(fileUrl.trim())) {
        window.open(fileUrl, '_blank', 'noopener,noreferrer');
        return;
    }

    // 3) 走代理（保留相容）
    if ((fileToken && fileToken.trim() !== '') || (fileUrl && fileUrl.trim() !== '')) {
        try {
            const proxyUrl = new URL(`/api/attachments/teams/${currentTeamId}/attachments/download`, window.location.origin);
            if (fileUrl && fileUrl.trim() !== '') {
                proxyUrl.searchParams.set('file_url', fileUrl);
            } else if (fileToken && fileToken.trim() !== '') {
                proxyUrl.searchParams.set('file_token', fileToken);
            }
            if (attachmentName && attachmentName.trim() !== '') {
                proxyUrl.searchParams.set('filename', attachmentName);
            }
            window.open(proxyUrl.toString(), '_blank', 'noopener,noreferrer');
        } catch (error) {
            console.error('構建附件下載 URL 失敗:', error);
            const errorMessage = window.i18n ? window.i18n.t('errors.attachmentDownloadFailed', {}, '附件下載失敗') : '附件下載失敗';
            AppUtils.showError(errorMessage + ': ' + error.message);
        }
    } else {
        const warningMessage = window.i18n ? window.i18n.t('errors.noAttachmentDownloadInfo', {}, '沒有可用的附件下載信息') : '沒有可用的附件下載信息';
        AppUtils.showWarning(warningMessage);
    }
}

// ===== JIRA Tooltip 功能 =====

// Tooltip 相關變數
let jiraTooltipTimeout = null;
let currentJiraHoveredElement = null;
let isJiraHoveringTooltip = false;

// 建立 JIRA tooltip 元素
function createJIRATooltip() {
    // 如果已經存在，先移除
    const existingTooltip = document.getElementById('tcg-tooltip-content');
    if (existingTooltip) {
        existingTooltip.remove();
    }

    const tooltip = document.createElement('div');
    tooltip.id = 'tcg-tooltip-content';
    tooltip.className = 'tcg-tooltip-content';
    tooltip.style.position = 'fixed';
    tooltip.style.display = 'none';

    document.body.appendChild(tooltip);
    return tooltip;
}

// 從 JIRA 取得 ticket 資訊
async function fetchJIRATicketInfo(tcgNumber) {
    try {
        const response = await window.AuthClient.fetch(`/api/jira/ticket/${tcgNumber}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            const data = await response.json();
            return data;
        } else if (response.status === 404) {
            return null;
        } else {
            console.error('JIRA API 錯誤:', response.status, response.statusText);
            return null;
        }
    } catch (error) {
        console.error('取得 JIRA ticket 資訊失敗:', error);
        return null;
    }
}

// 格式化 ticket tooltip 內容
function formatJIRATicketTooltip(tcgNumber, ticketData) {
    const summary = ticketData.summary || '無標題';
    const status = ticketData.status?.name || '未知狀態';
    const assignee = ticketData.assignee?.displayName || '未指派';
    const url = ticketData.url || `https://jira.example.com/browse/${tcgNumber}`;

    let statusClass = 'status-todo';
    if (status.toLowerCase().includes('in progress')) {
        statusClass = 'status-in-progress';
    } else if (status.toLowerCase().includes('done') || status.toLowerCase().includes('resolved')) {
        statusClass = 'status-done';
    }

    return `
        <div class="tcg-tooltip-header">
            <div class="tcg-ticket-info">
                <span class="tcg-ticket-number">${tcgNumber}</span>
                <span class="tcg-ticket-status ${statusClass}">${status}</span>
            </div>
        </div>

        <div class="tcg-ticket-content">
            <div class="tcg-ticket-title">${summary}</div>

            <div class="tcg-ticket-meta">
                <div class="tcg-assignee">
                    <span class="tcg-label">負責人:</span>
                    <span class="tcg-value">${assignee}</span>
                </div>
            </div>
        </div>

        <div class="tcg-tooltip-footer">
            <a href="${url}" target="_blank" class="tcg-jira-link">
                <i class="fas fa-external-link-alt me-1"></i>
                在 JIRA 中檢視
            </a>
        </div>
    `;
}

// 定位 tooltip
function positionJIRATooltip(tooltip, element) {
    if (!element || !tooltip) return;
    
    const rect = element.getBoundingClientRect();
    
    // 先設置初始位置並確保可見，這樣才能獲取準確的尺寸
    tooltip.style.visibility = 'hidden';
    tooltip.style.display = 'block';
    
    const tooltipRect = tooltip.getBoundingClientRect();

    // 預設位置：元素下方
    let top = rect.bottom + 8;
    let left = rect.left + (rect.width / 2) - (tooltipRect.width / 2);

    // 如果下方空間不足，顯示在元素上方
    if (top + tooltipRect.height > window.innerHeight - 8) {
        top = rect.top - tooltipRect.height - 8;
    }

    // 確保不超出視窗邊界
    if (left < 8) {
        left = 8;
    } else if (left + tooltipRect.width > window.innerWidth - 8) {
        left = window.innerWidth - tooltipRect.width - 8;
    }

    // 應用最終位置並顯示
    tooltip.style.top = top + 'px';
    tooltip.style.left = left + 'px';
    tooltip.style.visibility = 'visible';
}

// Test Run 頁面的 TCG 預覽函數
async function showTCGPreviewInTestRun(tcgNumber, eventObj) {
    if (!tcgNumber || !tcgNumber.trim()) {
        return;
    }
    
    // 找到觸發元素（查找包含該 TCG 號碼的按鈕）
    const triggerButton = eventObj ? eventObj.target : event.target;
    
    const tooltip = createJIRATooltip();

    // 設定載入狀態
    tooltip.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span>載入中...</span>
        </div>
    `;

    // 顯示 tooltip
    positionJIRATooltip(tooltip, triggerButton);

    try {
        const ticketData = await fetchJIRATicketInfo(tcgNumber);

        if (ticketData) {
            tooltip.innerHTML = formatJIRATicketTooltip(tcgNumber, ticketData);
        } else {
            tooltip.innerHTML = `
                <div class="text-muted small">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    無法取得 ${tcgNumber} 的資訊
                </div>
            `;
        }
        
        // 重新定位
        positionJIRATooltip(tooltip, triggerButton);
        
        // 添加點擊關閉事件
        tooltip.addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        // 點擊其他地方關閉 tooltip
        const closeTooltip = function(e) {
            if (!tooltip.contains(e.target) && e.target !== triggerButton) {
                tooltip.style.display = 'none';
                document.removeEventListener('click', closeTooltip);
            }
        };
        
        setTimeout(() => {
            document.addEventListener('click', closeTooltip);
        }, 100);
        
        // 自動隱藏 tooltip
        setTimeout(() => {
            if (tooltip && tooltip.style.display !== 'none') {
                tooltip.style.display = 'none';
                document.removeEventListener('click', closeTooltip);
            }
        }, 8000);
        
    } catch (error) {
        console.error('JIRA tooltip 載入失敗:', error);
        tooltip.innerHTML = `
            <div class="text-danger small">
                <i class="fas fa-times-circle me-1"></i>
                載入失敗
            </div>
        `;
        
        // 重新定位
        positionJIRATooltip(tooltip, triggerButton);
        
        // 添加點擊關閉事件
        tooltip.addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        // 點擊其他地方關閉 tooltip
        const closeTooltip = function(e) {
            if (!tooltip.contains(e.target) && e.target !== triggerButton) {
                tooltip.style.display = 'none';
                document.removeEventListener('click', closeTooltip);
            }
        };
        
        setTimeout(() => {
            document.addEventListener('click', closeTooltip);
        }, 100);
        
        // 自動隱藏 tooltip
        setTimeout(() => {
            if (tooltip && tooltip.style.display !== 'none') {
                tooltip.style.display = 'none';
                document.removeEventListener('click', closeTooltip);
            }
        }, 5000);
    }
}

// ================== Bug Tickets 功能 ==================
let addBugTicketModal = null;
let deleteBugTicketModal = null;
let currentItemIdForBugTicket = null;
let currentTicketNumberForDelete = null;

// 初始化 Bug Ticket Modal
function initBugTicketModal() {
    if (!addBugTicketModal) {
        addBugTicketModal = new bootstrap.Modal(document.getElementById('addBugTicketModal'));
    }
    
    // 確保 Bug Ticket Modal 有最高的 z-index (高於 Test Case Detail Modal)
    const modalElement = document.getElementById('addBugTicketModal');
    modalElement.style.zIndex = '1090';
    
    // 設置 Modal 事件監聽器來處理 backdrop z-index
    modalElement.addEventListener('shown.bs.modal', function() {
        // 找到最新的 backdrop 並設置正確的 z-index
        const backdrops = document.querySelectorAll('.modal-backdrop');
        if (backdrops.length > 0) {
            // 設置最新的 backdrop 有較高的 z-index
            const latestBackdrop = backdrops[backdrops.length - 1];
            latestBackdrop.style.zIndex = '1089';
        }
        
        // 確保 Modal 本身的 z-index 是最高的
        modalElement.style.zIndex = '1090';
    });
}

// 初始化刪除 Bug Ticket Modal
function initDeleteBugTicketModal() {
    if (!deleteBugTicketModal) {
        deleteBugTicketModal = new bootstrap.Modal(document.getElementById('deleteBugTicketModal'));
    }
    
    // 確保刪除 Bug Ticket Modal 有最高的 z-index
    const modalElement = document.getElementById('deleteBugTicketModal');
    modalElement.style.zIndex = '1090';
    
    // 設置 Modal 事件監聽器來處理 backdrop z-index
    modalElement.addEventListener('shown.bs.modal', function() {
        const backdrops = document.querySelectorAll('.modal-backdrop');
        if (backdrops.length > 0) {
            const latestBackdrop = backdrops[backdrops.length - 1];
            latestBackdrop.style.zIndex = '1089';
        }
        modalElement.style.zIndex = '1090';
    });
}

// 顯示 Bug Tickets
async function loadBugTickets(itemId) {
    try {
        // 顯示載入狀態
        const bugTicketsList = document.getElementById('bugTicketsList');
        const bugTicketsEmpty = document.getElementById('bugTicketsEmpty');
        const bugTicketsLoading = document.getElementById('bugTicketsLoading');

        if (bugTicketsLoading) bugTicketsLoading.style.display = 'block';
        if (bugTicketsEmpty) bugTicketsEmpty.style.display = 'none';
        if (bugTicketsList) bugTicketsList.innerHTML = '';
        
        const url = `/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/${itemId}/bug-tickets`;
        
        const response = await window.AuthClient.fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: Failed to load bug tickets`);
        }
        
        const bugTickets = await response.json();
        
        bugTicketsLoading.style.display = 'none';
        
        if (bugTickets.length === 0) {
            bugTicketsEmpty.style.display = 'block';
            bugTicketsList.innerHTML = '';
        } else {
            bugTicketsEmpty.style.display = 'none';
            bugTicketsList.innerHTML = bugTickets.map(ticket => {
                // 顯示時使用清理後的版本，但保留原始值用於刪除
                const cleanedTicket = cleanTicketNumber(ticket.ticket_number);
                const escapedCleanedTicket = escapeHtml(cleanedTicket);
                // 保留原始 ticket number 用於 API 呼叫（進行 HTML 轉義但不清理）
                const escapedOriginalTicket = escapeHtml(ticket.ticket_number);
                return `
                <div class="bug-ticket-item d-flex justify-content-between align-items-center mb-2 p-2 border rounded bg-light">
                    <div>
                        <strong class="bug-ticket-link" data-ticket="${escapedOriginalTicket}" style="cursor: pointer; color: #0066cc;">
                            ${escapedCleanedTicket}
                        </strong>
                    </div>
                    <button type="button" class="btn btn-secondary text-secondary p-0" data-item-id="${itemId}" data-ticket-original="${escapedOriginalTicket}" data-i18n-title="common.delete" style="border: none; background: none;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            }).join('');

            // 綁定刪除按鈕事件（使用事件委託）
            bugTicketsList.querySelectorAll('.btn-secondary').forEach(btn => {
                btn.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-item-id');
                    // 使用原始的 ticket number 進行刪除
                    const ticketNumber = this.getAttribute('data-ticket-original');
                    confirmDeleteBugTicket(parseInt(itemId), ticketNumber);
                });
            });

            // 重新翻譯動態添加的元素
            if (window.i18n && window.i18n.isReady()) {
                window.i18n.retranslate(bugTicketsList);
            }
        }
        
        return bugTickets;
    } catch (error) {
        console.error('載入 Bug Tickets 失敗:', error);
        const bugTicketsLoading = document.getElementById('bugTicketsLoading');
        const bugTicketsEmpty = document.getElementById('bugTicketsEmpty');
        
        bugTicketsLoading.style.display = 'none';
        bugTicketsEmpty.style.display = 'block';
        bugTicketsEmpty.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i><span data-i18n="testRun.loadBugTicketsFailed">載入 Bug Tickets 失敗</span>';
        return [];
    }
}

// 載入 Comment
async function loadComment(testRunItemId) {
    try {
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/${testRunItemId}/comment`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        const commentContent = document.getElementById('commentContent');
        if (commentContent) {
            // 確保恢復 small class 和 style（如果在編輯模式中被移除）
            if (!commentContent.classList.contains('small')) {
                commentContent.classList.add('small');
            }
            const currentStyle = commentContent.getAttribute('style');
            if (!currentStyle || !currentStyle.includes('white-space: pre-wrap')) {
                commentContent.setAttribute('style', 'flex: 1; overflow-y: auto; white-space: pre-wrap;');
            }

            if (data.comment && data.comment.trim()) {
                const originalMarkdown = data.comment;

                // 使用 marked 库将 markdown 转换为 HTML
                let htmlContent = marked.parse(originalMarkdown);

                // 使用 DOMPurify 清理 HTML，防止 XSS 攻击
                // 配置允许的标签和属性
                const cleanHtml = DOMPurify.sanitize(htmlContent, {
                    ALLOWED_TAGS: ['h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'br', 'strong', 'em', 'u', 'del',
                                  'ul', 'ol', 'li', 'blockquote', 'code', 'pre', 'hr', 'table', 'thead', 'tbody',
                                  'th', 'tr', 'td', 'a', 'img', 'span', 'div'],
                    ALLOWED_ATTR: ['href', 'title', 'alt', 'src', 'class', 'id'],
                    ALLOW_DATA_ATTR: false
                });

                // 在 data attribute 中存储原始 markdown，以便编辑时使用
                commentContent.setAttribute('data-original-markdown', originalMarkdown);

                // 设置渲染的 HTML
                commentContent.innerHTML = cleanHtml;
            } else {
                commentContent.innerHTML = '<span data-i18n="testRun.noComment">尚無註釋</span>';
                commentContent.removeAttribute('data-original-markdown');
            }
        }
    } catch (error) {
        console.error('載入 Comment 失敗:', error);
        const commentContent = document.getElementById('commentContent');
        if (commentContent) {
            commentContent.innerHTML = '<span class="text-danger">載入失敗</span>';
            commentContent.removeAttribute('data-original-markdown');
        }
    }
}

// 編輯 Comment
async function editComment(testRunItemId) {
    if (!getTrePermissions().canUpdateResults) {
        showExecutionPermissionDenied();
        return;
    }

    const commentContent = document.getElementById('commentContent');
    if (!commentContent) return;

    // 如果已經在編輯模式，不要重複進入
    if (document.getElementById('commentTextarea')) {
        return;
    }

    // 檢查是否顯示了"暫無註釋"，如果是則當前評論為空
    const isNoCommentShown = commentContent.querySelector && commentContent.querySelector('[data-i18n="testRun.noComment"]');

    // 優先使用存儲在 data attribute 中的原始 markdown，否則為空
    let currentComment = '';
    if (!isNoCommentShown) {
        const originalMarkdown = commentContent.getAttribute('data-original-markdown');
        if (originalMarkdown) {
            currentComment = originalMarkdown;
        }
    }

    // 儲存原始狀態
    const originalContent = commentContent.innerHTML;
    const originalMarkdown = commentContent.getAttribute('data-original-markdown');
    const hasSmallClass = commentContent.classList.contains('small');
    const originalStyle = commentContent.getAttribute('style');

    // 暫時移除 small class
    if (hasSmallClass) {
        commentContent.classList.remove('small');
    }
    // 調整 style 以配合編輯模式（保持 flex: 1 讓它填滿父容器）
    commentContent.setAttribute('style', 'flex: 1; overflow-y: auto; display: flex; flex-direction: column;');

    // 替換成編輯模式
    commentContent.innerHTML = `
        <textarea class="form-control mb-2" id="commentTextarea" rows="2" placeholder="輸入註釋內容..." style="flex: 1; resize: none; min-height: 60px;">${escapeHtml(currentComment)}</textarea>
        <div class="d-flex gap-2" style="flex-shrink: 0;">
            <button type="button" class="btn btn-primary" id="saveCommentBtn">
                <i class="fas fa-save me-1"></i>儲存
            </button>
            <button type="button" class="btn btn-secondary" id="cancelCommentBtn">
                <i class="fas fa-times me-1"></i>取消
            </button>
        </div>
    `;

    // 聚焦到 textarea
    const textarea = document.getElementById('commentTextarea');
    if (textarea) {
        textarea.focus();
        textarea.setSelectionRange(textarea.value.length, textarea.value.length);
        setupMarkdownHotkeys(textarea);
    }

    // 還原函數
    const restoreOriginal = () => {
        commentContent.innerHTML = originalContent;
        if (originalMarkdown) {
            commentContent.setAttribute('data-original-markdown', originalMarkdown);
        }
        if (hasSmallClass) {
            commentContent.classList.add('small');
        }
        if (originalStyle) {
            commentContent.setAttribute('style', originalStyle);
        }
    };

    // 綁定儲存按鈕事件
    document.getElementById('saveCommentBtn').addEventListener('click', async () => {
        const newComment = textarea.value.trim();
        await saveComment(testRunItemId, newComment);
    });

    // 綁定取消按鈕事件
    document.getElementById('cancelCommentBtn').addEventListener('click', () => {
        restoreOriginal();
    });

    // 綁定鍵盤事件
    textarea.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            restoreOriginal();
        } else if (e.key === 'Enter' && e.ctrlKey) {
            e.preventDefault();
            document.getElementById('saveCommentBtn').click();
        }
    });
}

// 儲存 Comment
async function saveComment(testRunItemId, comment) {
    if (!getTrePermissions().canUpdateResults) {
        showExecutionPermissionDenied();
        return;
    }

    try {
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/${testRunItemId}/comment`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ comment: comment })
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        // 重新載入 comment
        await loadComment(testRunItemId);

        // 顯示成功訊息
        if (window.AppUtils && typeof window.AppUtils.showSuccess === 'function') {
            window.AppUtils.showSuccess('註釋已儲存');
        }

    } catch (error) {
        console.error('儲存 Comment 失敗:', error);
        if (window.AppUtils && typeof window.AppUtils.showError === 'function') {
            window.AppUtils.showError('儲存註釋失敗: ' + error.message);
        }
    }
}

// 清理 Bug Ticket 編號，移除 URL 和特殊字符
function cleanTicketNumber(ticketNumber) {
    if (!ticketNumber) return '';

    // 移除 URL 前綴 (http://, https://, etc.)
    let cleaned = ticketNumber.replace(/^https?:\/\//i, '');

    // 如果包含 '/'，取最後一段（通常是 ticket number）
    if (cleaned.includes('/')) {
        const parts = cleaned.split('/');
        cleaned = parts[parts.length - 1];
    }

    // 移除尾部的特殊字符和空白
    cleaned = cleaned.trim();

    return cleaned;
}

// 新增 Bug Ticket
async function addBugTicket() {
    if (!getTrePermissions().canManageBugTickets) {
        showExecutionPermissionDenied();
        return;
    }
    const rawTicketNumber = document.getElementById('bugTicketNumber').value.trim();
    const ticketNumber = cleanTicketNumber(rawTicketNumber);

    if (!ticketNumber) {
        AppUtils.showError(window.i18n ? window.i18n.t('testRun.ticketNumberHelp') : '請輸入 JIRA Ticket 編號');
        return;
    }

    if (!currentItemIdForBugTicket) {
        AppUtils.showError('Missing item ID');
        return;
    }

    try {
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/${currentItemIdForBugTicket}/bug-tickets`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                ticket_number: ticketNumber
            })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to add bug ticket');
        }

        // 關閉模態框並清空表單
        addBugTicketModal.hide();
        document.getElementById('bugTicketNumber').value = '';

        // 重新載入 Bug Tickets 列表
        await loadBugTickets(currentItemIdForBugTicket);

        AppUtils.showSuccess(window.i18n ? window.i18n.t('testRun.bugTicketAdded') : 'Bug Ticket 新增成功');

    } catch (error) {
        console.error('新增 Bug Ticket 失敗:', error);
        AppUtils.showError(error.message || (window.i18n ? window.i18n.t('testRun.addBugTicketFailed') : '新增 Bug Ticket 失敗'));
    }
}

// 顯示刪除 Bug Ticket 確認對話框
function confirmDeleteBugTicket(itemId, ticketNumber) {
    initDeleteBugTicketModal();
    currentItemIdForBugTicket = itemId;
    currentTicketNumberForDelete = ticketNumber;

    // 顯示清理後的票號（更容易閱讀），但實際刪除時使用原始值
    const displayTicketNumber = cleanTicketNumber(ticketNumber);
    document.getElementById('deleteBugTicketNumber').textContent = displayTicketNumber;

    deleteBugTicketModal.show();
}

// 刪除 Bug Ticket
async function deleteBugTicket(itemId, ticketNumber) {
    if (!getTrePermissions().canManageBugTickets) {
        showExecutionPermissionDenied();
        return;
    }
    
    try {
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/${itemId}/bug-tickets/${encodeURIComponent(ticketNumber)}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('Failed to delete bug ticket');
        }
        
        // 重新載入 Bug Tickets 列表
        await loadBugTickets(itemId);
        
        AppUtils.showSuccess(window.i18n ? window.i18n.t('testRun.bugTicketDeleted') : 'Bug Ticket 已刪除');
        
    } catch (error) {
        console.error('刪除 Bug Ticket 失敗:', error);
        AppUtils.showError(error.message || (window.i18n ? window.i18n.t('testRun.deleteBugTicketFailed') : '刪除 Bug Ticket 失敗'));
    }
}

// 綁定 Bug Ticket 相關事件
function bindBugTicketEvents() {
    const permissions = getTrePermissions();
    const canManageBugTickets = permissions.canManageBugTickets;
    // 新增 Bug Ticket 按鈕
    const addBugTicketBtn = document.getElementById('addBugTicketBtn');
    if (addBugTicketBtn) {
        if (canManageBugTickets) {
            addBugTicketBtn.addEventListener('click', () => {
                if (addBugTicketBtn.disabled) {
                    return;
                }

                initBugTicketModal();
                currentItemIdForBugTicket = getCurrentItemId();
                if (currentItemIdForBugTicket) {
                    addBugTicketModal.show();
                    document.getElementById('bugTicketNumber').value = '';
                    setTimeout(() => {
                        document.getElementById('bugTicketNumber').focus();
                    }, 300);
                } else {
                    AppUtils.showError('請先選擇一個測試項目');
                }
            });
        } else {
            addBugTicketBtn.disabled = true;
        }
    }
    
    // 確認新增 Bug Ticket 按鈕
    const confirmAddBugTicket = document.getElementById('confirmAddBugTicket');
    if (confirmAddBugTicket) {
        if (canManageBugTickets) {
            confirmAddBugTicket.addEventListener('click', addBugTicket);
        } else {
            confirmAddBugTicket.disabled = true;
        }
    }

    // 確認刪除 Bug Ticket 按鈕
    const confirmDeleteBugTicketBtn = document.getElementById('confirmDeleteBugTicket');
    if (confirmDeleteBugTicketBtn) {
        if (canManageBugTickets) {
            confirmDeleteBugTicketBtn.addEventListener('click', async () => {
                if (currentItemIdForBugTicket && currentTicketNumberForDelete) {
                    deleteBugTicketModal.hide();
                    await deleteBugTicket(currentItemIdForBugTicket, currentTicketNumberForDelete);
                    // 保留 currentItemIdForBugTicket 以便繼續新增其他 Bug Tickets
                    currentTicketNumberForDelete = null;
                }
            });
        } else {
            confirmDeleteBugTicketBtn.disabled = true;
        }
    }
    
    // Enter 鍵提交表單
    const bugTicketNumberInput = document.getElementById('bugTicketNumber');
    if (bugTicketNumberInput) {
        if (canManageBugTickets) {
            bugTicketNumberInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addBugTicket();
                }
            });
        } else {
            bugTicketNumberInput.setAttribute('disabled', 'true');
        }
    }
    
    // 委託事件：Bug Ticket 點擊預覽
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('bug-ticket-link')) {
            const ticketNumber = e.target.getAttribute('data-ticket');
            if (ticketNumber) {
                showBugTicketPreview(ticketNumber, e.target);
            }
        }
    });
}

// 取得當前選中的測試項目 ID
function getCurrentItemId() {
    // 使用在 renderResultHistoryTimeline 中設定的 currentItemIdForBugTicket
    return currentItemIdForBugTicket;
}

// Bug Ticket 直接打開 JIRA 頁面
async function showBugTicketPreview(ticketNumber, triggerElement) {
    try {
        // 獲取 JIRA ticket 資訊（包括 URL）
        const response = await window.AuthClient.fetch(`/api/jira/ticket/${encodeURIComponent(ticketNumber)}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const ticketData = await response.json();

        // 如果成功獲取到 URL，直接在新標籤頁打開
        if (ticketData.url) {
            window.open(ticketData.url, '_blank');
        } else {
            console.error('未能獲取到 JIRA ticket URL');
        }
    } catch (error) {
        console.error('打開 JIRA ticket 失敗:', error);
        // 如果出現錯誤，顯示提示訊息
        alert('無法打開 JIRA ticket，請稍後重試');
    }
}

// JIRA 狀態對應的 Badge 類別
function getJIRAStatusBadgeClass(status) {
    if (!status) return 'bg-secondary';
    
    const statusLower = status.toLowerCase();
    if (['done', 'closed', 'resolved', 'fixed'].includes(statusLower)) {
        return 'bg-success';
    }
    if (['in progress', 'in-progress', 'inprogress'].includes(statusLower)) {
        return 'bg-primary';
    }
    if (['open', 'to do', 'todo', 'new'].includes(statusLower)) {
        return 'bg-info';
    }
    if (['blocked', 'on hold'].includes(statusLower)) {
        return 'bg-danger';
    }
    return 'bg-warning';
}

// ================== Bug Tickets Summary 功能 ==================
let bugTicketsSummaryModal = null;
let currentBugTicketsSummary = null;
let currentBugStatusFilter = 'ALL';

// Bug Tickets 狀態到徽章顏色的映射
function getBugStatusBadgeClass(status) {
    const statusName = (status || '').toUpperCase().trim();
    
    const statusMap = {
        'TO DO': 'bg-primary',
        'TODO': 'bg-primary',
        'IN PROGRESS': 'bg-info', 
        'INPROGRESS': 'bg-info',
        'RESOLVED': 'bg-success',
        'CLOSED': 'bg-dark',
        'OPEN': 'bg-warning',
        'SCHEDULED': 'bg-secondary'
    };
    
    return statusMap[statusName] || 'bg-secondary';
}

// Bug Tickets 狀態篩選功能
function filterBugTicketsByStatus(status) {
    currentBugStatusFilter = status;
    
    // 更新按鈕狀態
    document.querySelectorAll('[data-status]').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-status') === status) {
            btn.classList.add('active');
        }
    });
    
    // 重新渲染
    if (currentBugTicketsSummary) {
        renderBugTicketsCards(currentBugTicketsSummary, document.getElementById('bugTicketsSummaryList'));
        // 重新翻譯動態生成的內容
        if (window.i18n && window.i18n.isReady()) {
            window.i18n.retranslate(document.getElementById('bugTicketsSummaryList'));
        }
    }
}

// 初始化 Bug Tickets Summary Modal
function initBugTicketsSummaryModal() {
    const modalElement = document.getElementById('bugTicketsSummaryModal');
    if (modalElement && !bugTicketsSummaryModal) {
        bugTicketsSummaryModal = new bootstrap.Modal(modalElement);
    } else if (!modalElement) {
        console.error('找不到 bugTicketsSummaryModal 元素');
    }
}

// 顯示 Bug Tickets Summary Modal
async function showBugTicketsModal() {
    initBugTicketsSummaryModal();
    
    if (bugTicketsSummaryModal) {
        bugTicketsSummaryModal.show();
        
        // 延遲一下確保 Modal 完全打開
        setTimeout(() => {
            loadBugTicketsSummary();
        }, 100);
    } else {
        console.error('無法顯示 Modal');
    }
}

// 載入 Bug Tickets Summary 資料
async function loadBugTicketsSummary() {
    const loadingEl = document.getElementById('bugTicketsSummaryLoading');
    const emptyEl = document.getElementById('bugTicketsSummaryEmpty');
    const contentEl = document.getElementById('bugTicketsSummaryContent');
    
    // 檢查所有必要元素
    if (!loadingEl) {
        console.error('找不到 bugTicketsSummaryLoading 元素');
        return;
    }
    if (!emptyEl) {
        console.error('找不到 bugTicketsSummaryEmpty 元素');
        return;
    }
    if (!contentEl) {
        console.error('找不到 bugTicketsSummaryContent 元素');
        return;
    }
    
    // 重置所有狀態
    loadingEl.style.display = 'block';
    emptyEl.style.display = 'none';
    contentEl.style.display = 'none';
    
    try {
        const url = `/api/teams/${currentTeamId}/test-run-configs/${currentConfigId}/items/bug-tickets/summary`;
        const response = await window.AuthClient.fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const summaryData = await response.json();
        currentBugTicketsSummary = summaryData;
        loadingEl.style.display = 'none';
        
        if (!summaryData || summaryData.total_unique_tickets === 0 || !summaryData.tickets || summaryData.tickets.length === 0) {
            emptyEl.style.display = 'block';
            return;
        }
        
        contentEl.style.display = 'block';
        renderBugTicketsSummary(summaryData);
        
    } catch (error) {
        console.error('載入失敗:', error);
        loadingEl.style.display = 'none';
        emptyEl.style.display = 'block';
        emptyEl.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><span class="text-danger">載入失敗: ' + error.message + '</span>';
    }
}

// 渲染 Bug Tickets Summary
function renderBugTicketsSummary(summaryData) {
    const bugTicketsList = document.getElementById('bugTicketsSummaryList');
    
    if (!bugTicketsList) {
        console.error('找不到必要的元素');
        return;
    }
    
    renderBugTicketsCards(summaryData, bugTicketsList);
}

function renderBugTicketsCards(summaryData, bugTicketsList) {
    if (!summaryData.tickets || summaryData.tickets.length === 0) {
        const noBugTicketsText = '{{ i18n.t("testRun.noBugTicketsInRun") if i18n else "此 Test Run 尚無 Bug Tickets" }}';
        bugTicketsList.innerHTML = `<div class="text-muted text-center p-4"><i class="fas fa-info-circle me-2"></i>${noBugTicketsText}</div>`;
        return;
    }
    
    // 根據當前篩選條件過濾 tickets
    let filteredTickets = summaryData.tickets;
    if (currentBugStatusFilter !== 'ALL') {
        filteredTickets = summaryData.tickets.filter(ticket => {
            const statusName = (ticket.ticket_info.status.name || '').toUpperCase().trim();
            const filterStatus = currentBugStatusFilter.toUpperCase().trim();
            return statusName === filterStatus || 
                   (filterStatus === 'IN PROGRESS' && statusName === 'INPROGRESS') ||
                   (filterStatus === 'TO DO' && statusName === 'TODO');
        });
    }
    
    if (filteredTickets.length === 0) {
        const noTicketsForStatusText = '{{ i18n.t("testRun.noTicketsForStatus") if i18n else "此狀態下無 Bug Tickets" }}';
        bugTicketsList.innerHTML = `<div class="text-muted text-center p-4"><i class="fas fa-filter me-2"></i>${noTicketsForStatusText}</div>`;
        return;
    }
    
    let cardsHTML = '';
    
    filteredTickets.forEach(ticket => {
        const ticketInfo = ticket.ticket_info;
        const testCases = ticket.test_cases;
        
        let testCasesHTML = '';
        testCases.forEach(testCase => {
            testCasesHTML += `
                <div class="border rounded p-2 mb-2 bg-white" style="cursor: pointer;" 
                     onclick="showTestCaseQuickView('${testCase.test_case_number}')">
                    <strong class="text-primary">${testCase.test_case_number}</strong><br>
                    <small class="text-muted">${testCase.title || ''}</small>
                </div>
            `;
        });
        
        // 使用新的狀態顏色映射函數
        const badgeClass = getBugStatusBadgeClass(ticketInfo.status.name);
        
        cardsHTML += `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <h6 class="card-title">
                                <a href="${ticketInfo.url}" target="_blank" class="text-decoration-none">
                                    ${ticketInfo.ticket_number} 
                                    <i class="fas fa-external-link-alt fa-sm"></i>
                                </a>
                            </h6>
                            <span class="badge ${badgeClass}">${ticketInfo.status.name}</span>
                            <p class="card-text mt-2">
                                <small class="text-muted">${ticketInfo.summary || 'No summary available'}</small>
                            </p>
                        </div>
                        <div class="col-md-8">
                            <h6><i class="fas fa-list-ul me-1"></i><span data-i18n="testRun.relatedTestCases">相關測試案例</span>
                                <span class="badge bg-info">${testCases.length}</span>
                            </h6>
                            <div style="max-height: 200px; overflow-y: auto;">
                                ${testCasesHTML}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    bugTicketsList.innerHTML = cardsHTML;
}



// 重新整理 Bug Tickets 狀態（呼叫 JIRA API 更新狀態）
async function refreshBugTicketsStatus() {
    if (!currentBugTicketsSummary || currentBugTicketsSummary.total_unique_tickets === 0) {
        return;
    }
    
    // 顯示重新整理進度
    const refreshBtn = document.querySelector('button[onclick="refreshBugTicketsStatus()"]');
    const originalHtml = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>更新中...';
    refreshBtn.disabled = true;
    
    try {
        // 依序呼叫 JIRA API 更新每個 ticket 的狀態
        for (let ticket of currentBugTicketsSummary.tickets) {
            try {
                const response = await window.AuthClient.fetch(`/api/jira/ticket/${encodeURIComponent(ticket.ticket_info.ticket_number)}`);
                if (response.ok) {
                    const jiraData = await response.json();
                    // 更新本地資料
                    ticket.ticket_info.status = jiraData.status;
                    ticket.ticket_info.summary = jiraData.summary;
                }
            } catch (error) {
                console.warn(`Failed to update ticket ${ticket.ticket_info.ticket_number}:`, error);
            }
        }
        
        // 重新渲染
        renderBugTicketsSummary(currentBugTicketsSummary);
        AppUtils.showSuccess('Bug Tickets 狀態已更新');
        
    } catch (error) {
        console.error('重新整理 Bug Tickets 狀態失敗:', error);
        AppUtils.showError('更新狀態失敗: ' + error.message);
    } finally {
        refreshBtn.innerHTML = originalHtml;
        refreshBtn.disabled = false;
    }
}

// 測試案例快速預覽（使用瀏覽器 popup）
function showTestCaseQuickView(testCaseNumber) {
    // 直接使用現有的 Test Case Detail Modal
    showTestCaseDetailModal(testCaseNumber);
}

// Charts & Reports 功能
document.getElementById('exportBtn').addEventListener('click', function() {
    showChartsReportsModal();
});

function showChartsReportsModal() {
    const modal = new bootstrap.Modal(document.getElementById('chartsReportsModal'));
    modal.show();
    // Modal 顯示後載入圖表
    document.getElementById('chartsReportsModal').addEventListener('shown.bs.modal', function() {
        // 稍微延遲以確保所有元素都已渲染
        setTimeout(() => {
            initializeChartsAndReports();
        }, 200);
    }, { once: true });
}

async function initializeChartsAndReports() {
    try {
        // 顯示載入狀態
        showChartsLoading();
        
        // 收集統計資料
        const statsData = collectTestRunStats();
        
        // 更新基本資訊
        updateReportBasicInfo(statsData);
        
        // 渲染圖表
        await renderTestRunCharts(statsData);
        
        // 隱藏載入狀態
        hideChartsLoading();
        
    } catch (error) {
        console.error('初始化圖表失敗:', error);
        hideChartsLoading();
        showChartsError();
    }
}

function collectTestRunStats() {
    const stats = {
        statusData: {
            passed: 0,
            failed: 0,
            retest: 0,
            notAvailable: 0,
            pending: 0,
            notRequired: 0,
            skip: 0,
            notExecuted: 0
        },
        priorityData: {
            high: 0,
            medium: 0,
            low: 0
        },
        testRunInfo: {
            name: testRunConfig?.name || 'Test Run',
            environment: testRunConfig?.test_environment || '',
            buildNumber: testRunConfig?.build_number || '',
            version: testRunConfig?.test_version || '',
            totalItems: parseInt(document.getElementById('total-count')?.textContent || '0'),
            executedItems: parseInt(document.getElementById('executed-count')?.textContent || '0'),
            executionRate: document.getElementById('execution-rate')?.textContent || '0%',
            passRate: document.getElementById('pass-rate')?.textContent || '0%'
        }
    };
    
    // 從 testRunItems 計算詳細統計
    if (testRunItems && Array.isArray(testRunItems)) {
        testRunItems.forEach(item => {
            // 計算測試結果分布
            switch (item.test_result) {
                case 'Passed':
                    stats.statusData.passed++;
                    break;
                case 'Failed':
                    stats.statusData.failed++;
                    break;
                case 'Retest':
                    stats.statusData.retest++;
                    break;
                case 'Not Available':
                    stats.statusData.notAvailable++;
                    break;
                case 'Pending':
                    stats.statusData.pending++;
                    break;
                case 'Not Required':
                    stats.statusData.notRequired++;
                    break;
                case 'Skip':
                    stats.statusData.skip++;
                    break;
                default:
                    stats.statusData.notExecuted++;
                    break;
            }
            
            // 計算優先級分布
            switch (item.priority) {
                case 'High':
                    stats.priorityData.high++;
                    break;
                case 'Medium':
                    stats.priorityData.medium++;
                    break;
                case 'Low':
                    stats.priorityData.low++;
                    break;
            }
        });
    }
    
    return stats;
}

function applyExternalTestCaseUpdate(update) {
    try {
        if (!update || !update.test_case_number) return;
        if (update.teamId && currentTeamId && String(update.teamId) !== String(currentTeamId)) return;
        if (!Array.isArray(testRunItems)) return;

        const index = testRunItems.findIndex(it => it.test_case_number === update.test_case_number);
        if (index === -1) return;

        const item = testRunItems[index];

        if (update.deleted) {
            ['title', 'priority', 'precondition', 'steps', 'expected_result'].forEach(field => {
                if (Object.prototype.hasOwnProperty.call(update, field)) {
                    item[field] = update[field] ?? '';
                } else if (field !== 'title') {
                    item[field] = '';
                }
            });
            item.__testCaseDeleted = true;
            try {
                TRCache.removeExecDetail(currentTeamId, item.test_case_number);
            } catch (_) {}

            if (currentDetailTestCase && currentDetailTestCase.test_case_number === update.test_case_number) {
                try {
                    const modalEl = document.getElementById('testCaseDetailModal');
                    if (modalEl) {
                        const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                        modalInstance.hide();
                    }
                } catch (_) {}
                currentDetailTestCase = null;
            }
        } else {
            ['title', 'priority', 'precondition', 'steps', 'expected_result'].forEach(field => {
                if (Object.prototype.hasOwnProperty.call(update, field)) {
                    const value = update[field];
                    if (typeof value !== 'undefined' && value !== null) {
                        item[field] = value;
                    }
                }
            });
            item.__testCaseDeleted = false;
        }

        renderTestRunItems();

        try {
            initializeChartsAndReports();
        } catch (chartError) {
            console.debug('重新整理圖表失敗（忽略）:', chartError);
        }

        if (!update.deleted && currentDetailTestCase && currentDetailTestCase.test_case_number === update.test_case_number) {
            loadTestCaseDetail(update.test_case_number).catch(detailError => {
                console.debug('重新載入測試案例詳情失敗（忽略）:', detailError);
            });
        }

        try {
            updateStatistics();
        } catch (_) {}
    } catch (error) {
        console.debug('處理測試案例更新事件失敗:', error);
    }
}

function updateReportBasicInfo(statsData) {
    // 更新基本資訊
    document.getElementById('reportTestRunName').textContent = statsData.testRunInfo.name;
    document.getElementById('reportEnvironment').textContent = statsData.testRunInfo.environment || '-';
    document.getElementById('reportBuildNumber').textContent = statsData.testRunInfo.buildNumber || '-';
    
    // 更新執行摘要
    document.getElementById('reportTotalItems').textContent = statsData.testRunInfo.totalItems;
    document.getElementById('reportExecutedItems').textContent = statsData.testRunInfo.executedItems;
    document.getElementById('reportExecutionRate').textContent = statsData.testRunInfo.executionRate;
    document.getElementById('reportPassRate').textContent = statsData.testRunInfo.passRate;
    
    // 更新統計卡片
    document.getElementById('chartPassedCount').textContent = statsData.statusData.passed;
    document.getElementById('chartFailedCount').textContent = statsData.statusData.failed;
    document.getElementById('chartRetestCount').textContent = statsData.statusData.retest;
    document.getElementById('chartNotAvailableCount').textContent = statsData.statusData.notAvailable;
    document.getElementById('chartPendingCount').textContent = statsData.statusData.pending;
    document.getElementById('chartNotRequiredCount').textContent = statsData.statusData.notRequired;
}

let testRunCharts = {};

async function renderTestRunCharts(statsData) {
    // 清理舊圖表
    Object.values(testRunCharts).forEach(chart => {
        if (chart) chart.destroy();
    });
    testRunCharts = {};
    
    // 確保 Chart.js 已載入
    if (typeof Chart === 'undefined') {
        throw new Error('Chart.js not loaded');
    }

    // 註冊 DataLabels 插件（如果可用）
    try {
        if (typeof ChartDataLabels !== 'undefined') {
            Chart.register(ChartDataLabels);
        } else {
            console.warn('ChartDataLabels 插件未載入，圖表將不顯示數據標籤');
        }
    } catch (error) {
        console.warn('註冊 ChartDataLabels 插件時出錯:', error);
    }
    
    // 圖表配色
    const colorScheme = {
        passed: '#28a745',
        failed: '#dc3545',
        retest: '#ffc107',
        notAvailable: '#6c757d',
        pending: '#ffca2c',
        notRequired: '#adb5bd',
        skip: '#0d6efd',
        notExecuted: '#dee2e6',
        high: '#dc3545',
        medium: '#ffc107',
        low: '#28a745'
    };
    
    // 1. 測試狀態分布圓餅圖
    const statusCtx = document.getElementById('statusPieChart');
    if (statusCtx) {
        testRunCharts.statusPie = new Chart(statusCtx, {
            type: 'pie',
            data: {
                labels: ['Passed', 'Failed', 'Retest', 'Not Available', 'Pending', 'Not Required', 'Skip', 'Not Executed'],
                datasets: [{
                    data: [
                        statsData.statusData.passed,
                        statsData.statusData.failed,
                        statsData.statusData.retest,
                        statsData.statusData.notAvailable,
                        statsData.statusData.pending,
                        statsData.statusData.notRequired,
                        statsData.statusData.skip,
                        statsData.statusData.notExecuted
                    ],
                    backgroundColor: [
                        colorScheme.passed,
                        colorScheme.failed,
                        colorScheme.retest,
                        colorScheme.notAvailable,
                        colorScheme.pending,
                        colorScheme.notRequired,
                        colorScheme.skip,
                        colorScheme.notExecuted
                    ],
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1500,
                    easing: 'easeInOutQuart'
                },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.raw / total) * 100).toFixed(1);
                                return `${context.label}: ${context.raw} (${percentage}%)`;
                            }
                        }
                    },
                    ...(typeof ChartDataLabels !== 'undefined' ? {
                        datalabels: {
                            color: 'white',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: (value, context) => {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return percentage > 5 ? percentage + '%' : '';
                            }
                        }
                    } : {})
                }
            }
        });
    }
    
    // 2. 優先級分布長條圖
    const priorityCtx = document.getElementById('priorityBarChart');
    if (priorityCtx) {
        testRunCharts.priorityBar = new Chart(priorityCtx, {
            type: 'bar',
            data: {
                labels: ['高', '中', '低'],
                datasets: [{
                    label: '測試案例數量',
                    data: [
                        statsData.priorityData.high,
                        statsData.priorityData.medium,
                        statsData.priorityData.low
                    ],
                    backgroundColor: [
                        colorScheme.high,
                        colorScheme.medium,
                        colorScheme.low
                    ],
                    borderColor: [
                        colorScheme.high,
                        colorScheme.medium,
                        colorScheme.low
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1200,
                    easing: 'easeInOutQuart'
                },
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
}

function showChartsLoading() {
    const loadingElement = document.getElementById('chartsLoadingOverlay');
    if (loadingElement) {
        // 確保載入畫面可以顯示
        loadingElement.style.display = 'flex';
        loadingElement.style.visibility = 'visible';
        loadingElement.classList.remove('d-none');
    } else {
        console.error('找不到載入畫面元素 chartsLoadingOverlay');
    }
}

function hideChartsLoading() {
    const loadingElement = document.getElementById('chartsLoadingOverlay');
    if (loadingElement) {
        // 使用多種方式確保載入畫面被隱藏
        loadingElement.style.display = 'none';
        loadingElement.style.visibility = 'hidden';
        loadingElement.classList.add('d-none');
        // 強制刷新樣式
        loadingElement.offsetHeight;
    } else {
        console.error('找不到載入畫面元素 chartsLoadingOverlay');
    }
}

function showChartsError() {
    const errorElement = document.getElementById('chartsErrorMessage');
    if (errorElement) {
        errorElement.style.display = 'block';
    }
}

// PDF 下載功能
// 將 Chart.js 圖表轉換為靜態圖片以支援 PDF 列印
async function convertChartsToImages() {
    const conversions = [];
    const canvasElements = document.querySelectorAll('#chartsReportsModal canvas');

    // 首先等待所有圖表完全渲染（包括動畫和插件）
    await waitForAllChartsToRender(canvasElements);

    // 使用 Promise.all 確保所有轉換都完成
    const conversionPromises = Array.from(canvasElements).map((canvas, index) => {
        return new Promise(async (resolve) => {
            try {
                // 確認圖表存在且已渲染
                const chart = Chart.getChart(canvas);
                if (chart) {
                    // 確保圖表處於靜止狀態（禁用動畫效果）
                    const originalAnimation = chart.options.animation;
                    chart.options.animation = false;
                    chart.update('none'); // 立即更新，不使用動畫
                    
                    // 等待更新完成
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    // 獲取高品質的圖片資料，考慮高DPI顯示
                    const deviceRatio = window.devicePixelRatio || 1;
                    const imageData = canvas.toDataURL('image/png', 1.0);
                    
                    // 驗證圖片數據是否有效
                    if (!imageData || imageData === 'data:,' || imageData.length < 100) {
                        throw new Error(`圖表 ${index + 1} 轉換產生無效圖片數據`);
                    }
                    
                    // 創建 img 元素替換 canvas
                    const img = document.createElement('img');
                    img.src = imageData;
                    img.style.width = '100%';
                    img.style.height = 'auto';
                    img.style.maxWidth = '100%';
                    img.style.display = 'block';
                    img.classList.add('chart-image-replacement');
                    
                    // 等待圖片載入完成
                    await new Promise((imgResolve) => {
                        if (img.complete) {
                            imgResolve();
                        } else {
                            img.onload = imgResolve;
                            img.onerror = imgResolve;
                        }
                    });
                    
                    // 保存原始 canvas 以便後續恢復
                    canvas.style.display = 'none';
                    canvas.dataset.originalDisplay = 'block';
                    canvas.dataset.originalAnimation = JSON.stringify(originalAnimation);
                    canvas.parentNode.insertBefore(img, canvas.nextSibling);
                    
                    const conversionResult = { canvas, img, chart, originalAnimation };
                    conversions.push(conversionResult);
                    resolve(conversionResult);
                } else {
                    console.warn(`Canvas ${index + 1} 沒有對應的 Chart 實例`);
                    resolve(null);
                }
            } catch (error) {
                console.error(`圖表 ${index + 1} 轉換失敗:`, error);
                resolve(null);
            }
        });
    });
    
    // 等待所有轉換完成
    await Promise.all(conversionPromises);
    return conversions;
}

// 等待所有圖表完全渲染的輔助函數
async function waitForAllChartsToRender(canvasElements) {
    const chartPromises = Array.from(canvasElements).map(async (canvas, index) => {
        const chart = Chart.getChart(canvas);
        if (chart) {
            return waitForSingleChartRender(chart, index);
        }
        return Promise.resolve();
    });
    
    await Promise.all(chartPromises);
    
    // 額外等待時間確保插件（如 DataLabels）完全渲染
    await new Promise(resolve => setTimeout(resolve, 800));
}

// 等待單個圖表渲染完成
async function waitForSingleChartRender(chart, index) {
    return new Promise(resolve => {
        // 檢查圖表是否正在動畫中
        if (chart.isAnimating && chart.isAnimating()) {
            // Chart.js 3.x 使用 onAnimationComplete
            const originalOnComplete = chart.options.animation?.onComplete;
            chart.options.animation = chart.options.animation || {};
            chart.options.animation.onComplete = function(context) {
                // 恢復原始回調
                if (originalOnComplete) {
                    originalOnComplete.call(this, context);
                }
                resolve();
            };
            
            // 超時保護機制（3秒）
            setTimeout(() => {
                console.warn(`圖表 ${index + 1} 動畫等待超時，強制繼續`);
                resolve();
            }, 3000);
        } else {
            // 如果沒有動畫，短暫等待確保渲染穩定
            setTimeout(resolve, 300);
        }
    });
}

// PDF 下載狀態管理
function showPDFLoadingState() {
    const button = document.getElementById('downloadPDFBtn');
    const icon = document.getElementById('downloadIcon');
    const text = document.getElementById('downloadText');
    
    if (button && icon && text) {
        button.disabled = true;
        button.classList.add('disabled');
        icon.className = 'fas fa-spinner fa-spin me-2';
        text.textContent = window.i18n ? window.i18n.t('testRun.generatingPDF', {}, '正在生成 PDF...') : '正在生成 PDF...';
    }
}

function hidePDFLoadingState() {
    const button = document.getElementById('downloadPDFBtn');
    const icon = document.getElementById('downloadIcon');
    const text = document.getElementById('downloadText');
    
    if (button && icon && text) {
        button.disabled = false;
        button.classList.remove('disabled');
        icon.className = 'fas fa-download me-2';
        text.textContent = window.i18n ? window.i18n.t('testRun.downloadPDF', {}, '下載 PDF 報告') : '下載 PDF 報告';
    }
}

// 恢復 Canvas 圖表元素
function restoreChartsFromImages(conversions) {
    conversions.forEach(({ canvas, img, chart, originalAnimation }, index) => {
        try {
            // 移除替換的圖片
            if (img && img.parentNode) {
                img.parentNode.removeChild(img);
            }
            
            // 恢復原始 canvas
            canvas.style.display = canvas.dataset.originalDisplay || 'block';
            delete canvas.dataset.originalDisplay;
            
            // 恢復原始動畫設置
            if (chart && originalAnimation !== undefined) {
                chart.options.animation = originalAnimation;
                // 如果需要，重新啟用動畫
                if (originalAnimation) {
                    chart.update(); // 使用預設動畫重新渲染
                }
            }
            
            // 清理 dataset
            if (canvas.dataset.originalAnimation) {
                delete canvas.dataset.originalAnimation;
            }
        } catch (error) {
            console.error('恢復圖表時發生錯誤:', error);
        }
    });
}

async function downloadReportAsPDF() {
    // 顯示載入狀態
    showPDFLoadingState();
    
    try {
        // 檢查必要參數
        if (!currentTeamId || !currentConfigId) {
            throw new Error('缺少必要參數：team_id 或 config_id');
        }
        
        // 呼叫後端 API 生成 PDF
        const response = await window.AuthClient.fetch(`/api/teams/${currentTeamId}/test-runs/${currentConfigId}/generate-pdf`, {
            method: 'GET',
            headers: {
                'Accept': 'application/pdf'
            }
        });
        
        if (!response.ok) {
            if (response.status === 404) {
                throw new Error('找不到指定的 Test Run 配置');
            } else if (response.status === 500) {
                throw new Error('伺服器內部錯誤，請重試或聯繫管理員');
            } else {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
        }
        
        // 獲取 PDF 內容
        const pdfBlob = await response.blob();
        
        // 創建下載連結並自動下載
        const url = window.URL.createObjectURL(pdfBlob);
        const link = document.createElement('a');
        link.href = url;
        
        // 設定檔案名稱（包含時間戳記）
        const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
        link.download = `test-run-report-${currentConfigId}-${timestamp}.pdf`;
        
        // 觸發下載
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // 釋放記憶體
        window.URL.revokeObjectURL(url);
        
    } catch (error) {
        console.error('PDF 生成錯誤:', error);
        
        // 使用 i18n 友好的錯誤提示
        const errorMessage = window.i18n ? 
            window.i18n.t('testRun.pdfGenerationFailed', {}, 'PDF 生成失敗，請重試或聯繫管理員') : 
            'PDF 生成失敗，請重試或聯繫管理員';
        
        alert(errorMessage + '\n\n錯誤詳情：' + error.message);
    } finally {
        // 恢復載入狀態
        hidePDFLoadingState();
    }
}

</script>

<!-- Charts & Reports Modal -->
<div class="modal fade" id="chartsReportsModal" tabindex="-1" aria-labelledby="chartsReportsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chartsReportsModalLabel">
                    <i class="fas fa-chart-pie me-2"></i>
                    <span data-i18n="testRun.chartsReports">Charts & Reports</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="position: relative;">
                <!-- 載入覆蓋層 -->
                <div id="chartsLoadingOverlay" class="position-absolute w-100 h-100 d-flex align-items-center justify-content-center bg-white" style="z-index: 1000; display: none; top: 0; left: 0;">
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <div data-i18n="testRun.loadingCharts">載入圖表中...</div>
                    </div>
                </div>
                
                <!-- 錯誤訊息 -->
                <div id="chartsErrorMessage" class="alert alert-danger text-center" style="display: none;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span data-i18n="testRun.chartsLoadError">圖表載入失敗，請重新整理後再試</span>
                </div>
                
                <!-- 報告標題區域 -->
                <div class="text-center mb-4">
                    <h2 class="display-6">
                        <i class="fas fa-chart-pie me-3 text-primary"></i>
                        <span data-i18n="testRun.executionAnalytics">Test Run 執行分析報告</span>
                    </h2>
                    <p class="lead text-muted" data-i18n="testRun.analyticsSubtitle">測試執行狀態分布與統計分析</p>
                </div>
                
                <!-- 基本資訊區域 -->
                <div class="row mb-4 report-section">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <span data-i18n="testRun.basicInfo">基本資訊</span>
                                </h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td><span data-i18n="testRun.configName">名稱</span></td>
                                        <td id="reportTestRunName">-</td>
                                    </tr>
                                    <tr>
                                        <td><span data-i18n="testRun.testEnvironment">測試環境</span></td>
                                        <td id="reportEnvironment">-</td>
                                    </tr>
                                    <tr>
                                        <td><span data-i18n="testRun.buildNumber">建置版本</span></td>
                                        <td id="reportBuildNumber">-</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-chart-bar me-2"></i>
                                    <span data-i18n="testRun.executionSummary">執行摘要</span>
                                </h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td><span data-i18n="testRun.totalItems">總項目</span></td>
                                        <td id="reportTotalItems">0</td>
                                    </tr>
                                    <tr>
                                        <td><span data-i18n="testRun.executedItems">已執行</span></td>
                                        <td id="reportExecutedItems">0</td>
                                    </tr>
                                    <tr>
                                        <td><span data-i18n="testRun.executionRate">執行率</span></td>
                                        <td id="reportExecutionRate">0%</td>
                                    </tr>
                                    <tr>
                                        <td><span data-i18n="testRun.passRate">Pass Rate</span></td>
                                        <td id="reportPassRate">0%</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 圖表區域 -->
                <div class="row report-section">
                    <div class="col-lg-6 mb-4">
                        <div class="card chart-container">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-chart-pie me-2 text-primary"></i>
                                    <span data-i18n="testRun.statusDistribution">測試結果狀態分布</span>
                                </h6>
                                <div style="position: relative; height: 400px;">
                                    <canvas id="statusPieChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6 mb-4">
                        <div class="card chart-container">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-chart-bar me-2 text-success"></i>
                                    <span data-i18n="testRun.priorityDistribution">優先級分布</span>
                                </h6>
                                <div style="position: relative; height: 400px;">
                                    <canvas id="priorityBarChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 統計卡片 -->
                <div class="row report-section">
                    <div class="col-md-3 mb-3">
                        <div class="card text-center border-left-success">
                            <div class="card-body">
                                <div class="h4 text-success mb-1" id="chartPassedCount">0</div>
                                <div class="text-muted" data-i18n="testRun.passedItems">Passed</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center border-left-danger">
                            <div class="card-body">
                                <div class="h4 text-danger mb-1" id="chartFailedCount">0</div>
                                <div class="text-muted" data-i18n="testRun.failedItems">Failed</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center border-left-warning">
                            <div class="card-body">
                                <div class="h4 text-warning mb-1" id="chartRetestCount">0</div>
                                <div class="text-muted" data-i18n="testRun.retestItems">Retest</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center border-left-secondary">
                            <div class="card-body">
                                <div class="h4 text-secondary mb-1" id="chartNotAvailableCount">0</div>
                                <div class="text-muted" data-i18n="testRun.notAvailable">Not Available</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center border-left-warning">
                            <div class="card-body">
                                <div class="h4 text-muted mb-1" id="chartPendingCount">0</div>
                                <div class="text-muted" data-i18n="testRun.pending">Pending</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card text-center border-left-secondary">
                            <div class="card-body">
                                <div class="h4 text-secondary mb-1" id="chartNotRequiredCount">0</div>
                                <div class="text-muted" data-i18n="testRun.notRequired">Not Required</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
              <div class="d-flex align-items-center w-100 gap-3 flex-wrap">
                <button type="button" class="btn btn-primary" id="generateHTMLBtn" onclick="generateHtmlReport()">
                  <i class="fas fa-file-alt me-2" id="generateIcon"></i>
                  <span id="generateText" data-i18n="testRun.generateHtmlButton">產生並複製連結</span>
                </button>
                <button type="button" class="btn btn-secondary ms-auto" data-bs-dismiss="modal">
                  <span data-i18n="common.close">關閉</span>
                </button>
              </div>
            </div>
        </div>
    </div>
</div>

<script>
// 在 Charts & Reports 開啟時查詢報告狀態
(function(){
  // 保留掛鉤以後續擴充狀態展示，但目前不顯示或保存 URL
  const modal = document.getElementById('chartsReportsModal');
  if (modal) {
    modal.addEventListener('show.bs.modal', () => {});
  }
})();

// copyReportLink 移除：改由單一按鈕在生成後彈出手動複製視窗

// 生成 HTML 報告並複製連結
async function generateHtmlReport() {
  const btn = document.getElementById('generateHTMLBtn');
  const icon = document.getElementById('generateIcon');
  const text = document.getElementById('generateText');
  if (!btn) return;

  const translate = (key, params, fallback) => {
    if (window.i18n && typeof window.i18n.t === 'function') {
      return window.i18n.t(key, params || {}, fallback);
    }
    return typeof fallback !== 'undefined' ? fallback : key;
  };

  const defaultButtonLabel = translate('testRun.generateHtmlButton', {}, '生成並複製連結');
  const generatingLabel = translate('testRun.generatingHtml', {}, '生成中...');
  const generateFailed = translate('testRun.generateHtmlFailed', {}, '生成失敗');

  // 優先使用頁面內已初始化的 currentTeamId/currentConfigId
  let teamId = (typeof currentTeamId !== 'undefined' && currentTeamId) ? currentTeamId : null;
  let configId = (typeof currentConfigId !== 'undefined' && currentConfigId) ? currentConfigId : null;

  // 後備：從 URL 參數取得
  if (!teamId || !configId) {
    const params = new URLSearchParams(window.location.search);
    teamId = teamId || params.get('team_id') || params.get('teamId') || params.get('team');
    configId = configId || params.get('config_id') || params.get('configId') || params.get('config');
  }

  if (!teamId || !configId) {
    alert(translate('testRun.generateHtmlMissingParams', {}, '無法取得 team_id 或 config_id，請從管理頁進入執行頁面。'));
    return;
  }

  try {
    btn.disabled = true;
    icon.classList.add('fa-spinner', 'fa-spin');
    text.textContent = generatingLabel;

    const resp = await window.AuthClient.fetch(`/api/teams/${encodeURIComponent(teamId)}/test-runs/${encodeURIComponent(configId)}/generate-html`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await resp.json();
    if (!resp.ok || !data.success) {
      throw new Error(data?.detail || generateFailed);
    }

    const url = data.report_url;
    if (window.AppUtils && typeof AppUtils.showCopyModal === 'function') {
      AppUtils.showCopyModal(url);
    } else {
      const promptLabel = translate('copyModal.prompt', {}, '請手動複製此連結：');
      window.prompt(promptLabel, url);
    }
  } catch (err) {
    const errorMessage = err?.message || err;
    const alertMessage = translate('testRun.generateHtmlError', { error: errorMessage }, `生成 HTML 報告時發生錯誤：${errorMessage}`);
    alert(alertMessage);
  } finally {
    btn.disabled = false;
    icon.classList.remove('fa-spinner', 'fa-spin');
    icon.classList.add('fa-file-alt');
    text.textContent = defaultButtonLabel;
  }
}
// ===== 深連結與剪貼簿工具 =====
let __tcOpenedFromUrl = false;
function tryOpenTcFromUrlOnce() {
    if (__tcOpenedFromUrl) return;
    const tc = window.__PENDING_TC_FROM_URL__;
    if (!tc) { __tcOpenedFromUrl = true; return; }
    if (!Array.isArray(testRunItems) || testRunItems.length === 0) return;
    const exists = testRunItems.some(i => i && i.test_case_number === tc);
    if (exists) {
        __tcOpenedFromUrl = true;
        showTestCaseDetailModal(tc);
    } else {
        // 一次性嘗試即可，避免影響後續流程
        __tcOpenedFromUrl = true;
        console.warn('tc from URL not found in current testRunItems:', tc);
    }
}

function getCurrentTeamId() {
    try {
        const cur = AppUtils.getCurrentTeam && AppUtils.getCurrentTeam();
        if (cur && cur.id) return cur.id;
    } catch (_) {}
    const p = new URLSearchParams(window.location.search);
    const t = p.get('team_id') || p.get('teamId') || p.get('team');
    return t ? parseInt(t) : undefined;
}

function buildTreUrl(configId, teamId, tcNumber) {
    const origin = window.location.origin;
    const params = new URLSearchParams();
    if (configId) params.set('config_id', configId);
    if (teamId) params.set('team_id', teamId);
    if (tcNumber) params.set('tc', tcNumber);
    return `${origin}/test-run-execution?${params.toString()}`;
}

function safeCopyToClipboard(text, onSuccess, onError) {
    if (navigator && navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
        navigator.clipboard.writeText(text).then(() => { if (onSuccess) onSuccess(); }).catch(err => {
            try {
                const temp = document.createElement('input');
                temp.value = text;
                document.body.appendChild(temp);
                temp.select();
                document.execCommand('copy');
                document.body.removeChild(temp);
                if (onSuccess) onSuccess();
            } catch (e) { if (onError) onError(e); }
        });
    } else {
        try {
            const temp = document.createElement('input');
            temp.value = text;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand('copy');
            document.body.removeChild(temp);
            if (onSuccess) onSuccess();
        } catch (e) { if (onError) onError(e); }
    }
}

function ensureTeamIdInUrl_TRE(teamId) {
    try {
        const url = new URL(window.location.href);
        const before = url.searchParams.get('team_id');
        if (String(before || '') !== String(teamId)) {
            url.searchParams.set('team_id', teamId);
            history.replaceState(null, '', `${url.pathname}?${url.searchParams.toString()}`);
        }
    } catch (_) {}
}
</script>

<!-- Chart.js 相關 CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<style>
.chart-container {
    transition: all 0.2s ease;
}

.chart-container:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
    transform: translateY(-1px);
}

.border-left-success { border-left: 4px solid #28a745; }
.border-left-danger { border-left: 4px solid #dc3545; }
.border-left-warning { border-left: 4px solid #ffc107; }
.border-left-secondary { border-left: 4px solid #6c757d; }

/* Print styles moved to dynamic PDF generation function for better control */

/* Test Results 區塊樣式 */
.disabled-attachment-link {
    pointer-events: none;
    cursor: default;
    text-decoration: none;
}

.test-results-upload-zone {
    transition: all 0.3s ease;
}
.upload-dropzone {
    transition: border-color 0.3s ease, background-color 0.3s ease;
    cursor: pointer;
}
.upload-dropzone:hover {
    border-color: #0d6efd !important;
    background-color: rgba(13, 110, 253, 0.05);
}
.upload-dropzone.drag-over {
    border-color: #0d6efd !important;
    background-color: rgba(13, 110, 253, 0.1);
}
.test-result-file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    margin: 4px 0;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    background-color: #f8f9fa;
    transition: background-color 0.2s ease;
}
.test-result-file-item:hover {
    background-color: #e9ecef;
}
.clickable-file:hover {
    background-color: #d1ecf1 !important;
    border-color: #bee5eb !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.file-info {
    display: flex;
    align-items: center;
    flex: 1;
    min-width: 0;
    overflow: hidden;
}
.file-icon {
    width: 24px;
    margin-right: 8px;
}
.file-info .fw-medium {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 0.6rem;
    max-width: 100%;
}
.file-actions {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
    min-width: 30px;
    margin-left: 8px;
    justify-content: flex-end;
    align-items: center;
}
.upload-progress-item {
    border-left: 4px solid #0d6efd;
    background-color: rgba(13, 110, 253, 0.05);
}
.upload-success-item {
    border-left: 4px solid #198754;
    background-color: rgba(25, 135, 84, 0.05);
}
.upload-error-item {
    border-left: 4px solid #dc3545;
    background-color: rgba(220, 53, 69, 0.05);
}
</style>

<script>
// ================== Test Results 功能 ==================
class TestResultsManager {
    constructor(testRunItemId, testCaseNumber, teamId, configId) {
        this.testRunItemId = testRunItemId;
        this.testCaseNumber = testCaseNumber;
        this.teamId = teamId;
        this.configId = configId;
        this.currentFiles = [];
        this.isUploading = false;
        this.handleUploadButtonClick = null;
        this.handleDropzoneDragOver = null;
        this.handleDropzoneDragLeave = null;
        this.handleDropzoneDrop = null;
        this.handleDropzoneClick = null;
        this.handleFileInputChange = null;
        
        this.initializeElements();
        this.bindEvents();
        this.loadExistingResults();
    }
    
    initializeElements() {
        this.uploadBtn = document.getElementById('uploadTestResultsBtn');
        this.uploadArea = document.getElementById('testResultsUploadArea');
        this.fileInput = document.getElementById('testResultsFileInput');
        this.dropzone = document.querySelector('.upload-dropzone');
        this.progressArea = document.getElementById('uploadProgressArea');
        this.progressBar = document.getElementById('uploadProgressBar');
        this.uploadStatus = document.getElementById('uploadStatus');
        this.resultsList = document.getElementById('testResultsList');
        this.filesList = document.getElementById('testResultsList'); // 檔案列表區域引用
        this.loading = document.getElementById('testResultsLoading');
        this.empty = document.getElementById('testResultsEmpty');

        this.resetViewState();
    }
    
    bindEvents() {
        this.unbindEvents();

        const canUpload = getTrePermissions().canUploadResults;

        if (this.uploadBtn) {
            if (canUpload) {
                this.handleUploadButtonClick = () => this.toggleUploadArea();
                this.uploadBtn.addEventListener('click', this.handleUploadButtonClick);
            } else {
                this.uploadBtn.classList.add('disabled');
                this.uploadBtn.setAttribute('aria-disabled', 'true');
            }
        }

        if (this.dropzone) {
            if (canUpload) {
                this.handleDropzoneDragOver = (e) => this.handleDragOver(e);
                this.handleDropzoneDragLeave = (e) => this.handleDragLeave(e);
                this.handleDropzoneDrop = (e) => this.handleDrop(e);
                this.handleDropzoneClick = () => this.fileInput?.click();

                this.dropzone.addEventListener('dragover', this.handleDropzoneDragOver);
                this.dropzone.addEventListener('dragleave', this.handleDropzoneDragLeave);
                this.dropzone.addEventListener('drop', this.handleDropzoneDrop);
                this.dropzone.addEventListener('click', this.handleDropzoneClick);
            } else {
                this.dropzone.classList.add('disabled');
            }
        }

        if (this.fileInput) {
            if (canUpload) {
                this.handleFileInputChange = (e) => this.handleFileSelect(e);
                this.fileInput.addEventListener('change', this.handleFileInputChange);
            } else {
                this.fileInput.setAttribute('disabled', 'true');
            }
        }
    }

    unbindEvents() {
        if (this.uploadBtn && this.handleUploadButtonClick) {
            this.uploadBtn.removeEventListener('click', this.handleUploadButtonClick);
        }
        if (this.dropzone) {
            if (this.handleDropzoneDragOver) this.dropzone.removeEventListener('dragover', this.handleDropzoneDragOver);
            if (this.handleDropzoneDragLeave) this.dropzone.removeEventListener('dragleave', this.handleDropzoneDragLeave);
            if (this.handleDropzoneDrop) this.dropzone.removeEventListener('drop', this.handleDropzoneDrop);
            if (this.handleDropzoneClick) this.dropzone.removeEventListener('click', this.handleDropzoneClick);
        }
        if (this.fileInput && this.handleFileInputChange) {
            this.fileInput.removeEventListener('change', this.handleFileInputChange);
        }

        this.handleUploadButtonClick = null;
        this.handleDropzoneDragOver = null;
        this.handleDropzoneDragLeave = null;
        this.handleDropzoneDrop = null;
        this.handleDropzoneClick = null;
        this.handleFileInputChange = null;
    }

    resetViewState() {
        if (this.uploadArea) {
            this.uploadArea.style.display = 'none';
        }
        if (this.filesList) {
            this.filesList.style.display = 'block';
        }
        if (this.empty) {
            this.empty.style.display = 'none';
        }
        if (this.uploadBtn && this.uploadBtn.querySelector('i')) {
            this.uploadBtn.querySelector('i').className = 'fas fa-upload';
        }
    }
    
    async loadTestCaseAttachments_REMOVED() {
        try {
            if (!this.tcAttachmentsContainer) return;
            const listDiv = this.tcAttachmentsContainer.querySelector('[data-role="attachments-list"]');
            if (listDiv) listDiv.innerHTML = `<div class="text-muted small">${window.i18n ? window.i18n.t('messages.loading') : '載入中...'}</div>`;
            const resp = await window.AuthClient.fetch(`/api/teams/${this.teamId}/testcases/by-number/${encodeURIComponent(this.testCaseNumber)}`);
            if (!resp.ok) {
                if (listDiv) listDiv.innerHTML = `<div class="text-muted small">${window.i18n ? window.i18n.t('errors.noAttachments') : '尚無附件'}</div>`;
                return;
            }
            const data = await resp.json();
            const attachments = Array.isArray(data.attachments) ? data.attachments : [];
            if (!attachments.length) {
                if (listDiv) listDiv.innerHTML = `<div class="text-muted small">${window.i18n ? window.i18n.t('errors.noAttachments') : '尚無附件'}</div>`;
                return;
            }
            const html = attachments.map(att => {
                const name = att.name || att.file_token || 'file';
                const size = att.size || 0;
                const url = att.url || '#';
                return `
                    <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" href="${url}" target="_blank">
                        <span><i class="fas fa-file text-primary me-2"></i>${name}</span>
                        <small class="text-muted">${(size/1024/1024).toFixed(2)} MB</small>
                    </a>
                `;
            }).join('');
            if (listDiv) listDiv.innerHTML = html;
        } catch (e) {
            console.error('載入 Test Case 附件失敗:', e);
        }
    }
    
    async loadExistingResults() {
        try {
            this.showLoading(true);
            
            const response = await window.AuthClient.fetch(`/api/teams/${this.teamId}/test-run-configs/${this.configId}/items/${this.testRunItemId}/test-results`);
            
            if (response.ok) {
                const data = await response.json();
                const files = Array.isArray(data.test_results_files) ? data.test_results_files : [];
                this.renderResultsList(files);
            } else {
                console.error('載入測試結果失敗:', response.statusText);
                this.renderResultsList([]);
            }
        } catch (error) {
            console.error('載入測試結果異常:', error);
            this.renderResultsList([]);
        } finally {
            this.showLoading(false);
        }
    }
    
    toggleUploadArea() {
        if (!getTrePermissions().canUploadResults) {
            showExecutionPermissionDenied();
            return;
        }
        if (!this.uploadArea) {
            return;
        }
        // 修正判斷邏輯：只有明確設定為 'block' 才算可見
        const isVisible = this.uploadArea.style.display === 'block';
        const hasFiles = Array.isArray(this.currentFiles) && this.currentFiles.length > 0;

        if (!isVisible) {
            // 顯示上傳區域，隱藏檔案列表
            if (this.filesList) this.filesList.style.display = 'none';
            if (this.empty) this.empty.style.display = 'none';
            if (this.uploadArea) this.uploadArea.style.display = 'block';
            const icon = this.uploadBtn?.querySelector('i');
            if (icon) icon.className = 'fas fa-times';
        } else {
            // 隱藏上傳區域，重新顯示檔案列表
            if (this.uploadArea) this.uploadArea.style.display = 'none';
            if (this.filesList) this.filesList.style.display = hasFiles ? 'block' : 'none';
            if (this.empty) this.empty.style.display = hasFiles ? 'none' : 'block';
            const icon = this.uploadBtn?.querySelector('i');
            if (icon) icon.className = 'fas fa-upload';
        }
    }
    
    async handleFileSelect(event) {
        const files = Array.from(event.target.files);
        if (files.length > 0) {
            await this.uploadFiles(files);
        }
    }
    
    async handleDrop(event) {
        event.preventDefault();
        this.dropzone.classList.remove('drag-over');
        
        const files = Array.from(event.dataTransfer.files);
        if (files.length > 0) {
            await this.uploadFiles(files);
        }
    }
    
    handleDragOver(event) {
        event.preventDefault();
        this.dropzone.classList.add('drag-over');
    }
    
    handleDragLeave(event) {
        event.preventDefault();
        this.dropzone.classList.remove('drag-over');
    }
    
    async uploadFiles(files) {
        if (!getTrePermissions().canUploadResults) {
            showExecutionPermissionDenied();
            this.showProgress(false);
            return;
        }
        if (this.isUploading) {
            AppUtils.showWarning(i18n.t('testRun.uploadInProgress'));
            return;
        }
        
        this.isUploading = true;
        this.showProgress(true);
        
        try {
            const formData = new FormData();
            files.forEach(file => formData.append('files', file));
            
            const response = await window.AuthClient.fetch(`/api/teams/${this.teamId}/test-run-configs/${this.configId}/items/${this.testRunItemId}/upload-results`, {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                AppUtils.showSuccess(i18n.t('testRun.uploadSuccess'));
                this.loadExistingResults();
                this.toggleUploadArea();

                if (window.updateStatistics) {
                    window.updateStatistics();
                }

                // 重新載入 Test Run Items 數據以更新附件相關資訊
                if (window.loadTestRunItemsWithoutLoading) {
                    window.loadTestRunItemsWithoutLoading();
                }
            } else {
                const errorMsg = result.error_messages?.join('; ') || i18n.t('testRun.uploadFailed');
                AppUtils.showError(errorMsg);
            }
        } catch (error) {
            console.error('上傳異常:', error);
            AppUtils.showError(i18n.t('testRun.uploadError'));
        } finally {
            this.isUploading = false;
            this.showProgress(false);
            this.fileInput.value = '';
        }
    }
    
    renderResultsList(files) {
        const safeFiles = Array.isArray(files) ? files : [];
        this.currentFiles = safeFiles;
        this.canManageFiles = getTrePermissions().canUploadResults;

        if (!safeFiles.length) {
            if (this.resultsList) {
                this.resultsList.innerHTML = '';
            }
            this.showEmpty(true);
            return;
        }
        
        this.showEmpty(false);
        const filesHtml = safeFiles.map((file, index) => this.renderFileItem(file, index)).join('');
        if (this.resultsList) {
            this.resultsList.innerHTML = filesHtml;
        }

        this.bindFileItemEvents();
    }

    renderFileItem(file, fileIndex) {
        const fileIcon = this.getFileIcon(file.name);
        const canManageFiles = !!this.canManageFiles;
        const actionsHtml = canManageFiles ? `
                <div class="file-actions">
                    <button type="button" class="btn btn-xs btn-danger delete-file-btn" 
                            data-file-token="${file.file_token}"
                            data-file-name="${this.escapeHtml(file.name)}" 
                            data-i18n-title="testRun.deleteFile"
                            style="font-size: 0.6rem; padding: 2px 4px;"
                            onclick="event.stopPropagation();">
                        <i class="fas fa-trash" style="font-size: 0.7rem;"></i>
                    </button>
                </div>` : '';
        
        return `
            <div class="test-result-file-item clickable-file"
                 data-file-token="${file.file_token}"
                 data-file-name="${this.escapeHtml(file.name)}"
                 data-file-index="${fileIndex}"
                 data-config-id="${this.configId}"
                 data-item-id="${this.testRunItemId}"
                 style="cursor: pointer;"
                 title="點擊下載 ${this.escapeHtml(file.name)}">
                <div class="file-info">
                    <i class="${fileIcon} file-icon"></i>
                    <div>
                        <div class="fw-medium">${this.escapeHtml(file.name)}</div>
                    </div>
                </div>
                ${actionsHtml}
            </div>
        `;
    }
    
    getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const iconMap = {
            'png': 'fas fa-image text-primary',
            'jpg': 'fas fa-image text-primary',
            'jpeg': 'fas fa-image text-primary',
            'gif': 'fas fa-image text-primary',
            'pdf': 'fas fa-file-pdf text-danger',
            'txt': 'fas fa-file-alt text-secondary',
            'log': 'fas fa-file-alt text-secondary',
            'json': 'fas fa-file-code text-warning',
            'xml': 'fas fa-file-code text-warning',
            'zip': 'fas fa-file-archive text-info',
            'rar': 'fas fa-file-archive text-info'
        };
        return iconMap[ext] || 'fas fa-file text-secondary';
    }
    
    bindFileItemEvents() {
        // 檔案項目點擊下載事件
        document.querySelectorAll('.clickable-file').forEach(item => {
            item.addEventListener('click', (e) => {
                const fileToken = e.currentTarget.dataset.fileToken;
                const fileIndex = parseInt(e.currentTarget.dataset.fileIndex);
                const configId = parseInt(e.currentTarget.dataset.configId);
                const itemId = parseInt(e.currentTarget.dataset.itemId);
                this.downloadFile(fileToken, fileIndex, configId, itemId);
            });
        });

        // 刪除按鈕事件
        if (this.canManageFiles) {
            document.querySelectorAll('.delete-file-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const fileToken = e.currentTarget.dataset.fileToken;
                    const fileName = e.currentTarget.dataset.fileName;
                    this.deleteFile(fileToken, fileName);
                });
            });
        }
    }

    async downloadFile(fileToken, fileIndex = null, configId = null, itemId = null) {
        try {
            const downloadUrl = new URL(`/api/attachments/teams/${this.teamId}/attachments/download`, window.location.origin);

            // 優先使用 config_id + item_id + file_index（快速路徑，無遞迴搜尋）
            if (fileIndex !== null && configId !== null && itemId !== null) {
                downloadUrl.searchParams.set('config_id', configId);
                downloadUrl.searchParams.set('item_id', itemId);
                downloadUrl.searchParams.set('file_index', fileIndex);
            } else {
                // 降級到舊的方法（較慢）
                downloadUrl.searchParams.set('file_token', fileToken);
            }

            window.open(downloadUrl.toString(), '_blank');
        } catch (error) {
            console.error('下載檔案失敗:', error);
            AppUtils.showError('下載檔案失敗');
        }
    }
    
    async deleteFile(fileToken, fileName) {
        if (!getTrePermissions().canUploadResults) {
            showExecutionPermissionDenied();
            return;
        }
        const confirmed = await AppUtils.showConfirm(
            i18n.t('testRun.confirmDeleteFile', { fileName })
        );
        
        if (!confirmed) return;
        
        try {
            const response = await window.AuthClient.fetch(`/api/teams/${this.teamId}/test-run-configs/${this.configId}/items/${this.testRunItemId}/test-results/${fileToken}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                AppUtils.showSuccess(i18n.t('testRun.fileDeleteSuccess'));
                
                const fileItem = document.querySelector(`[data-file-token="${fileToken}"]`);
                if (fileItem) {
                    fileItem.remove();
                }

                if (Array.isArray(this.currentFiles)) {
                    this.currentFiles = this.currentFiles.filter(file => file && file.file_token !== fileToken);
                    if (this.currentFiles.length === 0) {
                        this.showEmpty(true);
                    }
                }
                
                setTimeout(() => {
                    this.loadExistingResults();
                }, 1000);

                if (window.updateStatistics) {
                    window.updateStatistics();
                }

                // 重新載入 Test Run Items 數據以更新附件相關資訊
                if (window.loadTestRunItemsWithoutLoading) {
                    window.loadTestRunItemsWithoutLoading();
                }
            } else {
                const errorMsg = result.error || i18n.t('testRun.fileDeleteFailed');
                AppUtils.showError(errorMsg);
            }
        } catch (error) {
            console.error('刪除檔案異常:', error);
            AppUtils.showError(i18n.t('testRun.fileDeleteFailed'));
        }
    }
    
    showLoading(show) {
        this.loading.style.display = show ? 'block' : 'none';
        if (show) {
            this.showEmpty(false);
            this.resultsList.style.display = 'none';
        } else {
            this.resultsList.style.display = 'block';
        }
    }
    
    showEmpty(show) {
        if (this.empty) {
            this.empty.style.display = show ? 'block' : 'none';
        }
        if (this.resultsList) {
            this.resultsList.style.display = show ? 'none' : 'block';
        }
    }
    
    showProgress(show) {
        this.progressArea.style.display = show ? 'block' : 'none';
        if (!show) {
            this.progressBar.style.width = '0%';
            this.uploadStatus.textContent = '';
        }
    }
    
    escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // 清理 DOM 狀態方法
    cleanup() {
        this.unbindEvents();
        this.currentFiles = [];
        this.isUploading = false;

        // 清理檔案列表
        if (this.resultsList) {
            this.resultsList.innerHTML = '';
        }

        // 重置上傳區域和檔案列表的顯示狀態
        if (this.uploadArea) {
            this.uploadArea.style.display = 'none';
        }
        if (this.filesList) {
            this.filesList.style.display = 'block';
        }

        // 顯示空狀態
        this.showEmpty(true);
        this.showLoading(false);
        this.showProgress(false);

        // 重置上傳按鈕狀態
        if (this.uploadBtn && this.uploadBtn.querySelector('i')) {
            this.uploadBtn.querySelector('i').className = 'fas fa-upload';
        }

        // 清理檔案輸入
        if (this.fileInput) {
            this.fileInput.value = '';
        }

        // 重置拖放區域狀態
        if (this.dropzone) {
            this.dropzone.classList.remove('drag-over');
        }

        // 重置內部狀態
        this.currentFiles = [];
        this.isUploading = false;
    }
}

// 全局變量
let currentTestResultsManager = null;

// 初始化 Test Results 管理器 (with setTimeout fix)
function initializeTestResults(testRunItemId, testCaseNumber, teamId, configId) {
    // 清理前一個 manager 的 DOM 狀態
    if (currentTestResultsManager) {
        currentTestResultsManager.cleanup();
        currentTestResultsManager = null;
    }

    // 確保 DOM 元素存在後再初始化
    setTimeout(() => {
        currentTestResultsManager = new TestResultsManager(
            testRunItemId,
            testCaseNumber,
            teamId,
            configId
        );
    }, 100);
}


</script>
</style>

{% endblock %}
/* reverted: no fixed height for attachments list */
